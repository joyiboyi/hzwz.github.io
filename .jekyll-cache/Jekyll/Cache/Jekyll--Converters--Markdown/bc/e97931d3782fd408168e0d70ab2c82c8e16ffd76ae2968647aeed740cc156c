I"ì<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>Orangeåœ¨ä»Šå¹´çš„BlackHatæ¼”è®²ä¸­ä»‹ç»äº†åœ¨Pwn2Own 2021ä¸Šä½¿ç”¨çš„Microsoft Exchangeæ”»å‡»é“¾ï¼Œä»–åˆ†äº«çš„<a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-ProxyLogon-Is-Just-The-Tip-Of-The-Iceberg-A-New-Attack-Surface-On-Microsoft-Exchange-Server.pdf">å†…å®¹</a>ç»™äº†æˆ‘å¾ˆå¤§çš„å¯å‘ã€‚</p>

<p>æœ¬æ–‡ä»…åœ¨æŠ€æœ¯ç ”ç©¶çš„è§’åº¦è®°å½•æˆ‘åœ¨ç ”ç©¶ProxyShellä¸­çš„ç»†èŠ‚ï¼Œåˆ†æåˆ©ç”¨æ€è·¯ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>è°ƒè¯•ç¯å¢ƒæ­å»º</li>
  <li>æ¼æ´åˆ†æ</li>
  <li>åˆ©ç”¨æ€è·¯</li>
</ul>

<h2 id="0x02-è°ƒè¯•ç¯å¢ƒæ­å»º">0x02 è°ƒè¯•ç¯å¢ƒæ­å»º</h2>
<hr />

<h3 id="1ç¦ç”¨visual-studioä¸­çš„è°ƒè¯•ä¼˜åŒ–">1.ç¦ç”¨Visual Studioä¸­çš„è°ƒè¯•ä¼˜åŒ–</h3>

<p>è®¾ç½®ç¯å¢ƒå˜é‡<code class="language-plaintext highlighter-rouge">COMPLUS_ZapDisable=1</code></p>

<p>é‡å¯ç³»ç»Ÿ</p>

<h3 id="2æŸ¥çœ‹exchangeä¸­å¯¹åº”çš„è¿›ç¨‹">2.æŸ¥çœ‹Exchangeä¸­å¯¹åº”çš„è¿›ç¨‹</h3>

<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\System32\inetsrv\appcmd list wp
</code></pre></div></div>

<p>å¯ä»¥è·å¾—Exchangeçš„æ‰€æœ‰è¿›ç¨‹å’Œå¯¹åº”çš„pidï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2021-8-12/2-1.png" alt="Alt text" /></p>

<h3 id="3ä½¿ç”¨dnspyè¿›è¡Œè°ƒè¯•">3.ä½¿ç”¨<a href="https://github.com/dnSpy/dnSpy">dnSpy</a>è¿›è¡Œè°ƒè¯•</h3>

<p>æ‰“å¼€ç›¸å…³çš„dllæ–‡ä»¶å¹¶åœ¨å¾…è°ƒè¯•çš„ä½ç½®ä¸‹æ–­ç‚¹ï¼Œé€‰æ‹©é™„åŠ è¿›ç¨‹å¼€å§‹è°ƒè¯•</p>

<p>å¦‚æœä¸ç¡®å®šå¾…è°ƒè¯•çš„Exchangeè¿›ç¨‹ï¼Œå¯ä»¥é€‰æ‹©æ‰€æœ‰w3wp.exe</p>

<h2 id="0x03-æ¼æ´è°ƒè¯•">0x03 æ¼æ´è°ƒè¯•</h2>
<hr />

<p>ä½¿ç”¨dnSpyæ‰“å¼€æ–‡ä»¶<code class="language-plaintext highlighter-rouge">C:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\bin\Microsoft.Exchange.FrontEndHttpProxy.dll</code></p>

<p>ä¾æ¬¡å®šä½åˆ°<code class="language-plaintext highlighter-rouge">Microsoft.Exchange.Clients.Owa.Core</code> -&gt; <code class="language-plaintext highlighter-rouge">Microsoft.Exchange.HttpProxy</code></p>

<p>å…³äºSSRFæ¼æ´(CVE-2021-34473)çš„æ¼æ´åŸç†å¯ä»¥å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼š</p>

<p>https://peterjson.medium.com/reproducing-the-proxyshell-pwn2own-exploit-49743a4ea9a1</p>

<h2 id="0x04-æ¼æ´åˆ†æ">0x04 æ¼æ´åˆ†æ</h2>
<hr />

<h3 id="1åˆ¤æ–­æ¼æ´æ˜¯å¦å­˜åœ¨">1.åˆ¤æ–­æ¼æ´æ˜¯å¦å­˜åœ¨</h3>

<p>è¿™é‡Œä½¿ç”¨OrangeåŸæ–‡ç»™å‡ºçš„æ–¹æ³•ï¼š</p>

<p>è®¿é—®ï¼šhttps://<exchange url="">/autodiscover/autodiscover.json?@foo.com/mapi/nspi/?&amp;Email=autodiscover/autodiscover.json%3f@foo.com</exchange></p>

<p>å¦‚æœæ¼æ´å­˜åœ¨ï¼Œè¿”å›å¦‚ä¸‹ç»“æœï¼š</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2021-8-12/2-2.png" alt="Alt text" /></p>

<p>æƒé™ä¸ºSystem</p>

<p>urlåœ°å€ä¸­çš„â€/mapi/nspiâ€ä¸ºExchangeæœåŠ¡å™¨è®¿é—®çš„æœ€ç»ˆåœ°å€</p>

<p>urlåœ°å€ä¸­çš„â€?&amp;Email=autodiscover/autodiscover.json%3f@foo.comâ€ä½œä¸ºå‚æ•°ï¼Œè¿™æ˜¯ä¸ºäº†æ»¡è¶³æ¼æ´è§¦å‘çš„æ¡ä»¶ã€‚æ­¤å¤„è¿˜å¯ä»¥é€šè¿‡è®¾ç½®Cookieçš„å†…å®¹ä¸ºâ€Email=Autodiscover/autodiscover.json%3f@foo.comâ€å®ç°ç›¸åŒçš„æ•ˆæœï¼Œæºç å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2021-8-12/2-3.png" alt="Alt text" /></p>

<h3 id="2é€šè¿‡ssrfæ¼æ´è°ƒç”¨exchange-web-serviceews">2.é€šè¿‡SSRFæ¼æ´è°ƒç”¨Exchange Web Service(EWS)</h3>

<p>Exchange Web Service(EWS)å¯¹åº”é‚®ç®±ç”¨æˆ·çš„é‚®ä»¶å†…å®¹ï¼Œå…³äºEWSçš„ä½¿ç”¨å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/Exchange-Web-Service(EWS)%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%972-SOAP-XML-message">ã€ŠExchange Web Service(EWS)å¼€å‘æŒ‡å—2â€”â€”SOAP XML messageã€‹</a>ï¼Œé€šè¿‡å‘é€XMLè¯·æ±‚ï¼Œèƒ½å¤Ÿè·å¾—å¯¹åº”ç”¨æˆ·çš„é‚®ä»¶å†…å®¹</p>

<p>ç”±äºSSRFé»˜è®¤çš„æƒé™ä¸ºSystemï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°èƒ½å¤Ÿæ¨¡æ‹Ÿä»»æ„é‚®ç®±ç”¨æˆ·çš„æ–¹æ³•ï¼Œæ‰èƒ½å¤Ÿè¯»å–å¯¹åº”ç”¨æˆ·çš„é‚®ä»¶å†…å®¹</p>

<p>ç»è¿‡ä¸€æ®µæ—¶é—´çš„è°ƒè¯•ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°é€šè¿‡å‚æ•°æŒ‡å®šEWSè®¤è¯ç”¨æˆ·çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Exchangeææƒæ¼æ´(CVE-2018-8581)ä¸­çš„æŠ€å·§ï¼Œé€šè¿‡åœ¨Headerä¸­ä½¿ç”¨SerializedSecurityContextï¼ŒæŒ‡å®šSIDå¯ä»¥å®ç°èº«ä»½ä¼ªè£…ï¼Œä»è€Œä»¥æŒ‡å®šç”¨æˆ·èº«ä»½è¿›è¡ŒEWSè°ƒç”¨æ“ä½œ</p>

<p>ä»£ç åœ°å€ï¼š</p>

<p>https://github.com/thezdi/PoC/blob/master/CVE-2018-8581/serverHTTP_relayNTLM.py#L48-L64</p>

<p>Headeræ ¼å¼å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;soap:Header&gt;
     &lt;t:RequestServerVersion Version="Exchange2016" /&gt;
     
&lt;m:SerializedSecurityContext&gt;
&lt;m:UserSid&gt;'''+VICTIM_SID+'''&lt;/m:UserSid&gt;
&lt;m:GroupSids&gt;
   &lt;m:GroupIdentifier&gt;
     &lt;t:SecurityIdentifier&gt;'''+VICTIM_SID+'''&lt;/t:SecurityIdentifier&gt;
   &lt;/m:GroupIdentifier&gt;
&lt;/m:GroupSids&gt;
   
&lt;RestrictedGroupSids&gt;
&lt;RestrictedGroupIdentifier&gt; &lt;/RestrictedGroupIdentifier&gt;
&lt;/RestrictedGroupSids&gt;
&lt;/m:SerializedSecurityContext&gt;
 
&lt;/soap:Header&gt; 
</code></pre></div></div>

<p>ä¸ºäº†è·å¾—ç”¨æˆ·çš„SIDï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Exchange SSRFæ¼æ´(CVE-2021-26855)ä¸­çš„æŠ€å·§ï¼Œé€šè¿‡è®¿é—®/autodiscover/autodiscover.xmlè·å¾—legacyDnï¼Œä½œä¸ºå‚æ•°ç»§ç»­è®¿é—®/mapi/emsmdbï¼Œå°±èƒ½å¤Ÿè·å¾—ç”¨æˆ·å¯¹åº”çš„sid</p>

<p>è‡³æ­¤ï¼Œæ•´ä¸ªåˆ©ç”¨é“¾å®Œæˆï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>

<p>1.è®¿é—®/autodiscover/autodiscover.xmlè·å¾—legacyDn
2.è®¿é—®/mapi/emsmdbè·å¾—ç”¨æˆ·å¯¹åº”çš„sid
3.åœ¨Headerä¸­ä½¿ç”¨SerializedSecurityContextï¼ŒæŒ‡å®šç”¨æˆ·èº«ä»½è¿›è¡ŒEWSè°ƒç”¨æ“ä½œ</p>

<h3 id="3æšä¸¾é‚®ç®±ç”¨æˆ·åˆ—è¡¨">3.æšä¸¾é‚®ç®±ç”¨æˆ·åˆ—è¡¨</h3>

<p>æˆ‘åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E8%8E%B7%E5%BE%97Exchange-GlobalAddressList%E7%9A%84%E6%96%B9%E6%B3%95">ã€Šæ¸—é€æŠ€å·§â€”â€”è·å¾—Exchange GlobalAddressListçš„æ–¹æ³•ã€‹</a>æåˆ°è¿‡ï¼šâ€œExchange GlobalAddressList(å…¨å±€åœ°å€åˆ—è¡¨)åŒ…å«Exchangeç»„ç»‡ä¸­æ‰€æœ‰é‚®ç®±ç”¨æˆ·çš„é‚®ä»¶åœ°å€ï¼Œåªè¦è·å¾—Exchangeç»„ç»‡å†…ä»»ä¸€é‚®ç®±ç”¨æˆ·çš„å‡­æ®ï¼Œå°±èƒ½å¤Ÿé€šè¿‡GlobalAddressListå¯¼å‡ºå…¶ä»–é‚®ç®±ç”¨æˆ·çš„é‚®ä»¶åœ°å€ã€‚â€</p>

<p>è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥è¿›è¡Œåˆ©ç”¨çš„ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨<a href="https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/findpeople-operation?redirectedfrom=MSDN">FindPeople</a>æ“ä½œï¼Œåšä¸€ä¸ªéå†å¹¶è¿›è¡Œç»“æœå»é‡å³å¯</p>

<p>å®ç°ç»†èŠ‚å¯ä»¥å‚è€ƒä¹‹å‰å¼€æºçš„è„šæœ¬ï¼šhttps://github.com/3gstudent/Homework-of-Python/blob/master/ewsManage.py</p>

<h3 id="4é»˜è®¤é‚®ç®±ç”¨æˆ·">4.é»˜è®¤é‚®ç®±ç”¨æˆ·</h3>

<p>ä¸ºäº†è¯»å–Exchange GlobalAddressList(å…¨å±€åœ°å€åˆ—è¡¨)ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—Exchangeç»„ç»‡å†…ä»»ä¸€é‚®ç®±ç”¨æˆ·çš„å‡­æ®ï¼Œå¯¹åº”åˆ°è¿™ä¸ªæ¼æ´ï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦é‚®ç®±ç”¨æˆ·åç§°</p>

<p>Exchangeä¸­é»˜è®¤å­˜åœ¨ä»¥ä¸‹å››ä¸ªç”¨æˆ·å¯ä¾›ä½¿ç”¨ï¼š</p>

<ul>
  <li>SystemMailbox{bb558c35-97f1-4cb9-8ff7-d53741dc928c}</li>
  <li>SystemMailbox{e0dc1c29-89c3-4034-b678-e6c29d823ed9}</li>
  <li>SystemMailbox{D0E409A0-AF9B-4720-92FE-AAC869B0D201}(Exchange 2016 CU8 and later)</li>
  <li>SystemMailbox{2CE34405-31BE-455D-89D7-A7C7DA7A0DAA}(Exchange 2016 CU8 and later)</li>
</ul>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://docs.microsoft.com/en-us/exchange/architecture/mailbox-servers/recreate-arbitration-mailboxes?view=exchserver-2019</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>CVE-2021-34473ä½œä¸ºProxyShellæ”»å‡»é“¾çš„åŸºç¡€ï¼ŒéªŒè¯ç®€å•ï¼Œå±å®³å·¨å¤§ã€‚ç«™åœ¨é˜²å¾¡çš„è§’åº¦ï¼Œå»ºè®®ç”¨æˆ·å°½å¿«æ›´æ–°è¡¥ä¸ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET