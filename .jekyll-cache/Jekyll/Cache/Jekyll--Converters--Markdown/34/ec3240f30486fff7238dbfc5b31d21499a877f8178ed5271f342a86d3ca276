I"‚+<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>è¦å¯¹æŒ‡å®šè¿›ç¨‹è¿›è¡Œè¿œç¨‹æ³¨å…¥ï¼Œé€šå¸¸ä½¿ç”¨Windowsæä¾›çš„API CreateRemoteThreadåˆ›å»ºä¸€ä¸ªè¿œç¨‹çº¿ç¨‹ï¼Œè¿›è€Œæ³¨å…¥dllæˆ–æ˜¯æ‰§è¡Œshellcodeã€‚</p>

<p>åœ¨64ä½ç³»ç»Ÿä¸‹ï¼Œè¯¥æ–¹æ³•éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œæ³¨å…¥çš„ç›®æ ‡è¿›ç¨‹è¦åŒç¨‹åºçš„ç»“æ„ä¿æŒä¸€è‡´ï¼Œå³32ä½ç¨‹åºåªèƒ½å¯¹32è¿›ç¨‹ä½œæ³¨å…¥ï¼Œ64ä½ç¨‹åºåªèƒ½å¯¹64ä½è¿›ç¨‹ä½œæ³¨å…¥</p>

<p><code class="language-plaintext highlighter-rouge">32ä½ç¨‹åºå¯¹64ä½ç¨‹åºè¿›è¡Œæ³¨å…¥æ—¶ä¼šå¤±è´¥(32ä½å’Œ64ä½çš„ç»“æ„ä¸åŒ)</code></p>

<p>ç„¶è€Œï¼Œåœ¨æŸäº›ç‰¹æ®Šçš„ç¯å¢ƒä¸‹ï¼Œæ— æ³•æå‰é¢„çŸ¥ç›®æ ‡è¿›ç¨‹çš„ç»“æ„ï¼Œå‡†å¤‡ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„ç¨‹åºåˆä¸ç°å®</p>

<p>æ‰€ä»¥åªèƒ½é‡æ–°æ€è€ƒè¿™ä¸ªé—®é¢˜ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">32ä½ç¨‹åºçœŸçš„æ— æ³•å¯¹64ä½ç¨‹åºè¿›è¡Œè¿œç¨‹æ³¨å…¥å—ï¼Ÿ</code></p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æˆ‘åœ¨odzhançš„åšå®¢é‡Œæ‰¾åˆ°äº†è§£å†³æ€è·¯ï¼Œæ–‡ç« åœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://modexp.wordpress.com/2015/11/19/dllpic-injection-on-windows-from-wow64-process/</p>

<p>æœ¬æ–‡å°†ä¼šä»‹ç»å®ç°æ€è·¯ï¼Œå‚è€ƒodzhançš„å¼€æºå·¥ç¨‹â€piâ€ï¼Œç¼–å†™æµ‹è¯•ä»£ç ï¼Œç”Ÿæˆ32ä½ç¨‹åºï¼Œå®ç°å¯¹64ä½è¿›ç¨‹calc.exeçš„è¿›ç¨‹æ³¨å…¥ï¼ŒéªŒè¯32ä½ç¨‹åºèƒ½å¤Ÿå¯¹64è¿›ç¨‹ä½œæ³¨å…¥çš„ç»“è®º</p>

<h2 id="0x02-å®ç°æ€è·¯">0x02 å®ç°æ€è·¯</h2>
<hr />

<h3 id="132ä½ç¨‹åºæ”¯æŒå¯¹64ä½ç¨‹åºçš„è¯»å†™">1ã€32ä½ç¨‹åºæ”¯æŒå¯¹64ä½ç¨‹åºçš„è¯»å†™</h3>

<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p>

<p>rgb/29aï¼š</p>

<p>http://www.vxheaven.org/lib/vrg02.html</p>

<p>ReWolfï¼š</p>

<p>http://blog.rewolf.pl/blog/</p>

<p>https://github.com/rwfpl/rewolf-wow64ext</p>

<h3 id="2-åˆ©ç”¨createremotethreadä½œè¿›ç¨‹æ³¨å…¥çš„é€šç”¨æ–¹æ³•">2ã€ åˆ©ç”¨CreateRemoteThreadä½œè¿›ç¨‹æ³¨å…¥çš„é€šç”¨æ–¹æ³•</h3>

<p><strong>è¿›ç¨‹æ³¨å…¥æµç¨‹ï¼š</strong></p>

<ul>
  <li>OpenProcess</li>
  <li>VirtualAllocEx</li>
  <li>WriteProcessMemory</li>
  <li>VirtualProtectEx</li>
  <li>CreateRemoteThread</li>
  <li>WaitForSingleObject</li>
</ul>

<p>åœ¨å…·ä½“çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæŒ‡å®šäº†è¿›ç¨‹åç§°ï¼Œéœ€è¦å…ˆå°†è¿›ç¨‹åç§°è½¬æ¢ä¸ºè¿›ç¨‹IDï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DWORD processNameToId(LPCTSTR lpszProcessName)  
{  
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);  
    PROCESSENTRY32 pe;  
    pe.dwSize = sizeof(PROCESSENTRY32);  
    if (!Process32First(hSnapshot, &amp;pe)) {  
        MessageBox(NULL,"The frist entry of the process list has not been copyied to the buffer","Notice", MB_ICONINFORMATION | MB_OK);  
        return 0;  
    }  
    while (Process32Next(hSnapshot, &amp;pe)) {  
        if (!strcmp(lpszProcessName, pe.szExeFile)) {  
            return pe.th32ProcessID;  
        }  
    }    
    return 0;  
}  
</code></pre></div></div>

<p>ä¾æ¬¡å®ç°å¦‚ä¸‹æ“ä½œï¼š</p>

<ul>
  <li>æ ¹æ®è¿›ç¨‹IDæ‰“å¼€è¿›ç¨‹ï¼Œè·å¾—è¿›ç¨‹å¥æŸ„</li>
  <li>ç”³è¯·å†…å­˜ç©ºé—´</li>
  <li>å†™å…¥æ•°æ®</li>
  <li>å°†å†…å­˜æ”¹ä¸ºå¯è¯»å¯æ‰§è¡Œ(å¯é€‰)</li>
  <li>åˆ›å»ºçº¿ç¨‹</li>
  <li>ç­‰å¾…çº¿ç¨‹é€€å‡º(å¯é€‰)</li>
</ul>

<p>ä»£ç å¯å‚è€ƒï¼š</p>

<p>http://blog.csdn.net/g710710/article/details/7303081</p>

<p>å¯¹å‚è€ƒä»£ç ä½œç»†å¾®ä¿®æ”¹ï¼Œå°†æ³¨å…¥è¿›ç¨‹åç§°æŒ‡å®šä¸ºcalc.exeï¼Œå®Œæ•´ä»£ç å·²ä¸Šä¼ githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/CreateRemoteThread/blob/master/CreateRemoteThreadTest.cpp</p>

<p>ç¨‹åºè¿è¡Œåï¼ŒæŸ¥æ‰¾è¿›ç¨‹calc.exeï¼Œæ¥ç€å°è¯•è¿œç¨‹æ³¨å…¥ï¼Œå¼¹å‡ºå¯¹è¯æ¡†ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-2-10/2-1.png" alt="Alt text" /></p>

<p>å°†ç¨‹åºç¼–è¯‘æˆx86ï¼Œå¯¹32ä½çš„è¿›ç¨‹calc.exeè¿›è¡Œæ³¨å…¥ï¼ŒæˆåŠŸ</p>

<p>å°†ç¨‹åºç¼–è¯‘æˆx64ï¼Œå¯¹64ä½çš„è¿›ç¨‹calc.exeè¿›è¡Œæ³¨å…¥ï¼ŒæˆåŠŸ</p>

<p>å°†ç¨‹åºç¼–è¯‘æˆx86ï¼Œå¯¹64ä½çš„è¿›ç¨‹calc.exeè¿›è¡Œæ³¨å…¥ï¼ŒOpenProcessã€VirtualAllocExã€WriteProcessMemoryã€VirtualProtectExå‡æ­£å¸¸ï¼Œæ‰§è¡ŒCreateRemoteThreadæ—¶ä¼šæŠ¥é”™</p>

<p><strong>è§£å†³æ€è·¯ï¼š</strong></p>

<p>å‚è€ƒrgb/29aå’ŒReWolfçš„æ€è·¯ï¼Œå°†æ­¤å¤„çš„CreateRemoteThreadåˆ‡æ¢ä¸º64ä½åå†åˆ›å»ºçº¿ç¨‹ï¼Œå®Œæˆåå†åˆ‡æ¢å›32ä½ï¼Œå³å¯å®ç°32ä½ç¨‹åºå¯¹64ä½è¿›ç¨‹çš„è¿œç¨‹æ³¨å…¥</p>

<h3 id="3åˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯32ä½è¿˜æ˜¯64ä½">3ã€åˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯32ä½è¿˜æ˜¯64ä½</h3>

<p>ä½¿ç”¨APIï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void WINAPI GetNativeSystemInfo(
  _Out_ LPSYSTEM_INFO lpSystemInfo
);
</code></pre></div></div>

<p>æŸ¥çœ‹ç»“æ„ä½“ä¸­çš„wProcessorArchitectureå¯è·å¾—CPUæ¶æ„ï¼Œè¿›è€Œåˆ¤æ–­æ“ä½œç³»ç»Ÿ</p>

<p>ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;windows.h&gt;
BOOL Is64BitOS()
{
    typedef VOID (WINAPI *LPFN_GetNativeSystemInfo)( __out LPSYSTEM_INFO lpSystemInfo );
    LPFN_GetNativeSystemInfo fnGetNativeSystemInfo = (LPFN_GetNativeSystemInfo)GetProcAddress( GetModuleHandle("kernel32"),"GetNativeSystemInfo");
    if(fnGetNativeSystemInfo)
    {
        SYSTEM_INFO stInfo = {0};
        fnGetNativeSystemInfo( &amp;stInfo);
        if( stInfo.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_IA64
            || stInfo.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_AMD64)
        {
            return TRUE;
        }
    }
    return FALSE;
}
int main()
{
    if (Is64BitOS())   
        printf("x64\n");
    else
        printf("x86\n");
    return 0;
}
</code></pre></div></div>

<h3 id="4åˆ¤æ–­æ³¨å…¥çš„è¿›ç¨‹æ˜¯32ä½è¿˜æ˜¯64ä½">4ã€åˆ¤æ–­æ³¨å…¥çš„è¿›ç¨‹æ˜¯32ä½è¿˜æ˜¯64ä½</h3>

<p>æŸ¥æ‰¾è¿›ç¨‹IDï¼Œæ‰“å¼€è¿›ç¨‹ï¼Œè·å¾—å¥æŸ„ï¼Œä½¿ç”¨APIï¼Œä¼ å…¥å‚æ•°ï¼Œè¿›è¡Œåˆ¤æ–­</p>

<p>ä½¿ç”¨APIï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BOOL WINAPI IsWow64Process(
  __in HANDLE hProcess,
  __out PBOOL Wow64Process
);
</code></pre></div></div>

<p>è¿”å›true, ä»£è¡¨è¿›ç¨‹æ˜¯32ä½ï¼Œå¦åˆ™æ˜¯64ä½</p>

<p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;windows.h&gt;
#include &lt;TlHelp32.h&gt;  

BOOL IsWow64(HANDLE hProcess)
{
    typedef BOOL (WINAPI *LPFN_ISWOW64PROCESS) (HANDLE, PBOOL);
    LPFN_ISWOW64PROCESS fnIsWow64Process;
    
    BOOL bIsWow64 = FALSE;
    fnIsWow64Process = (LPFN_ISWOW64PROCESS)GetProcAddress(
    GetModuleHandle("kernel32"),"IsWow64Process");

    if (NULL != fnIsWow64Process)
    {
        fnIsWow64Process(hProcess, &amp;bIsWow64);  
    }
    return bIsWow64;
}

DWORD processNameToId(LPCTSTR lpszProcessName)  
{  
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);  
    PROCESSENTRY32 pe;  
    pe.dwSize = sizeof(PROCESSENTRY32);  
    if (!Process32First(hSnapshot, &amp;pe)) {  
        MessageBox(NULL,   
            "The frist entry of the process list has not been copyied to the buffer","Notice", MB_ICONINFORMATION | MB_OK);  
        return 0;  
    }  
    while (Process32Next(hSnapshot, &amp;pe)) {  
        if (!strcmp(lpszProcessName, pe.szExeFile)) {  
            return pe.th32ProcessID;  
        }  
    }     
    return 0;  
}  

int main()
{
    BOOL           bWow64;  
    char *szExeName="calc.exe";  
    DWORD dwProcessId = processNameToId(szExeName);  
    if (dwProcessId == 0) {  
        MessageBox(NULL, "The target process have not been found !","Notice", MB_ICONINFORMATION | MB_OK);  
        return -1;  
    }  
    HANDLE hTargetProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwProcessId);     
    if (!hTargetProcess) {  
        MessageBox(NULL, "Open target process failed !",   
            "Notice", MB_ICONINFORMATION | MB_OK);  
        return 0;  
    }  
    bWow64 = IsWow64(hTargetProcess);

    if(bWow64)
        printf("32-bit process\n");
    else
        printf("64-bit process\n");
}
</code></pre></div></div>

<h3 id="5å¼€æºå·¥ç¨‹pi">5ã€å¼€æºå·¥ç¨‹pi</h3>

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>https://github.com/odzhan/shellcode/tree/master/win/pi</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>usage: pi [options] &lt;proc name | proc id&gt;

       -d          Wait after memory allocation before running thread
       -e &lt;cmd&gt;    Execute command in context of remote process (shows window)
       -f &lt;file&gt;   Load a PIC file into remote process
       -l &lt;dll&gt;    Load a DLL file into remote process
       -p          List available processes on system
       -x &lt;cpu&gt;    Exclude process running in cpu mode, 32 or 64
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>examples:

    pi -e "cmd /c echo this is a test &gt; test.txt &amp; notepad test.txt" -x32 iexplore.exe
    pi -l ws2_32.dll notepad.exe
    pi -f reverse_shell.bin chrome.exe
</code></pre></div></div>

<p><strong>æµ‹è¯•ç³»ç»Ÿï¼š</strong></p>

<p>Win7x64</p>

<p><strong>cmdæ‰§è¡Œï¼š</strong></p>

<p><code class="language-plaintext highlighter-rouge">pi32.exe -e "cmd /c start calc.exe" -x32 calc.exe</code></p>

<p>ä¸Šè¿°å‘½ä»¤å°†å¯¹64ä½çš„calc.exeè¿›è¡Œæ³¨å…¥</p>

<p>å›æ˜¾å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-2-10/2-2.png" alt="Alt text" /></p>

<p>payloadæ²¡æœ‰æˆåŠŸæ‰§è¡Œ</p>

<h2 id="0x03-æœ€ç»ˆä»£ç ">0x03 æœ€ç»ˆä»£ç </h2>
<hr />

<p>è™½ç„¶piæµ‹è¯•å¤±è´¥ï¼Œä½†æ˜¯ä»£ç å€¼å¾—å‚è€ƒï¼Œæå–å…³é”®ä»£ç ï¼Œå¼€å‘æµ‹è¯•ç¨‹åº</p>

<p>æµ‹è¯•ç¨‹åºç»“æ„å¦‚ä¸‹ï¼š</p>

<p>åˆ¤æ–­å½“å‰ç³»ç»Ÿ</p>

<ul>
  <li>
    <p>å¦‚æœä¸º32ä½ç³»ç»Ÿï¼Œ è°ƒç”¨ç³»ç»Ÿapi CreateRemoteThreadï¼Œå¯¹ç›®æ ‡è¿›ç¨‹å°è¯•è¿œç¨‹æ³¨å…¥ï¼Œå¼¹å‡ºå¯¹è¯æ¡†</p>
  </li>
  <li>
    <p>å¦‚æœä¸º64ä½ç³»ç»Ÿï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªåˆ†æ”¯ï¼Œå¯¹è¿›ç¨‹åˆ¤æ–­</p>
  </li>
</ul>

<p>åˆ¤æ–­è¿›ç¨‹calc.exe</p>

<ul>
  <li>
    <p>å¦‚æœä¸º32ä½ï¼Œè°ƒç”¨ç³»ç»Ÿapi CreateRemoteThreadï¼Œå¯¹ç›®æ ‡è¿›ç¨‹å°è¯•è¿œç¨‹æ³¨å…¥ï¼Œå¼¹å‡ºå¯¹è¯æ¡†</p>
  </li>
  <li>
    <p>å¦‚æœä¸º64ä½ï¼Œè°ƒç”¨è‡ªå®šä¹‰api CreateRemoteThread64ï¼Œå¯¹ç›®æ ‡è¿›ç¨‹å°è¯•è¿œç¨‹æ³¨å…¥ï¼Œæ‰§è¡Œpayloadï¼šâ€cmd /c start calc.exeâ€</p>
  </li>
</ul>

<p>å®Œæ•´ä»£ç å·²ä¸Šä¼ githubï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/CreateRemoteThread/blob/master/CreateRemoteThread32to64.cpp</p>

<h2 id="0x04-å®é™…æµ‹è¯•">0x04 å®é™…æµ‹è¯•</h2>
<hr />

<p><strong>æµ‹è¯•ç³»ç»Ÿï¼š</strong></p>

<p>Win7 x64</p>

<p>1ã€å°†ç¨‹åºç¼–è¯‘æˆ32ä½ï¼Œæ‰“å¼€64ä½calc.exe</p>

<p>2ã€è¿è¡Œæµ‹è¯•ç¨‹åº</p>

<p>å‘½ä»¤è¡Œè¾“å‡ºå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-2-10/2-3.png" alt="Alt text" /></p>

<p>æˆåŠŸæ‰§è¡Œpayloadï¼šâ€cmd /c start calc.exeâ€ï¼Œå¼¹å‡ºè®¡ç®—å™¨</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†32ä½ç¨‹åºå¯¹64ä½è¿›ç¨‹è¿œç¨‹æ³¨å…¥çš„å®ç°æ–¹æ³•ï¼Œå‚ç…§ä»¥ä¸Šä»£ç å¯å®ç°Windows 32ä½/64ä½ç³»ç»Ÿä¸‹è¿›ç¨‹æ³¨å…¥çš„é€šç”¨æ¨¡æ¿ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET