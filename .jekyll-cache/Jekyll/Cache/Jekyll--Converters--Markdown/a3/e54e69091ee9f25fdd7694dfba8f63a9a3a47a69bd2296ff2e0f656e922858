I"€3<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨Windows 10 Enterpriseå’ŒServer 2016å¼•å…¥çš„æ–°åŠŸèƒ½Decvice Guardæ˜¯ä¸€ç§ç™½åå•æœºåˆ¶ï¼Œå¯ç”¨æ¥é˜»æ­¢æœªæˆæƒçš„ä»£ç æ‰§è¡Œã€‚</p>

<p>ç®€å•çš„ç†è§£ï¼Œåªè¦æ˜¯ä¸åŒ…å«å¾®è½¯æ•°å­—ç­¾åçš„ç¨‹åºï¼Œå‡æ— æ³•ç”¨æ¥æ‰§è¡Œä»£ç ã€‚</p>

<p>ç„¶è€Œï¼Œå¦‚æœèƒ½å¤Ÿæ‰¾åˆ°å¸¦æœ‰å¾®è½¯ç­¾åçš„ç¨‹åºï¼Œé‚£ä¹ˆå°±èƒ½ç»•è¿‡Decvice Guardå¯¹åº”ç”¨ç¨‹åºçš„æ‹¦æˆªï¼Œå®ç°ä»£ç æ‰§è¡Œã€‚</p>

<p>ç›®å‰å·²çŸ¥çš„æ–¹æ³•æœ‰ï¼š</p>

<p><strong>1ã€WinDbg/CDB</strong></p>

<p>å¯ç”¨æ¥æ‰§è¡Œshell code</p>

<p>ä½œè€…ï¼šMatt Graeber@mattifestation</p>

<p>åœ°å€ï¼šhttp://www.exploit-monday.com/2016/08/windbg-cdb-shellcode-runner.html</p>

<p><strong>2ã€CSI.exe</strong></p>

<p>å¯ç”¨æ¥æ‰§è¡Œc#ä»£ç </p>

<p>ä½œè€…ï¼šCasey Smith@subTee</p>

<p>åœ°å€ï¼šhttps://twitter.com/subTee/status/796737674954608641</p>

<p><strong>3ã€dnx.exe</strong></p>

<p>å¯ç”¨æ¥æ‰§è¡Œc#ä»£ç </p>

<p>ä½œè€…ï¼šMatt Nelson@enigma0x3</p>

<p>åœ°å€ï¼šhttps://enigma0x3.net/2016/11/17/bypassing-application-whitelisting-by-using-dnx-exe/</p>

<p><strong>4ã€rcsi.exe</strong></p>

<p>å¯ç”¨æ¥æ‰§è¡Œc#ä»£ç </p>

<p>ä½œè€…ï¼šMatt Nelson@enigma0x3</p>

<p>åœ°å€ï¼šhttps://enigma0x3.net/2016/11/21/bypassing-application-whitelisting-by-using-rcsi-exe/</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>Matt Nelson@enigma0x3åœ¨æœ€è¿‘åˆ†äº«äº†ä»–ç»•è¿‡Decvice Guardçš„ä¸¤ç§æ–¹æ³•ï¼Œè¿™æ˜¯ç»§Matt Graeber@mattifestationå’ŒCasey Smith@subTeeåçš„ç¬¬ä¸‰å’Œç¬¬å››ç§ç»•è¿‡æ–¹æ³•ï¼Œæœ¬æ–‡å°†é‡ç°è¿™ä¸¤ä¸ªè¿‡ç¨‹ï¼Œå®Œæˆä»–ç•™ç»™è¯»è€…çš„ä¸¤ä¸ªä½œä¸šï¼Œä¼˜åŒ–dnx.exeçš„ç¯å¢ƒæ­å»ºæ­¥éª¤ï¼Œåˆ†äº«å­¦ä¹ å¿ƒå¾—ã€‚</p>

<p><strong>é“¾æ¥å¦‚ä¸‹ï¼š</strong></p>

<p>https://enigma0x3.net/2016/11/17/bypassing-application-whitelisting-by-using-dnx-exe/</p>

<p>https://enigma0x3.net/2016/11/21/bypassing-application-whitelisting-by-using-rcsi-exe/</p>

<h2 id="0x02-dnxexe">0x02 dnx.exe</h2>
<hr />

<p>dnx.exeå†…ç½®äº.NET Execution environmentï¼ŒåŒ…å«æ•°å­—ç­¾åï¼Œå¯ç”¨æ¥æ‰§è¡Œc#ä»£ç </p>

<p>é¦–å…ˆæ­å»ºdnx.exeçš„ä½¿ç”¨ç¯å¢ƒ</p>

<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p>

<p>https://blogs.msdn.microsoft.com/sujitdmello/2015/04/23/step-by-step-installation-instructions-for-getting-dnx-on-your-windows-machine/</p>

<p>èµ„æ–™æ˜¾ç¤ºéœ€è¦powershell v4.0å’Œå®‰è£…Visual C++ 2013 redistributable packageï¼Œå®é™…æµ‹è¯•â€print helloworldâ€å¹¶ä¸éœ€è¦è¿™äº›æ¡ä»¶ï¼ŒåŒæ—¶é…ç½®æ­¥éª¤ä¹Ÿå¯ä»¥ç®€åŒ–ï¼Œä»¥ä¸‹ä¸ºç®€åŒ–çš„é…ç½®æ­¥éª¤ï¼š</p>

<p>æµ‹è¯•ç³»ç»Ÿï¼šWin8 x86</p>

<h3 id="1ä¸‹è½½å¹¶å®‰è£…microsoft-net-framework-452">1ã€ä¸‹è½½å¹¶å®‰è£…Microsoft .NET Framework 4.5.2ï¼š</h3>

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>https://www.microsoft.com/zh-CN/download/confirmation.aspx?id=42643</p>

<h3 id="2å®‰è£…dnvm">2ã€å®‰è£…DNVM</h3>

<p><strong>cmdï¼š</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>powershell -NoProfile -ExecutionPolicy unrestricted -Command "&amp;{$Branch='â€™'dev';iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/aspnet/Home/dev/dnvminstall.ps1'))}"
</code></pre></div></div>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-1.png" alt="Alt text" /></p>

<h3 id="3å®‰è£…dnx">3ã€å®‰è£…DNX</h3>

<p><code class="language-plaintext highlighter-rouge">æ‰“å¼€æ–°çš„cmd</code></p>

<p><strong>cmdï¼š</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnvm list 
</code></pre></div></div>

<p>è¾“å…¥yï¼Œå®‰è£…dnx</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-2.png" alt="Alt text" /></p>

<p><strong>cmd:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnvm install latest -Unstable -Persistent
</code></pre></div></div>

<p><strong>cmd:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnx
</code></pre></div></div>

<p>å°†ä¼šçœ‹åˆ°dnxçš„æ“ä½œè¯´æ˜</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-3.png" alt="Alt text" /></p>

<h3 id="4æ›´æ–°dnxå’Œdnvm-bits">4ã€æ›´æ–°DNXå’ŒDNVM bits</h3>

<p><strong>cmd:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnvm upgrade
dnvm update-self
</code></pre></div></div>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-4.png" alt="Alt text" /></p>

<h3 id="5é…ç½®package">5ã€é…ç½®Package</h3>

<p><code class="language-plaintext highlighter-rouge">æ–°å»ºæ–‡ä»¶å¤¹test</code></p>

<p><strong>cmdï¼š</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd c:\test
dnu restore -s https://www.myget.org/F/aspnetvnext
</code></pre></div></div>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-5.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">C:\Windows\System32</code>ç›´æ¥è¾“å…¥<code class="language-plaintext highlighter-rouge">dnu restore -s https://www.myget.org/F/aspnetvnext</code>ä¼šæŠ¥é”™ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-6.png" alt="Alt text" /></p>

<h3 id="6æ·»åŠ è„šæœ¬æ–‡ä»¶">6ã€æ·»åŠ è„šæœ¬æ–‡ä»¶</h3>

<p>æ–°å»ºæ–‡ä»¶Program.csï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
public class Program
{
    public static void Main()
    {
        Console.WriteLine("Hello World");
    }
}
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>classåå¿…é¡»ä¸ºProgramï¼Œå¦åˆ™æŠ¥é”™</p>

<p>æ–°å»ºæ–‡ä»¶project.jsonï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "dependencies":{

    },
    "commands":{
        "test":"test"
    },
    "frameworks":{
        "dnx451":{},
        "dnxcore50":{
            "dependencies":{
                "System.Console":"4.0.0-beta-*"
            }
        }
    }
}
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>project.jsonä¸­â€commandsâ€å†…çš„â€testâ€éœ€è¦åŒæ–‡ä»¶å¤¹åç§°testå¯¹åº”</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä¸­æ–‡ç³»ç»Ÿçš„æµè§ˆå™¨å¤åˆ¶https://blogs.msdn.microsoft.com/sujitdmello/2015/04/23/step-by-step-installation-instructions-for-getting-dnx-on-your-windows-machine/ä¸­çš„ç¤ºä¾‹ä»£ç ä¸ºunicodeæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨ä¼šæŠ¥é”™ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-7.png" alt="Alt text" /></p>

<p>éœ€è¦å°†å…¶ä¸­çš„Unicodeå­—ç¬¦è½¬åŒ–</p>

<h3 id="7æµ‹è¯•è„šæœ¬">7ã€æµ‹è¯•è„šæœ¬</h3>

<p><strong>cmd:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnu restore 
</code></pre></div></div>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-8.png" alt="Alt text" /></p>

<p><strong>cmd:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnx test
</code></pre></div></div>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/1-9.png" alt="Alt text" /></p>

<p><strong>æ³¨:</strong></p>

<p>å¦‚æœä»…æµ‹è¯•ä¸Šè¿°ä»£ç ï¼Œåªéœ€å®Œæˆæ­¥éª¤3å³å¯</p>

<h3 id="8win10-device-guardæµ‹è¯•">8ã€Win10 Device Guardæµ‹è¯•</h3>

<p>dnx.exeæµ‹è¯•æˆåŠŸåï¼Œæ¥ä¸‹æ¥éœ€è¦æ‰¾åˆ°dnx.exeåœ¨Win10ä¸Šä½¿ç”¨éœ€è¦åŒ…å«å“ªäº›æ”¯æŒæ–‡ä»¶ï¼Œæœ€ç›´è§‚çš„æ–¹æ³•å¯å€ŸåŠ©äºProcessMonitor</p>

<p>ä½¿ç”¨ProcessMonitorè·å–dnx.exeåœ¨è¿è¡Œæ—¶çš„æ“ä½œï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/2-1.png" alt="Alt text" /></p>

<p>æ‰¾åˆ°å…³é”®ç›®å½•ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">C:\Users\a\.dnx\runtimes\dnx-clr-win-x86.1.0.0-rc1-update2\bin\</code></p>

<p>ç»å®é™…æµ‹è¯•ï¼Œåœ¨Win10ä¸Šä½¿ç”¨ï¼Œåªéœ€è¦è¯¥ç›®å½•ä¸‹çš„éƒ¨åˆ†æ–‡ä»¶ï¼Œå¤§å°ä¸º<code class="language-plaintext highlighter-rouge">7.44MB</code></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¿™æ˜¯Matt Nelson@enigma0x3ç•™ç»™è¯»è€…çš„ä½œä¸š</p>

<p>æ–‡ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼š</p>

<ul>
  <li>dnx.clr.dll</li>
  <li>dnx.exe</li>
  <li>dnx.onecore.dll</li>
  <li>Microsoft.CodeAnalysis.CSharp.dll</li>
  <li>Microsoft.CodeAnalysis.dll</li>
  <li>Microsoft.Dnx.ApplicationHost.dll</li>
  <li>Microsoft.Dnx.Compilation.Abstractions.dll</li>
  <li>Microsoft.Dnx.Compilation.CSharp.Abstractions.dll</li>
  <li>Microsoft.Dnx.Compilation.CSharp.Common.dll</li>
  <li>Microsoft.Dnx.Compilation.CSharp.dll</li>
  <li>Microsoft.Dnx.Compilation.dll</li>
  <li>Microsoft.Dnx.Host.Clr.dll</li>
  <li>Microsoft.Dnx.Host.dll</li>
  <li>Microsoft.Dnx.Loader.dll</li>
  <li>Microsoft.Dnx.Runtime.dll</li>
  <li>Microsoft.Extensions.PlatformAbstractions.dll</li>
  <li>System.Collections.Immutable.dll</li>
  <li>System.Reflection.Metadata.dll</li>
  <li>vcruntime140.dll(ä¹Ÿå¯å¿½ç•¥ï¼Œä½†ä¼šæŠ¥é”™ï¼Œä¸å½±å“ä»£ç æ‰§è¡Œ)</li>
</ul>

<p>è¯¥ç›®å½•ä¸‹çš„è¿™äº›æ–‡ä»¶ä¸éœ€è¦ï¼š</p>

<ul>
  <li>dnu.cmd</li>
  <li>dnx.win32.dll</li>
  <li>Microsoft.Dnx.Compilation.DesignTime.dll</li>
  <li>Microsoft.Dnx.DesignTimeHost.Abstractions.dll</li>
  <li>Microsoft.Dnx.dll</li>
  <li>Microsoft.Dnx.Host.Mono.dll</li>
  <li>Microsoft.Dnx.Runtime.Internals.dll</li>
</ul>

<p>å¦‚å›¾ï¼Œç”±äºdnx.exeåŒ…å«å¾®è½¯çš„ç­¾åè¯ä¹¦ï¼Œæ‰€ä»¥åœ¨Device Guard UMCI(user mode code integrity)å¼€å¯çš„ç¯å¢ƒä¸­ä»å…·æœ‰æ‰§è¡Œæƒé™</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/2-2.png" alt="Alt text" /></p>

<p>ç»•è¿‡æˆåŠŸ</p>

<h2 id="0x03-rcsiexe">0x03 rcsi.exe</h2>
<hr />

<p>rcsi.exeå†…ç½®äºMicrosoft â€œRoslynâ€ CTPä¸­ï¼ŒåŒ…å«å¾®è½¯æ•°å­—ç­¾å</p>

<p>Microsoft â€œRoslynâ€ CTPä¸‹è½½åœ°å€ï¼š
https://www.microsoft.com/en-us/download/details.aspx?id=34685&amp;tduid=(24d3dfde6075d394de05e49e871fa656)(256380)(2459594)(TnL5HPStwNw-qGm27mnsJb9VbqZPmTLajQ)()</p>

<p>å®‰è£…å‰æï¼š</p>
<ul>
  <li>å®‰è£…Visual Studio 2012</li>
  <li>å®‰è£…VS2012 SDK</li>
</ul>

<h3 id="1å®é™…æµ‹è¯•">1ã€å®é™…æµ‹è¯•</h3>
<p>æµ‹è¯•ç³»ç»Ÿï¼šWin8.1 x86
å®‰è£…Visual Studio 2012ã€VS2012 SDKã€Microsoft â€œRoslynâ€ CTP</p>

<h3 id="2æ‰§è¡Œä»£ç ">2ã€æ‰§è¡Œä»£ç </h3>
<p>rcsi.exeçš„è·¯å¾„ä¸ºï¼š</p>

<p><code class="language-plaintext highlighter-rouge">C:\Program Files\Microsoft Roslyn CTP\Binaries</code></p>

<p>æ–°å»ºæ–‡ä»¶test.csxï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
Console.WriteLine("Hello World");
Console.ReadLine();
</code></pre></div></div>

<p><strong>cmd:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"C:\Program Files\Microsoft Roslyn CTP\Binaries\rcsi.exe" test.csx
</code></pre></div></div>

<p>å¦‚å›¾ï¼ŒæˆåŠŸæ‰§è¡ŒC#ä»£ç </p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/3-1.png" alt="Alt text" /></p>

<p>rcsi.exeåŒcsi.exeç±»ä¼¼ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œc#ä»£ç ï¼Œä¸åŒç‚¹åœ¨äºcsi.exeæ”¯æŒäº¤äº’ï¼Œè€Œrcsi.exeä¸èƒ½</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/3-2.png" alt="Alt text" /></p>

<h3 id="3win10-device-guardæµ‹è¯•">3ã€Win10 Device Guardæµ‹è¯•</h3>

<p>rcsi.exeåœ¨Win10ä¸Šè¿è¡ŒåŒæ ·éœ€è¦æ”¯æŒæ–‡ä»¶
åŒæ ·ä½¿ç”¨ProcessMonitorè·å–rcsi.exeåœ¨è¿è¡Œæ—¶çš„æ“ä½œï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/3-3.png" alt="Alt text" /></p>

<p>æ‰¾åˆ°rcsi.exeéœ€è¦çš„æ”¯æŒæ–‡ä»¶å¦‚ä¸‹ï¼š</p>

<ul>
  <li>C:\Windows\Microsoft.NET\assembly\GAC_MSIL\Roslyn.Compilers.CSharp\v4.0_1.2.0.0__31bf3856ad364e35\Roslyn.Compilers.CSharp.dll</li>
  <li>C:\Windows\Microsoft.NET\assembly\GAC_MSIL\Roslyn.Compilers\v4.0_1.2.0.0__31bf3856ad364e35\Roslyn.Compilers.dll</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¿™ä¹Ÿæ˜¯Matt Nelson@enigma0x3ç•™ç»™è¯»è€…çš„ä½œä¸š</p>

<p>åœ¨Win10ä¸‹æµ‹è¯•æˆåŠŸï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-25/3-4.png" alt="Alt text" /></p>

<h2 id="0x04-é˜²å¾¡">0x04 é˜²å¾¡</h2>
<hr />

<p>å‚ç…§Matt Graeberçš„æ–¹æ³•ï¼Œæ›´æ–°Device Guard Bypass Mitigation Rulesï¼Œå¯åˆ†åˆ«æ‹¦æˆªåˆ©ç”¨WinDbg/CDBã€csi.exeã€dnx.exeå’Œrcsi.exeçš„ä»£ç æ‰§è¡Œ</p>

<p>å‚è€ƒåœ°å€å¦‚ä¸‹ï¼š</p>

<p>http://www.exploit-monday.com/2016/09/using-device-guard-to-mitigate-against.html</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡å¯¹dnx.exeå’Œrcsi.exeçš„åˆ©ç”¨æ–¹æ³•åšäº†ä»‹ç»ï¼Œæˆªè‡³ç›®å‰å…±æœ‰å››ç§ç»•è¿‡Device Guardçš„æ–¹æ³•ï¼Œç›¸ä¿¡æœªæ¥ä¼šæœ‰æ›´å¤šçš„æ–¹æ³•è¢«å‘ç°ï¼Œä¸æ­¤åŒæ—¶ï¼Œé˜²å¾¡æ‰‹æ®µä¹Ÿéœ€è¦éšä¹‹å‡çº§ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET