I"Ô+<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Pass-the-Hash-with-Remote-Desktop(Restricted-Admin-mode)">ã€Šæ¸—é€æŠ€å·§â€”â€”Pass the Hash with Remote Desktop(Restricted Admin mode)ã€‹</a>ä»‹ç»äº†ç‰¹å®šæ¡ä»¶ä¸‹(Serveréœ€è¦å¼€å¯Restricted Admin modeï¼ŒClientéœ€è¦æ”¯æŒRestricted Admin mode)Pass the Hash with Remote Desktopçš„æ–¹æ³•ï¼Œæœ¬æ–‡å°†è¦ä»‹ç»æ›´ä¸ºé€šç”¨çš„æ–¹æ³•ï¼ˆé€šè¿‡NTLM hashç™»å½•RDPï¼‰ï¼Œåˆ†æåŸç†ï¼Œå¼€æºä»£ç ï¼Œè®°å½•ç»†èŠ‚ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>æ¸—é€æµ‹è¯•ä¸­çš„éœ€æ±‚</li>
  <li>éªŒè¯å£ä»¤æˆ–è€…NTLM hashçš„å®ç°æ–¹æ³•</li>
  <li>Cå®ç°ä»£ç </li>
  <li>Pythonå®ç°ä»£ç </li>
  <li>C sharpå®ç°ä»£ç </li>
</ul>

<h2 id="0x02-æ¸—é€æµ‹è¯•ä¸­çš„éœ€æ±‚">0x02 æ¸—é€æµ‹è¯•ä¸­çš„éœ€æ±‚</h2>
<hr />

<p>å¦‚æœæ˜¯å¼€å‘è¿œç¨‹æ¡Œé¢æœåŠ¡çš„å®¢æˆ·ç«¯ï¼Œå¯ä¾›é€‰æ‹©çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚é€šè¿‡C#è°ƒç”¨ActiveXç»„ä»¶AxMSTSCLib</p>

<p>è¯¦ç»†æ–¹æ³•å¯å‚è€ƒï¼šhttps://www.codeproject.com/Articles/43705/Remote-Desktop-using-C-NET</p>

<p>ä½†æ˜¯åœ¨æ¸—é€æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸¤ä¸ªéœ€æ±‚ï¼š</p>

<h4 id="1éªŒè¯å£ä»¤æˆ–è€…hash">1.éªŒè¯å£ä»¤æˆ–è€…hash</h4>

<p>éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>

<ul>
  <li>å¯ä»¥åœ¨Windowså’ŒLinuxç³»ç»Ÿä¸Šè¿è¡Œ</li>
  <li>ç™»å½•æ–¹å¼æ”¯æŒæ˜æ–‡å£ä»¤å’ŒNTLM hash</li>
  <li>å‘½ä»¤è¡Œä¸‹ä½¿ç”¨</li>
</ul>

<h4 id="2è¿œç¨‹ç™»å½•">2.è¿œç¨‹ç™»å½•</h4>

<ul>
  <li>å¯ä»¥åœ¨Windowså’ŒLinuxç³»ç»Ÿä¸Šè¿è¡Œ</li>
  <li>ç™»å½•æ–¹å¼æ”¯æŒæ˜æ–‡å£ä»¤å’ŒNTLM hash</li>
</ul>

<h2 id="0x03-éªŒè¯å£ä»¤æˆ–è€…hashçš„å®ç°æ–¹æ³•">0x03 éªŒè¯å£ä»¤æˆ–è€…hashçš„å®ç°æ–¹æ³•</h2>
<hr />

<p>ä¸ºäº†æ”¯æŒNTLM hashç™»å½•ï¼Œéœ€è¦å¯¹åè®®å’ŒåŠ å¯†æ–¹å¼æœ‰æ‰€äº†è§£</p>

<p>å…³äºRDPåè®®çš„å‚è€ƒèµ„æ–™ï¼šhttps://github.com/FreeRDP/FreeRDP/wiki/Reference-Documentation</p>

<h3 id="1ä½¿ç”¨pythonå®ç°rdp_checkpy">1.ä½¿ç”¨Pythonå®ç°(rdp_check.py)</h3>

<p>ä»£ç åœ°å€ï¼šhttps://github.com/SecureAuthCorp/impacket/blob/master/examples/rdp_check.py</p>

<ul>
  <li>å¯ä»¥åœ¨Windowså’ŒLinuxç³»ç»Ÿä¸Šè¿è¡Œ</li>
  <li>ç™»å½•æ–¹å¼æ”¯æŒæ˜æ–‡å£ä»¤å’ŒNTLM hash</li>
  <li>å‘½ä»¤è¡Œä¸‹ä½¿ç”¨</li>
</ul>

<p>è„šæœ¬è¿è¡Œå‰éœ€è¦å®‰è£…Impacket</p>

<p>å®‰è£…æ–¹æ³•ï¼š<code class="language-plaintext highlighter-rouge">pip install Impacket</code></p>

<p>å¦‚æœæ˜¯åœ¨Windowsç³»ç»Ÿä¸‹ä½¿ç”¨ï¼Œå¯ä»¥å°†Pythonè„šæœ¬è½¬æ¢æˆexeï¼Œç¼–è¯‘å¥½çš„exeæ–‡ä»¶ä¸‹è½½åœ°å€ï¼šhttps://github.com/maaaaz/impacket-examples-windows</p>

<p>ä½¿ç”¨ç¤ºä¾‹ï¼šæ˜æ–‡å£ä»¤éªŒè¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rdp_check.py /administrator:test123@192.168.1.1
</code></pre></div></div>

<p>ä½¿ç”¨ç¤ºä¾‹ï¼šNTLM hashéªŒè¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rdp_check.py /administrator@192.168.1.1 -hashes :c5a237b7e9d8e708d8436b6148a25fa1
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>hashçš„æ ¼å¼ä¸º<code class="language-plaintext highlighter-rouge">LMHASH:NTHASH</code>ï¼Œå¦‚æœåªæœ‰NTLM hashï¼Œæ ¼å¼ä¸º<code class="language-plaintext highlighter-rouge"> :NTHASH</code>ï¼Œéœ€è¦æ³¨æ„<code class="language-plaintext highlighter-rouge">:</code>å‰é¢å­˜åœ¨ä¸€ä¸ªç©ºæ ¼å­—ç¬¦</p>

<h3 id="2ä½¿ç”¨cå®ç°freerdp">2.ä½¿ç”¨Cå®ç°(FreeRDP)</h3>

<p>ä»£ç åœ°å€ï¼šhttps://github.com/FreeRDP</p>

<ul>
  <li>å¯ä»¥åœ¨Windowså’ŒLinuxç³»ç»Ÿä¸Šè¿è¡Œ</li>
  <li>ç™»å½•æ–¹å¼æ”¯æŒæ˜æ–‡å£ä»¤</li>
  <li>å‘½ä»¤è¡Œä¸‹ä½¿ç”¨</li>
</ul>

<p>å¦‚æœä¸ºäº†æ”¯æŒNTLM hashç™»å½•ï¼Œéœ€è¦ä½¿ç”¨æ—§ç‰ˆæœ¬çš„FreeRDPï¼Œä¸‹è½½åœ°å€ï¼šhttps://labs.portcullis.co.uk/download/FreeRDP-pth.tar.gz</p>

<p>å¦‚æœä»…ä»…ä¸ºäº†éªŒè¯å£ä»¤æˆ–è€…hashï¼Œéœ€è¦ä¿®æ”¹ä»£ç ï¼Œå»é™¤åç»­ç™»å½•çš„åŠŸèƒ½</p>

<p>å…³äºFreeRDPçš„ä½¿ç”¨å¯å‚è€ƒï¼šhttps://github.com/FreeRDP/FreeRDP/wiki/CommandLineInterface</p>

<h3 id="3ä½¿ç”¨c-sharpå®ç°sharprdpcheck">3.ä½¿ç”¨C sharpå®ç°(SharpRDPCheck)</h3>

<ul>
  <li>å¯ä»¥åœ¨Windowsç³»ç»Ÿä¸Šè¿è¡Œ</li>
  <li>ç™»å½•æ–¹å¼æ”¯æŒæ˜æ–‡å£ä»¤å’ŒNTLM hash</li>
  <li>å‘½ä»¤è¡Œä¸‹ä½¿ç”¨</li>
</ul>

<p>å¼€å‘è¿‡ç¨‹è®°å½•ï¼š</p>

<p>è¿™é‡Œæ— æ³•é€šè¿‡è°ƒç”¨ActiveXç»„ä»¶AxMSTSCLibå®ç°ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>

<ul>
  <li>ä½¿ç”¨ActiveXç»„ä»¶AxMSTSCLibæ— æ³•é€šè¿‡NTLM hashç™»å½•</li>
  <li>å¯¹å‘½ä»¤è¡Œçš„æ”¯æŒä¸å¤Ÿå‹å¥½</li>
</ul>

<p>æ‰€ä»¥åªèƒ½å‚ç…§<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/rdp_check.py">rdp_check.py</a>çš„æ–¹å¼ï¼Œæ‰‹åŠ¨æ„é€ é€šä¿¡æ•°æ®</p>

<p>ç»è¿‡æœç´¢ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªå¯ä¾›å‚è€ƒçš„ä»£ç ï¼šhttps://github.com/RDPUploader/RDPUploader</p>

<p>RDPUploaderåŒ…æ‹¬ä¸‰ä¸ªå­é¡¹ç›®ï¼Œç¼–è¯‘æˆåŠŸåç”Ÿæˆä¸¤ä¸ªdllå’Œä¸€ä¸ªexeæ–‡ä»¶ï¼Œä¸æ”¯æŒå‘½ä»¤è¡Œæ“ä½œï¼Œä¹Ÿä¸æ”¯æŒNTLM hashç™»å½•ï¼Œä½†å…¶ä¸­çš„é€šä¿¡è¿‡ç¨‹å†™çš„å¾ˆæ¸…æ™°</p>

<p>æ¥ä¸‹æ¥ä»¥RDPUploaderä¸ºæ¨¡æ¿è¿›è¡Œå¼€å‘</p>

<p>è¿™é‡Œå…·ä½“ä»‹ç»ä¸€ä¸‹æ”¯æŒNTLM hashç™»å½•çš„æ–¹æ³•ï¼š</p>

<p>Remote Desktop Protocolåœ¨è¿›è¡ŒéªŒè¯æ—¶ï¼Œå…ˆå°†æ˜æ–‡å£ä»¤è½¬æ¢æˆNTLM hashï¼Œå†è¿›è¡ŒéªŒè¯</p>

<p>æˆ‘ä»¬é¦–å…ˆå¯»æ‰¾RDPUploaderä¸­ä»æ˜æ–‡å£ä»¤è½¬æ¢ä¸ºNTLM hashçš„ä»£ç ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private static byte[] nTOWFv1(string password)
{
    if (password == null)
	{
        throw new Exception("Password parameter is required");
    }

    return MD4.ComputeHash(Encoding.Unicode.GetBytes(password));
}

private static byte[] nTOWFv2(string domain, string username, string password)
{
    HMACT64 hmact = new HMACT64(nTOWFv1(password));
    hmact.update(Encoding.Unicode.GetBytes(username.ToUpper()));
    hmact.update(Encoding.Unicode.GetBytes(domain));
	return hmact.digest();
}
</code></pre></div></div>

<p><strong>è¡¥å……ï¼šNTLM hashçš„ç”Ÿæˆæ–¹æ³•</strong></p>

<ol>
  <li>å°†æ˜æ–‡å£ä»¤è½¬æ¢æˆåå…­è¿›åˆ¶çš„æ ¼å¼</li>
  <li>è½¬æ¢æˆUnicodeæ ¼å¼ï¼Œå³åœ¨æ¯ä¸ªå­—èŠ‚ä¹‹åæ·»åŠ 0x00</li>
  <li>å¯¹Unicodeå­—ç¬¦ä¸²ä½œMD4åŠ å¯†ï¼Œç”Ÿæˆ32ä½çš„åå…­è¿›åˆ¶æ•°å­—ä¸²</li>
</ol>

<p>è¿™é‡Œä»¥æ˜æ–‡å£ä»¤test123ä¸ºä¾‹ï¼š</p>

<p>è½¬æ¢æˆåå…­è¿›åˆ¶çš„æ ¼å¼ä¸º<code class="language-plaintext highlighter-rouge">74657374313233</code></p>

<p>è½¬æ¢æˆUnicodeæ ¼å¼ä¸º<code class="language-plaintext highlighter-rouge">7400650073007400310032003300</code></p>

<p>å¯¹å­—ç¬¦ä¸²<code class="language-plaintext highlighter-rouge">7400650073007400310032003300</code>ä½œMD4åŠ å¯†ï¼Œç»“æœä¸º<code class="language-plaintext highlighter-rouge">c5a237b7e9d8e708d8436b6148a25fa1</code></p>

<p>æ›´å¤šç»†èŠ‚å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-NTLM-hash%E5%92%8CNet-NTLM-hash%E4%BB%8B%E7%BB%8D">ã€ŠWindowsä¸‹çš„å¯†ç hashâ€”â€”NTLM hashå’ŒNet-NTLM hashä»‹ç»ã€‹</a></p>

<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†<code class="language-plaintext highlighter-rouge">nTOWFv1(password)</code>çš„ç»“æœè¾“å‡ºï¼ŒéªŒè¯NTLM hashçš„ç”Ÿæˆæ–¹æ³•æ˜¯å¦å‡†ç¡®ï¼Œä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private static byte[] nTOWFv2(string domain, string username, string password)
{

    byte[] a = nTOWFv1(password);
    string text = "";
    for (int i = 0; i &lt; a.Length; i++)
    {
        text += a[i].ToString("X2");
    }
    Console.WriteLine(text);
    HMACT64 hmact = new HMACT64(a);
    hmact.update(Encoding.Unicode.GetBytes(username.ToUpper()));
    hmact.update(Encoding.Unicode.GetBytes(domain));
	return hmact.digest();
}
</code></pre></div></div>

<p>è¾“å‡ºçš„å­—ç¬¦ä¸²ä¸º<code class="language-plaintext highlighter-rouge">C5A237B7E9D8E708D8436B6148A25FA1</code>ï¼ŒéªŒè¯æˆåŠŸ</p>

<p>æ¥ä¸‹æ¥ï¼Œç›´æ¥ä¼ å…¥å­—ç¬¦ä¸²<code class="language-plaintext highlighter-rouge">C5A237B7E9D8E708D8436B6148A25FA1</code>è¿›è¡ŒéªŒè¯</p>

<p>è¿™é‡Œéœ€è¦å°†hexæ ¼å¼çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºbyte[]ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static byte[] ConvertHexStringToBytes(string hexString)
{
    hexString = hexString.Replace(" ", "");
    if (hexString.Length % 2 != 0)
    {
        throw new ArgumentException("wrong length of ntlm hash");
    }
	byte[] returnBytes = new byte[hexString.Length / 2];
    for (int i = 0; i &lt; returnBytes.Length; i++)
    {
        returnBytes[i] = Convert.ToByte(hexString.Substring(i * 2, 2), 16);
    }
	return returnBytes;
 }

private static byte[] nTOWFv2(string domain, string username, string password)
{
    string text = "C5A237B7E9D8E708D8436B6148A25FA1";
	byte[] byteArray = ConvertHexStringToBytes(text);
    HMACT64 hmact = new HMACT64(byteArray);
    hmact.update(Encoding.Unicode.GetBytes(username.ToUpper()));
    hmact.update(Encoding.Unicode.GetBytes(domain));
	return hmact.digest();
}
</code></pre></div></div>

<p>éªŒè¯æˆåŠŸï¼Œæœ€åå°†å›ºå®šå­—ç¬¦ä¸²ä¿®æ”¹ä¸ºå˜é‡ä¼ é€’å³å¯å®ç°å¯¹NTLM hashç™»å½•çš„æ”¯æŒ</p>

<p>å®Œæ•´ä»£ç å·²å¼€æºï¼Œåœ°å€å¦‚ä¸‹ï¼šhttps://github.com/3gstudent/SharpRDPCheck/</p>

<p>å¯é€šè¿‡Visual Studioè¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘çš„ç›®æ ‡æ¡†æ¶æ¨èä½¿ç”¨.NET Framework 4.6ï¼Œè¿™æ˜¯ä¸ºäº†ä½¿ç”¨TLSv1.2</p>

<p>å¦åˆ™ä¼šä½¿ç”¨TLSv1.0ï¼Œåœ¨è¿›è¡Œç™»å½•æ—¶ä¼šå¤±è´¥ï¼Œæç¤ºå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[!] Authentication Error (The decryption operation failed, see inner exception.)

InnerException: System.ComponentModel.Win32Exception (0x80004005): The Local Sec
urity Authority cannot be contacted
</code></pre></div></div>

<p>å‚è€ƒèµ„æ–™ï¼šhttps://docs.microsoft.com/en-us/dotnet/api/system.net.security.sslstream.authenticateasclient?redirectedfrom=MSDN&amp;view=netframework-4.8</p>

<p>ç¼–è¯‘æˆåŠŸååœ¨å®‰è£….NET Framework 4çš„Windowsç³»ç»Ÿä¸‹éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨</p>

<h2 id="0x04-é˜²å¾¡æ€è·¯">0x04 é˜²å¾¡æ€è·¯</h2>
<hr />

<p>å¯¹äºRDPçš„çˆ†ç ´æ”»å‡»ï¼Œå¯ä»¥é€‰æ‹©æé«˜ç”¨æˆ·å£ä»¤çš„å¼ºåº¦</p>

<p>å¯¹äºçˆ†ç ´è¡Œä¸ºçš„æ£€æµ‹ï¼Œå¯ä»¥é€šè¿‡cmdæŸ¥çœ‹å…¶ä»–ç”¨æˆ·é€šè¿‡RDPç™»å½•å½“å‰ç³»ç»Ÿçš„æ—¥å¿—ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wevtutil gli "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational"
wevtutil qe /f:text "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational"
</code></pre></div></div>

<p>æ¯å½“Listener RDP-Tcpæ”¶åˆ°ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œå°†äº§ç”ŸEventIDä¸º261çš„æ—¥å¿—</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æ”¶åˆ°äº†RDPçš„è¿æ¥è¯·æ±‚ï¼Œæ— è®ºè¿æ¥æ˜¯å¦æˆåŠŸï¼Œå‡ä¼šäº§ç”ŸEventIDä¸º261çš„æ—¥å¿—</p>

<p>é€šè¿‡PowershellæŸ¥çœ‹å…¶ä»–ç”¨æˆ·é€šè¿‡RDPç™»å½•å½“å‰ç³»ç»Ÿçš„æ—¥å¿—ï¼š</p>

<p>https://gallery.technet.microsoft.com/Remote-Desktop-Connection-3fe225cd</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†é’ˆå¯¹Remote Desktop Protocolï¼ŒéªŒè¯å£ä»¤æˆ–è€…NTLM hashçš„å®ç°æ–¹æ³•ï¼Œå¼€æºä»£ç SharpRDPCheckï¼Œåˆ†äº«ç¨‹åºå®ç°NTLM hashç™»å½•çš„ç»†èŠ‚ï¼Œæœ€åä»‹ç»é€šè¿‡æ—¥å¿—æ£€æµ‹RDPçˆ†ç ´è¡Œä¸ºçš„æ–¹æ³•ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET