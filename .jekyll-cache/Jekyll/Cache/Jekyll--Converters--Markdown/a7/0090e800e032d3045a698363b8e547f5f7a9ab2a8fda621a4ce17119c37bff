I"ã<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/Powershell-tricks-Hide-Process-by-kd.exe/">ã€ŠPowershell tricks::Hide Process by kd.exeã€‹</a>ä»‹ç»è¿‡é€šè¿‡kd.exeéšè—è¿›ç¨‹çš„æŠ€å·§ï¼Œæœ€å¤§çš„ç¼ºç‚¹æ˜¯éœ€è¦å¼€å¯Local kernel debuggingæ¨¡å¼ï¼Œç­‰å¾…é‡å¯æ‰èƒ½ç”Ÿæ•ˆ
è¿™æ¬¡ä»‹ç»å¦å¤–ä¸€ä¸ªéšè—è¿›ç¨‹çš„æ–¹æ³•â€”â€”åˆ©ç”¨global API hooks
ä¼˜ç‚¹æ˜¯å³æ—¶ç”Ÿæ•ˆï¼Œä¸éœ€è¦ç­‰å¾…ç³»ç»Ÿé‡å¯</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦å‚ç…§Sergey Podobryçš„æ–‡ç« ï¼Œå¯¹è¯¥æ–¹æ³•è¿›è¡Œä»‹ç»ï¼Œåˆ†æå®é™…æµ‹è¯•ä¸­éœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼Œå¹¶è¡¥å…¨åœ¨64ä½ä¸‹å…·ä½“çš„å‚æ•°è®¾ç½®</p>

<p><strong>å‚è€ƒé“¾æ¥ï¼š</strong></p>

<p>https://www.codeproject.com/articles/49319/easy-way-to-set-up-global-api-hooks?display=print</p>

<p>https://github.com/subTee/AppInitGlobalHooks-Mimikatz</p>

<h2 id="0x02-åŸç†">0x02 åŸç†</h2>
<hr />

<p>åœ¨ç”¨æˆ·å±‚ï¼Œé€šè¿‡global API hookså°†æµ‹è¯•dllæ³¨å…¥åˆ°ç³»ç»Ÿçš„æ‰€æœ‰è¿›ç¨‹ï¼Œå®ç°å¯¹æŒ‡å®šè¿›ç¨‹çš„éšè—</p>

<h3 id="hookæ–¹å¼">hookæ–¹å¼</h3>

<p>ä¿®æ”¹æ³¨å†Œè¡¨é”®å€¼AppInit_DLLs</p>

<p><strong>ä½ç½®ï¼š</strong></p>

<p><code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows</code></p>

<p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p>

<p><strong>LoadAppInit_DLLs:</strong></p>

<p>(REG_DWORD)	Value that globally enables or disables AppInit_DLLs.</p>
<ul>
  <li>0x0 â€“ AppInit_DLLs are disabled.</li>
  <li>0x1 â€“ AppInit_DLLs are enabled.</li>
</ul>

<p><strong>AppInit_DLLs:</strong></p>

<p>(REG_SZ)
Space - or comma -separated list of DLLs to load. The complete path to the DLL should be specified using short file names.	C:\PROGRA~1\Test\Test.dll</p>

<p><strong>RequireSignedAppInit_DLLs:</strong></p>

<p>(REG_DWORD)	Require code-signed DLLs.</p>

<ul>
  <li>0x0 â€“ Load any DLLs.</li>
  <li>0x1 â€“ Load only code-signed DLLs.</li>
</ul>

<h3 id="ä»£ç å®ç°">ä»£ç å®ç°</h3>

<p>é€šè¿‡Mhook libraryå®ç°API hooking</p>

<p><strong>ä¼˜ç‚¹ï¼š</strong></p>

<ul>
  <li>å¼€æº</li>
  <li>æ”¯æŒx86å’Œx64</li>
  <li>ä½¿ç”¨ç®€ä¾¿</li>
</ul>

<p><strong>å‚è€ƒåœ°å€ï¼š</strong></p>

<p>http://codefromthe70s.org/mhook22.aspx</p>

<h2 id="0x03-å®é™…æµ‹è¯•">0x03 å®é™…æµ‹è¯•</h2>
<hr />

<p><strong>æµ‹è¯•ç¯å¢ƒï¼š</strong></p>

<p>Win7x86</p>

<h3 id="1è®¾ç½®æ³¨å†Œè¡¨é”®å€¼appinit_dlls">1.è®¾ç½®æ³¨å†Œè¡¨é”®å€¼AppInit_DLLs</h3>

<p><strong>å‚ç…§ä»£ç ï¼š</strong></p>

<p>https://github.com/subTee/AppInitGlobalHooks-Mimikatz/blob/master/AppInit.reg</p>

<p>.regæ–‡ä»¶å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows]
"AppInit_DLLs"="C:\\Tools\\AppInitHookx64.dll,C:\\Tools\\AppInitHook.dll"
"LoadAppInit_DLLs"=dword:00000001
"RequireSignedAppInit_DLLs"=dword:00000000
</code></pre></div></div>

<p>è¡¨ç¤º</p>

<ul>
  <li>AppInit_DLLs are enabled</li>
  <li>Load any DLLsï¼Œdo not need code-signed DLLs</li>
  <li>DLL pathï¼šC:\Tools\AppInitHookx64.dll,C:\Tools\AppInitHook.dll</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>è®¾ç½®çš„è·¯å¾„ä¸èƒ½å­˜åœ¨ç©ºæ ¼ï¼Œå¦åˆ™å¤±æ•ˆ</p>

<h3 id="2ç¼–è¯‘ç”Ÿæˆappinithookdllå¹¶æ”¾åœ¨ctoolsä¸‹">2.ç¼–è¯‘ç”ŸæˆAppInitHook.dllå¹¶æ”¾åœ¨C:\Toolsä¸‹</h3>

<p>å‚ç…§å·¥ç¨‹ï¼š</p>

<p>https://github.com/subTee/AppInitGlobalHooks-Mimikatz</p>

<h3 id="3è¿è¡Œmimikatzexe">3.è¿è¡Œmimikatz.exe</h3>

<p>ä»»åŠ¡ç®¡ç†å™¨è¿›ç¨‹åˆ—è¡¨ä¸å­˜åœ¨mimikatz.exe</p>

<p>Process Explorerä¸å­˜åœ¨mimikatz.exe</p>

<p>Tasklist.exeä¸å­˜åœ¨mimikatz.exe</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ­¤å¤„æ²¡æœ‰å®Œå…¨éšè—è¿›ç¨‹ï¼Œæ˜¯å°†è¿›ç¨‹åè®¾ç½®ä¸ºconhost.exeï¼Œè¿™æ˜¯å› ä¸ºmimikatzæ˜¯æ§åˆ¶å°åº”ç”¨ç¨‹åº</p>

<p>å¦‚æœæ¢æˆputty.exeæˆ–calc.exeè¿™ç§Win32é¡¹ç›®ï¼Œåˆ™ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œèƒ½å¤Ÿå®Œå…¨éšè—è¿›ç¨‹</p>

<p>ä½¿ç”¨Process ExploreræŸ¥çœ‹æ–°å»ºçš„è¿›ç¨‹ï¼Œå‡åŠ è½½äº†AppInitHook.dllï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-11/2-1.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ç®¡ç†å‘˜æƒé™è¿è¡ŒProcess Explorerï¼Œå¯æŸ¥çœ‹é«˜æƒé™è¿›ç¨‹åŠ è½½çš„dll</p>

<h3 id="4win7x64æµ‹è¯•">4.Win7x64æµ‹è¯•</h3>

<p>64ä½ç³»ç»ŸåŒ32ä½ç³»ç»Ÿçš„åŒºåˆ«åœ¨æ³¨å†Œè¡¨ä¹Ÿæœ‰æ‰€ä½“ç°</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¦æƒ…å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ã€Šå…³äº32ä½ç¨‹åºåœ¨64ä½ç³»ç»Ÿä¸‹è¿è¡Œä¸­éœ€è¦æ³¨æ„çš„é‡å®šå‘é—®é¢˜ã€‹</p>

<p>64ä½ç¨‹åºå¯¹åº”æ³¨å†Œè¡¨ä½ç½®ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\</code></p>

<p>32ä½ç¨‹åºå¯¹åº”æ³¨å†Œè¡¨ä½ç½®ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\</code></p>

<p>æ‰€ä»¥ï¼Œå¦‚æœè¦hook 64ä½ç³»ç»Ÿä¸‹çš„æ‰€æœ‰è¿›ç¨‹(32ä½å’Œ64ä½)ï¼Œéœ€è¦ä¿®æ”¹ä¸¤å¤„æ³¨å†Œè¡¨é”®å€¼</p>

<p>64ä½çš„æ³¨å†Œè¡¨é”®å€¼ä½ç½®ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\Windows]</code></p>

<p>32ä½çš„æ³¨å†Œè¡¨é”®å€¼ä½ç½®ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">[HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows]</code></p>

<p>å…·ä½“ä¿®æ”¹ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/AppInitGlobalHooks-Mimikatz/blob/master/AppInit64.reg</p>

<p>ä¿®æ”¹åä½¿ç”¨Process ExploreræŸ¥çœ‹å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-11/2-2.png" alt="Alt text" /></p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-11/2-3.png" alt="Alt text" /></p>

<p>æˆåŠŸæ³¨å…¥32ä½å’Œ64ä½è¿›ç¨‹</p>

<h2 id="0x04-è¡¥å……">0x04 è¡¥å……</h2>
<hr />

<p>è¯¥æ–¹æ³•åªæ”¯æŒWin7 å’Œ Windows Server 2008 R2ï¼Œä¸æ”¯æŒæ›´é«˜ç‰ˆæœ¬å¦‚Win8ã€Server2012</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-11/2-4.png" alt="Alt text" /></p>

<p>å¦‚ä¸Šå›¾ï¼Œåœ¨Win8ç³»ç»Ÿï¼Œè™½ç„¶æˆåŠŸåŠ è½½AppInitHook.dllï¼Œä½†æ˜¯æ— æ³•éšè—è¿›ç¨‹</p>

<p><strong>åŸå› å¦‚ä¸‹ï¼š</strong></p>

<p>ä»Win8ç³»ç»Ÿå¼€å§‹ï¼Œå¾®è½¯å¯¹AppInit_DLLsåšäº†é™åˆ¶ï¼šbiosä¸­é»˜è®¤å¼€å¯çš„secure bootå°†ä¼šç¦ç”¨AppInit_DLLsï¼Œä½¿å…¶å¤±æ•ˆ</p>

<p>è¯¦æƒ…å¯å‚ç…§ï¼š</p>

<p>https://msdn.microsoft.com/en-us/library/windows/desktop/dn280412(v=vs.85).aspx</p>

<h2 id="0x05-é˜²å¾¡">0x05 é˜²å¾¡</h2>
<hr />

<p>åªé’ˆå¯¹Win7 å’Œ Windows Server 2008 R2åŠä»¥ä¸‹ç³»ç»Ÿ</p>

<p><strong>1.æŸ¥çœ‹æ³¨å†Œè¡¨é”®å€¼</strong></p>

<p><code class="language-plaintext highlighter-rouge">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\Windows]</code></p>

<p><code class="language-plaintext highlighter-rouge">[HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows]</code></p>

<p>AppInit_DLLsé¡¹æœ‰æ— å¯ç–‘dllè·¯å¾„</p>

<p><strong>2.é€šè¿‡Process ExploreræŸ¥çœ‹è¿›ç¨‹æœ‰æ— åŠ è½½å¯ç–‘çš„dll</strong></p>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡å¯¹åˆ©ç”¨global API hooksåœ¨Win7ç³»ç»Ÿä¸‹éšè—è¿›ç¨‹çš„æ–¹æ³•åšäº†ä»‹ç»ï¼Œç»“åˆåˆ©ç”¨æ€è·¯ï¼Œå¸®åŠ©å¤§å®¶å¯¹è¿™ç§åˆ©ç”¨æ–¹å¼è¿›è¡Œæ›´å¥½çš„é˜²å¾¡</p>

<p>å½“ç„¶ï¼Œåˆ©ç”¨global API hooksèƒ½åšçš„è¿˜æœ‰æ›´å¤š</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>
:ET