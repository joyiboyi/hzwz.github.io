I"Î8<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />
<p>ä¹‹å‰æˆ‘åœ¨ç ”ç©¶â€Use SCT to Bypass Application Whitelisting Protectionâ€çš„æ—¶å€™æ›¾æœ‰è¿‡ä¸€ä¸ªæƒ³æ³•ï¼šåœ¨æ‰§è¡Œregsvr32å‘½ä»¤æ³¨å†ŒCOMç»„ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨æ³¨å†Œè¡¨HKEY_CLASSES_ROOT\CLSID\ä¸‹ä¼šåŒæ­¥åˆ›å»ºCOMç»„ä»¶çš„é”®å€¼ï¼Œå¹¶ä¸”classidçš„å­é¡¹InprocServer32ä¸‹ä¼šåŒ…å«scrobj.dllçš„ç»å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆå¦‚æœä¿®æ”¹äº†å­é¡¹InprocServer32çš„é”®å€¼ï¼Œèƒ½å¦å®ç°å¯¹æŸäº›æ“ä½œçš„åŠ«æŒï¼Ÿ</p>

<p>ç„¶è€Œå®é™…ä¿®æ”¹HKCR\CLSID\ä¸‹çš„é”®å€¼éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œå› æ­¤æ²¡æœ‰å¯¹è¿™ä¸ªæƒ³æ³•æ·±å…¥ç ”ç©¶ã€‚ç›´åˆ°æœ€è¿‘ï¼ŒMatt Nelson@enigma0x3çš„åšå®¢ç»™äº†æˆ‘æ–°çš„æ€è·¯ï¼Œåªéœ€è¦æ™®é€šç”¨æˆ·æƒé™å°±å¯ä»¥å®ç°å¯¹é«˜æƒé™ç³»ç»Ÿæ³¨å†Œè¡¨é”®å€¼çš„åŠ«æŒï¼Œè®©æˆ‘å¯¹userland registry hijackingæœ‰äº†æ–°çš„è®¤è¯†ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />
<p>æœ¬æ–‡å°†å¯¹userland registry hijackingçš„åŸç†è¿›è¡Œä»‹ç»ï¼Œå®ä¾‹åˆ†æåœ¨Userland Persistenceå’ŒBypassUACä¸¤æ–¹é¢çš„å…·ä½“åº”ç”¨ï¼Œå€ŸåŠ©Process Monitorï¼Œä»‹ç»ä¸€ç§å¯»æ‰¾BypassUACçš„æ–¹æ³•ã€‚</p>

<h2 id="0x02-userland-registry-hijackingåŸç†">0x02 Userland registry hijackingåŸç†</h2>
<hr />

<h3 id="1é”®å€¼åŒæ­¥">1ã€é”®å€¼åŒæ­¥</h3>

<p>ä¿®æ”¹HKCU:\Software\Classes\ä¸‹çš„é”®å€¼ä¸­é»˜è®¤åç§°çš„æ•°æ®ï¼Œå¯ä»¥åŒæ—¶ä¿®æ”¹HKCR:\ä¸‹å¯¹åº”é”®å€¼é»˜è®¤åç§°çš„æ•°æ®(å‰ææ˜¯HKCR:\å·²å­˜åœ¨æ­¤æ³¨å†Œè¡¨é¡¹)</p>

<p>ä¾‹å¦‚ï¼š</p>

<p>ç¼–è¾‘HKEY_CURRENT_USER\Software\Classes\mscfile\shell\open\commandçš„é»˜è®¤å€¼ä¸ºc:\test\admin.exe</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/1-1.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>é»˜è®¤HKEY_CURRENT_USER\Software\Classes\ä¸‹ä¸å­˜åœ¨mscfile\shell\open\commandï¼Œéœ€è¦è‡ªå·±åˆ›å»º</p>

<p>å®šä½åˆ°HKEY_CLASSES_ROOT\mscfile\shell\open\commandä¸‹ï¼Œå‘ç°é»˜è®¤å€¼è¢«è‡ªåŠ¨ä¿®æ”¹ä¸ºc:\test\admin.exe</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/1-2.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>åœ¨HKCU:\Software\Classes\CLSIDä¸‹æ–°å»ºä¸€ä¸ªHKCR:\CLSIDä¸å­˜åœ¨çš„é”®å€¼ï¼Œå¹¶ä¸ä¼šæ›´æ–°HKCR:\CLSIDçš„æ•°æ®</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/1-3.png" alt="Alt text" /></p>

<p>æ–°å»ºHKEY_CURRENT_USER\Software\Classes\mscfile\shell\open\command\1ï¼Œé»˜è®¤åç§°çš„æ•°æ®è®¾ä¸º1ï¼Œç„¶è€ŒHKEY_CLASSES_ROOT\mscfile\shell\open\commandå¹¶ä¸ä¼šæ–°å»ºå­é¡¹1</p>

<h3 id="2æƒé™">2ã€æƒé™</h3>

<ul>
  <li>
    <p>ä¿®æ”¹HKCUä¸‹çš„é”®å€¼åªéœ€è¦æ™®é€šç”¨æˆ·æƒé™</p>
  </li>
  <li>
    <p>ä¿®æ”¹HKCRä¸‹çš„é”®å€¼éœ€è¦ç®¡ç†å‘˜æƒé™</p>
  </li>
</ul>

<p>ç»¼ä¸Šï¼Œåªéœ€è¦ä»¥æ™®é€šç”¨æˆ·çš„æƒé™ç¼–è¾‘HKCU:\Software\Classes\ä¸‹çš„é”®å€¼å°±å¯ä»¥åŒæ­¥ä¿®æ”¹å¯¹åº”ç®¡ç†å‘˜æƒé™HKCRä¸‹çš„é”®å€¼ã€‚</p>

<p>æ ¹æ®ä»¥ä¸Šä»‹ç»çš„åŸç†ï¼Œå¯å…·ä½“åº”ç”¨åœ¨Userland Persistenceå’ŒBypassUACä¸¤æ–¹é¢ï¼š</p>

<h2 id="0x03-userland-persistence-with-scheduled-tasks">0x03 Userland Persistence With Scheduled Tasks</h2>
<hr />

<p>å¦‚æœåŠ«æŒç³»ç»ŸæŸä¸ªè®¡åˆ’ä»»åŠ¡å¯¹åº”çš„æ³¨å†Œè¡¨é”®å€¼ï¼Œä¿®æ”¹å…¶ä¸­è¦å¯åŠ¨çš„dllç»å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆä»…éœ€æ™®é€šç”¨æˆ·æƒé™å°±èƒ½å®ç°ä¸€ä¸ªåé—¨ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p>

<h3 id="1æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡åŒæ³¨å†Œè¡¨çš„å¯¹åº”å…³ç³»">1ã€æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡åŒæ³¨å†Œè¡¨çš„å¯¹åº”å…³ç³»</h3>

<p>ç³»ç»Ÿä¸­çš„è®¡åˆ’ä»»åŠ¡åŒæ³¨å†Œè¡¨HKCU:\Software\Classes\CLSID\ä¸‹çš„é”®å€¼å­˜åœ¨å¯¹åº”å…³ç³»ï¼Œå¯å€ŸåŠ©<code class="language-plaintext highlighter-rouge">Matt Nelson@enigma0x3</code>åˆ†äº«çš„è„šæœ¬ç›´æ¥æŸ¥çœ‹</p>

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>https://github.com/enigma0x3/Misc-PowerShell-Stuff/blob/master/Get-ScheduledTaskComHandler.ps1</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>é€šè¿‡è®¡åˆ’ä»»åŠ¡é¢æ¿æŸ¥çœ‹çš„ä¿¡æ¯ä¸å®Œå…¨ï¼Œè®¡åˆ’ä»»åŠ¡é¢æ¿çš„æ‰“å¼€æ–¹å¼ä¸ºï¼šæˆ‘çš„ç”µè„‘-å³é”®-ç®¡ç†ï¼Œæ‰¾åˆ°è®¡åˆ’ä»»åŠ¡ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/1-4.png" alt="Alt text" /></p>

<p>psè„šæœ¬è·å–çš„éƒ¨åˆ†å¯¹åº”å…³ç³»å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/1-5.png" alt="Alt text" /></p>

<p>å¯è·å¾—æ¯ä¸ªè®¡åˆ’ä»»åŠ¡å¯¹åº”æ³¨å†Œè¡¨é”®å€¼çš„ä½ç½®å’Œå¯åŠ¨çš„dll</p>

<h3 id="2ä¿®æ”¹å¯¹åº”é”®å€¼ä¸­çš„dllä½ç½®">2ã€ä¿®æ”¹å¯¹åº”é”®å€¼ä¸­çš„dllä½ç½®</h3>

<p>æ‰¾åˆ°å¯¹åº”å…³ç³»åï¼Œéœ€è¦å®šä½å…·ä½“çš„æ³¨å†Œè¡¨é”®å€¼ä½ç½®ï¼Œå³HKEY_CURRENT_USER\Software\Classes\CLSID{CLSID},é€šå¸¸æƒ…å†µHKCUä¸‹è¯¥é”®å€¼ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨å»ºç«‹ï¼Œé»˜è®¤å€¼è®¾ä¸ºéœ€è¦è¿è¡Œçš„æµ‹è¯•dllçš„ç»å¯¹è·¯å¾„ï¼Œé”®å€¼åˆ›å»ºåHKCRä¸‹çš„é”®å€¼ä¼šåŒæ­¥æ›´æ–°ï¼Œè®¡åˆ’ä»»åŠ¡å¯åŠ¨çš„dlléšä¹‹è¢«ä¿®æ”¹ã€‚</p>

<p><strong>å®ä¾‹ï¼š</strong></p>

<p>1ã€æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡åŒæ³¨å†Œè¡¨çš„å¯¹åº”å…³ç³»</p>

<p>è¿è¡ŒGet-ScheduledTaskComHandleræ‰¾åˆ°å¯è¢«åŠ«æŒçš„dllï¼ŒæŒ‘é€‰ä¸€ä¸ªé€šç”¨çš„è®¡åˆ’ä»»åŠ¡â€”â€”UserTaskï¼Œè¯¦ç»†ä¿¡æ¯å¦‚ä¸‹ï¼š</p>

<p>TaskName      : UserTask</p>

<p>CLSID         : {58fb76b9-ac85-4e55-ac04-427593b1d060}</p>

<p>Dll           : C:\Windows\system32\dimsjob.dll</p>

<p>Logon         : True</p>

<p>IsUserContext : True</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ­¤æ“ä½œéœ€è¦æŸ¥æ‰¾HKCRä¸‹çš„é”®å€¼ï¼Œæ‰€ä»¥éœ€è¦ç®¡ç†å‘˜æƒé™æ‰å¯ä»¥è·å¾—</p>

<p>2ã€ä¿®æ”¹å¯¹åº”é”®å€¼ä¸­çš„dllä½ç½®</p>

<p>åœ¨HKEY_CURRENT_USER\Software\Classes\CLSID\ä¸‹æ–°å»ºé¡¹{58fb76b9-ac85-4e55-ac04-427593b1d060}</p>

<p>æ¥ç€æ–°å»ºé¡¹InprocServer32</p>

<p>å€¼è®¾å®šä¸ºc:\test\MessageBox32.dll</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ³¨å†Œè¡¨é¡¹{58fb76b9-ac85-4e55-ac04-427593b1d060}é€šç”¨ï¼Œä¸åŒç³»ç»Ÿä¸‹é”®å€¼åç§°ç›¸åŒ</p>

<p>MessageBox32.dllä¸‹è½½åœ°å€ä¸ºï¼š</p>

<p>https://github.com/enigma0x3/MessageBox</p>

<p>å®é™…æµ‹è¯•å‘ç°https://github.com/enigma0x3/MessageBox/tree/master/binçš„dllåœ¨win7ä¸‹å¤±æ•ˆï¼Œä½¿ç”¨æºä»£ç é‡æ–°ç¼–è¯‘ç”Ÿæˆæ–°çš„dllå¯ä»¥ä½¿ç”¨</p>

<p>æ­¤æ—¶æŸ¥çœ‹HKEY_CLASSES_ROOT\CLSID{58fb76b9-ac85-4e55-ac04-427593b1d060}\InprocServer32ï¼Œé»˜è®¤å€¼è¢«ä¿®æ”¹ä¸ºc:\test\MessageBox32.dllï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/2-0.png" alt="Alt text" /></p>

<p>æ³¨é”€ç”¨æˆ·ï¼Œé‡æ–°ç™»å½•ï¼ŒMessageBox32.dllè¢«åŠ è½½ï¼Œå¼¹æ¡†</p>

<p>ä½†æ˜¯åœ¨Scheduled Taské¢æ¿çš„æ—¥å¿—ä¸­ä¼šæç¤ºDLLä¸­å‡ºé”™(0x800401F9)ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/2-1.png" alt="Alt text" /></p>

<p>çŒœæµ‹æ˜¯å¯¼å‡ºå‡½æ•°çš„é—®é¢˜å¯¼è‡´dllåŠ è½½æŠ¥é”™ï¼Œä½¿ç”¨dumpbinæŸ¥çœ‹è®¡åˆ’ä»»åŠ¡UserTaskå¯¹åº”çš„åŸdllçš„å¯¼å‡ºå‡½æ•°ï¼Œæ‰§è¡Œï¼š</p>

<p>dumpbin /exports C:\Windows\system32\dimsjob.dll</p>

<p><strong>æ³¨ï¼š</strong>
UserTaskå¯¹åº”çš„åŸdllçš„ç»å¯¹è·¯å¾„ä¸ºC:\Windows\system32\dimsjob.dll</p>

<p>è·å¾—dimsjob.dllçš„å¯¼å‡ºå‡½æ•°è¡¨ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/2-2.png" alt="Alt text" /></p>

<p>æ‰€ä»¥éœ€è¦ä¸ºdllæ·»åŠ æ–°çš„å¯¼å‡ºå‡½æ•°ï¼š</p>

<ul>
  <li>DllCanUnloadNow</li>
  <li>DllGetClassObject</li>
  <li>DllRegisterServer</li>
  <li>DllUnregisterServer</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>å…·ä½“ä¸ºdllæ·»åŠ å¯¼å‡ºå‡½æ•°çš„æ–¹æ³•åœ¨ã€ŠCode Execution of Regsvr32.exeã€‹åšäº†è¯¦ç»†ä»‹ç»ï¼Œæ­¤å¤„ç•¥è¿‡</p>

<p>æ·»åŠ æˆåŠŸåï¼ŒdumpbinæŸ¥çœ‹ç»“æœå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/2-3.png" alt="Alt text" /></p>

<p>æ›¿æ¢æ—§çš„MessageBox32.dllï¼Œæ³¨é”€ç”¨æˆ·ï¼Œé‡æ–°ç™»å½•ï¼Œæ–°çš„MessageBox32.dllè¢«åŠ è½½ï¼Œå¼¹æ¡†</p>

<p>æŸ¥çœ‹Scheduled Taské¢æ¿çš„æ—¥å¿—ï¼Œé—®é¢˜è§£å†³ï¼Œæ“ä½œæˆåŠŸå®Œæˆï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/2-4.png" alt="Alt text" /></p>

<p>ä»¥ä¸Šæ“ä½œå¯é€šè¿‡powershellè‡ªåŠ¨å®ç°ï¼Œä¿®æ”¹UserTaskçš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function Invoke-ScheduledTaskComHandlerUserTask
{
    [CmdletBinding(SupportsShouldProcess = $True, ConfirmImpact = 'Medium')]
    Param (
        [Parameter(Mandatory = $True)]
        [ValidateNotNullOrEmpty()]
        [String]
        $Command,

        [Switch]
        $Force
    )
    $ScheduledTaskCommandPath = "HKCU:\Software\Classes\CLSID\{58fb76b9-ac85-4e55-ac04-427593b1d060}\InprocServer32"
    if ($Force -or ((Get-ItemProperty -Path $ScheduledTaskCommandPath -Name '(default)' -ErrorAction SilentlyContinue) -eq $null)){
        New-Item $ScheduledTaskCommandPath -Force |
            New-ItemProperty -Name '(Default)' -Value $Command -PropertyType string -Force | Out-Null
    }else{
        Write-Verbose "Key already exists, consider using -Force"
        exit
    }

    if (Test-Path $ScheduledTaskCommandPath) {
        Write-Verbose "Created registry entries to hijack the UserTask"
    }else{
        Write-Warning "Failed to create registry key, exiting"
        exit
    }  
}
Invoke-ScheduledTaskComHandlerUserTask -Command "C:\test\testmsg.dll" -Verbose

</code></pre></div></div>
<p>æµ‹è¯•ç³»ç»Ÿï¼š Win7 x86</p>

<p>åœ¨è¿è¡Œåï¼Œå½“ç”¨æˆ·é‡æ–°ç™»å½•åï¼ŒåŠ è½½dllï¼Œå®é™…æ¼”ç¤ºå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/2-5.gif" alt="Alt text" /></p>

<p>ä¾æ¬¡æ‰§è¡ŒDLL_PROCESS_ATTACH()å’ŒDllGetClassObject(),ç”±äºDllGetClassObject()ä»…ä½œå¼¹æ¡†ï¼Œæ‰€ä»¥ä¹‹åä¼šæ˜¾ç¤ºtaskhost.exeæŠ¥é”™</p>

<p><strong>æ³¨ï¼š</strong>
æ­¤å¤„ä»…ä½œæ¼”ç¤ºï¼Œæš‚ä¸ä»‹ç»å…·ä½“è§£å†³æ–¹æ³•</p>

<p>è‡³æ­¤ï¼ŒæˆåŠŸåŠ«æŒè®¡åˆ’ä»»åŠ¡UserTaskï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½testmsg.dll</p>

<h2 id="0x04-uacbypass">0x04 UACBypass</h2>
<hr />
<p>è®¡åˆ’ä»»åŠ¡åŒæ³¨å†Œè¡¨HKCR:\ä¸‹çš„é”®å€¼å­˜åœ¨å¯¹åº”å…³ç³»ï¼ŒåŒæ ·ä¸€äº›é«˜æƒé™çš„ç¨‹åºä¹Ÿä¼šè°ƒç”¨HKCR:\ä¸‹çš„é”®å€¼ï¼Œè¿™å°±ä¸ºBypass UACå¸¦æ¥äº†å¯èƒ½ã€‚</p>

<p>åŒæ ·çš„åŸç†ï¼Œé€šè¿‡ä¿®æ”¹HKEY_CURRENT_USER\Software\Classes\ä¸‹çš„é”®å€¼åŒæ­¥ä¿®æ”¹HKCR:\ä¸‹çš„é”®å€¼ï¼Œå¦‚æœé«˜æƒé™çš„ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨æ­¤å¤„è¢«ä¿®æ”¹è¿‡çš„é”®å€¼ï¼Œè‡ªç„¶å°±å®ç°äº†Bypass UACï¼Œä»¥é«˜æƒé™å¯åŠ¨æˆ‘ä»¬è®¾å®šçš„ç¨‹åºã€‚</p>

<p>æ­¤å¤„çš„éš¾ç‚¹åœ¨äºæ‰¾åˆ°è¿™ä¸ªé«˜æƒé™çš„ç¨‹åº</p>

<p><strong>æ–¹æ³•ï¼š</strong>
å€ŸåŠ©Process Monitorï¼Œå¯ä»¥æŸ¥çœ‹ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„æ³¨å†Œè¡¨ã€æ–‡ä»¶ã€ç½‘ç»œã€è¿›ç¨‹é—´çš„è°ƒç”¨å…³ç³»</p>

<p>æ¥ä¸‹æ¥ä½¿ç”¨Process Monitorå¤ç°ä¸€ä¸‹Matt Nelson@enigma0x3å‘ç°çš„è¿‡ç¨‹</p>

<h3 id="1æ‰¾åˆ°é«˜æƒé™çš„exe">1ã€æ‰¾åˆ°é«˜æƒé™çš„exe</h3>
<p>Matt Nelson@enigma0x3çš„æ–¹æ³•ä¸ºä½¿ç”¨sigcheckæŸ¥çœ‹exeçš„manifest</p>

<p>å‚æ•°å¦‚ä¸‹ï¼š</p>

<p>sigcheck.exe -m c:\windows\system32\eventvwr.exe</p>

<p>è¿”å›ç»“æœå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/3-1.png" alt="Alt text" /></p>

<p>ä»level=â€highestAvailableâ€å¾—çŸ¥eventvwr.exeçš„æƒé™ä¸ºé«˜æƒé™</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æä¾›ä¸€ä¸ªæ›´åŠ ç›´è§‚çš„åˆ¤æ–­æ–¹æ³•ï¼š</p>

<p>æŸ¥çœ‹æ–‡ä»¶å›¾æ ‡ï¼Œå¦‚æœå¸¦æœ‰UACæ ‡å¿—ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯é«˜æƒé™çš„ç¨‹åºï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/3-2.png" alt="Alt text" /></p>

<h3 id="2ä½¿ç”¨process-monitoræŸ¥çœ‹è¿›ç¨‹è°ƒç”¨å…³ç³»">2ã€ä½¿ç”¨Process MonitoræŸ¥çœ‹è¿›ç¨‹è°ƒç”¨å…³ç³»</h3>

<p>å¯åŠ¨Process Monitor</p>

<p>è¿è¡Œeventvwr.exe</p>

<p>Process Monitoré€‰æ‹©Tools-Process Treeï¼Œæ‰¾åˆ°eventvwr.exeï¼Œå³é”®-Go To Eventï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/3-3.png" alt="Alt text" /></p>

<p>ä»”ç»†æŸ¥çœ‹è¿›ç¨‹è°ƒç”¨å…³ç³»ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/3-4.png" alt="Alt text" /></p>

<p>æ‰¾åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>

<ul>
  <li>
    <p>eventvwr.exeçš„æƒé™ä¸ºhigh</p>
  </li>
  <li>
    <p>eventvwr.exeé¦–å…ˆæŸ¥è¯¢é”®å€¼HKCU\Software\Classes\mscfile\shell\open\commandï¼ŒæŸ¥è¯¢ç»“æœä¸ºNAME NOT FOUND</p>
  </li>
  <li>
    <p>eventvwr.exeæ¥ç€æŸ¥è¯¢é”®å€¼HKCR\mscfile\shell\open\commandï¼Œç»“æœä¸ºSUCCESS</p>
  </li>
</ul>

<h3 id="3ä¿®æ”¹æµ‹è¯•">3ã€ä¿®æ”¹æµ‹è¯•</h3>

<p>å¦‚æœä¿®æ”¹é”®å€¼HKCU\Software\Classes\mscfile\shell\open\commandï¼Œä½¿å…¶æŸ¥è¯¢ç»“æœä¸ºSUCCESSï¼Œä¼šå¦‚ä½•å‘¢ï¼Ÿ</p>

<p>ä¸‹é¢é¦–å…ˆä¿®æ”¹é”®å€¼HKCU\Software\Classes\mscfile\shell\open\commandï¼Œå€¼ä¸ºcalc.exe</p>

<p>å†æ¬¡è¿è¡Œeventvwr.exeï¼Œå‘ç°å¯åŠ¨äº†calc.exe</p>

<p>ä½¿ç”¨Process MonitoræŸ¥çœ‹è¿›ç¨‹è°ƒç”¨å…³ç³»ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/3-5.png" alt="Alt text" /></p>

<p>æ­¤æ—¶å¯¹é”®å€¼HKCU\Software\Classes\mscfile\shell\open\commandçš„æŸ¥è¯¢ç»“æœä¸ºSUCCESS</p>

<p>è‡³æ­¤ï¼ŒæˆåŠŸé€šè¿‡ä¿®æ”¹HKCU\Software\Classes\mscfile\shell\open\commandï¼Œå®ç°BypassUACï¼Œè·å¾—äº†é«˜æƒé™</p>

<p>calc.exeçš„æƒé™ä¸ºhighï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/3-6.png" alt="Alt text" /></p>

<h3 id="4æ›´å¤šç»“è®º">4ã€æ›´å¤šç»“è®º</h3>

<p>ä¿®æ”¹HKCU\Software\Classes\mscfile\shell\open\commandåï¼Œä¼šåŠ«æŒæ‰€æœ‰.mscæ–‡ä»¶çš„è¿è¡Œï¼Œå¦‚gpedit.msc,å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-8-22/2-6.png" alt="Alt text" /></p>

<p>æŒ‰ç…§è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘å¯¹system32ä¸‹çš„æ‰€æœ‰é«˜æƒé™exeè¿›è¡Œäº†æµ‹è¯•ï¼Œå°šæœªå‘ç°æ ¹æ®åŒæ ·çš„æ–¹æ³•åˆ©ç”¨commandé”®å€¼å®ç°çš„UACBypassï¼Œä½†æ˜¯å…¶ä»–é”®å€¼ä»å€¼å¾—æµ‹è¯•ã€‚</p>

<h2 id="0x05-é˜²å¾¡">0x05 é˜²å¾¡</h2>
<hr />
<p>Win10ç³»ç»Ÿå·²å¯¹è¯¥å¤„åšäº†ä¿®å¤ï¼Œä½ç‰ˆæœ¬Windowsç³»ç»Ÿå°šæœªä¿®å¤ï¼Œé˜²å¾¡å»ºè®®ï¼š</p>

<ul>
  <li>
    <p>set the UAC level to â€œAlways Notifyâ€</p>
  </li>
  <li>
    <p>remove the current user from the Local Administrators group</p>
  </li>
  <li>
    <p>alert on new registry entries in HKCU\Software\Classes\</p>
  </li>
</ul>

<blockquote>
  <p>å¼•ç”¨è‡ªhttps://enigma0x3.net/2016/08/15/fileless-uac-bypass-using-eventvwr-exe-and-registry-hijacking/</p>
</blockquote>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />
<p>è®¡åˆ’ä»»åŠ¡ä¸­å¯è¢«ç”¨ä½œpersistenceçš„dllæœ‰å¾ˆå¤šï¼Œåœ¨é˜²å¾¡ä¸Šå»ºè®®å¯¹æ­¤è¿›è¡Œç›‘æ§ã€‚
é€šè¿‡Process Monitorå¯»æ‰¾BypassUACçš„æ–¹æ³•å€¼å¾—ç»§ç»­ç ”ç©¶ï¼Œä¸€å®šä¼šæœ‰æ–°çš„å‘ç°ã€‚</p>

<p><strong>ç›¸å…³å­¦ä¹ èµ„æ–™ï¼š</strong></p>

<p>https://enigma0x3.net/2016/08/15/fileless-uac-bypass-using-eventvwr-exe-and-registry-hijacking/</p>

<p>https://enigma0x3.net/2016/05/25/userland-persistence-with-scheduled-tasks-and-com-handler-hijacking/</p>

<p>https://blog.gdatasoftware.com/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>
:ET