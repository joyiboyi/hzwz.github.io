I"Ù<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¸Šç¯‡æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E4%B8%8BNTFS%E6%96%87%E4%BB%B6%E7%9A%84%E6%97%B6%E9%97%B4%E5%B1%9E%E6%80%A7">ã€Šæ¸—é€æŠ€å·§â€”â€”Windowsä¸‹NTFSæ–‡ä»¶çš„æ—¶é—´å±æ€§ã€‹</a>ä»‹ç»äº†ä¿®æ”¹NTFSæ–‡ä»¶æ—¶é—´å±æ€§çš„æ–¹æ³•å’Œç»†èŠ‚ï¼Œä»¥åŠå–è¯ä¸Šçš„å»ºè®®ã€‚
æœ¬æ–‡å°†è¦ç»§ç»­ç ”ç©¶NTFSæ–‡ä»¶å¦ä¸€å¤„è®°å½•æ–‡ä»¶ä¿®æ”¹æ—¶é—´çš„ä½ç½®â€”â€”USN Journalï¼ŒåŒæ ·æ˜¯åˆ†æåˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºå–è¯ä¸Šçš„å»ºè®®ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>åŸºæœ¬æ¦‚å¿µ</li>
  <li>è¯»å–USN Journalçš„æ–¹æ³•</li>
  <li>åˆ©ç”¨æ€è·¯</li>
  <li>å–è¯å»ºè®®</li>
</ul>

<h2 id="0x02-usn-journalçš„åŸºæœ¬æ¦‚å¿µ">0x02 USN Journalçš„åŸºæœ¬æ¦‚å¿µ</h2>
<hr />

<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>

<p>https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/bb742450(v=technet.10)</p>

<p>USN Journal (Update Sequence Number Journal)ï¼Œä¹Ÿç§°ä½œChange Journalï¼Œç”¨æ¥è®°å½•NTFS volumeä¸­æ–‡ä»¶ä¿®æ”¹çš„ä¿¡æ¯ï¼Œèƒ½å¤Ÿæé«˜æœç´¢æ–‡ä»¶çš„æ•ˆç‡</p>

<p>æ¯ä¸ªNTFS volumeå¯¹åº”ä¸€ä¸ªUSN Journalï¼Œå­˜å‚¨åœ¨<code class="language-plaintext highlighter-rouge">NTFS metafile</code>çš„<code class="language-plaintext highlighter-rouge">$Extend\$UsnJrnl</code>ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸åŒçš„NTFS volumeå¯¹åº”çš„USN Journalä¸åŒ</p>

<p>USN Journalä¼šè®°å½•æ–‡ä»¶å’Œç›®å½•çš„åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ã€é‡å‘½åå’ŒåŠ è§£å¯†æ“ä½œï¼Œæ¯æ¡è®°å½•çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct {
  DWORD         RecordLength;
  WORD          MajorVersion;
  WORD          MinorVersion;
  DWORDLONG     FileReferenceNumber;
  DWORDLONG     ParentFileReferenceNumber;
  USN           Usn;
  LARGE_INTEGER TimeStamp;
  DWORD         Reason;
  DWORD         SourceInfo;
  DWORD         SecurityId;
  DWORD         FileAttributes;
  WORD          FileNameLength;
  WORD          FileNameOffset;
  WCHAR         FileName[1];
} USN_RECORD_V2, *PUSN_RECORD_V2;
</code></pre></div></div>

<p>å®˜æ–¹èµ„æ–™ï¼š</p>

<p>https://docs.microsoft.com/en-us/windows/desktop/api/winioctl/ns-winioctl-usn_record_v2</p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">NTFS metafile</code>çš„<code class="language-plaintext highlighter-rouge">$Extend\$UsnJrnl\$Max</code>ä¿å­˜USN Journalæ–‡ä»¶çš„æ€»å¤§å°ï¼Œå¦‚æœUSN Journalçš„è®°å½•é•¿åº¦è¶…å‡ºæ€»å¤§å°ï¼Œä¼šä»æœ€åˆå§‹çš„è®°å½•å¼€å§‹è¦†ç›–</p>

<h2 id="0x03-è¯»å–usn-journalçš„æ–¹æ³•">0x03 è¯»å–USN Journalçš„æ–¹æ³•</h2>
<hr />

<h3 id="1ä½¿ç”¨å‘½ä»¤fsutil-usn">1ã€ä½¿ç”¨å‘½ä»¤fsutil usn</h3>

<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>

<p>https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc788042(v%3dws.10)</p>

<h4 id="1æŸ¥çœ‹cç›˜çš„usn-journalä¿¡æ¯">(1)æŸ¥çœ‹Cç›˜çš„USN Journalä¿¡æ¯</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fsutil usn queryjournal c:
</code></pre></div></div>

<p>åŒ…æ‹¬ä»¥ä¸‹ä¿¡æ¯ï¼š</p>

<ul>
  <li>Usn Journal ID</li>
  <li>First Usn</li>
  <li>Next Usn</li>
  <li>Lowest Valid Usn</li>
  <li>Max Usn</li>
  <li>Maximum Size</li>
  <li>Allocation Delta</li>
</ul>

<h4 id="2æŸ¥çœ‹cç›˜æ‰€æœ‰çš„usn-journal">(2)æŸ¥çœ‹Cç›˜æ‰€æœ‰çš„USN Journal</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fsutil usn enumdata 1 0 1 c:
</code></pre></div></div>

<p>åŒ…æ‹¬ä»¥ä¸‹ä¿¡æ¯ï¼š</p>

<ul>
  <li>File Ref#</li>
  <li>ParentFile Ref#</li>
  <li>Usn</li>
  <li>SecurityId</li>
  <li>Reason</li>
  <li>Name</li>
</ul>

<p>è¾“å‡ºç»“æœä¸å¤Ÿè¯¦ç»†</p>

<h3 id="2ä½¿ç”¨å¼€æºå·¥å…·">2ã€ä½¿ç”¨å¼€æºå·¥å…·</h3>

<h4 id="1å¯¼å‡ºusn-journal">(1)å¯¼å‡ºUSN Journal</h4>

<p>ä¸‹è½½åœ°å€ï¼š</p>

<p>https://github.com/jschicht/ExtractUsnJrnl</p>

<p>å‚æ•°å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ExtractUsnJrnl /DevicePath:c: /OutputPath:c:\test /OutputName:UsnJrnl_vol1.bin
</code></pre></div></div>

<h4 id="2å°†usn-journalè½¬ä¸ºcsvæ ¼å¼è¾“å‡º">(2)å°†USN Journalè½¬ä¸ºCSVæ ¼å¼è¾“å‡º</h4>

<p>ä¸‹è½½åœ°å€ï¼š</p>

<p>https://github.com/jschicht/UsnJrnl2Csv</p>

<p>å‚æ•°å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UsnJrnl2Csv /UsnJrnlFile:c:\test\UsnJrnl_vol1.bin /OutputPath:c:\test
</code></pre></div></div>

<p>åŒ…æ‹¬ä»¥ä¸‹ä¿¡æ¯ï¼š</p>

<ul>
  <li>Offset</li>
  <li>FileName</li>
  <li>USN</li>
  <li>Timestamp</li>
  <li>Reason</li>
  <li>MFTReference</li>
  <li>MFTReferenceSeqNo</li>
  <li>MFTParentReference</li>
  <li>MFTParentReferenceSeqNo</li>
  <li>FileAttributes</li>
  <li>MajorVersion</li>
  <li>MinorVersion</li>
  <li>SourceInfo</li>
  <li>SecurityId</li>
</ul>

<p>è¾“å‡ºç»“æœå¾ˆå®Œæ•´</p>

<h3 id="3cå®ç°">3ã€c++å®ç°</h3>

<p>æˆ‘è¿™é‡Œå†™äº†ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œä¸‹è½½åœ°å€ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/EnumUsnJournal.cpp</p>

<p>ä»£ç å®ç°äº†æšä¸¾Cç›˜çš„USN Journalï¼Œä»…è¾“å‡ºæ–‡ä»¶å</p>

<h2 id="0x04-åˆ©ç”¨æ€è·¯">0x04 åˆ©ç”¨æ€è·¯</h2>
<hr />

<h3 id="1æ¸…é™¤æ‰€æœ‰usn-journal">1ã€æ¸…é™¤æ‰€æœ‰USN Journal</h3>

<h4 id="1ä½¿ç”¨fsutil">(1)ä½¿ç”¨fsutil</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fsutil usn deletejournal /d c:
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>æˆ‘åœ¨æµ‹è¯•ç¯å¢ƒä¸‹æ²¡æœ‰åˆ é™¤æˆåŠŸ</p>

<h4 id="2api">(2)API</h4>

<p>https://docs.microsoft.com/en-us/windows/desktop/api/winioctl/ns-winioctl-delete_usn_journal_data</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æˆ‘åœ¨æµ‹è¯•ç¯å¢ƒä¸‹æ²¡æœ‰åˆ é™¤æˆåŠŸ</p>

<h3 id="2æ¸…é™¤å•æ¡usn-journal">2ã€æ¸…é™¤å•æ¡USN Journal</h3>

<p>æˆ‘è¿˜æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„APIæ¥å£</p>

<p>å”¯ä¸€çš„æ–¹æ³•æ˜¯ç›´æ¥ä¿®æ”¹NTFSæ–‡ä»¶ï¼Œä½†æ˜¯è‡ªnt6.xå¼€å§‹ï¼ŒWindowsç¦æ­¢åŠ è½½æœªç»ç­¾åçš„é©±åŠ¨æ–‡ä»¶</p>

<p>è¿™é‡Œå¯ä»¥å°è¯•ä½¿ç”¨ä»˜è´¹ç‰ˆçš„WinHexå¯¹NTFSæ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œä¿®æ”¹<code class="language-plaintext highlighter-rouge">$Extend\$UsnJrnl</code>ä¸­çš„å†…å®¹</p>

<p>ä¹Ÿå¯ä»¥å°è¯•ç»•è¿‡é©±åŠ¨ä¿æŠ¤</p>

<p>$UsnJrnlçš„å†…å®¹å¯å‚è€ƒï¼š</p>

<p>http://forensicinsight.org/wp-content/uploads/2013/07/F-INSIGHT-Advanced-UsnJrnl-Forensics-English.pdf</p>

<p>æŒ‰ç…§æ ¼å¼è¯»å–USN Journalï¼Œåˆ é™¤æŒ‡å®šUSN Journalï¼Œå†å†™å…¥ç£ç›˜</p>

<h3 id="3æš´åŠ›è¦†ç›–">3ã€æš´åŠ›è¦†ç›–</h3>

<p>é¦–å…ˆæŸ¥çœ‹ç£ç›˜USN Journalæ–‡ä»¶çš„æ€»é•¿åº¦</p>

<p>ç„¶åé€šè¿‡åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ã€é‡å‘½åç­‰æ“ä½œç”ŸæˆUSN Journalçš„è®°å½•ï¼Œå½“è¶…è¿‡æ€»é•¿åº¦åä¼šè¦†ç›–æœ€åˆå§‹çš„è®°å½•ï¼Œç›´è‡³è¦†ç›–æ‰€æœ‰çš„USN Journal</p>

<h2 id="0x05-å–è¯å»ºè®®">0x05 å–è¯å»ºè®®</h2>
<hr />

<h4 id="1è¯»å–usn-journalåˆ—å‡ºæ‰€æœ‰è®°å½•æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯ç–‘è®°å½•">1ã€è¯»å–USN Journalï¼Œåˆ—å‡ºæ‰€æœ‰è®°å½•ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯ç–‘è®°å½•</h4>

<p>è¯¥æ–¹æ³•å¹¶éå®Œå…¨å¯ä¿¡ï¼Œæ”»å‡»è€…åªè¦èƒ½å¤Ÿç»•è¿‡é©±åŠ¨ä¿æŠ¤ï¼Œå°±èƒ½ä¿®æ”¹USN Journal</p>

<h4 id="2å°è¯•å…¶ä»–æ–¹æ³•">2ã€å°è¯•å…¶ä»–æ–¹æ³•</h4>

<p>æ¯”å¦‚ä»å†…å­˜ä¸­è¯»å–$MFT records</p>

<p>https://github.com/jschicht/HexDump</p>

<p>https://github.com/jschicht/MftCarver</p>

<p>Joakim Schichtçš„githubæœ‰å¾ˆå¤šå–è¯çš„å·¥å…·å€¼å¾—å‚è€ƒ:</p>

<p>https://github.com/jschicht/</p>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†NTFSæ–‡ä»¶çš„USN Journalçš„åˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºå–è¯ä¸Šçš„å»ºè®®ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET