I"Ü*<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>è¦å¯¹æŒ‡å®šè¿›ç¨‹è¿›è¡Œè¿œç¨‹æ³¨å…¥ï¼Œé€šå¸¸ä½¿ç”¨Windowsæä¾›çš„API CreateRemoteThreadåˆ›å»ºä¸€ä¸ªè¿œç¨‹çº¿ç¨‹ï¼Œè¿›è€Œæ³¨å…¥dllæˆ–æ˜¯æ‰§è¡Œshellcode</p>

<p>Sysmonå¯ç”¨æ¥ç›‘æ§å’Œè®°å½•ç³»ç»Ÿæ´»åŠ¨ï¼Œå¯è®°å½•CreateRemoteThreadæ“ä½œ</p>

<p>æ³¨å…¥çš„æ–¹æ³•ä¸åªæœ‰CreateRemoteThreadï¼Œèƒ½å¦é€šè¿‡å…¶ä»–æ³¨å…¥æ–¹å¼ç»•è¿‡Sysmonçš„ç›‘æ§å‘¢ï¼Ÿ</p>

<p>Casey Smith@subTeeåœ¨ä»–çš„æ–‡ç« ä¸­ç»™å‡ºäº†ç­”æ¡ˆï¼š</p>

<p><code class="language-plaintext highlighter-rouge">Shellcode Injection via QueueUserAPC - Hiding From Sysmon</code></p>

<p><strong>åœ°å€å¦‚ä¸‹ï¼š</strong></p>

<p>http://subt0x10.blogspot.com/2017/01/shellcode-injection-via-queueuserapc.html</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»å¦‚ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>Sysmoné…ç½®æµ‹è¯•ï¼Œç›‘æ§CreateRemoteThreadæ“ä½œ</li>
  <li>c++å®ç°é€šè¿‡APCå¯¹Dllæ³¨å…¥</li>
  <li>ç»•è¿‡Sysmonæµ‹è¯•</li>
  <li>Casey Smith@subTeeåˆ†äº«çš„C#å®ç°ä»£ç å’Œç”¨é€”</li>
</ul>

<h3 id="sysmon">Sysmonï¼š</h3>

<p>å¯ç”¨æ¥ç›‘æ§å’Œè®°å½•ç³»ç»Ÿæ´»åŠ¨ï¼Œå¹¶è®°å½•åˆ°windowsäº‹ä»¶æ—¥å¿—ï¼ŒåŒ…å«å¦‚ä¸‹äº‹ä»¶ï¼š</p>

<ul>
  <li>Event ID 1: Process creation</li>
  <li>Event ID 2: A process changed a file creation time</li>
  <li>Event ID 3: Network connection</li>
  <li>Event ID 4: Sysmon service state changed</li>
  <li>Event ID 5: Process terminated</li>
  <li>Event ID 6: Driver loaded</li>
  <li>Event ID 7: Image loaded</li>
  <li>Event ID 8: CreateRemoteThread</li>
  <li>Event ID 9: RawAccessRead</li>
  <li>Event ID 10: ProcessAccess</li>
  <li>Event ID 11: FileCreate</li>
  <li>Event ID 12: RegistryEvent (Object create and delete)</li>
  <li>Event ID 13: RegistryEvent (Value Set)</li>
  <li>Event ID 14: RegistryEvent (Key and Value Rename)</li>
  <li>Event ID 15: FileCreateStreamHash</li>
  <li>Event ID 255: Error</li>
</ul>

<p>è¯¦æƒ…è§https://technet.microsoft.com/en-us/sysinternals/sysmon</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>CreateRemoteThreadä¸ºEvent ID 8</p>

<h3 id="dllæ³¨å…¥">Dllæ³¨å…¥</h3>

<p>å¸¸è§æ–¹æ³•ï¼š</p>

<ul>
  <li>åˆ›å»ºæ–°çº¿ç¨‹</li>
  <li>è®¾ç½®çº¿ç¨‹ä¸Šä¸‹èƒŒæ™¯æ–‡ï¼Œä¿®æ”¹å¯„å­˜å™¨</li>
  <li>æ’å…¥Apcé˜Ÿåˆ—</li>
  <li>ä¿®æ”¹æ³¨å†Œè¡¨</li>
  <li>æŒ‚é’©çª—å£æ¶ˆæ¯</li>
  <li>è¿œç¨‹æ‰‹åŠ¨å®ç°LoadLibrary</li>
</ul>

<p>å¼•ç”¨è‡ªhttp://www.cnblogs.com/uAreKongqi/p/6012353.html</p>

<h3 id="shellcode-injection-via-queueuserapc---hiding-from-sysmon">Shellcode Injection via QueueUserAPC - Hiding From Sysmonï¼š</h3>

<p>c#å®ç°ï¼Œé€šè¿‡è°ƒç”¨QueueUserAPCæ‰§è¡Œshellcodeï¼Œå¯åº”ç”¨äºInstallUtil.exeå’ŒMsbuild.exeï¼Œèƒ½å¤Ÿç»•è¿‡Sysmonå¯¹Event ID 8: CreateRemoteThreadçš„ç›‘æ§</p>

<p><strong>æ–‡ç« åœ°å€ï¼š</strong></p>

<p>http://subt0x10.blogspot.com/2017/01/shellcode-injection-via-queueuserapc.html</p>

<h2 id="0x02-sysmonç®€ä»‹">0x02 Sysmonç®€ä»‹</h2>
<hr />

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>https://technet.microsoft.com/en-us/sysinternals/sysmon</p>

<p>ä»¥ç³»ç»ŸæœåŠ¡å’Œé©±åŠ¨çš„æ–¹å¼å®‰è£…åœ¨ç³»ç»Ÿä¸Š</p>

<p>ç”¨æ¥ç›‘æ§å’Œè®°å½•ç³»ç»Ÿæ´»åŠ¨ï¼Œå¹¶è®°å½•åˆ°windowsäº‹ä»¶æ—¥å¿—ä¸­</p>

<p>æä¾›è¿›ç¨‹åˆ›å»ºã€ç½‘ç»œè¿æ¥ä»¥åŠæ–‡ä»¶åˆ›å»ºæ—¶é—´æ›´æ”¹ç­‰æ“ä½œçš„è¯¦ç»†ä¿¡æ¯</p>

<p>é€šè¿‡äº‹ä»¶æ—¥å¿—ï¼Œå¯è¯†åˆ«å¼‚å¸¸æ´»åŠ¨ï¼Œäº†è§£æ”»å‡»è€…åœ¨ç½‘ç»œä¸Šçš„æ“ä½œ</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ç³»ç»Ÿå®‰è£…Sysmonåï¼Œæ–°å¢æœåŠ¡Sysmon</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/2-0.png" alt="Alt text" /></p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ”»å‡»è€…è·å¾—äº†ä¸»æœºæƒé™ï¼Œé€šè¿‡æŸ¥çœ‹å·²å®‰è£…æœåŠ¡å¯ä»¥çœ‹åˆ°Sysmonçš„å®‰è£…</p>

<h3 id="å®‰è£…">å®‰è£…</h3>

<p>ä»¥é»˜è®¤é…ç½®å®‰è£…ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">sysmon -accepteula  â€“i -n</code></p>

<p>ä»¥é…ç½®æ–‡ä»¶å®‰è£…ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">sysmon -c config.xml</code></p>

<p>é…ç½®æ–‡ä»¶config.xmlæ ¼å¼ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>xmlå¤§å°å†™æ•æ„Ÿ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Sysmon schemaversion="3.20"&gt;      
&lt;!-- Capture all hashes --&gt;      
&lt;HashAlgorithms&gt;*&lt;/HashAlgorithms&gt;      
&lt;EventFiltering&gt;        
&lt;!-- Log all drivers except if the signature --&gt;       
 &lt;!-- contains Microsoft or Windows --&gt;       
 &lt;DriverLoad onmatch="exclude"&gt;          
&lt;Signature condition="contains"&gt;microsoft&lt;/Signature&gt;         
 &lt;Signature condition="contains"&gt;windows&lt;/Signature&gt;        
&lt;/DriverLoad&gt;       
 &lt;!-- Do not log process termination --&gt;        
&lt;ProcessTerminate onmatch="include" /&gt;       
 &lt;!-- Log network connection if the destination port equal 443 --&gt;        
&lt;!-- or 80, and process isn't InternetExplorer --&gt;        
&lt;NetworkConnect onmatch="include"&gt;          
&lt;DestinationPort&gt;443&lt;/DestinationPort&gt;          
&lt;DestinationPort&gt;80&lt;/DestinationPort&gt;        
&lt;/NetworkConnect&gt;        
&lt;NetworkConnect onmatch="exclude"&gt;          
&lt;Image condition="end with"&gt;iexplore.exe&lt;/Image&gt;       
 &lt;/NetworkConnect&gt;     
 &lt;/EventFiltering&gt;    
&lt;/Sysmon&gt;
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¥ç¤ºä¾‹å¼•ç”¨è‡ªhttp://www.freebuf.com/sectool/122779.html</p>

<h3 id="æŸ¥çœ‹é…ç½®">æŸ¥çœ‹é…ç½®</h3>

<p><code class="language-plaintext highlighter-rouge">sysmon -c</code></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>é…ç½®å±æ€§ä¿å­˜åœ¨æ³¨å†Œè¡¨å¦‚ä¸‹ä½ç½®ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\SysmonDrv\Parameters</code></p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/2-01.png" alt="Alt text" /></p>

<h3 id="æŸ¥çœ‹æ—¥å¿—è®°å½•">æŸ¥çœ‹æ—¥å¿—è®°å½•</h3>

<p>1.é€šè¿‡é¢æ¿</p>

<p>ä½ç½®å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">Control Panel\System and Security-View event logs</code></p>

<p><code class="language-plaintext highlighter-rouge">Applications and Services Logs-Microsoft-Windows-Sysmon-Operational</code></p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/2-02.png" alt="Alt text" /></p>

<p>2.é€šè¿‡powershellæŸ¥çœ‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<p>(ç®¡ç†å‘˜æƒé™)</p>

<p><code class="language-plaintext highlighter-rouge">Get-WinEvent -FilterHashtable @{logname="Microsoft-Windows-Sysmon/Operational";}</code></p>

<h3 id="ç›‘æ§å¹¶è®°å½•createremotethread">ç›‘æ§å¹¶è®°å½•CreateRemoteThread</h3>

<p>é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Sysmon schemaversion="3.20"&gt;      
&lt;!-- Capture all hashes --&gt;      
&lt;HashAlgorithms&gt;*&lt;/HashAlgorithms&gt;      
 &lt;EventFiltering&gt;        
&lt;!-- Log all drivers except if the signature --&gt;       
 &lt;!-- contains Microsoft or Windows --&gt;       
&lt;CreateRemoteThread onmatch="include"&gt;
&lt;TargetImage condition="end with"&gt;calc.exe&lt;/TargetImage&gt;
&lt;/CreateRemoteThread&gt;
 &lt;/EventFiltering&gt;    
&lt;/Sysmon&gt;
</code></pre></div></div>

<p>ä¿å­˜ä¸ºRecordCreateRemoteTh.xml</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¥é…ç½®æ–‡ä»¶è¡¨ç¤ºå¯¹è¿›ç¨‹calc.exeç›‘æ§ï¼Œå¦‚æœæ•è·åˆ°CreateRemoteThreadï¼Œå°†ä¼šå†™å…¥äº‹ä»¶æ—¥å¿—</p>

<p>å®‰è£…é…ç½®æ–‡ä»¶ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">Sysmon.exe -c RecordCreateRemoteTh.xml</code></p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/2-1.png" alt="Alt text" /></p>

<p>æŸ¥çœ‹é…ç½®ä¿¡æ¯</p>

<p><code class="language-plaintext highlighter-rouge">Sysmon.exe -c</code></p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/2-2.png" alt="Alt text" /></p>

<p>å¯åŠ¨calc.exe</p>

<p>æ‰§è¡ŒCreateRemoteTh.exeï¼Œcalc.exeè¢«æ³¨å…¥ï¼Œå¼¹æ¡†ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/2-3.png" alt="Alt text" /></p>

<p>CreateRemoteTh.exeçš„æºä»£ç å¯å‚ç…§ï¼š</p>

<p>https://github.com/3gstudent/CreateRemoteThread/blob/master/CreateRemoteThreadTest.cpp</p>

<p>æŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç°Event ID 8</p>

<p>å¦‚ä¸‹å›¾ï¼Œæ£€æµ‹åˆ°CreateRemoteThread</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/2-4.png" alt="Alt text" /></p>

<p>é€šè¿‡powershellæŸ¥çœ‹Event ID 8</p>

<p><code class="language-plaintext highlighter-rouge">Get-WinEvent -FilterHashtable @{logname="Microsoft-Windows-Sysmon/Operational";ID=8}</code></p>

<p>å¦‚ä¸‹å›¾ï¼Œè·å–æ—¥å¿—Event ID 8</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/2-5.png" alt="Alt text" /></p>

<h2 id="0x03-cå®ç°é€šè¿‡apcå¯¹dllæ³¨å…¥">0x03 c++å®ç°é€šè¿‡APCå¯¹Dllæ³¨å…¥</h2>
<hr />

<p>ä½¿ç”¨APCæ³¨å…¥ï¼š</p>

<p>ä»£ç å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Inject-dll-by-APC/blob/master/test.cpp</p>

<p>å…³äºä»£ç çš„è¯¦ç»†è¯´æ˜å¯å‚ç…§ï¼š</p>

<p>http://blogs.microsoft.co.il/pavely/2017/03/14/injecting-a-dll-without-a-remote-thread/</p>

<p>å¦‚å›¾ï¼ŒæˆåŠŸæ³¨å…¥åˆ°calc.exe</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/3-1.png" alt="Alt text" /></p>

<p>ä½¿ç”¨ProcessExploreræŸ¥çœ‹calc.exeåŠ è½½çš„dllï¼Œå¦‚ä¸‹å›¾ï¼ŒæˆåŠŸæ³¨å…¥testdll</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-4-6/3-2.png" alt="Alt text" /></p>

<p>æŸ¥çœ‹æ—¥å¿—ï¼Œå¹¶æ²¡æœ‰äº§ç”ŸEvent ID 8ï¼ŒæˆåŠŸç»•è¿‡Sysmonå¯¹CreateRemoteThreadçš„ç›‘æ§</p>

<h2 id="0x04-casey-smithsubteeåˆ†äº«çš„cå®ç°ä»£ç å’Œç”¨é€”">0x04 Casey Smith@subTeeåˆ†äº«çš„C#å®ç°ä»£ç å’Œç”¨é€”</h2>
<hr />

<p>å¯åº”ç”¨åˆ° InstallUtil.exeå’ŒMsbuild.exeçš„åˆ©ç”¨ä¸Šé¢</p>

<p><strong>InstallUtil.exeï¼š</strong></p>

<p>https://gist.github.com/subTee/7bbd8e995ed8e8b1f8dab1dc926def8a</p>

<p><strong>Msbuild.exeï¼š</strong></p>

<p>https://gist.github.com/subTee/cf3e1b06cf58fcc9e0255190d30c2d38</p>

<p>è°ƒç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰äº§ç”ŸEvent ID 8</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡å¯¹Sysmonçš„ç›‘æ§åŠŸèƒ½åšäº†æµ‹è¯•ï¼Œå¹¶ä»‹ç»å¦‚ä½•é€šè¿‡APCå®ç°Dllæ³¨å…¥ï¼Œç»•è¿‡Sysmonå¯¹CreateRemoteThreadçš„ç›‘æ§</p>

<p>åœ¨ç‰¹å®šç¯å¢ƒä¸‹ï¼Œå¦‚æœæ— æ³•æ‰‹åŠ¨å…³é—­SysmonæœåŠ¡ï¼Œåˆ©ç”¨APCèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šç»•è¿‡Sysmonå¯¹CreateRemoteThreadçš„ç›‘æ§</p>

<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p>

<p>http://subt0x10.blogspot.com/2017/01/shellcode-injection-via-queueuserapc.html</p>

<p>https://www.darkoperator.com/blog/2014/8/8/sysinternals-sysmon</p>

<p>http://www.freebuf.com/sectool/122779.html</p>

<p>http://www.cnblogs.com/uAreKongqi/p/6012353.html</p>

<p>http://blogs.microsoft.co.il/pavely/2017/03/14/injecting-a-dll-without-a-remote-thread/</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>
:ET