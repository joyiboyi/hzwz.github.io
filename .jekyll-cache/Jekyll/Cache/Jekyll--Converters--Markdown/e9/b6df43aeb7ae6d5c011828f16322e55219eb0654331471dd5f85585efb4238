I"é)<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« ã€ŠvSphereå¼€å‘æŒ‡å—1â€”â€”vSphere Automation APIã€‹å’Œã€ŠvSphereå¼€å‘æŒ‡å—2â€”â€”vSphere Web Services APIã€‹åˆ†åˆ«ä»‹ç»äº†é€šè¿‡vSphere Automation APIå’ŒvSphere Web Services APIå®ç°vCenter ServeråŒè™šæ‹Ÿæœºäº¤äº’çš„æ–¹æ³•ï¼Œæœ¬æ–‡å°†è¦ä»‹ç»é€šè¿‡PowerCLIå®ç°vCenter ServeråŒè™šæ‹Ÿæœºäº¤äº’çš„æ–¹æ³•</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>PowerCLIçš„å®‰è£…é…ç½®</li>
  <li>PowerCLIå‘½ä»¤</li>
  <li>C Sharpè°ƒç”¨PowerCLIçš„æ–¹æ³•</li>
</ul>

<h2 id="0x02-powercliçš„å®‰è£…é…ç½®">0x02 PowerCLIçš„å®‰è£…é…ç½®</h2>
<hr />

<p>PowerCLIæ˜¯ç”¨äºç®¡ç†VMwareåŸºç¡€æ¶æ„çš„PowerShellæ¨¡å—çš„é›†åˆï¼Œä¹‹å‰è¢«ç§°ä½œVI Toolkit (for Windows)</p>

<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>

<p>https://developer.vmware.com/powercli</p>

<h3 id="1powercliçš„å®‰è£…">1.PowerCLIçš„å®‰è£…</h3>

<h4 id="1åœ¨çº¿å®‰è£…">(1)åœ¨çº¿å®‰è£…</h4>

<p>PowerShellç‰ˆæœ¬æœ€ä½éœ€è¦æ»¡è¶³PowerShell 5.0</p>

<p>å®‰è£…å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install-Module -Name VMware.PowerCLI
</code></pre></div></div>

<h4 id="2ç¦»çº¿å®‰è£…">(2)ç¦»çº¿å®‰è£…</h4>

<p>ä¸‹è½½PowerCLIçš„Zipæ–‡ä»¶ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://code.vmware.com/doc/preview?id=13693</p>

<p>è·å¾—PowerShell Modulesçš„è·¯å¾„ï¼ŒPowershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$env:PSModulePath
</code></pre></div></div>

<p>é»˜è®¤å¯ç”¨çš„ä¸€ä¸ªä½ç½®ï¼š<code class="language-plaintext highlighter-rouge">C:\Program Files\WindowsPowerShell\Modules</code></p>

<p>å°†PowerCLIçš„Zipæ–‡ä»¶è§£å‹è‡³è¯¥ç›®å½•</p>

<p>è§£é”æ–‡ä»¶:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd C:\Program Files\WindowsPowerShell\Modules
Get-ChildItem * -Recurse | Unblock-File
</code></pre></div></div>

<p>ç¡®è®¤æ˜¯å¦å®‰è£…æˆåŠŸ:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Module -Name VMware.PowerCLI -ListAvailable
</code></pre></div></div>

<h3 id="2powercliçš„ä½¿ç”¨">2.PowerCLIçš„ä½¿ç”¨</h3>

<p>æ”¯æŒå‘½ä»¤çš„è¯´æ˜æ–‡æ¡£ï¼š</p>

<p>https://developer.vmware.com/docs/powercli/latest/products/vmwarevsphereandvsan/</p>

<p>é¦–å…ˆè°ƒç”¨<code class="language-plaintext highlighter-rouge">Connect-VIServer</code>è¿æ¥è‡³vCenterï¼Œæ¥ä¸‹æ¥å¯¹è™šæ‹Ÿæœºè¿›è¡Œç®¡ç†ï¼Œæœ€åéœ€è¦è°ƒç”¨<code class="language-plaintext highlighter-rouge">Disconnect-VIServer</code>æ–­å¼€è¿æ¥</p>

<p>å‚ç…§è¯´æ˜æ–‡æ¡£ï¼ŒåŒæ ·å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p>

<ul>
  <li>è¯»å–è™šæ‹Ÿæœºçš„é…ç½®</li>
  <li>æŸ¥çœ‹è™šæ‹Ÿæœºæ–‡ä»¶</li>
  <li>åˆ é™¤è™šæ‹Ÿæœºæ–‡ä»¶</li>
  <li>å‘è™šæ‹Ÿæœºä¸Šä¼ æ–‡ä»¶</li>
  <li>ä»è™šæ‹Ÿæœºä¸‹è½½æ–‡ä»¶</li>
  <li>åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œå‘½ä»¤</li>
</ul>

<p>å…·ä½“å¯¹åº”çš„å‘½ä»¤ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

<h4 id="1è¯»å–è™šæ‹Ÿæœºçš„é…ç½®">(1)è¯»å–è™šæ‹Ÿæœºçš„é…ç½®</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connect-VIServer -Server 192.168.1.1 -Protocol https -User admin -Password pass1 -Force
Get-VM
Disconnect-VIServer -Server 192.168.1.1 -Force -Confirm:$false
</code></pre></div></div>

<h4 id="2æŸ¥çœ‹è™šæ‹Ÿæœºæ–‡ä»¶">(2)æŸ¥çœ‹è™šæ‹Ÿæœºæ–‡ä»¶</h4>

<p>å¯é€šè¿‡åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œå‘½ä»¤å®ç°</p>

<h4 id="3åˆ é™¤è™šæ‹Ÿæœºæ–‡ä»¶">(3)åˆ é™¤è™šæ‹Ÿæœºæ–‡ä»¶</h4>

<p>å¯é€šè¿‡åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œå‘½ä»¤å®ç°</p>

<h4 id="4å‘è™šæ‹Ÿæœºçš„ä¸Šä¼ æ–‡ä»¶">(4)å‘è™šæ‹Ÿæœºçš„ä¸Šä¼ æ–‡ä»¶</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connect-VIServer -Server 192.168.1.1 -Protocol https -User admin -Password pass1 -Force
Copy-VMGuestFile -Source c:\text.txt -Destination c:\temp\ -VM VM -LocalToGuest  -GuestUser user -GuestPassword pass2
Disconnect-VIServer -Server 192.168.1.1 -Force -Confirm:$false
</code></pre></div></div>

<h4 id="5ä»è™šæ‹Ÿæœºä¸‹è½½æ–‡ä»¶">(5)ä»è™šæ‹Ÿæœºä¸‹è½½æ–‡ä»¶</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connect-VIServer -Server 192.168.1.1 -Protocol https -User admin -Password pass1 -Force
Copy-VMGuestFile -Source c:\text.txt -Destination c:\temp\ -VM VM -GuestToLocal -GuestUser user -GuestPassword pass2
Disconnect-VIServer -Server 192.168.1.1 -Force -Confirm:$false
</code></pre></div></div>

<h4 id="6åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œå‘½ä»¤">(6)åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œå‘½ä»¤</h4>

<p>è™šæ‹Ÿæœºç³»ç»Ÿä¸ºWindowsï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connect-VIServer -Server 192.168.1.1 -Protocol https -User admin -Password pass1 -Force
Invoke-VMScript -VM VM -ScriptText "dir" -GuestUser administrator -GuestPassword pass2
Disconnect-VIServer -Server 192.168.1.1 -Force -Confirm:$false
</code></pre></div></div>

<p>è™šæ‹Ÿæœºç³»ç»Ÿä¸ºLinuxï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connect-VIServer -Server 192.168.1.1 -Protocol https -User admin -Password pass1 -Force
Invoke-VMScript -VM VM2 -ScriptText "pwd" -GuestUser root -GuestPassword pass2
Disconnect-VIServer -Server 192.168.1.1 -Force -Confirm:$false
</code></pre></div></div>

<p><strong>æ³¨:</strong></p>

<p>å®ç°ä»¥ä¸ŠåŠŸèƒ½ä¸éœ€è¦å®Œæ•´çš„PowerCLIï¼Œæˆ‘ä»¬å¯ä»¥ä»…åœ¨<code class="language-plaintext highlighter-rouge">C:\Program Files\WindowsPowerShell\Modules</code>ä¸­ä¿ç•™ä»¥ä¸‹æ–‡ä»¶å¤¹ï¼š</p>

<ul>
  <li>VMware.PowerCLI</li>
  <li>VMware.Vim</li>
  <li>VMware.VimAutomation.Cis.Core</li>
  <li>VMware.VimAutomation.Common</li>
  <li>VMware.VimAutomation.Core</li>
  <li>VMware.VimAutomation.Sdk</li>
</ul>

<h2 id="0x03-c-sharpè°ƒç”¨powercliçš„æ–¹æ³•">0x03 C Sharpè°ƒç”¨PowerCLIçš„æ–¹æ³•</h2>
<hr />

<p>å¯ä¾›å‚è€ƒçš„ç¤ºä¾‹ä»£ç ï¼š</p>

<p>https://github.com/vmspot/vcenter-inventory</p>

<p>ä»£ç å¼•ç”¨äº†PowerCLIä¸­çš„dllï¼Œå®ç°äº†é€šè¿‡vCenter Serverå¯¹è™šæ‹Ÿæœºèµ„æºçš„è®¿é—®ï¼Œæ˜¯ä¸€ä¸ªç•Œé¢ç¨‹åº</p>

<p>åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä»£ç éœ€è¦åšä»¥ä¸‹ä¿®æ”¹ï¼š</p>

<h4 id="1ç¦ç”¨è¯ä¹¦è®¤è¯">(1)ç¦ç”¨è¯ä¹¦è®¤è¯</h4>

<p>æ·»åŠ ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System.net;
System.Net.ServicePointManager.ServerCertificateValidationCallback = ((sender, certificate, chain, sslPolicyErrors) =&gt; true);
</code></pre></div></div>

<h4 id="2é¿å…é”™è¯¯">(2)é¿å…é”™è¯¯</h4>

<p>é”™è¯¯å†…å®¹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error: An error occurred while making the HTTP request to https://&lt;ip&gt;/. This could be due to the fact that the server certificate is not configuredproperly with HTTP.SYS in the HTTPS case. This could also be caused by a mismatch of the security binding between the client and the server.
</code></pre></div></div>

<p>è§£å†³æ–¹æ³•ï¼š</p>

<p>æ·»åŠ ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Tls12;
</code></pre></div></div>

<p>æœ€ç»ˆçš„å‘½ä»¤è¡Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

using VMware.Vim;
using System.Collections.Specialized;

namespace ConsoleApplication28
{
    class Program
    {
        static void Main(string[] args)
        {
            System.Net.ServicePointManager.ServerCertificateValidationCallback = ((sender, certificate, chain, sslPolicyErrors) =&gt; true);
            System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Tls12;

            string host = "192.168.1.1";
            string username = "administrator@vsphere.local";
            string password = "Password123";

            //Create a new VIM client object that will be used to connect to vCenter's SDK service
            VimClient Client = new VimClientImpl();
            Client.Connect("https://" + host + "/sdk");
            Client.Login(username, password);

            // Get a list of Windows VM's
            NameValueCollection filter = new NameValueCollection();
            filter.Add("Config.GuestFullName", "Windows");

            List&lt;EntityViewBase&gt; vmlist = new List&lt;EntityViewBase&gt;();
            vmlist = Client.FindEntityViews(typeof(VirtualMachine), null, filter, null);

            //Populate the VM names into the VM ListBox
            foreach (VirtualMachine vm in vmlist)
            {
                Console.WriteLine(" -  vm:" + vm.Name);
                Console.WriteLine("    HostName:" + vm.Guest.HostName);
                Console.WriteLine("    IpAddress:" + vm.Guest.IpAddress);
                Console.WriteLine("    GuestState:" + vm.Guest.GuestState);              
            }

            //Get a list of ESXi hosts
            List&lt;EntityViewBase&gt; hostlist = new List&lt;EntityViewBase&gt;();
            hostlist = Client.FindEntityViews(typeof(HostSystem), null, null, null);

            //Populate the Host names into the Host ListBox
            foreach (HostSystem vmhost in hostlist)
            {                
                Console.WriteLine(vmhost.Name);
            }

        }
    }
}
</code></pre></div></div>

<p>åœ¨ç¼–è¯‘ç¨‹åºå‰ï¼Œéœ€è¦å¼•ç”¨ä»¥ä¸‹4ä¸ªdllï¼š</p>

<ul>
  <li>VimService.dllï¼Œä½äº<code class="language-plaintext highlighter-rouge">C:\Program Files\WindowsPowerShell\Modules\VMware.Vim\net45</code></li>
  <li>VMware.Binding.Wcf.dllï¼Œä½äº<code class="language-plaintext highlighter-rouge">C:\Program Files\WindowsPowerShell\Modules\VMware.Vim\net45</code></li>
  <li>VMware.Binding.WsTrust.dllï¼Œä½äº<code class="language-plaintext highlighter-rouge">C:\Program Files\WindowsPowerShell\Modules\VMware.VimAutomation.Common\net45</code></li>
  <li>VMware.Vim.dllï¼Œä½äº<code class="language-plaintext highlighter-rouge">C:\Program Files\WindowsPowerShell\Modules\VMware.Vim\net45</code></li>
</ul>

<h2 id="0x04-å°ç»“">0x04 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†é€šè¿‡PowerCLIå®ç°vCenter ServeråŒè™šæ‹Ÿæœºäº¤äº’çš„æ–¹æ³•ï¼Œç›¸æ¯”äºvSphere Automation APIå’ŒvSphere Web Services APIï¼Œä½¿ç”¨PowerCLIæ›´åŠ æ–¹ä¾¿ï¼Œä»…éœ€è¦å¼•å…¥PowerCLIåï¼Œé€šè¿‡ç®€å•çš„å‘½ä»¤å°±èƒ½å¤Ÿå®ç°åŒè™šæ‹Ÿæœºçš„äº¤äº’</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET