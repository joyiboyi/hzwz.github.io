I"²,<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« ã€Šæ¸—é€æŠ€å·§â€”â€”Pass the Hash with Remote Desktop Protocolã€‹ä»‹ç»äº†ä½¿ç”¨hashç™»å½•RDPçš„æ–¹æ³•ï¼Œæœ¬æ–‡å°†è¦ç»§ç»­ä»‹ç»ä½¿ç”¨hashç™»å½•ewsçš„æ–¹æ³•ã€‚</p>

<p>æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡<code class="language-plaintext highlighter-rouge">mimikatzçš„over pass the hash</code>å’Œ<code class="language-plaintext highlighter-rouge">ewsçš„ä½¿ç”¨å½“å‰å‡­æ®ç™»å½•</code>èƒ½å¤Ÿå®ç°ä½¿ç”¨hashç™»å½•ewsï¼Œç›¸å…³ç»†èŠ‚å¯å‚è€ƒ<a href="https://3gstudent.github.io/Exchange-Web-Service(EWS)%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97">ã€ŠExchange Web Service(EWS)å¼€å‘æŒ‡å—ã€‹</a></p>

<p>ä½†ç¼ºç‚¹æ˜¯éœ€è¦è·å¾—ç®¡ç†å‘˜æƒé™å¹¶å¯¹lsassè¿›ç¨‹è¿›è¡Œæ“ä½œï¼Œæ— æ³•åŒæ—¶å¯¹å¤šä¸ªç”¨æˆ·éªŒè¯ã€‚</p>

<p>æ‰€ä»¥æœ¬æ–‡å°†è¦ä»‹ç»æ›´ä¸ºé€šç”¨çš„æ–¹æ³•ï¼Œå¼€æºå®ç°è„šæœ¬ï¼Œè®°å½•æ€è·¯å’Œå¼€å‘è¿‡ç¨‹ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>è§£å¯†Exchangeçš„é€šä¿¡æ•°æ®</li>
  <li>ä½¿ç”¨hashç™»å½•ewsçš„æ€è·¯</li>
  <li>å¼€æºä»£ç </li>
</ul>

<h2 id="0x02-è§£å¯†exchangeçš„é€šä¿¡æ•°æ®">0x02 è§£å¯†Exchangeçš„é€šä¿¡æ•°æ®</h2>
<hr />

<p>Exchangeé»˜è®¤ä½¿ç”¨TLSåè®®å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œæˆ‘ä»¬é€šè¿‡WiresharkæŠ“åŒ…çš„æ–¹å¼åªèƒ½è·å¾—åŠ å¯†åçš„å†…å®¹ï¼Œéœ€è¦è¿›è¡Œè§£å¯†</p>

<p>è¿™é‡Œåˆ†åˆ«ä»‹ç»Exchange Serverå’ŒExchange Clientæ•è·æ˜æ–‡é€šä¿¡æ•°æ®çš„æ–¹æ³•</p>

<h3 id="1exchange-serveræ•è·æ˜æ–‡é€šä¿¡æ•°æ®çš„æ–¹æ³•">1.Exchange Serveræ•è·æ˜æ–‡é€šä¿¡æ•°æ®çš„æ–¹æ³•</h3>

<h4 id="1åœ¨exchange-serverä¸Šå¯¼å‡ºè¯ä¹¦æ–‡ä»¶">(1)åœ¨Exchange Serverä¸Šå¯¼å‡ºè¯ä¹¦æ–‡ä»¶</h4>

<p>ä½¿ç”¨mimikatzï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe crypto::capi "crypto::certificates /systemstore:local_machine /store:my /export"
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>å¦‚æœä¸ä½¿ç”¨å‘½ä»¤<code class="language-plaintext highlighter-rouge">crypto::capi</code>ï¼Œæ— æ³•å¯¼å‡ºå¸¦æœ‰ç§é’¥çš„è¯ä¹¦æ–‡ä»¶(pfxæ–‡ä»¶)</p>

<p>è¿™æ¡å‘½ä»¤ä¼šå¯¼å‡ºå¤šä¸ªè¯ä¹¦æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/2-1.png" alt="Alt text" /></p>

<p>ä¸ºäº†æ‰¾åˆ°Exchangeé€šä¿¡æ•°æ®ä½¿ç”¨çš„è¯ä¹¦æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<p>è®¿é—®Exchangeç™»å½•é¡µé¢ï¼Œé€šè¿‡æŸ¥çœ‹è¯ä¹¦çš„æœ‰æ•ˆæœŸæ‰¾åˆ°å¯¹åº”çš„è¯ä¹¦æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/2-2.png" alt="Alt text" /></p>

<p>ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå®ç°å¯¹è¯ä¹¦ä¿¡æ¯çš„è·å–ï¼Œä»£ç å¯å‚è€ƒï¼šhttps://github.com/3gstudent/Homework-of-C-Sharp/blob/master/SSLCertScan.cs</p>

<p>æµ‹è¯•å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/2-3.png" alt="Alt text" /></p>

<h4 id="2é…ç½®wireshark">(2)é…ç½®Wireshark</h4>

<p><code class="language-plaintext highlighter-rouge">Edit</code> -&gt; <code class="language-plaintext highlighter-rouge">Preferences...</code></p>

<p><code class="language-plaintext highlighter-rouge">Protocols</code> - &gt; <code class="language-plaintext highlighter-rouge">TLS</code></p>

<p>é€‰æ‹©<code class="language-plaintext highlighter-rouge">RSA keys list</code></p>

<p>å¡«å…¥é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/2-4.png" alt="Alt text" /></p>

<h4 id="3ç¦ç”¨ecdhå¯†é’¥äº¤æ¢ç®—æ³•">(3)ç¦ç”¨ECDHå¯†é’¥äº¤æ¢ç®—æ³•</h4>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/demystifying-schannel/ba-p/259233#</p>

<p>é€šè¿‡æ³¨å†Œè¡¨å…³é—­ECDHçš„cmdå‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg add hklm\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\KeyExchangeAlgorithms\ECDH /v Enabled /t REG_DWORD /d 0 /f
</code></pre></div></div>

<p>å…³é—­ä¹‹åï¼Œé€šè¿‡<a href="https://github.com/3gstudent/Homework-of-C-Sharp/blob/master/SSLCertScan.cs">SSLCertScan</a>å†æ¬¡è·å–è¯ä¹¦ä¿¡æ¯ï¼Œ<code class="language-plaintext highlighter-rouge">Key Exchange Algorithm</code>ç”±<code class="language-plaintext highlighter-rouge">ECDH Ephemeral</code>å˜ä¸º<code class="language-plaintext highlighter-rouge">RsaKeyX</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/2-5.png" alt="Alt text" /></p>

<p>è‡³æ­¤ï¼ŒExchange Serveré…ç½®å®Œæˆï¼Œå†æ¬¡æ•è·æ•°æ®ï¼Œèƒ½å¤Ÿè·å¾—æ˜æ–‡é€šä¿¡æ•°æ®ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/2-6.png" alt="Alt text" /></p>

<h3 id="2exchange-clientæ•è·æ˜æ–‡é€šä¿¡æ•°æ®çš„æ–¹æ³•">2.Exchange Clientæ•è·æ˜æ–‡é€šä¿¡æ•°æ®çš„æ–¹æ³•</h3>

<h4 id="1æ·»åŠ ç¯å¢ƒå˜é‡">(1)æ·»åŠ ç¯å¢ƒå˜é‡</h4>

<p>å˜é‡å<code class="language-plaintext highlighter-rouge">SSLKEYLOGFILE</code>ï¼Œå€¼ä¸ºæ–‡ä»¶è·¯å¾„</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/3-1.png" alt="Alt text" /></p>

<h4 id="2é…ç½®wireshark-1">(2)é…ç½®Wireshark</h4>

<p><code class="language-plaintext highlighter-rouge">Edit</code> -&gt; <code class="language-plaintext highlighter-rouge">Preferences...</code></p>

<p><code class="language-plaintext highlighter-rouge">Protocols</code> - &gt; <code class="language-plaintext highlighter-rouge">TLS</code></p>

<p>è®¾ç½®<code class="language-plaintext highlighter-rouge">(Pre)-Master-Secret log filename</code>ä¸º<code class="language-plaintext highlighter-rouge">C:\test\sslkey.log</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/3-2.png" alt="Alt text" /></p>

<p>è‡³æ­¤ï¼ŒExchange Clienté…ç½®å®Œæˆ</p>

<p>æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè®¿é—®Exchangeï¼Œä½¿ç”¨Wiresharkèƒ½å¤Ÿè·å¾—æ˜æ–‡æ•°æ®ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/3-3.png" alt="Alt text" /></p>

<h2 id="0x03-ä½¿ç”¨hashç™»å½•ewsçš„æ€è·¯">0x03 ä½¿ç”¨hashç™»å½•ewsçš„æ€è·¯</h2>
<hr />

<p>é€šè¿‡<code class="language-plaintext highlighter-rouge">mimikatzçš„over pass the hash</code>å’Œ<code class="language-plaintext highlighter-rouge">ewsçš„ä½¿ç”¨å½“å‰å‡­æ®ç™»å½•</code>èƒ½å¤Ÿå®ç°ä½¿ç”¨hashç™»å½•ewsï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨Exchange Serverå’ŒExchange Clientæ•è·æ•°æ®ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/4-1.png" alt="Alt text" /></p>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„éªŒè¯è¿‡ç¨‹ä½¿ç”¨äº†NTLM Over HTTP Protocol</p>

<p>NTLM Over HTTP Protocolçš„ç»†èŠ‚å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E9%80%9A%E8%BF%87HTTP%E5%8D%8F%E8%AE%AE%E8%8E%B7%E5%BE%97Net-NTLM-hash">ã€Šæ¸—é€æŠ€å·§â€”â€”é€šè¿‡HTTPåè®®è·å¾—Net-NTLM hashã€‹</a></p>

<p>è®¤è¯æµç¨‹ï¼š</p>

<p>1.å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªGETè¯·æ±‚ï¼Œè¯·æ±‚è·å¾—ç½‘é¡µå†…å®¹
2.æœåŠ¡å™¨ç”±äºå¼€å¯äº†NTLMè®¤è¯ï¼Œæ‰€ä»¥è¿”å›401ï¼Œæç¤ºéœ€è¦NTLMè®¤è¯
3.å®¢æˆ·ç«¯å‘èµ·NTLMè®¤è¯ï¼Œå‘æœåŠ¡å™¨å‘é€åå•†æ¶ˆæ¯
4.æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯åï¼Œç”Ÿæˆä¸€ä¸ª16ä½çš„éšæœºæ•°(è¿™ä¸ªéšæœºæ•°è¢«ç§°ä¸ºChallenge),æ˜æ–‡å‘é€å›å®¢æˆ·ç«¯
5.å®¢æˆ·ç«¯æ¥æ”¶åˆ°Challengeåï¼Œä½¿ç”¨è¾“å…¥çš„å¯†ç hashå¯¹ChallengeåŠ å¯†ï¼Œç”Ÿæˆresponseï¼Œå°†responseå‘é€ç»™æœåŠ¡å™¨
6.æœåŠ¡å™¨æ¥æ”¶å®¢æˆ·ç«¯åŠ å¯†åçš„responseï¼Œç»è¿‡åŒæ ·çš„è¿ç®—ï¼Œæ¯”è¾ƒç»“æœï¼Œè‹¥åŒ¹é…ï¼Œæä¾›åç»­æœåŠ¡ï¼Œå¦åˆ™ï¼Œè®¤è¯å¤±è´¥</p>

<p>å¯¹äºæ­¥éª¤5:â€ä½¿ç”¨è¾“å…¥çš„å¯†ç hashå¯¹ChallengeåŠ å¯†â€</p>

<p>å¦‚æœæˆ‘ä»¬ç›´æ¥ä¼ å…¥hashï¼Œå¯¹ChallengeåŠ å¯†ï¼Œä¹Ÿèƒ½å®ç°ç›¸åŒçš„åŠŸèƒ½</p>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¾—å‡ºäº†ä½¿ç”¨hashç™»å½•ewsçš„å®ç°æ€è·¯ï¼š</p>

<p>æ¨¡æ‹ŸNTLM Over HTTP Protocolï¼Œç›´æ¥ä¼ å…¥hashï¼Œå¯¹ChallengeåŠ å¯†ï¼Œç”Ÿæˆresponseï¼Œå°†responseå‘é€ç»™æœåŠ¡å™¨</p>

<h2 id="0x04-ç¨‹åºå®ç°">0x04 ç¨‹åºå®ç°</h2>
<hr />

<p>è¿™é‡Œé€‰ç”¨Pythonå®ç°ï¼Œä¼˜ç‚¹æ˜¯å¯ç›´æ¥è°ƒç”¨Impacketå®ç°NTLM Over HTTP Protocol</p>

<p>å‚è€ƒä»£ç ï¼š</p>

<p>https://github.com/dirkjanm/PrivExchange/blob/master/privexchange.py</p>

<p>è„šæœ¬è¿è¡Œå‰éœ€è¦å®‰è£…Impacket</p>

<p>å®‰è£…æ–¹æ³•ï¼š<code class="language-plaintext highlighter-rouge">pip install Impacket</code></p>

<p>æˆ‘çš„å®ç°ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-Python/blob/master/checkEWS.py</p>

<p>ä»£ç åˆ†åˆ«æ”¯æŒå¯¹æ˜æ–‡å’Œntlm hashçš„éªŒè¯</p>

<p>éªŒè¯æ˜æ–‡ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/5-1.png" alt="Alt text" /></p>

<p>éªŒè¯hashï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2020-5-12/5-2.png" alt="Alt text" /></p>

<p>æˆ‘çš„ä»£ç åœ¨éªŒè¯æˆåŠŸåï¼Œä¼šæ¥ç€å‘é€soapå‘½ä»¤è·å¾—æ”¶ä»¶ç®±çš„ä¿¡æ¯</p>

<p>å…³äºsoapå‘½ä»¤çš„æ ¼å¼å¯å‚è€ƒï¼š</p>

<p>https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-operations-in-exchange</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯èµ„æ–™ä¸­çš„soapå‘½ä»¤éœ€è¦è°ƒæ•´æ ¼å¼ï¼Œå¦åˆ™æŠ¥é”™è¿”å›<code class="language-plaintext highlighter-rouge">500</code>ï¼Œæç¤º<code class="language-plaintext highlighter-rouge">An internal server error occurred. The operation failed.</code></p>

<p>è°ƒæ•´æ ¼å¼å®ä¾‹ï¼š</p>

<p>https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/getfolder-operationä¸­çš„soapæ ¼å¼å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
   xmlns:t="https://schemas.microsoft.com/exchange/services/2006/types"&gt;
  &lt;soap:Body&gt;
    &lt;GetFolder xmlns="https://schemas.microsoft.com/exchange/services/2006/messages"
               xmlns:t="https://schemas.microsoft.com/exchange/services/2006/types"&gt;
      &lt;FolderShape&gt;
        &lt;t:BaseShape&gt;Default&lt;/t:BaseShape&gt;
      &lt;/FolderShape&gt;
      &lt;FolderIds&gt;
        &lt;t:DistinguishedFolderId Id="inbox"/&gt;
      &lt;/FolderIds&gt;
    &lt;/GetFolder&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;
</code></pre></div></div>

<p>è°ƒæ•´æ ¼å¼åçš„å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
               xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages" 
               xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types" 
               xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soap:Body&gt;
    &lt;m:GetFolder&gt;
      &lt;m:FolderShape&gt;
        &lt;t:BaseShape&gt;Default&lt;/t:BaseShape&gt;
      &lt;/m:FolderShape&gt;
      &lt;m:FolderIds&gt;
        &lt;t:DistinguishedFolderId Id="inbox"/&gt;
      &lt;/m:FolderIds&gt;
    &lt;/m:GetFolder&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;
</code></pre></div></div>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†ä½¿ç”¨Wiresharkè§£å¯†Exchangeé€šä¿¡æ•°æ®çš„æ–¹æ³•ï¼Œä»‹ç»ä½¿ç”¨hashç™»å½•ewsçš„æ–¹æ³•ï¼Œå¼€æºå®ç°è„šæœ¬ï¼Œè®°å½•æ€è·¯å’Œå¼€å‘è¿‡ç¨‹ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET