I"Ÿ&<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>SharpSniperç”¨äºåœ¨åŸŸç¯å¢ƒä¸­æ‰¾åˆ°æŒ‡å®šåŸŸç”¨æˆ·çš„IPåœ°å€ï¼Œéœ€è¦å…·æœ‰è¯»å–åŸŸæ§åˆ¶å™¨æ—¥å¿—çš„æƒé™ï¼Œåœ°å€ï¼šhttps://github.com/HunnicCyber/SharpSniper</p>

<p>æœ¬æ–‡å°†è¦å¯¹SharpSniperçš„å®ç°åŸç†è¿›è¡Œåˆ†æï¼Œæ‰©å±•ç”¨æ³•ï¼Œåˆ†åˆ«ä»‹ç»å¦‚ä½•ä½¿ç”¨wevtutil.exeå’Œpowershellè„šæœ¬å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼Œåˆ†äº«å…¶ä¸­éœ€è¦æ³¨æ„çš„ç»†èŠ‚ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>SharpSniperå®ç°åŸç†</li>
  <li>ä½¿ç”¨wevtutilå®ç°</li>
  <li>ä½¿ç”¨powershellå®ç°</li>
</ul>

<h2 id="0x02-sharpsniperå®ç°åŸç†">0x02 SharpSniperå®ç°åŸç†</h2>
<hr />

<p>é€šè¿‡æŸ¥è¯¢åŸŸæ§åˆ¶å™¨ä¸Šçš„ç”¨æˆ·ç™»å½•æ—¥å¿—(Event ID:4624)ï¼Œè·å¾—åŸŸç”¨æˆ·ä½¿ç”¨è¿‡çš„IPåœ°å€</p>

<p>å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>

<h3 id="1é€šè¿‡æŸ¥è¯¢æ—¥å¿—è·å¾—åŸŸç”¨æˆ·ä½¿ç”¨è¿‡çš„ip">1.é€šè¿‡æŸ¥è¯¢æ—¥å¿—è·å¾—åŸŸç”¨æˆ·ä½¿ç”¨è¿‡çš„IP</h3>

<p>XPathæŸ¥è¯¢æ¡ä»¶(ä»¥æŸ¥è¯¢ç”¨æˆ·testbä¸ºä¾‹)ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"Event[System[(EventID=4624)] and EventData[Data[@Name='TargetUserName']='testb']]"
</code></pre></div></div>

<p>å¯¹åº”ä»£ç åœ°å€ï¼š
https://github.com/HunnicCyber/SharpSniper/blob/master/QueryDC.cs#L16</p>

<h3 id="2é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤å‡ºåŸŸç”¨æˆ·ä½¿ç”¨è¿‡çš„ip">2.é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤å‡ºåŸŸç”¨æˆ·ä½¿ç”¨è¿‡çš„IP</h3>

<p>æ­£åˆ™è¡¨è¾¾å¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b"
</code></pre></div></div>

<ul>
  <li>\bè¡¨ç¤ºå•è¯çš„å‰æˆ–åè¾¹ç•Œ</li>
  <li>\d{1,3}è¡¨ç¤ºå­—ç¬¦ä¸ªæ•°åœ¨1åˆ°3ä½ä¹‹é—´</li>
  <li>.è¡¨ç¤ºåŒ¹é…å­—ç¬¦â€.â€</li>
</ul>

<p>å¯¹åº”ä»£ç åœ°å€ï¼š</p>

<p>https://github.com/HunnicCyber/SharpSniper/blob/master/Program.cs#L54</p>

<h2 id="0x03-ä½¿ç”¨wevtutilå®ç°">0x03 ä½¿ç”¨wevtutilå®ç°</h2>
<hr />

<h3 id="1æŸ¥è¯¢æŒ‡å®šç”¨æˆ·ä»¥æŸ¥è¯¢ç”¨æˆ·testbä¸ºä¾‹çš„ç™»å½•æ—¥å¿—">1.æŸ¥è¯¢æŒ‡å®šç”¨æˆ·(ä»¥æŸ¥è¯¢ç”¨æˆ·testbä¸ºä¾‹)çš„ç™»å½•æ—¥å¿—</h3>

<p>cmdå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wevtutil qe security /format:text /q:"Event[System[(EventID=4624)] and EventData[Data[@Name='TargetUserName']='testb']]"
</code></pre></div></div>

<p>åŒ…æ‹¬æ¯æ¡æ—¥å¿—çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/2-1.png" alt="Alt text" /></p>

<h3 id="2ä»è¯¦ç»†ä¿¡æ¯ä¸­æå–å‡ºip">2.ä»è¯¦ç»†ä¿¡æ¯ä¸­æå–å‡ºip</h3>

<p>è¿™é‡Œå¯ä»¥å€ŸåŠ©<code class="language-plaintext highlighter-rouge">find</code>å‘½ä»¤è¿›è¡Œç­›é€‰</p>

<p>cmdå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wevtutil qe security /format:text /q:"Event[System[(EventID=4624)] and EventData[Data[@Name='TargetUserName']='testb']]"|find "Source Network Address"
</code></pre></div></div>

<p>ç­›é€‰åçš„ç»“æœå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/2-2.png" alt="Alt text" /></p>

<p>ä»æ—¥å¿—ä¸­æå–å‡ºç”¨æˆ·testbä½¿ç”¨è¿‡çš„æ‰€æœ‰IPåœ°å€</p>

<h3 id="è¡¥å……xpathæŸ¥è¯¢æ¡ä»¶çš„ç¼–å†™">è¡¥å……ï¼šXPathæŸ¥è¯¢æ¡ä»¶çš„ç¼–å†™</h3>

<p>å¯ä»¥ä½¿ç”¨Event Viewerè‡ªåŠ¨ç”Ÿæˆéœ€è¦çš„XPathè¯­å¥</p>

<p>1.æ‰“å¼€Event Viewer</p>

<p>cmdæ‰§è¡Œï¼š<code class="language-plaintext highlighter-rouge">eventvwr.msc</code></p>

<p>2.é€‰æ‹©<code class="language-plaintext highlighter-rouge">Create Custom View..</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/3-1.png" alt="Alt text" /></p>

<p>3.è®¾ç½®æŸ¥è¯¢æ¡ä»¶åé€‰æ‹©XMLæ ‡ç­¾</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/3-2.png" alt="Alt text" /></p>

<p>è‡ªåŠ¨ç”Ÿæˆéœ€è¦çš„XPathè¯­å¥ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/3-3.png" alt="Alt text" /></p>

<p>4.ä½¿ç”¨wevtutilè°ƒç”¨æŸ¥è¯¢è¯­å¥çš„ä¸¤ç§æ–¹æ³•</p>

<p>(1)æŒ‰ç…§/qå‚æ•°çš„æ ¼å¼è¿›è¡Œä¿®æ”¹</p>

<p>éœ€è¦æå–è‡ªåŠ¨ç”Ÿæˆçš„XPathè¯­å¥ä¸­Selectæ ‡ç­¾ä¸­çš„å†…å®¹</p>

<p>(2)é€šè¿‡è¯»å–æ–‡ä»¶è°ƒç”¨æŸ¥è¯¢</p>

<p>ç›´æ¥ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„XPathè¯­å¥</p>

<p>å°†æ­¥éª¤3ä¸­çš„æŸ¥è¯¢è¯­å¥ä¿å­˜åˆ°æ–‡ä»¶ï¼Œä¾‹å¦‚custom1.xml</p>

<p>è¯»å–æ–‡ä»¶è°ƒç”¨æŸ¥è¯¢çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wevtutil qe custom1.xml /sq:true /rd:true /f:text
</code></pre></div></div>

<h2 id="0x04-ä½¿ç”¨powershellå®ç°">0x04 ä½¿ç”¨powershellå®ç°</h2>
<hr />

<h3 id="1æŸ¥è¯¢æŒ‡å®šç”¨æˆ·ä»¥æŸ¥è¯¢ç”¨æˆ·testbä¸ºä¾‹çš„ç™»å½•æ—¥å¿—-1">1.æŸ¥è¯¢æŒ‡å®šç”¨æˆ·(ä»¥æŸ¥è¯¢ç”¨æˆ·testbä¸ºä¾‹)çš„ç™»å½•æ—¥å¿—</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-WinEvent -LogName "security" -FilterXPath "Event[System[(EventID=4624)] and EventData[Data[@Name='TargetUserName']='testb']]"|Format-List
</code></pre></div></div>

<p>åŒ…æ‹¬æ¯æ¡æ—¥å¿—çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/4-1.png" alt="Alt text" /></p>

<h3 id="2ä»è¯¦ç»†ä¿¡æ¯ä¸­æå–å‡ºipçš„ä¸‰ç§æ–¹æ³•">2.ä»è¯¦ç»†ä¿¡æ¯ä¸­æå–å‡ºipçš„ä¸‰ç§æ–¹æ³•</h3>

<h4 id="1ä½¿ç”¨findå‘½ä»¤">(1)ä½¿ç”¨findå‘½ä»¤</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-WinEvent -LogName "security" -FilterXPath "Event[System[(EventID=4624)] and EventData[Data[@Name='TargetUserName']='testb']]"|Format-List|find "Source Network Address"
</code></pre></div></div>

<p>ç»“æœå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/4-2.png" alt="Alt text" /></p>

<h4 id="2é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œè¿‡æ»¤">(2)é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œè¿‡æ»¤</h4>

<p>ç¬¬ä¸€ç§å®ç°æ–¹æ³•ï¼š</p>

<p>ä½¿ç”¨SharpSniperä¸­çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯¹åº”çš„powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$events = Get-WinEvent -LogName "security" -FilterXPath "Event[System[(EventID=4624)] and EventData[Data[@Name='TargetUserName']='testb']]"
$i=0
while ($i -lt $events.length) {
    $IP=[regex]::matches($events[$i].Message, '\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b')
    Write-Host $IP
    $i++
}
</code></pre></div></div>

<p>ç»“æœå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/4-3.png" alt="Alt text" /></p>

<p>ç¬¬äºŒç§å®ç°æ–¹æ³•ï¼š</p>

<p>æœç´¢å…³é”®è¯<code class="language-plaintext highlighter-rouge">"Source Network Address:"</code>ï¼Œå¯¹åº”çš„powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$events = Get-WinEvent -LogName "security" -FilterXPath "Event[System[(EventID=4624)] and EventData[Data[@Name='TargetUserName']='testb']]"
$i=0
while ($i -lt $events.length) {
    $IP=[regex]::matches($events[$i].Message, 'Source Network Address:(.+)') | %{$_.Groups[1].Value.Trim()}
    Write-Host $IP
    $i++
}
</code></pre></div></div>

<p>ç»“æœå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/4-4.png" alt="Alt text" /></p>

<h4 id="3å…ˆè½¬æ¢æˆxmlæ ¼å¼å†è¿›è¡Œç­›é€‰">(3)å…ˆè½¬æ¢æˆxmlæ ¼å¼ï¼Œå†è¿›è¡Œç­›é€‰</h4>

<p>åœ¨è¾“å‡ºæ—¶ï¼Œåªæœ‰Messageåˆ—ï¼Œæ— æ³•é€‰æ‹©åªè¾“å‡ºâ€Source Network Addressâ€çš„å†…å®¹</p>

<p>è¿™é‡Œå¦‚æœå°†è¾“å‡ºå†…å®¹è½¬æ¢ä¸ºxmlæ ¼å¼ï¼Œ<code class="language-plaintext highlighter-rouge">"Source Network Address"</code>å¯¹åº”çš„åˆ—ä¸º<code class="language-plaintext highlighter-rouge">ipaddress</code></p>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://blog.51cto.com/beanxyz/1695288</p>

<p>å¯¹åº”çš„powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$Events = Get-WinEvent -LogName "security" -FilterXPath "Event[System[(EventID=4624)] and EventData[Data[@Name='TargetUserName']='testb']]"     
ForEach ($Event in $Events) {       
  $eventXML = [xml]$Event.ToXml()         
  For ($i=0; $i -lt $eventXML.Event.EventData.Data.Count; $i++) {   
    Add-Member -InputObject $Event -MemberType NoteProperty -Force -Name $eventXML.Event.EventData.Data[$i].name -Value $eventXML.Event.EventData.Data[$i].'#text'     
  }       
}       
$events|select ipaddress
</code></pre></div></div>

<p>ç»“æœå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-16/4-5.png" alt="Alt text" /></p>

<h3 id="è¡¥å……ä½¿ç”¨powershellè°ƒç”¨è‡ªåŠ¨ç”Ÿæˆçš„xpathæŸ¥è¯¢æ¡ä»¶">è¡¥å……ï¼šä½¿ç”¨powershellè°ƒç”¨è‡ªåŠ¨ç”Ÿæˆçš„XPathæŸ¥è¯¢æ¡ä»¶</h3>

<p>å‚ç…§0x03ä¸­çš„å†…å®¹ï¼Œä½¿ç”¨Event Viewerè‡ªåŠ¨ç”Ÿæˆéœ€è¦çš„XPathè¯­å¥</p>

<p>ç›´æ¥ä¿å­˜åœ¨å˜é‡<code class="language-plaintext highlighter-rouge">$xml</code>ä¸­å¹¶è¿›è¡Œè°ƒç”¨ï¼Œå¯¹åº”çš„powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$xml = @'

&lt;QueryList&gt;
  &lt;Query Id="0" Path="Security"&gt;
    &lt;Select Path="Security"&gt;*[System[(EventID=4624) and TimeCreated[timediff(@SystemTime) &amp;lt;= 604800000]]]&lt;/Select&gt;
  &lt;/Query&gt;
&lt;/QueryList&gt;

'@

Get-WinEvent -FilterXml $xml
</code></pre></div></div>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡åˆ†æäº†SharpSniperçš„å®ç°åŸç†ï¼Œæ‰©å±•ç”¨æ³•ï¼Œåˆ†åˆ«ä»‹ç»å¦‚ä½•ä½¿ç”¨wevtutil.exeå’Œpowershellè„šæœ¬å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼Œå¯ä»¥ç”¨æ¥è·å–åŸŸç¯å¢ƒä¸­å…³é”®ç”¨æˆ·ä½¿ç”¨è¿‡çš„IPã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET