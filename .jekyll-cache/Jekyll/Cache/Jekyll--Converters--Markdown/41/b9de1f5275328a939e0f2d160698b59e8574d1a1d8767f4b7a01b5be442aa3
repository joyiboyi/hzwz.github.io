I"Ş$<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨Windowsç³»ç»Ÿä¸­ï¼Œä½¿ç”¨net useå‘½ä»¤èƒ½å¤Ÿå®ç°è¿œç¨‹è¿æ¥ç½‘ç»œä¸­å…¶ä»–è®¡ç®—æœºçš„å…±äº«èµ„æºï¼Œè¿æ¥å»ºç«‹åä¼šåˆ›å»ºä¸€ä¸ªnet sessionã€‚
åœ¨æ¸—é€æµ‹è¯•ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è·å¾—äº†ä¸€å°Windowsä¸»æœºçš„æƒé™ï¼Œåœ¨ä¸Šé¢å‘ç°äº†net sessionï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªnet sessionï¼Œä½¿ç”¨net sessionçš„tokenåˆ›å»ºè¿›ç¨‹ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>æŸ¥çœ‹net sessionçš„æ–¹æ³•</li>
  <li>net sessionçš„åˆ©ç”¨</li>
  <li>net sessionçš„æ¸…é™¤</li>
  <li>åˆ©ç”¨æ€è·¯</li>
  <li>é˜²å¾¡å»ºè®®</li>
</ul>

<h2 id="0x02-æµ‹è¯•ç¯å¢ƒ">0x02 æµ‹è¯•ç¯å¢ƒ</h2>
<hr />

<p>COMPUTER01ï¼š</p>

<ul>
  <li>Win7 x64</li>
  <li>åŸŸå†…ä¸€å°ä¸»æœº</li>
  <li>192.168.10.2</li>
  <li>ä½¿ç”¨å¸å·test1ç™»å½•</li>
</ul>

<p>DC:</p>

<ul>
  <li>Server2008 R2x64</li>
  <li>åŸŸæ§æœåŠ¡å™¨</li>
  <li>192.168.10.1</li>
</ul>

<p>åœ¨DCä¸Šä½¿ç”¨åŸŸç®¡ç†å‘˜å¸å·Administratoré€šè¿‡net useè¿œç¨‹è¿æ¥COMPUTER01ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/2-1.png" alt="Alt text" /></p>

<h2 id="0x03-æŸ¥çœ‹net-sessionçš„æ–¹æ³•">0x03 æŸ¥çœ‹net sessionçš„æ–¹æ³•</h2>
<hr />

<h3 id="1cmdå‘½ä»¤">1ã€cmdå‘½ä»¤</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net session
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/3-1.png" alt="Alt text" /></p>

<h3 id="2logonsessions">2ã€LogonSessions</h3>

<p>ä¸‹è½½åœ°å€ï¼š</p>

<p>https://docs.microsoft.com/en-us/sysinternals/downloads/logonsessions</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/3-2.png" alt="Alt text" /></p>

<p>å¯ä»¥å‘ç°ï¼Œnet sessionçš„Logon typeä¸ºNetwork</p>

<h3 id="3cå®ç°">3ã€c++å®ç°</h3>

<p>é¦–å…ˆé€šè¿‡Windows API LsaEnumerateLogonSessions()æšä¸¾å½“å‰çš„Logon Session</p>

<p>æ¥ç€ä½¿ç”¨LsaGetLogonSessionData()è·å¾—æ¯ä¸ªLogon Sessionçš„å…·ä½“ä¿¡æ¯</p>

<p>åœ¨ç¨‹åºç¼–å†™ä¸Šéœ€è¦æ³¨æ„æ— æ³•ç›´æ¥æ˜¾ç¤ºsidå’Œæ—¶é—´ï¼Œéœ€è¦å¯¹æ ¼å¼è¿›è¡Œè½¬æ¢</p>

<p>å¼€æºä»£ç åœ°å€ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/ListLogonSessions.cpp</p>

<p>ä»£ç æŒ‰ç…§LogonSessionsçš„æ ¼å¼è¾“å‡ºç»“æœ</p>

<h3 id="4mimikatz">4ã€mimikatz</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>privilege::debug
token::list
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/3-3.png" alt="Alt text" /></p>

<p>TEST\Administratorå¯¹åº”çš„IDä¸º6919466</p>

<h4 id="è¡¥å……mimikatzçš„å‘½ä»¤">è¡¥å……mimikatzçš„å‘½ä»¤</h4>

<p>æŸ¥çœ‹å½“å‰tokenï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token::whoami
</code></pre></div></div>

<p>æ¢å¤è¿›ç¨‹tokenï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token::revert
</code></pre></div></div>

<p>å‡å†’æˆsystemï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token::elevate
</code></pre></div></div>

<p>å‡å†’æˆdomain adminï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token::elevate /domainadmin
</code></pre></div></div>

<p>å‡å†’æˆenterprise adminï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token::elevate /enterpriseadmin
</code></pre></div></div>

<p>å‡å†’æˆadminï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token::elevate /admin
</code></pre></div></div>

<p>å‡å†’æˆidä¸º123456çš„tokenï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token::elevate /id:123456
</code></pre></div></div>

<h2 id="0x04-net-sessionçš„åˆ©ç”¨">0x04 net sessionçš„åˆ©ç”¨</h2>
<hr />

<p>net sessionçš„tokenä¿å­˜åœ¨lsassè¿›ç¨‹ä¸­ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/3-0.png" alt="Alt text" /></p>

<p>åœ¨åˆ©ç”¨ä¸Šï¼Œnet sessionç­‰åŒäºå¯¹å…¶tokençš„åˆ©ç”¨</p>

<h3 id="1mimikatz">1ã€mimikatz</h3>

<p>å‡å†’æˆidä¸º6919466çš„tokenï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token::elevate /id:6919466
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/3-4.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä¸Šè¿°æ“ä½œåªæ”¹å˜äº†Thread Token</p>

<p>Windowsä¸‹æœ‰ä¸¤ç§tokenï¼šPrimary Tokenå’ŒImpersonation Token</p>

<p>Primary Tokenå¯¹åº”Process Tokenï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å”¯ä¸€çš„Primary Token</p>

<p>Impersonation Tokenå¯¹åº”Thread Tokenï¼Œå¯ä»¥è¢«ä¿®æ”¹</p>

<p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨è¯¥tokenåˆ›å»ºè¿›ç¨‹cmd.exeï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>process::start cmd.exe
</code></pre></div></div>

<p>ä½†æ˜¯è¯¥å‘½ä»¤ä¸ä¼šä½¿ç”¨æ–°çš„Thread Tokenï¼Œä¹Ÿå°±æ˜¯è¯´è¿›ç¨‹cmd.exeå¹¶æ²¡æœ‰ä»¥TEST\Administratorå¯åŠ¨</p>

<h4 id="åŸå› å¦‚ä¸‹">åŸå› å¦‚ä¸‹ï¼š</h4>

<p>https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimikatz/modules/kuhl_m_process.c#L38</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/3-5.png" alt="Alt text" /></p>

<p>https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_process.c#L490</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/3-6.png" alt="Alt text" /></p>

<p>mimikatzåœ¨æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">process::start</code>å‘½ä»¤æ—¶ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">CreateProcess</code>åˆ›å»ºè¿›ç¨‹ï¼Œå¹¶æ²¡æœ‰ä¼ å…¥token</p>

<h4 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•ï¼š</h4>

<p>ä¿®æ”¹mimikatzçš„æºç ï¼Œä½¿ç”¨CreateProcessAsUser()åˆ›å»ºè¿›ç¨‹ï¼Œèƒ½å¤Ÿä¼ å…¥Token</p>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–å·¥å…·æ¥å®ç°è¿™ä¸ªè¿‡ç¨‹</p>

<h3 id="2ä½¿ç”¨incognito">2ã€ä½¿ç”¨incognito</h3>

<p>æºä»£ç å¼€æºåœ°å€ï¼š</p>

<p>https://github.com/fdiskyou/incognito2</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Token%E7%AA%83%E5%8F%96%E4%B8%8E%E5%88%A9%E7%94%A8">ã€Šæ¸—é€æŠ€å·§â€”â€”Tokençªƒå–ä¸åˆ©ç”¨ã€‹</a>æ›¾ä»‹ç»è¿‡incognitoçš„ç”¨æ³•</p>

<p>åˆ—å‡ºå½“å‰tokenï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>incognito.exe list_tokens -u
</code></pre></div></div>

<p>ä»¥â€TEST\Administratorâ€å¯åŠ¨cmd.exeï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>incognito.exe execute -c "TEST\Administrator" cmd.exe
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/4-1.png" alt="Alt text" /></p>

<p>net sessionåˆ©ç”¨æˆåŠŸï¼Œä»¥ç”¨æˆ·â€TEST\Administratorâ€å¯åŠ¨è¿›ç¨‹cmd.exeï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-12-3/4-2.png" alt="Alt text" /></p>

<h2 id="0x05-net-sessionçš„æ¸…é™¤">0x05 net sessionçš„æ¸…é™¤</h2>
<hr />

<h3 id="1cmdå‘½ä»¤-1">1ã€cmdå‘½ä»¤</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net session /delete /y
</code></pre></div></div>

<h3 id="2åˆ é™¤net-useè¿æ¥">2ã€åˆ é™¤net useè¿æ¥</h3>

<p>net useçš„å‘èµ·æ–¹åˆ é™¤è¿æ¥ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net use * /del /y
</code></pre></div></div>

<h2 id="0x06-åˆ©ç”¨æ€è·¯">0x06 åˆ©ç”¨æ€è·¯</h2>
<hr />

<h3 id="1æœ¬åœ°ææƒ">1ã€æœ¬åœ°ææƒ</h3>

<p>å¦‚æœå°šæœªè·å¾—æœ¬åœ°ç®¡ç†å‘˜æƒé™ï¼Œä½†è·å¾—äº†SeImpersonateæˆ–è€…SeAssignPrimaryTokenæƒé™ï¼Œå°±èƒ½åˆ©ç”¨net sessionä¸­çš„tokenåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå®ç°ææƒ</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/Windows%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E5%B7%A5%E5%85%B7Juicy-Potato%E6%B5%8B%E8%AF%95%E5%88%86%E6%9E%90">ã€ŠWindowsæœ¬åœ°ææƒå·¥å…·Juicy Potatoæµ‹è¯•åˆ†æã€‹</a>å’Œ<a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90%E7%9A%84%E5%88%A9%E7%94%A8">ã€Šæ¸—é€æŠ€å·§â€”â€”Windowsä¹ç§æƒé™çš„åˆ©ç”¨ã€‹</a>æåˆ°è¿‡è¿™ä¸ªæ–¹æ³•</p>

<h3 id="2åŸŸå†…æ¸—é€">2ã€åŸŸå†…æ¸—é€</h3>

<p>å–å†³äºnet sessionçš„æƒé™ï¼Œæ–°åˆ›å»ºçš„è¿›ç¨‹èƒ½å¤Ÿç»§æ‰¿net sessionçš„token</p>

<h2 id="0x07-é˜²å¾¡å»ºè®®">0x07 é˜²å¾¡å»ºè®®</h2>
<hr />

<p>1ã€åŸŸç¯å¢ƒå†…é™åˆ¶ç”¨æˆ·æƒé™ï¼Œå°½é‡é¿å…ä½¿ç”¨åŸŸç®¡ç†å‘˜å¸æˆ·è¿œç¨‹è¿æ¥
2ã€ä½¿ç”¨net useè¿œç¨‹è¿æ¥åè®°å¾—åŠæ—¶æ¸…é™¤</p>

<h2 id="0x08-å°ç»“">0x08 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åˆ©ç”¨net sessionçš„tokenåˆ›å»ºè¿›ç¨‹çš„æ–¹æ³•ï¼Œåˆ†æåˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET