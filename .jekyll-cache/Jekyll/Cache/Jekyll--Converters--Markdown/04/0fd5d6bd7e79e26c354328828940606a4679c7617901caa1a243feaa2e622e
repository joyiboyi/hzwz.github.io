I"ğ/<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-DNS%E8%AE%B0%E5%BD%95%E7%9A%84%E8%8E%B7%E5%8F%96">ã€ŠåŸŸæ¸—é€â€”â€”DNSè®°å½•çš„è·å–ã€‹</a>å’Œ<a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E8%8E%B7%E5%BE%97DNS%E8%AE%B0%E5%BD%95">ã€ŠåŸŸæ¸—é€â€”â€”æ™®é€šç”¨æˆ·æƒé™è·å¾—DNSè®°å½•ã€‹</a>ä»‹ç»äº†åœ¨åŸŸç¯å¢ƒä¸‹è·å¾—DNSè®°å½•çš„æ–¹æ³•ï¼Œæœ‰åŠ©äºæˆ‘ä»¬å¿«é€Ÿäº†è§£åŸŸå†…çš„ç½‘ç»œæ¶æ„ã€‚</p>

<p>ä½†æ˜¯ï¼ŒDNSè®°å½•åªèƒ½ä½œä¸ºè¾…åŠ©åˆ¤æ–­ï¼ŒDNSè®°å½•ã€DNSè®°å½•ä¸­å¯¹åº”çš„MachineAccount(æœºå™¨å¸æˆ·)å’Œå®é™…çš„è®¡ç®—æœºä¸‰è€…ä¹‹é—´ä¸å­˜åœ¨å¯¹åº”å…³ç³»</p>

<p>åŸŸå†…çš„éç‰¹æƒç”¨æˆ·èƒ½å¤Ÿè‡ªç”±åˆ›å»ºDNSè®°å½•å’ŒMachineAccount</p>

<p>æœ¬æ–‡å°†è¦ä»‹ç»åŸŸå†…éç‰¹æƒç”¨æˆ·åˆ›å»ºDNSè®°å½•ä¸MachineAccountçš„æ–¹æ³•ï¼Œè®°å½•éœ€è¦æŒæ¡çš„çŸ¥è¯†ç‚¹</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>MachineAccountç®€ä»‹</li>
  <li>éç‰¹æƒç”¨æˆ·åˆ›å»ºMachineAccountçš„æ–¹æ³•</li>
  <li>éç‰¹æƒç”¨æˆ·åˆ›å»ºDNSè®°å½•çš„æ–¹æ³•</li>
</ul>

<h2 id="0x02-machineaccountç®€ä»‹">0x02 MachineAccountç®€ä»‹</h2>
<hr />

<h3 id="1machineaccount">1.MachineAccount</h3>

<p>æ¯å½“ä¸€ä¸ªè®¡ç®—æœºåŠ å…¥åŸŸä¸­ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæœºå™¨å¸æˆ·(MachineAccount)ï¼Œä½œä¸ºâ€Domain Computersâ€ç»„çš„æˆå‘˜</p>

<p>åœ¨åŸŸç¯å¢ƒä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è·å¾—æ‰€æœ‰æœºå™¨å¸æˆ·çš„åˆ—è¡¨:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net group "Domain Computers" /domain
</code></pre></div></div>

<p>æ¯ä¸€ä¸ªæœºå™¨å¸æˆ·åä»¥å­—ç¬¦<code class="language-plaintext highlighter-rouge">$</code>ç»“å°¾</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä½¿ç”¨Mimikatzçš„DCSyncåŠŸèƒ½å¯¼å‡ºæ‰€æœ‰ç”¨æˆ·hashæ—¶ï¼Œä¹Ÿä¼šå¯¼å‡ºæ‰€æœ‰æœºå™¨å¸æˆ·çš„hash</p>

<p>å¦‚æœè·å¾—äº†æœºå™¨å¸æˆ·çš„hashï¼Œå¯ä»¥ç”¨æ¥åˆ¶ä½œç™½é“¶ç¥¨æ®(Silver Ticket)ï¼Œæ¥ç€è·å¾—å¯¹åº”æœåŠ¡çš„è®¿é—®æƒé™ï¼Œåˆ©ç”¨æ–¹æ³•å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ã€ŠåŸŸæ¸—é€â€”â€”Pass The Ticketã€‹</p>

<h3 id="2machineaccountquota">2.MachineAccountQuota</h3>

<p>ç”¨æ¥è¡¨ç¤ºå…è®¸ç”¨æˆ·åœ¨åŸŸä¸­åˆ›å»ºçš„è®¡ç®—æœºå¸æˆ·æ•°ï¼Œé»˜è®¤ä¸º10</p>

<p>è¯´æ˜æ–‡æ¡£ï¼š</p>

<p>https://docs.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota</p>

<p>å…³äºMachineAccountQuota(MAQ)çš„ä»‹ç»å¯å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://blog.netspi.com/machineaccountquota-is-useful-sometimes/</p>

<p>è¿™é‡Œä»…å¯¹å‚è€ƒèµ„æ–™ä¸­æåˆ°çš„10ä¸ªè§„åˆ™åšç®€è¦æ€»ç»“å¹¶æ·»åŠ ä¸ªäººç†è§£ï¼Œç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>

<p>(1)å…è®¸éç‰¹æƒç”¨æˆ·é€šè¿‡MAQåˆ›å»ºè®¡ç®—æœºå¸æˆ·ï¼Œé»˜è®¤ä¸º10ä¸ªï¼Œä½†æ— æ³•åˆ é™¤åˆ›å»ºçš„è®¡ç®—æœºè´¦æˆ·</p>

<p>ç¦ç”¨MAQçš„æ–¹æ³•å¯å‚è€ƒï¼šhttps://social.technet.microsoft.com/wiki/contents/articles/5446.active-directory-how-to-prevent-authenticated-users-from-joining-workstations-to-a-domain.aspx</p>

<p>(2)åˆ›å»ºè€…å¸æˆ·çš„SIDå­˜å‚¨åœ¨è®¡ç®—æœºå¸æˆ·çš„ms-DS-CreatorSIDå±æ€§ä¸­</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºé€šè¿‡MAQåˆ›å»ºçš„è®¡ç®—æœºå¸æˆ·ï¼ŒæŸ¥çœ‹ms-DS-CreatorSIDå±æ€§èƒ½å¤Ÿæ‰¾åˆ°åˆ›å»ºè€…å¸æˆ·çš„SID</p>

<p>(3)é€šè¿‡MAQåˆ›å»ºçš„è®¡ç®—æœºå¸æˆ·å°†æ”¾å…¥â€Domain Computersâ€ç»„ä¸­</p>

<p>(4)é€šè¿‡MAQåˆ›å»ºçš„è®¡ç®—æœºå¸æˆ·ï¼Œå¯ä¿®æ”¹ä»¥ä¸‹å±æ€§ï¼š</p>

<ul>
  <li>AccountDisabled</li>
  <li>description</li>
  <li>displayName</li>
  <li>DnsHostName</li>
  <li>ServicePrincipalName</li>
  <li>userParameters</li>
  <li>userAccountControl</li>
  <li>msDS-AdditionalDnsHostName</li>
  <li>msDS-AllowedToActOnBehalfOfOtherIdentity</li>
  <li>samAccountName</li>
</ul>

<p>å…¶ä¸­AccountDisabledå±æ€§å¯ä»¥ç”¨æ¥ç¦ç”¨è¯¥ç”¨æˆ·</p>

<p>userAccountControlå±æ€§è®°å½•äº†ç”¨æˆ·çš„å±æ€§ä¿¡æ¯ï¼Œå…·ä½“å¯å‚è€ƒhttps://support.microsoft.com/en-us/help/305144/how-to-use-useraccountcontrol-to-manipulate-user-account-properties</p>

<p>(5)æ·»åŠ è®¡ç®—æœºå¸æˆ·å°†åˆ›å»ºä»¥ä¸‹4ä¸ªSPNï¼š</p>

<ul>
  <li>HOST/MachineAccountName</li>
  <li>HOST/MachineAccountName.domain.name</li>
  <li>RestrictedKrbHost/MachineAccountName</li>
  <li>RestrictedKrbhost/MachineAccountName.domain.name</li>
</ul>

<p>(6)æœºå™¨å¸æˆ·æ²¡æœ‰æœ¬åœ°ç™»å½•æƒé™</p>

<p>ä½†å¯ä»¥é€šè¿‡â€runas /netonlyâ€æ‰§è¡Œå‘½ä»¤</p>

<h2 id="0x03-éç‰¹æƒç”¨æˆ·åˆ›å»ºmachineaccountçš„æ–¹æ³•">0x03 éç‰¹æƒç”¨æˆ·åˆ›å»ºMachineAccountçš„æ–¹æ³•</h2>
<hr />

<h3 id="1powershellå®ç°">1.Powershellå®ç°</h3>

<p>éœ€è¦ä½¿ç”¨<a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a></p>

<p>é€šè¿‡MAQåˆ›å»ºè®¡ç®—æœºå¸æˆ·testNewçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>New-MachineAccount -MachineAccount testNew -Password $(ConvertTo-SecureString "123456789" -AsPlainText -Force)
</code></pre></div></div>

<p>æŸ¥çœ‹è®¡ç®—æœºå¸æˆ·testNewçš„å®Œæ•´å±æ€§ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ADComputer testNew -Properties *
</code></pre></div></div>

<p>å…·ä½“åŒ…æ‹¬ä»¥ä¸‹å±æ€§ï¼š</p>

<ul>
  <li>AccountExpirationDate</li>
  <li>accountExpires</li>
  <li>AccountLockoutTime</li>
  <li>AccountNotDelegated</li>
  <li>AllowReversiblePasswordEncryption</li>
  <li>AuthenticationPolicy</li>
  <li>AuthenticationPolicySilo</li>
  <li>BadLogonCount</li>
  <li>badPasswordTime</li>
  <li>badPwdCount</li>
  <li>CannotChangePassword</li>
  <li>CanonicalName</li>
  <li>Certificates</li>
  <li>CN</li>
  <li>codePage</li>
  <li>CompoundIdentitySupported</li>
  <li>countryCode</li>
  <li>Created</li>
  <li>createTimeStamp</li>
  <li>Deleted</li>
  <li>Description</li>
  <li>DisplayName</li>
  <li>DistinguishedName</li>
  <li>DNSHostName</li>
  <li>DoesNotRequirePreAuth</li>
  <li>dSCorePropagationData</li>
  <li>Enabled</li>
  <li>HomedirRequired</li>
  <li>HomePage</li>
  <li>instanceType</li>
  <li>IPv4Address</li>
  <li>IPv6Address</li>
  <li>isCriticalSystemObject</li>
  <li>isDeleted</li>
  <li>KerberosEncryptionType</li>
  <li>LastBadPasswordAttempt</li>
  <li>LastKnownParent</li>
  <li>lastLogoff</li>
  <li>lastLogon</li>
  <li>LastLogonDate</li>
  <li>localPolicyFlags</li>
  <li>Location</li>
  <li>LockedOut</li>
  <li>logonCount</li>
  <li>ManagedBy</li>
  <li>MemberOf</li>
  <li>MNSLogonAccount</li>
  <li>Modified</li>
  <li>modifyTimeStamp</li>
  <li>mS-DS-CreatorSID</li>
  <li>msDS-User-Account-Control-Computed</li>
  <li>Name</li>
  <li>nTSecurityDescriptor</li>
  <li>ObjectCategory</li>
  <li>ObjectClass</li>
  <li>ObjectGUID</li>
  <li>objectSid</li>
  <li>OperatingSystem</li>
  <li>OperatingSystemHotfix</li>
  <li>OperatingSystemServicePack</li>
  <li>OperatingSystemVersion</li>
  <li>PasswordExpired</li>
  <li>PasswordLastSet</li>
  <li>PasswordNeverExpires</li>
  <li>PasswordNotRequired</li>
  <li>PrimaryGroup</li>
  <li>primaryGroupID</li>
  <li>PrincipalsAllowedToDelegateToAccount</li>
  <li>ProtectedFromAccidentalDeletion</li>
  <li>pwdLastSet</li>
  <li>SamAccountName</li>
  <li>sAMAccountType</li>
  <li>sDRightsEffective</li>
  <li>ServiceAccount</li>
  <li>servicePrincipalName</li>
  <li>ServicePrincipalNames</li>
  <li>SID</li>
  <li>SIDHistory</li>
  <li>TrustedForDelegation</li>
  <li>TrustedToAuthForDelegation</li>
  <li>UseDESKeyOnly</li>
  <li>userAccountControl</li>
  <li>userCertificate</li>
  <li>UserPrincipalName</li>
  <li>uSNChanged</li>
  <li>uSNCreated</li>
  <li>whenChanged</li>
  <li>whenCreated</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>Get-ADComputerå‘½ä»¤éœ€è¦ç”¨åˆ°ActiveDirectoryæ¨¡å—ï¼ŒåŸŸæ§åˆ¶å™¨ä¸€èˆ¬ä¼šå®‰è£…</p>

<p>å¯¹äºæœªå®‰è£…Active Directoryæ¨¡å—çš„ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯¼å…¥Active Directoryæ¨¡å—ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import-module .\Microsoft.ActiveDirectory.Management.dll
</code></pre></div></div>

<p>Microsoft.ActiveDirectory.Management.dllåœ¨å®‰è£…powershellæ¨¡å—Active Directoryåç”Ÿæˆï¼Œæˆ‘å·²ç»æå–å‡ºæ¥å¹¶ä¸Šä¼ è‡³githubï¼š</p>

<p>https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll</p>

<p><a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a>ä¹Ÿæ”¯æŒæŸ¥çœ‹è®¡ç®—æœºå¸æˆ·çš„å±æ€§ï¼Œä½†éœ€è¦æŒ‡å®šå…·ä½“è¦æŸ¥çœ‹çš„å±æ€§</p>

<p>ä¾‹å¦‚æŸ¥çœ‹servicePrincipalNameå±æ€§çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-MachineAccountAttribute -MachineAccount testNew -Attribute servicePrincipalName
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p><a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a>çš„Get-MachineAccountCreatorå‘½ä»¤èƒ½å¤Ÿæšä¸¾æ‰€æœ‰è®¡ç®—æœºå¸æˆ·(MachineAccount)çš„åˆ›å»ºè€…</p>

<p>ä¿®æ”¹è®¡ç®—æœºå¸æˆ·çš„å±æ€§å¯ä½¿ç”¨<a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a>çš„Set-MachineAccountAttributeå‘½ä»¤ï¼Œæ”¯æŒä¿®æ”¹çš„å±æ€§å¦‚ä¸‹ï¼š</p>

<ul>
  <li>AccountDisabled</li>
  <li>description</li>
  <li>displayName</li>
  <li>DnsHostName</li>
  <li>ServicePrincipalName</li>
  <li>userParameters</li>
  <li>userAccountControl</li>
  <li>msDS-AdditionalDnsHostName</li>
  <li>msDS-AllowedToActOnBehalfOfOtherIdentity</li>
  <li>SamAccountName</li>
</ul>

<p>å®ä¾‹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set-MachineAccountAttribute -MachineName testNew -Attribute SamAccountName -Value test
</code></pre></div></div>

<h3 id="2cå®ç°">2.C#å®ç°</h3>

<p><a href="https://github.com/pkb1s/SharpAllowedToAct">SharpAllowedToAct</a>åŒ…å«äº†è¿™ä¸ªåŠŸèƒ½</p>

<p>æˆ‘å°†å…¶ä¸­åˆ›å»ºMachineAccountçš„åŠŸèƒ½æå–å‡ºæ¥ï¼Œç®€å•ä¿®æ”¹åä½¿å…¶æ”¯æŒcsc.exeæˆ–Visual Studioç¼–è¯‘</p>

<p>å®Œæ•´ä»£ç å·²ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Sharp/blob/master/AddMachineAccountofDomain.cs</p>

<p>å¯ä»¥ä½¿ç”¨Visual Studioåˆ›å»ºC#å·¥ç¨‹ç¼–è¯‘AddMachineAccountofDomain.csç”Ÿæˆexeæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å°†AddMachineAccountofDomain.csä¸Šä¼ è‡³æµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨csc.exeè¿›è¡Œç¼–è¯‘</p>

<p>ä½¿ç”¨csc.exeè¿›è¡Œç¼–è¯‘çš„ç¯å¢ƒæ”¯æŒ.Net3.5æˆ–æ›´é«˜ç‰ˆæœ¬</p>

<p>ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\Microsoft.NET\Framework64\v3.5\csc.exe AddMachineAccountofDomain.cs /r:System.DirectoryServices.dll,System.DirectoryServices.Protocols.dll
or
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe AddMachineAccountofDomain.cs /r:System.DirectoryServices.dll,System.DirectoryServices.Protocols.dll
</code></pre></div></div>

<h2 id="0x04-éç‰¹æƒç”¨æˆ·åˆ›å»ºdnsè®°å½•çš„æ–¹æ³•">0x04 éç‰¹æƒç”¨æˆ·åˆ›å»ºDNSè®°å½•çš„æ–¹æ³•</h2>
<hr />

<p>è¿™é‡Œå¯ä»¥ä½¿ç”¨<a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a>ä¸­çš„Invoke-DNSUpdate.ps1</p>

<p>Invoke-DNSUpdateå‘½ä»¤æ”¯æŒæ·»åŠ ä»¥ä¸‹è®°å½•ï¼š</p>

<ul>
  <li>A</li>
  <li>AAAA</li>
  <li>CNAME</li>
  <li>MX</li>
  <li>PTR</li>
  <li>SRV</li>
  <li>TXT</li>
</ul>

<p>æ·»åŠ æœºå™¨å¸æˆ·testNewçš„Aè®°å½•ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-DNSUpdate -DNSType A -DNSName testNew -DNSData 192.168.1.111
</code></pre></div></div>

<p>åˆ é™¤æ­¤è®°å½•çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-DNSUpdate -DNSType A -DNSName testNew
</code></pre></div></div>

<p>éç‰¹æƒç”¨æˆ·æ— æ³•ä¿®æ”¹æˆ–åˆ é™¤å·²æœ‰çš„è®°å½•</p>

<p>æ›´å¤šç»†èŠ‚å¯å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://blog.netspi.com/exploiting-adidns/</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åŸŸå†…éç‰¹æƒç”¨æˆ·åˆ›å»ºDNSè®°å½•ä¸MachineAccountçš„æ–¹æ³•ï¼Œè¯æ˜äº†DNSè®°å½•åªèƒ½ä½œä¸ºè¾…åŠ©åˆ¤æ–­åŸŸå†…ç½‘ç»œæ¶æ„çš„æ–¹æ³•</p>

<p>ç«™åœ¨é˜²å¾¡çš„è§’åº¦ï¼Œå¦‚æœæ”»å‡»è€…åªæœ‰åŸŸå†…éç‰¹æƒç”¨æˆ·çš„æƒé™ï¼Œåœ¨å°è¯•é€šè¿‡MAQåˆ›å»ºè®¡ç®—æœºå¸æˆ·æ—¶ï¼Œå¦‚æœæ²¡æœ‰è·å¾—æ›´é«˜æƒé™ï¼Œå°±æ— æ³•æ¸…é™¤æ”»å‡»ç—•è¿¹(æ— æ³•åˆ é™¤é€šè¿‡MAQåˆ›å»ºçš„è®¡ç®—æœºå¸æˆ·)ï¼Œå¯é€šè¿‡æŸ¥çœ‹è®¡ç®—æœºå¸æˆ·çš„åˆ›å»ºè€…æ‰¾åˆ°æ”»å‡»è€…æ§åˆ¶çš„ç”¨æˆ·</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET