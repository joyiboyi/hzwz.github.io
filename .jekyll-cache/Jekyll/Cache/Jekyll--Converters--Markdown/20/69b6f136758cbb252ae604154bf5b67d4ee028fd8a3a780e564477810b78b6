I"Ä4<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>Application Compatibilityæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œä¸»è¦ç”¨æ¥è§£å†³åº”ç”¨ç¨‹åºåœ¨æ–°ç‰ˆWindowsç³»ç»Ÿä¸Šçš„å…¼å®¹æ€§é—®é¢˜ã€‚ç„¶è€Œåœ¨æ¸—é€æµ‹è¯•ä¸­å®ƒå´æœ‰ç€æ›´å¤šçš„ç”¨å¤„ï¼Œæœ¬æ–‡å°†å¯¹å…¬å¼€èµ„æ–™è¿›è¡Œæ•´ç†ï¼Œä»‹ç»åœ¨æ¸—é€æµ‹è¯•ä¸­çš„å…·ä½“åˆ©ç”¨æŠ€æœ¯ï¼Œå¸®åŠ©å¤§å®¶æ›´å¥½çš„è®¤è¯†å®ƒï¼Œé˜²å¾¡å®ƒã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<h3 id="shim">Shimï¼š</h3>

<p>ç›¸å½“äºæ˜¯åœ¨åº”ç”¨ç¨‹åºå’ŒWindows APIä¹‹é—´çš„é€»è¾‘å±‚ã€‚</p>

<p>å½“åº”ç”¨ç¨‹åºåˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼ŒWindowsLoaderé¦–å…ˆä¼šæ£€æŸ¥sysmain.sdbï¼ˆä½äº%windir%\AppPatch\ï¼‰ï¼Œå¦‚æœå­˜åœ¨å·²æ³¨å†Œçš„sdbæ–‡ä»¶ï¼ŒIATå°†è¢«é‡å®šå‘åˆ°Shimï¼Œå®ç°åŠŸèƒ½æ›¿æ¢ã€‚</p>

<p>æœ¬æ–‡å°†ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>åˆ›å»ºShimæ–‡ä»¶</li>
  <li>å®é™…åˆ©ç”¨æ–¹æ³•</li>
  <li>ç›¸å…³å¼€æºå·¥å…·</li>
  <li>æ£€æµ‹å’Œé˜²å¾¡</li>
</ul>

<h2 id="0x02-åˆ›å»ºshimæ–‡ä»¶">0x02 åˆ›å»ºShimæ–‡ä»¶</h2>
<hr />

<h3 id="1microsoft-application-compatibility-toolkitact">1.Microsoft Application Compatibility Toolkit(ACT)</h3>

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>https://www.microsoft.com/en-us/download/details.aspx?id=7352</p>

<p>é»˜è®¤ä¿®å¤æ–¹å¼ç§ç±»ä¸ªæ•°ä¸º365</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/0-1.png" alt="Alt text" /></p>

<p>å¯åŠ¨æ—¶åŠ å…¥<code class="language-plaintext highlighter-rouge">/x</code>å‚æ•°å¯è·å¾—æ›´å¤šä¿®å¤æ–¹å¼ï¼Œæ€»æ•°807</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/0-2.png" alt="Alt text" /></p>

<p>æ ¹æ®æç¤ºåˆ›å»ºåç”Ÿæˆ.sdbæ–‡ä»¶ï¼Œéœ€è¦å®‰è£…ä½¿å…¶ç”Ÿæ•ˆ</p>

<p>å¯åœ¨Microsoft Application Compatibility Toolkitä¸­ç›´æ¥é€‰æ‹©å®‰è£…ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/1-1.png" alt="Alt text" /></p>

<h2 id="0x03-å®é™…åˆ©ç”¨æ–¹æ³•">0x03 å®é™…åˆ©ç”¨æ–¹æ³•</h2>
<hr />

<h3 id="1hiding-in-the-registry">1.Hiding in the Registry</h3>

<p>é€‰æ‹©<code class="language-plaintext highlighter-rouge">VirtualRegistry</code></p>

<p>Command lineå¡«å…¥ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ADDREDIRECT(HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run^HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunHidden)
</code></pre></div></div>

<p>å®‰è£…shim</p>

<p>å¯åŠ¨regedit</p>

<p><code class="language-plaintext highlighter-rouge">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>ä¸‹é”®å€¼æ— æ³•æŸ¥çœ‹,å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/0-3.png" alt="Alt text" /></p>

<p>ä½†åœ¨cmdä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
</code></pre></div></div>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/0-4.png" alt="Alt text" /></p>

<h3 id="2hiding-in-the-file-system">2.Hiding in the File System</h3>

<p>é€‰æ‹©<code class="language-plaintext highlighter-rouge">CorrectFilePaths</code></p>

<p>Command lineå¡«å…¥ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:\test\;c:\users
</code></pre></div></div>

<p>Module name å¡«å…¥<code class="language-plaintext highlighter-rouge">*.exe</code>,ç‚¹å‡»add</p>

<p>å®‰è£…shim</p>

<p>å¯åŠ¨cmd.exeï¼Œæ— æ³•æŸ¥çœ‹c:\testä¸‹çš„æ–‡ä»¶</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/0-5.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ç±»ä¼¼çš„è¿˜æœ‰<code class="language-plaintext highlighter-rouge">VirtualizeDeleteFile</code> å’Œ<code class="language-plaintext highlighter-rouge">RedirectShortcut</code></p>

<h3 id="3persistence">3.Persistence</h3>

<p>å¯ä¾›é€‰æ‹©çš„Fixæœ‰ï¼š</p>

<ul>
  <li>InjectDll</li>
  <li>LoadLibraryRedirect</li>
  <li>RedirectShortcut</li>
  <li>RedirectEXE</li>
  <li>ShimViaEAT</li>
  <li>LoadLibraryfromCWD</li>
  <li>Hijacking DLL</li>
</ul>

<h3 id="4disable-security-features-of-the-os">4.Disable Security Features of the OS</h3>

<p>å¯ä¾›é€‰æ‹©çš„Fixæœ‰ï¼š</p>

<ul>
  <li>Disable NX</li>
  <li>Disable ASLR</li>
  <li>DisableSEH</li>
  <li>Prevent the Loading of DLLs</li>
  <li>Disable Windows Resource Protection</li>
  <li>Elevate to Administrator</li>
  <li>DisableWindowsDefender</li>
  <li>DisableAdvancedRPCClientHardening</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä»¥ä¸Šæ€è·¯å‚è€ƒè‡ªï¼š</p>

<p>http://www.irongeek.com/i.php?page=videos/derbycon3/4206-windows-0wn3d-by-default-mark-baggett</p>

<p>http://sdb.tools/files/paper.pdf</p>

<h2 id="0x04-å®‰è£…å’Œå¸è½½shim">0x04 å®‰è£…å’Œå¸è½½Shim</h2>
<hr />

<h3 id="1sdbinstexe">1.sdbinst.exe</h3>

<p>ç”¨æ¥å®‰è£…å’Œå¸è½½.sdbæ–‡ä»¶</p>

<p>å¾®è½¯å®˜æ–¹æä¾›ï¼Œé»˜è®¤ä½äºc:\windows\system32ä¸‹ï¼Œè¿è¡Œéœ€è¦ç®¡ç†å‘˜æƒé™</p>

<p><strong>usage:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> -? - print this help text.
 -p - Allow SDBs containing patches.
 -q - Quiet mode: prompts are auto-accepted.
 -u - Uninstall.
 -g {guid} - GUID of file (uninstall only).
 -n "name" - Internal name of file (uninstall only). 
</code></pre></div></div>

<p><strong>å¸è½½ï¼š</strong></p>

<p>sdbinst.exe -u -n â€œnameâ€</p>

<p>å®‰è£…è¿‡ç¨‹ä¸­sdbinst.exeåšäº†å¦‚ä¸‹æ“ä½œï¼š</p>

<p>åœ¨å¦‚ä¸‹æ³¨å†Œè¡¨ä½ç½®åˆ›å»ºé”®å€¼ä¿å­˜Shimä¿¡æ¯ï¼š</p>

<ul>
  <li>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom</li>
  <li>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDB</li>
</ul>

<p>å°†sdbæ–‡ä»¶å¤åˆ¶åˆ°å¦‚ä¸‹æ–‡ä»¶è·¯å¾„ï¼š</p>

<ul>
  <li>C:\Windows\AppPatch\Custom\</li>
  <li>C:\Windows\AppPatch\Custom\Custom64\</li>
</ul>

<p>æ·»åŠ åˆ°å·²å®‰è£…çš„åº”ç”¨ç¨‹åºåˆ—è¡¨ä¸­</p>

<p>ä¾æ¬¡æ‰“å¼€æ§åˆ¶é¢æ¿-ç¨‹åº-ç¨‹åºå’ŒåŠŸèƒ½-å¸è½½ç¨‹åºï¼Œå¯çœ‹åˆ°å®‰è£…çš„Shimåç§°</p>

<h3 id="2sdb-explorer">2.sdb-explorer</h3>

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>https://github.com/evil-e/sdb-explorer</p>

<p>åŒæ ·å¯ç”¨æ¥å®‰è£….sdbæ–‡ä»¶ï¼Œç›¸æ¯”äºsdbinst.exeå¤šäº†å¦‚ä¸‹ç‰¹å¾ï¼š</p>

<ul>
  <li>æºä»£ç å¼€æº</li>
  <li>æ”¯æŒIn-Memory patch</li>
  <li>å®‰è£…è¿‡ç¨‹ä¸å°†sdbæ–‡ä»¶å¤åˆ¶åˆ°C:\Windows\AppPatch\Custom\ä¸‹</li>
  <li>å®‰è£…è¿‡ç¨‹ä¸åœ¨å·²å®‰è£…çš„åº”ç”¨ç¨‹åºåˆ—è¡¨ä¸­æ˜¾ç¤ºå®‰è£…çš„Shimåç§°</li>
</ul>

<p><strong>usage:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Print full sdb tree
  sdb-explorer.exe -t filename.sdb 

Print patch details
  sdb-explorer.exe [-i] -p filename.sdb (patch | patchid | patchref | patchbin)
     -i - create IDAPython Script (optional)

Print patch details for checksum
  sdb-explorer.exe [-i] -s filename.sdb

Create file containing the leaked memory
  sdb-explorer.exe -l filename.sdb

Print Match Entries
  sdb-explorer.exe -d filename.sdb

Create Patch From file
  sdb-explorer.exe -C config.dat [-o filename.sdb]

Register sdb file
  sdb-explorer.exe -r filename.sdb [-a application.exe]

Display usage
  sdb-explorer.exe -h
</code></pre></div></div>

<p>æ¼”ç¤ºå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/1-2.png" alt="Alt text" /></p>

<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ³¨å†Œsdbæ–‡ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sdb-explorer.exe -r C:\Users\a\Desktop\test1.sdb -a putty.exe
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>-açš„å‚æ•°æŒ‡å®šç¨‹åºçš„åç§°ï¼Œä¸èƒ½å¡«å…¥ç¨‹åºçš„ç»å¯¹è·¯å¾„</p>

<p>é€šè¿‡sdb-explorer.exeæ³¨å†Œçš„sdbæ–‡ä»¶æ— æ³•é€šè¿‡sdbinst.exeæ¥åˆ é™¤ï¼Œä¼šæ˜¾ç¤ºsbdæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/1-3.png" alt="Alt text" /></p>

<p>å¸è½½å¯é€šè¿‡åˆ é™¤æ³¨å†Œè¡¨é”®å€¼çš„æ–¹å¼å®ç°</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>é€šè¿‡sdb-explorerå¯ä»¥åˆ›å»ºä¸€ä¸ªIn-Memory patchçš„shimï¼Œæ¥ç€ç¼–è¯‘æˆsdbæ–‡ä»¶ï¼Œè¿›è€Œå®‰è£…ä½¿ç”¨ï¼Œå…³äºIn-Memory patchçš„å­¦ä¹ å¿ƒå¾—å°†åœ¨ä»¥ååˆ†äº«</p>

<p><strong>In-Memory patchï¼š</strong></p>

<ul>
  <li>å¯ä»¥æ›¿æ¢æˆ–å†™å…¥å†…å­˜ä¸­çš„æŸä¸ªåŒºåŸŸçš„ä»»æ„å­—èŠ‚</li>
  <li>å¯ç”¨æ¥ç»•è¿‡åº”ç”¨ç¨‹åºç™½åå•</li>
</ul>

<h2 id="0x05-æŸ¥çœ‹shimä¿¡æ¯">0x05 æŸ¥çœ‹Shimä¿¡æ¯</h2>
<hr />

<h3 id="1sdb2xml">1.sdb2xml</h3>

<p>ä».sdbæ–‡ä»¶æå–å‡ºxmlæ ¼å¼çš„æ•°æ®ï¼Œå¯ç”¨æ¥åˆ†æsdbæ–‡ä»¶</p>

<p><strong>ä½œè€…ï¼š</strong></p>

<p>Heath Stewart</p>

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>https://blogs.msdn.microsoft.com/heaths/2007/11/03/shim-database-to-xml/</p>

<p><strong>usage:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sdb2xml sdb [-out report] [-base64 | -extract] [-?]

  sdb          Path to the shim database to process.
  -base64      Base-64 encode data in the XML report.
  -extract     Extract binary data to current or report directory.
  -out report  Path to the XML file to generate; otherwise, output to console.
</code></pre></div></div>

<p>å¦‚å›¾ï¼Œä½¿ç”¨sdb2xmlæŸ¥çœ‹test1.sdbæ–‡ä»¶ä¸­çš„æ•°æ®</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/2-1.png" alt="Alt text" /></p>

<h3 id="2compatibility-database-dumper-cdd">2.Compatibility Database Dumper (CDD)</h3>

<p><strong>ä½œè€…ï¼š</strong></p>

<p>Alex Ionesceu</p>

<p><strong>usage:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdd.exe [-s][-e][-l][-f][-p][-d kernel-mode database file][-a usermode database file]

 -s Show shims
 -e Show executables
 -l Show layers
 -f Show flags
 -p Show patches
 -d Use Blocked Driver Database from this path
 -a Use Application Compatibility Database from this path 
</code></pre></div></div>

<p><strong>å‚è€ƒåœ°å€ï¼š</strong></p>

<p>http://www.alex-ionescu.com/?p=40</p>

<p>ä½†ä½œè€…Alex Ionescuç›®å‰å°šæœªå°†å…¶å¼€æº</p>

<h3 id="3shim-database-tool-sdb">3.Shim Database Tool (sdb)</h3>

<p><strong>ä½œè€…ï¼š</strong></p>

<p>Jochen Kalmbach</p>

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>http://blog.kalmbach-software.de/2010/02/22/the-shim-database/</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¥å·¥å…·æºä»£ç å¼€æº</p>

<p><strong>Usage:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sdb.exe [-noids] [-match] [PathToShimDatabse] [PathToFileName]

 -noids  Will prevent the output of the TagIds
 -match  Will match the provided file with the installed databases
         and displays the activated shims
         In this case 'PathToFileName' is required

NOTE: If no shim database path is provided,
      the default database will be used.
</code></pre></div></div>

<p>ä».sdbæ–‡ä»¶æå–å‡ºxmlæ ¼å¼çš„æ•°æ®ï¼Œæ¼”ç¤ºå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/2-2.png" alt="Alt text" /></p>

<p>æ˜¾ç¤ºæŒ‡å®šç¨‹åºæ˜¯å¦è¢«æ·»åŠ Shimï¼Œå¦‚å›¾ï¼Œæ‰¾åˆ°putty.exeå·²è¢«æ·»åŠ äº†ä¸€ä¸ªShimï¼Œguidä¸º<code class="language-plaintext highlighter-rouge">8F9DA6E2-5A7C-41E1-B89F8B72D63DEBA8</code></p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-10-19/2-3.png" alt="Alt text" /></p>

<h2 id="0x06-æ£€æµ‹å’Œé˜²å¾¡">0x06 æ£€æµ‹å’Œé˜²å¾¡</h2>
<hr />

<p><strong>ç¦ç”¨Shimçš„æ–¹æ³•ï¼š</strong></p>

<ul>
  <li>
    <p>è‹±æ–‡ç³»ç»Ÿï¼š
æ‰“å¼€gpedit.mscï¼Œé€‰æ‹©Administrative Templates-Windows Components-Application Compatibility-Turn off Application Compatibility Engine</p>
  </li>
  <li>
    <p>ä¸­æ–‡ç³»ç»Ÿï¼š
æ‰“å¼€gpedit.mscï¼Œé€‰æ‹©è®¡ç®—æœºé…ç½®-ç®¡ç†æ¨¡æ¿-Windowsç»„ä»¶-åº”ç”¨ç¨‹åºå…¼å®¹æ€§-å…³é—­åº”ç”¨ç¨‹åºå…¼å®¹æ€§å¼•æ“</p>
  </li>
</ul>

<p>ä½†ä¸å»ºè®®å…³é—­Shimï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>

<ul>
  <li>å¯¼è‡´EMETæ— æ³•ä½¿ç”¨</li>
  <li>æ— æ³•æ›´æ–°è¡¥ä¸</li>
</ul>

<p><strong>æ£€æµ‹å’Œé˜²å¾¡ï¼š</strong></p>

<ul>
  <li>AutoRunsä¸ä¼šæ£€æµ‹åˆ°Shim</li>
  <li>Shimçš„å®‰è£…éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œæ³¨æ„æƒé™æ§åˆ¶</li>
  <li>ç›‘æ§ç‰¹å®šæ³¨å†Œè¡¨é”®å€¼
HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom
HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDB</li>
  <li>æ³¨æ„ç³»ç»Ÿä¸­æœªç­¾åçš„sdbæ–‡ä»¶</li>
  <li>ä½¿ç”¨æ£€æµ‹è„šæœ¬ï¼Œå¦‚https://github.com/securesean/Shim-Process-Scannerå’Œhttps://github.com/securesean/Shim-Process-Scanner-Lite</li>
</ul>

<h2 id="0x07-å°ç»“">0x07 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡å¯¹Application Compatibility Shimsåœ¨æ¸—é€æµ‹è¯•ä¸­çš„ç›¸å…³æŠ€å·§åšäº†æ•´ç†ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚å¯¹äºIn-Memory patchï¼Œå€¼å¾—ç ”ç©¶çš„è¿˜æœ‰å¾ˆå¤šï¼Œå­¦ä¹ å¿ƒå¾—å°†åœ¨ä»¥ååˆ†äº«ã€‚</p>

<p>æ›´å¤šå…³äºShimçš„ç ”ç©¶èµ„æ–™å¯è®¿é—®ï¼š</p>

<p>http://sdb.tools/index.html</p>

<hr />
<p><strong>æœ¬æ–‡å‚è€ƒé“¾æ¥ï¼š</strong></p>

<p>http://blacksunhackers.club/2016/08/post-exploitation-persistence-with-application-shims-intro/</p>

<p>https://www.blackhat.com/docs/asia-14/materials/Erickson/Asia-14-Erickson-Persist-It-Using-And-Abusing-Microsofts-Fix-It-Patches.pdf</p>

<p>http://www.irongeek.com/i.php?page=videos/derbycon3/4206-windows-0wn3d-by-default-mark-baggett</p>

<p>http://sdb.io/erickson-codeblue.pdf</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>
:ET