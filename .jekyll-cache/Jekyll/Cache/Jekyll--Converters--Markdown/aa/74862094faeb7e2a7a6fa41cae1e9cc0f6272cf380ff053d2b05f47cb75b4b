I"Á*<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />
<p>ä¹‹å‰åœ¨ã€Šå¯¼å‡ºå½“å‰åŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æŠ€æœ¯æ•´ç†ã€‹ä¸­ç ”ç©¶è¿‡å¦‚ä½•é€šè¿‡Volume Shadow Copyå®ç°å¯¹ntds.ditæ–‡ä»¶çš„å¤åˆ¶ï¼Œ å¯ç”¨æ¥å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·hashã€‚è€Œæœ€è¿‘åœ¨Carbon Blackçš„åšå®¢ä¸Šé¢åˆå­¦åˆ°äº†ä¸€äº›æ–°çš„åˆ©ç”¨æ–¹æ³•ï¼Œäºæ˜¯æ•´ç†æˆæ–‡ã€‚</p>

<p><strong>å­¦ä¹ é“¾æ¥ï¼š</strong></p>

<p>https://www.carbonblack.com/2015/08/05/bit9-carbon-black-threat-research-team-unveils-nefarious-intents-of-volume-shadows-copies/</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä»¥ä¸‹ä¸¤æ–¹é¢å†…å®¹ï¼š</p>

<ol>
  <li>
    <p>é€šè¿‡Volume Shadow Copyæ¢å¤ç³»ç»Ÿè‡ªåŠ¨è¿˜åŸç‚¹å†…ä¿å­˜çš„æ–‡ä»¶</p>
  </li>
  <li>
    <p>é€šè¿‡Volume Shadow Copyåˆ›å»ºä¸€ä¸ªæ— æ–‡ä»¶çš„è¿›ç¨‹</p>

    <p>æµç¨‹å¦‚ä¸‹ï¼š</p>
  </li>
</ol>

<ul>
  <li>åˆ›å»ºå½“å‰å·å½±é•œåƒ</li>
  <li>å¯åŠ¨é•œåƒå†…çš„ç¨‹åº</li>
  <li>åˆ é™¤å·å½±é•œåƒæ–‡ä»¶</li>
  <li>ç¨‹åºæºæ–‡ä»¶è¢«åˆ é™¤</li>
  <li>è¯¥è¿›ç¨‹å®ç°æ— æ–‡ä»¶</li>
</ul>

<h2 id="0x02-èƒŒæ™¯çŸ¥è¯†">0x02 èƒŒæ™¯çŸ¥è¯†</h2>
<hr />

<h3 id="volume-shadow-copy-service">Volume Shadow Copy Service</h3>

<ul>
  <li>ç”¨äºæ•°æ®å¤‡ä»½</li>
  <li>æ”¯æŒWindows Server 2003 åŠä»¥ä¸Šæ“ä½œç³»ç»Ÿ</li>
  <li>ç³»ç»Ÿé»˜è®¤åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è‡ªåŠ¨åˆ›å»ºæ•°æ®å¤‡ä»½ï¼Œå¦‚è¡¥ä¸å®‰è£…åã€‚åœ¨Win7ç³»ç»Ÿå¤§æ¦‚æ¯éš”ä¸€å‘¨è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œè¯¥æ—¶é—´æ— æ³•ç¡®å®š</li>
  <li>ç¦ç”¨VSSä¼šå½±å“ç³»ç»Ÿæ­£å¸¸ä½¿ç”¨ï¼Œå¦‚ System Restoreå’Œ Windows Server Backup</li>
  <li>å¯ä½¿ç”¨VShadowåœ¨å‘½ä»¤è¡Œä¸‹æ‰‹åŠ¨åˆ›å»ºå·å½±é•œåƒ</li>
  <li>ç³»ç»Ÿé»˜è®¤ä¸æ”¯æŒVShadowï¼Œå¯åœ¨Microsoft Windows Software Development Kit (SDK)ä¸­è·å¾—è¯¥å·¥å…·</li>
</ul>

<p><strong>æ³¨ï¼š</strong></p>

<p>Windows Server 2003å’ŒXPç³»ç»Ÿéœ€è¦Volume Shadow Copy Service SDK 7.2ï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://www.microsoft.com/en-us/download/details.aspx?id=23490</p>

<p>Windows Server 2008 R2å’ŒWindows 7ç³»ç»Ÿéœ€è¦å¯¹åº”çš„SDKç‰ˆæœ¬(è¯¥ç‰ˆæœ¬Win8ä¹Ÿé€‚ç”¨)ï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹ï¼š</p>

<p>https://www.microsoft.com/en-us/download/details.aspx?id=3138</p>

<h2 id="0x03-æ¢å¤ç³»ç»Ÿè‡ªåŠ¨è¿˜åŸç‚¹å†…ä¿å­˜çš„æ–‡ä»¶">0x03 æ¢å¤ç³»ç»Ÿè‡ªåŠ¨è¿˜åŸç‚¹å†…ä¿å­˜çš„æ–‡ä»¶</h2>
<hr />

<h3 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h3>

<p>é€šè¿‡vssadminæŸ¥çœ‹å·å½±é•œåƒï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin list shadows
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong>
vssadminç³»ç»Ÿè‡ªå¸¦</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/2-1.png" alt="Alt text" /></p>

<p>é€šè¿‡wmicæŸ¥çœ‹å·å½±é•œåƒï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic /NAMESPACE:"\\root\CIMV2" PATH Win32_ShadowCopy GET /all /FORMAT:list
</code></pre></div></div>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/2-2.png" alt="Alt text" /></p>

<p>æå–å‡ºå…³é”®çš„ä¿¡æ¯DeviceObjectã€IDå’ŒInstallDateï¼Œå¯¹åº”wmicå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic /NAMESPACE:"\\root\CIMV2" PATH Win32_ShadowCopy GET DeviceObject,ID,InstallDate /FORMAT:list
</code></pre></div></div>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/2-3.png" alt="Alt text" /></p>

<p><strong>æ³¨ï¼š</strong></p>

<p>åœ¨åˆ é™¤æŸä¸ªå·å½±é•œåƒæ—¶éœ€è¦å¡«å…¥è¯¥å·å½±é•œåƒçš„ID</p>

<h3 id="åˆ›å»ºç¬¦å·é“¾æ¥">åˆ›å»ºç¬¦å·é“¾æ¥</h3>

<p>å°†å·å½±é•œåƒå’Œæ–‡ä»¶å¤¹å»ºç«‹è™šæ‹Ÿå…³è”ï¼Œç±»ä¼¼äºé€šè¿‡å¿«æ·æ–¹å¼å¯è®¿é—®å·å½±é•œåƒä¸­ä¿å­˜çš„æ–‡ä»¶ï¼Œä½¿ç”¨mklinkå‘½ä»¤ï¼Œç³»ç»Ÿè‡ªå¸¦ï¼Œéœ€è¦<code class="language-plaintext highlighter-rouge">ç®¡ç†å‘˜æƒé™</code>
æ ¼å¼å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mklink /d æŒ‡å®šå¿«æ·æ–¹å¼è·¯å¾„ [Shadow copy device name]\
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>[Shadow copy device name]åè¦å¸¦ä¸€ä¸ª<br />
å¦‚æœä¸å°å¿ƒæ¼æ‰\,åœ¨å»ºç«‹å…³è”åæ— æ³•å¯¹å…¶è¿›è¡Œåç»­æ“ä½œï¼Œå¯ç›´æ¥åˆ é™¤è¯¥å…³è”å†é‡æ–°å»ºç«‹</p>

<p>ä¾‹å¦‚ï¼Œé€‰å–<code class="language-plaintext highlighter-rouge">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4</code>ï¼Œå¯¹åº”çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mklink /d c:\testvsc \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4\
</code></pre></div></div>

<p>å¦‚å›¾ï¼ŒæˆåŠŸåˆ›å»º</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/2-4.png" alt="Alt text" />
<img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/2-5.png" alt="Alt text" /></p>

<p><code class="language-plaintext highlighter-rouge">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4</code>å¯¹åº”çš„æ—¶é—´ç‚¹ä¸ºInstallDate=20160907160419.347805+480ï¼Œäºæ˜¯c:\testvscä¸­ä¿å­˜çš„å³ä¸ºæ­¤æ—¶é—´ç‚¹ç³»ç»Ÿä¸­ä¿å­˜çš„æ–‡ä»¶</p>

<h2 id="0x04-åˆ›å»ºä¸€ä¸ªæ— æ–‡ä»¶çš„è¿›ç¨‹">0x04 åˆ›å»ºä¸€ä¸ªæ— æ–‡ä»¶çš„è¿›ç¨‹</h2>
<hr />
<p>æµ‹è¯•ç³»ç»Ÿï¼š Win 8.1 x86</p>

<p>æµ‹è¯•exeï¼š Win32Project1.exe</p>

<p>æ‰§è¡Œåå¼¹æ¡†ï¼Œå¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/2-6.png" alt="Alt text" /></p>

<h3 id="1-åˆ›å»ºå·å½±é•œåƒ">1. åˆ›å»ºå·å½±é•œåƒ</h3>
<p>ä¸Šä¼ Win32Project1.exeå’ŒVShadow.exeï¼Œä¸ºå½“å‰ç³»ç»Ÿåˆ›å»ºå·å½±é•œåƒï¼Œç®¡ç†å‘˜æƒé™æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vshadow.exe -p c:\
</code></pre></div></div>

<p>å¦‚å›¾ï¼Œä¸ºCç›˜åˆ›å»ºå·å½±é•œåƒï¼ŒDeviceNameä¸º<code class="language-plaintext highlighter-rouge">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy5</code>ï¼ŒIDä¸º{10f63e0b-e47d-4121-969f-87fa458c5043}</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/3-1.png" alt="Alt text" /></p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/3-2.png" alt="Alt text" /></p>

<h3 id="2-åˆ›å»ºç¬¦å·é“¾æ¥">2. åˆ›å»ºç¬¦å·é“¾æ¥</h3>
<p>å‘½ä»¤è¡Œæ‰§è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mklink /d c:\vscfiletest \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy5\
</code></pre></div></div>

<p>åˆ›å»ºæ–‡ä»¶å¤¹c:\vscfiletestï¼Œæ‰§è¡Œå…¶ä¸­çš„æµ‹è¯•æ–‡ä»¶Win32Project1.exe
å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/3-3.png" alt="Alt text" /></p>

<p>ä½¿ç”¨Process ExploreræŸ¥çœ‹Win32Project1.exeï¼Œè·¯å¾„æ˜¾ç¤ºä¸ºc:\vscfiletest\test\Win32Project1.exe</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/3-4.png" alt="Alt text" /></p>

<h3 id="3-åˆ é™¤ç¬¦å·é“¾æ¥">3. åˆ é™¤ç¬¦å·é“¾æ¥</h3>
<p>åˆ é™¤å¿«æ·æ–¹å¼æ–‡ä»¶å¤¹å°±å¥½ï¼Œå‘½ä»¤è¡Œå‚æ•°å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rmdir c:\vscfiletest\
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>å³ä½¿æ–‡ä»¶å¤¹ä¸­çš„Win32Project1.exeæ­£åœ¨è¿è¡Œï¼Œä»å¯åˆ é™¤</p>

<h3 id="4åˆ é™¤å·å½±é•œåƒ">4ã€åˆ é™¤å·å½±é•œåƒ</h3>

<p>é€šè¿‡wmicæ‰¾åˆ°å·å½±é•œåƒå¯¹åº”çš„IDï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic /NAMESPACE:"\\root\CIMV2" PATH Win32_ShadowCopy GET DeviceObject,ID,InstallDate /FORMAT:list
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy5\</code>å¯¹åº”çš„IDä¸º{10f63e0b-e47d-4121-969f-87fa458c5043}</p>

<p>å®Œæ•´çš„åˆ é™¤ä»£ç ä¸ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin delete shadows /shadow={10f63e0b-e47d-4121-969f-87fa458c5043} /quiet
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>åŠ å…¥/quietæ˜¯ä¸ºäº†å¼ºåˆ¶åˆ é™¤ï¼Œçœå»è¾“å…¥Yç¡®è®¤</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/3-5.png" alt="Alt text" /></p>

<p><strong>è¡¥å……ï¼š</strong>
åˆ é™¤æ‰€æœ‰å·å½±é•œåƒçš„å‘½ä»¤ä¸ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vssadmin delete shadows /all /quiet
</code></pre></div></div>

<p>æ­¤æ—¶ï¼ŒWin32Project1.exeä»åœ¨åå°è¿è¡Œï¼Œè€Œæºæ–‡ä»¶c:\vscfiletest\test\Win32Project1.exeå·²ç»ä¸å­˜åœ¨</p>

<p>å¦‚å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-9-7/3-6.png" alt="Alt text" /></p>

<h2 id="0x05-é˜²å¾¡">0x05 é˜²å¾¡</h2>
<hr />
<ul>
  <li>åˆ©ç”¨Volume Shadow Copyçš„å‰ææ˜¯éœ€è¦è·å¾—ç®¡ç†å‘˜æƒé™ï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦é˜²æ­¢æ”»å‡»è€…è·å¾—ç®¡ç†å‘˜æƒé™</li>
  <li>å¯¹äºä¸ªäººç”¨æˆ·ä¸»æœºï¼Œå»ºè®®ç›´æ¥ç¦ç”¨Volume Shadow CopyæœåŠ¡</li>
  <li>Carbon Blackçš„åšå®¢ä¸Šé¢æä¾›çš„é˜²å¾¡æ–¹æ³•å¦‚ä¸‹ï¼š</li>
</ul>

<blockquote>
  <p>Search by hashes:</p>

  <p>process_md5:3e1360a23ea5f9caf4987ccf35f2fcaf OR
process_md5:576b379a59d094fb7b06c261a96034a6 OR
process_md5:d0cd7ad91b2ff568275d497214ff185c OR
process_md5:97fd0f3c05f1707544a9a6a0c896b43e OR
process_md5:d560c155b68121d98f8370e7deafbc4d OR
process_md5:c5d2992c8cba0771f71fe4d7625a0b8b OR
process_md5:53d3e33ad31af6716559f29e889aca49</p>

  <p>Search for Vshadow being executed:</p>

  <p>modload:vss_ps.dll cmdline:â€-p C:\â€</p>

  <p>modload:vss_ps.dll cmdline:â€-pâ€ -path:System32\werfault.exe</p>

  <p>Search for mklink being executed via a shell out:</p>

  <p>cmdline:â€â€C:\Windows\system32\cmd.exeâ€ /c mklink /Dâ€</p>

  <p>Search for processes being executed from the volume shadow copy
locations:</p>

  <p>path:device/harddiskvolumeshadowcopy*</p>

  <p>path:device/harddiskvolume*</p>
</blockquote>

<p>ä»¥ä¸Šå¼•ç”¨è‡ªhttps://www.carbonblack.com/2015/08/05/bit9-carbon-black-threat-research-team-unveils-nefarious-intents-of-volume-shadows-copies/</p>

<h2 id="0x06-å°ç»“">0x06 å°ç»“</h2>
<hr />
<p>æ€»ç»“ä¸€ä¸‹æ¸—é€æµ‹è¯•ä¸­Volume Shadow Copyçš„ä½œç”¨ï¼š</p>

<ol>
  <li>
    <p>é€šè¿‡Volume Shadow Copyæ¢å¤ç³»ç»Ÿè‡ªåŠ¨è¿˜åŸç‚¹å†…ä¿å­˜çš„æ–‡ä»¶</p>
  </li>
  <li>
    <p>é€šè¿‡Volume Shadow Copyåˆ›å»ºä¸€ä¸ªæ— æ–‡ä»¶çš„è¿›ç¨‹</p>
  </li>
  <li>
    <p>å¤åˆ¶æ­£è¢«ç¨‹åºå ç”¨çš„æ–‡ä»¶ï¼Œå¦‚ntds.ditï¼Œå½“ç„¶powershellç‰ˆçš„NinjaCopyä¹Ÿèƒ½å®ç°ç›¸åŒçš„åŠŸèƒ½,å¯å‚ç…§https://github.com/3gstudent/NinjaCopy</p>
  </li>
</ol>

<p><strong>æ›´å¤šå­¦ä¹ èµ„æ–™ï¼š</strong></p>

<p>https://www.carbonblack.com/2015/08/03/new-crypto-ransomware-lurks-in-the-shadows/
http://securityweekly.com/2012/10/15/volume-shadow-copies-the-los/
https://technet.microsoft.com/en-us/library/ee923636.aspx</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>
:ET