I"¥-<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>æˆ‘åœ¨æœ€è¿‘çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œå‘ç°Powershellå‘½ä»¤çš„å†å²è®°å½•æœ‰æ—¶ä¼šåŒ…å«ç³»ç»Ÿæ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚è¿œç¨‹æœåŠ¡å™¨çš„è¿æ¥å£ä»¤ï¼Œäºæ˜¯æˆ‘å¯¹Powershellçš„å†å²è®°å½•åŠŸèƒ½åšäº†è¿›ä¸€æ­¥ç ”ç©¶ï¼Œæ€»ç»“ä¸€äº›æ¸—é€æµ‹è¯•ä¸­å¸¸ç”¨å¯¼å‡ºå†å²è®°å½•çš„æ–¹æ³•ï¼Œç»“åˆåˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>ä¸¤ç§Powershellå‘½ä»¤çš„å†å²è®°å½•</li>
  <li>å¯¼å‡ºPowershellå‘½ä»¤å†å²è®°å½•çš„æ–¹æ³•</li>
  <li>é˜²å¾¡å»ºè®®</li>
</ul>

<h2 id="0x02-ä¸¤ç§powershellå‘½ä»¤çš„å†å²è®°å½•">0x02 ä¸¤ç§Powershellå‘½ä»¤çš„å†å²è®°å½•</h2>
<hr />

<p>è®°å½•Powershellå‘½ä»¤çš„å†å²è®°å½•æœ‰ä¸¤ç§æ–¹å¼ï¼Œå¯åˆ†åˆ«ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Get-History</code>å’Œ<code class="language-plaintext highlighter-rouge">Get-PSReadlineOption</code>è¯»å–</p>

<h3 id="1get-history">1ã€Get-History</h3>

<p>å‚è€ƒæ–‡æ¡£ï¼š</p>

<p>https://docs.microsoft.com/en-us/powershell/module/Microsoft.PowerShell.Core/Get-History?view=powershell-3.0</p>

<p>é»˜è®¤Powershell v2åŠä»¥ä¸Šæ”¯æŒ</p>

<p>èƒ½å¤Ÿè®°å½•å½“å‰ä¼šè¯ä¸­è¾“å…¥çš„å‘½ä»¤ï¼Œå¤šä¸ªPowershellè¿›ç¨‹ä¹‹é—´ä¸å…±äº«ï¼ŒPowershellè¿›ç¨‹é€€å‡ºåè‡ªåŠ¨æ¸…é™¤æ‰€æœ‰è®°å½•</p>

<h4 id="1-å¸¸ç”¨å‘½ä»¤">1. å¸¸ç”¨å‘½ä»¤</h4>

<p>è·å¾—å†å²è®°å½•çš„å®Œæ•´ä¿¡æ¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-History | Format-List -Property *
</code></pre></div></div>

<p>åŒ…æ‹¬ï¼š</p>

<ul>
  <li>Id</li>
  <li>CommandLine</li>
  <li>ExecutionStatus</li>
  <li>StartExecutionTime</li>
  <li>EndExecutionTime</li>
</ul>

<p>æµ‹è¯•å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-5-16/2-1.png" alt="Alt text" /></p>

<p>åˆ é™¤æ‰€æœ‰å†å²è®°å½•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Clear-History
</code></pre></div></div>

<p>æŒ‰IDå·åˆ é™¤å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Clear-History -Id 3
</code></pre></div></div>

<h4 id="2-åˆ©ç”¨æ€è·¯">2. åˆ©ç”¨æ€è·¯</h4>

<p>è·å¾—äº†ä¸€å°Windowsç³»ç»Ÿçš„æƒé™ï¼Œå‘ç°åå°æœ‰Powershellè¿›ç¨‹ï¼Œæƒ³è¦è¯»å–Powershellè¿›ç¨‹ä¸­çš„å†å²è®°å½•</p>

<p>(1)Powershellè¿›ç¨‹æ— æ³•æ¥æ”¶é”®ç›˜è¾“å…¥å‘½ä»¤</p>

<p>ä¾‹å¦‚PowershellåŠ è½½äº†ä¸€ä¸ªåœ¨åå°è¿è¡Œçš„è„šæœ¬:<code class="language-plaintext highlighter-rouge">Powershell -ep bypass -f 1.ps1</code></p>

<p>æ­¤æ—¶æ— æ³•å‘Powershellè¿›ç¨‹å‘é€é”®ç›˜æ¶ˆæ¯ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡è¯»å–è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°è·å¾—æœ‰ç”¨çš„ä¿¡æ¯ï¼Œå¼€æºä»£ç ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/GetProcessCommandLine.cpp</p>

<p>ä»£ç å®ç°äº†è¯»å–æŒ‡å®šè¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œé€šå¸¸èƒ½å¤Ÿè·å¾—æœ‰ç”¨çš„ä¿¡æ¯</p>

<p>(2)Powershellè¿›ç¨‹èƒ½å¤Ÿæ¥æ”¶é”®ç›˜è¾“å…¥å‘½ä»¤</p>

<p>è¿™é‡Œå¯ä»¥æ¨¡æ‹Ÿå‘é€é”®ç›˜æ¶ˆæ¯ï¼Œå¯¼å‡ºå†å²è®°å½•</p>

<p>ç¨‹åºå®ç°æ€è·¯ï¼š</p>

<ul>
  <li>é€šè¿‡éå†æšä¸¾æ‰€æœ‰çª—å£</li>
  <li>é€šè¿‡GetWindowThreadProcessIdä»çª—å£ï¼ˆHWNDï¼‰è·å¾—PID</li>
  <li>æ¯”è¾ƒPIDï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„çª—å£</li>
  <li>å‘ç¬¦åˆæ¡ä»¶çš„çª—å£å‘é€é”®ç›˜æ¶ˆæ¯ï¼ˆPostMessageï¼‰</li>
</ul>

<p>ç¨‹åºç»†èŠ‚ï¼š</p>

<p>1.Virtual-Key Codes</p>

<p>æ¯ä¸€ä¸ªé”®ç›˜è¾“å…¥æ¶ˆæ¯å¯¹åº”ä¸€ä¸ªVirtual-Key Code</p>

<p>å‚è€ƒèµ„æ–™ï¼š
https://docs.microsoft.com/en-us/windows/desktop/inputdev/virtual-key-codes</p>

<p>éœ€è¦æ¨¡æ‹Ÿé”®ç›˜æŒ‰ä¸‹å’Œé”®ç›˜æŠ¬èµ·ä¸¤ä¸ªæ“ä½œï¼Œå¼€æºçš„æµ‹è¯•ä»£ç ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/SendKeyboardMessageToPowershell.cpp</p>

<p>ä»£ç å®ç°äº†æœç´¢æŒ‡å®špidçš„è¿›ç¨‹ï¼Œå‘è¿›ç¨‹å‘é€é”®ç›˜æ¶ˆæ¯ï¼Œå†…å®¹ä¸º:<code class="language-plaintext highlighter-rouge">whoami</code></p>

<p>2.å¯¼å‡ºå†å²è®°å½•</p>

<p>å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-History|export-csv $env:temp"\history.csv"
</code></pre></div></div>

<p>å…¶ä¸­éœ€è¦è€ƒè™‘å­—ç¬¦<code class="language-plaintext highlighter-rouge">"|"</code>ã€<code class="language-plaintext highlighter-rouge">"$"</code>å’Œ<code class="language-plaintext highlighter-rouge">"""</code>ï¼Œæ¨¡æ‹Ÿé”®ç›˜è¾“å…¥æ—¶éœ€è¦åŠ <code class="language-plaintext highlighter-rouge">Shifté”®</code></p>

<p>è¿™é‡Œçš„å®ç°æ–¹æ³•æ˜¯å…ˆä½¿ç”¨<code class="language-plaintext highlighter-rouge">keybd_event</code>æŒ‰ä¸‹<code class="language-plaintext highlighter-rouge">Shifté”®</code>ï¼Œå†ç”¨<code class="language-plaintext highlighter-rouge">PostMessage</code>å‘é€æŒ‰é”®çš„å­—æ¯ï¼Œæœ€åæŠ¬èµ·ä¸¤ä¸ªæŒ‰é”®</p>

<p>å¼€æºçš„æµ‹è¯•ä»£ç ï¼š</p>

<p>https://github.com/3gstudent/Homework-of-C-Language/blob/master/SendKeyboardMessageToPowershell(Get-History).cpp</p>

<p>ä»£ç å®ç°äº†æœç´¢æŒ‡å®špidçš„è¿›ç¨‹ï¼Œå‘è¿›ç¨‹å‘é€é”®ç›˜æ¶ˆæ¯ï¼Œå†…å®¹ä¸º:<code class="language-plaintext highlighter-rouge">Get-History|export-csv $env:temp"\history.csv"</code></p>

<h4 id="3-è¡¥å……æŸ¥çœ‹cmdexeçš„å†å²è®°å½•">3. è¡¥å……ï¼šæŸ¥çœ‹cmd.exeçš„å†å²è®°å½•</h4>

<p>å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doskey /h
</code></pre></div></div>

<p>æ¸…ç©ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doskey /reinstall
</code></pre></div></div>

<p>ä¹Ÿå¯ä»¥é€šè¿‡å‘é€é”®ç›˜æ¶ˆæ¯çš„æ–¹å¼å¯¼å‡ºcmd.exeçš„å‘½ä»¤å†å²è®°å½•</p>

<h3 id="2get-psreadlineoption">2ã€Get-PSReadlineOption</h3>

<p>å‚è€ƒæ–‡æ¡£ï¼š</p>

<p>https://docs.microsoft.com/en-us/powershell/module/psreadline/?view=powershell-5.1</p>

<p>é»˜è®¤Powershell v5æ”¯æŒ</p>

<p>Powershell v3å’ŒPowershell v4éœ€è¦å®‰è£…Get-PSReadlineOptionåæ‰å¯ä»¥ä½¿ç”¨</p>

<p>å®‰è£…åï¼Œæ‰€æœ‰Powershellå‘½ä»¤çš„å†å²è®°å½•ä¼šä¿å­˜åœ¨åŒä¸€ä½ç½®ï¼Œå¯éšæ—¶æŸ¥çœ‹</p>

<h4 id="1-powershell-v3å’Œpowershell-v4çš„å®‰è£…å’Œä½¿ç”¨">1. Powershell v3å’ŒPowershell v4çš„å®‰è£…å’Œä½¿ç”¨</h4>

<p>è¿™é‡Œä»¥64ä½ç³»ç»Ÿä¸ºä¾‹ï¼Œå®‰è£…æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<p>(1)å®‰è£…PowerShellGet</p>

<p>ä¸‹è½½ï¼š</p>

<p>https://www.microsoft.com/en-us/download/details.aspx?id=51451</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>å®‰è£…å‰éœ€è¦å…³é—­powershellè¿›ç¨‹</p>

<p>å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå®ç°éšè”½å®‰è£…ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msiexec /q /i PackageManagement_x64.msi
</code></pre></div></div>

<p>å®‰è£…æˆåŠŸåï¼Œåœ¨æ§åˆ¶é¢æ¿çš„å·²å®‰è£…ç¨‹åºåˆ—è¡¨(Control Panel\Programs\Programs and Features)æœ‰æ˜¾ç¤º:<code class="language-plaintext highlighter-rouge">Package Management Preview - x64</code></p>

<p>å¯ä»¥é€šè¿‡åˆ é™¤å¯¹åº”çš„æ³¨å†Œè¡¨é¡¹è¿›è¡Œéšè—ï¼Œæ›´å¤šç»†èŠ‚å¯å‚è€ƒ<a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80-%E8%8E%B7%E5%BE%97%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E5%B7%B2%E5%AE%89%E8%A3%85%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%88%97%E8%A1%A8">ã€Šæ¸—é€åŸºç¡€â€”â€”è·å¾—å½“å‰ç³»ç»Ÿå·²å®‰è£…çš„ç¨‹åºåˆ—è¡¨ã€‹</a></p>

<p><code class="language-plaintext highlighter-rouge">Package Management Preview - x64</code>çš„æ³¨å†Œè¡¨è·¯å¾„ä¸º<code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{57E5A8BB-41EB-4F09-B332-B535C5954A28}</code></p>

<p>åªéœ€è¦åˆ é™¤è¿™ä¸ªæ³¨å†Œè¡¨é¡¹åŠå­é¡¹å³å¯å®ç°åœ¨å·²å®‰è£…ç¨‹åºåˆ—è¡¨ä¸­éšè—</p>

<p>åˆ é™¤æ³¨å†Œè¡¨é¡¹çš„cmdå‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg delete HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{57E5A8BB-41EB-4F09-B332-B535C5954A28} /f
</code></pre></div></div>

<p>(2)å®‰è£…PSReadLine</p>

<p>é€šè¿‡Install-Moduleå‘½ä»¤å®‰è£…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install-Module -Name PSReadLine
</code></pre></div></div>

<p>å¼¹å‡ºæç¤ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NuGet provider is required to continue
PowerShellGet requires NuGet provider version '2.8.5.201' or newer to interact
with NuGet-based repositories. The NuGet provider must be available in
'C:\Program Files\PackageManagement\ProviderAssemblies' or
'C:\Users\Administrator\AppData\Local\PackageManagement\ProviderAssemblies'.
You can also install the NuGet provider by running 'Install-PackageProvider
-Name NuGet -MinimumVersion 2.8.5.201 -Force'. Do you want PowerShellGet to
install and import the NuGet provider now?
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is "Y"):
</code></pre></div></div>

<p>éœ€è¦å†æ¬¡è¾“å…¥<code class="language-plaintext highlighter-rouge">Y</code>è¿›è¡Œå®‰è£…</p>

<p>å¦‚æœéœ€è¦å®ç°ä¸€é”®å®‰è£…ï¼Œå¯ä»¥å…ˆå®‰è£…NuGetï¼Œå†å®‰è£…PSReadLineï¼Œå®Œæ•´å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
Install-Module -Name PSReadLine
</code></pre></div></div>

<p>(3)ä½¿ç”¨</p>

<p>æ‰€æœ‰powershellå‘½ä»¤å°†ä¼šä¿å­˜åœ¨å›ºå®šä½ç½®:<code class="language-plaintext highlighter-rouge">%appdata%\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</code></p>

<p>æŸ¥çœ‹å‘½ä»¤çš„å†å²è®°å½•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Content (Get-PSReadlineOption).HistorySavePath
</code></pre></div></div>

<p>æ¸…é™¤å‘½ä»¤çš„å†å²è®°å½•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove-Item (Get-PSReadlineOption).HistorySavePath
</code></pre></div></div>

<h4 id="2-åˆ©ç”¨æ€è·¯-1">2. åˆ©ç”¨æ€è·¯</h4>

<p>è·å¾—äº†Windowsç³»ç»Ÿçš„è®¿é—®æƒé™ï¼Œé¦–å…ˆæŸ¥çœ‹Powershellç‰ˆæœ¬ï¼Œå¦‚æœæ˜¯v5ï¼Œå¯é€šè¿‡è¯»å–æ–‡ä»¶<code class="language-plaintext highlighter-rouge">%appdata%\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</code>è·å¾—å†å²è®°å½•</p>

<p>å¦‚æœç³»ç»Ÿæ˜¯Powershell v3æˆ–Powershell v4ï¼Œå¯é€šè¿‡å‘½ä»¤è¡Œå®‰è£…PSReadLineï¼Œè¿™æ ·å°±èƒ½è®°å½•åç»­ç³»ç»Ÿæ‰€æœ‰çš„Powershellå‘½ä»¤</p>

<h2 id="0x03-é˜²å¾¡å»ºè®®">0x03 é˜²å¾¡å»ºè®®</h2>
<hr />

<p>å¦‚æœä½¿ç”¨é«˜ç‰ˆæœ¬çš„Windowsç³»ç»Ÿï¼Œå¦‚Win10ï¼Œé»˜è®¤Powershellç‰ˆæœ¬ä¸º5.0ï¼Œä¼šè®°å½•Powershellçš„å‘½ä»¤ï¼Œå»ºè®®å®šæ—¶è¿›è¡Œæ¸…é™¤ï¼Œä½ç½®ï¼š<code class="language-plaintext highlighter-rouge">%appdata%\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</code></p>

<p>æ¸…é™¤å‘½ä»¤çš„å†å²è®°å½•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Remove-Item (Get-PSReadlineOption).HistorySavePath
</code></pre></div></div>

<p>å¯¹äºä½ç‰ˆæœ¬çš„Powershellï¼Œå¦‚æœå‘½ä»¤ä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯(å¦‚è¿œç¨‹è¿æ¥çš„å£ä»¤)ï¼Œéœ€è¦åŠæ—¶æ¸…é™¤ï¼Œå‘½ä»¤ä¸ºï¼š<code class="language-plaintext highlighter-rouge">Clear-History</code></p>

<p>å¯¹äºcmd.exeï¼Œå¦‚æœå‘½ä»¤ä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯(å¦‚è¿œç¨‹è¿æ¥çš„å£ä»¤)ï¼Œéœ€è¦åŠæ—¶æ¸…é™¤ï¼Œå‘½ä»¤ä¸ºï¼š<code class="language-plaintext highlighter-rouge">doskey /reinstall</code></p>

<h2 id="0x04-å°ç»“">0x04 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†ä¸¤ç§Powershellå‘½ä»¤çš„å†å²è®°å½•ï¼Œæ€»ç»“å¸¸ç”¨å¯¼å‡ºå†å²è®°å½•çš„æ–¹æ³•ï¼Œç»“åˆåˆ©ç”¨æ€è·¯ï¼Œç»™å‡ºé˜²å¾¡å»ºè®®ã€‚</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET