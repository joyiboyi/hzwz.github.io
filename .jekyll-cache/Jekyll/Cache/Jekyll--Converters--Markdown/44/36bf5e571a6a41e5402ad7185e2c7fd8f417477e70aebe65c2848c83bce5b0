I"¨'<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ProxyShellä¸­ç¬¬äºŒä¸ªæ¼æ´çš„ç»†èŠ‚ï¼Œåˆ†æåˆ©ç”¨æ€è·¯ã€‚</p>

<h2 id="0x01-ç®€ä»‹">0x01 ç®€ä»‹</h2>
<hr />

<p>æœ¬æ–‡å°†è¦ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>CommonAccessToken</li>
  <li>Exchange PowerShell Remoting</li>
  <li>åˆ©ç”¨åˆ†æ</li>
</ul>

<h2 id="0x02-commonaccesstoken">0x02 CommonAccessToken</h2>
<hr />

<p>åœ¨ä¸Šç¯‡æ–‡ç« ã€ŠProxyShellåˆ©ç”¨åˆ†æ1â€”â€”CVE-2021-34473ã€‹æåˆ°ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°é€šè¿‡å‚æ•°æŒ‡å®šEWSè®¤è¯ç”¨æˆ·çš„æ–¹æ³•ï¼Œä½†æ˜¯å¯¹äºExchange PowerShell Remotingï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥CommonAccessTokenæŒ‡å®šè®¤è¯ç”¨æˆ·ï¼Œè®¿é—®Exchange PowerShell Remoting</p>

<h3 id="1å®šä½å‚æ•°ä¼ å…¥æ–¹æ³•">1.å®šä½å‚æ•°ä¼ å…¥æ–¹æ³•</h3>

<p>ä½¿ç”¨dnsSpyæ‰“å¼€æ–‡ä»¶<code class="language-plaintext highlighter-rouge">C:\Program Files\Microsoft\Exchange Server\V15\Bin\Microsoft.Exchange.Configuration.RemotePowershellBackendCmdletProxyModule.dll</code></p>

<p>ä¾æ¬¡å®šä½åˆ°<code class="language-plaintext highlighter-rouge">Microsoft.Exchange.Configuration.RemotePowershellBackendCmdletProxy</code> -&gt; <code class="language-plaintext highlighter-rouge">RemotePowershellBackendCmdletProxyModule</code> -&gt; <code class="language-plaintext highlighter-rouge">CommonAccessToken CommonAccessTokenFromUrl(string user, Uri requestURI, out Exception ex)</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2021-8-13/2-1.png" alt="Alt text" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡X-Rps-CATä½œä¸ºå‚æ•°ä¼ å…¥CommonAccessToken</p>

<p>ä¼ é€’å‚æ•°çš„æ–¹å¼å¯ä»¥å‚è€ƒä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2021-8-13/2-2.png" alt="Alt text" /></p>

<h3 id="2commonaccesstokençš„ç”Ÿæˆ">2.CommonAccessTokençš„ç”Ÿæˆ</h3>

<p>ä½¿ç”¨dnsSpyæ‰“å¼€æ–‡ä»¶<code class="language-plaintext highlighter-rouge">C:\Program Files\Microsoft\Exchange Server\V15\Bin\Microsoft.Exchange.Net.dll</code></p>

<p>ä¾æ¬¡å®šä½åˆ°<code class="language-plaintext highlighter-rouge">Microsoft.Exchange.Security.Authorization</code> -&gt; <code class="language-plaintext highlighter-rouge">CommonAccessToken</code> -&gt; <code class="language-plaintext highlighter-rouge">Deserialize(Stream stream)</code></p>

<p>å¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2021-8-13/2-3.png" alt="Alt text" /></p>

<p>åœ¨èµ·å§‹ä½ç½®ä¸‹æ–­ç‚¹</p>

<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\System32\inetsrv\appcmd list wp
</code></pre></div></div>

<p>æ‰¾åˆ°applicationPool:MSExchangePowerShellAppPoolå¯¹åº”çš„è¿›ç¨‹pid</p>

<p>é™„åŠ åˆ°è¯¥è¿›ç¨‹ä¸Šï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œèƒ½å¤Ÿæ•è·åˆ°æ­£ç¡®çš„æ ¼å¼</p>

<p>æ­¤æ—¶ï¼Œé€‰ä¸­Localsä¸­çš„binaryReaderï¼Œä¾æ¬¡æŒ‰é¼ æ ‡å³é”® -&gt; é€‰æ‹©Show in Memory Window -&gt; Memory 1ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2021-8-13/2-4.png" alt="Alt text" /></p>

<p>æŸ¥çœ‹è¯¥å†…å­˜åŒºåŸŸé™„è¿‘çš„å†…å®¹ï¼Œæ•è·åˆ°äº†æ­£ç¡®çš„æ ¼å¼ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2021-8-13/2-5.png" alt="Alt text" /></p>

<p>ç»è¿‡åˆ†æï¼Œæ•è·çš„å†…å®¹ç»“æ„å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>V + ç‰ˆæœ¬(\x01\x00) + T + ç±»å‹é•¿åº¦(\x07) + ç±»å‹(Windows) + C + \x00 + A + è®¤è¯ç±»å‹é•¿åº¦(\x08) + è®¤è¯ç±»å‹(kerberos) + L + ç”¨æˆ·åé•¿åº¦ + ç”¨æˆ·å + U + sidé•¿åº¦ + sid + G + ç»„ä¸ªæ•°(4å­—èŠ‚ï¼Œlittle endianï¼Œ\x06\x00\x00\x00) + åˆ†éš”ç¬¦\x07\x00\x00\x00 + ç»„1é•¿åº¦ + ç»„1 + åˆ†éš”ç¬¦\x07\x00\x00\x00 + ç»„2é•¿åº¦ + ç»„2 + åˆ†éš”ç¬¦\x07\x00\x00\x00 + ç»„3é•¿åº¦ + ç»„3 + åˆ†éš”ç¬¦\x07\x00\x00\x00 + ç»„4é•¿åº¦ + ç»„4 + åˆ†éš”ç¬¦\x07\x00\x00\x00 + ç»„5é•¿åº¦ + ç»„5 + åˆ†éš”ç¬¦\x07\x00\x00\x00 + ç»„6é•¿åº¦ + ç»„6 + E + \x00\x00\x00\x00
</code></pre></div></div>

<p>å¯¹äºè®¤è¯ç±»å‹é•¿åº¦ï¼Œé•¿åº¦ä¸º1å­—èŠ‚ï¼Œå­—èŠ‚åºä¸ºlittle endianï¼Œå†…å®¹ä¸ºè®¤è¯ç±»å‹çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œä¾‹å¦‚è®¤è¯ç±»å‹ä¸ºbasicï¼Œé‚£ä¹ˆè®¤è¯ç±»å‹é•¿åº¦ä¸º\x05</p>

<p>åœ¨Pythonä»£ç å®ç°ä¸Šï¼Œè®¡ç®—è®¤è¯ç±»å‹é•¿åº¦å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>authtype = "kerberos"
authlen = (len(authtype)).to_bytes(1, 'little')
</code></pre></div></div>

<p>ç»è¿‡å®é™…æµ‹è¯•ï¼Œæ„é€ CommonAccessTokenæ—¶ï¼Œæœ‰ä»¥ä¸‹æŠ€å·§ï¼š</p>

<ul>
  <li>ç”¨æˆ·ååªè¦æ˜¯åˆæ³•ç”¨æˆ·å³å¯ï¼Œå¯ä»¥ä½¿ç”¨é»˜è®¤é‚®ç®±</li>
  <li>sidä¸ºå…³é”®å†…å®¹ï¼Œä»£è¡¨è®¤è¯ç”¨æˆ·çš„æƒé™ï¼Œå¦‚æœéœ€è¦è®¤è¯ä¸ºç®¡ç†å‘˜ç”¨æˆ·Administratorï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºS-1-5-domain-500</li>
  <li>å¦‚æœåŸŸç¯å¢ƒç¦ç”¨äº†ç®¡ç†å‘˜ç”¨æˆ·administratorï¼Œä»ç„¶èƒ½å¤Ÿè®¤è¯æˆåŠŸ</li>
  <li>group sidåªè¦æ˜¯å¯ç”¨çš„å³å¯ï¼Œä¾‹å¦‚éšä¾¿æŒ‡å®šä¸€ä¸ªS-1-1-0</li>
</ul>

<p>å…³äºsidçš„æ ¼å¼å¯ä»¥å‚è€ƒï¼š</p>

<p>https://docs.microsoft.com/en-US/windows/security/identity-protection/access-control/security-identifiers</p>

<h3 id="3commonaccesstokençš„éªŒè¯">3.CommonAccessTokençš„éªŒè¯</h3>

<p>åœ¨ä»¥æ­£ç¡®çš„æ–¹å¼ä¼ å…¥å‚æ•°X-Rps-CATï¼Œå¦‚æœCommonAccessTokenä¹Ÿæœ‰æ•ˆï¼Œé‚£ä¹ˆåœ¨è®¿é—®/Powershellæ—¶ä¼šè¿”å›çŠ¶æ€ç 200</p>

<h2 id="0x03-exchange-powershell-remoting">0x03 Exchange PowerShell Remoting</h2>
<hr />

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>https://docs.microsoft.com/en-us/powershell/module/exchange/?view=exchange-ps</p>

<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80-%E4%BB%8EExchange%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%90%9C%E7%B4%A2%E5%92%8C%E5%AF%BC%E5%87%BA%E9%82%AE%E4%BB%B6">ã€Šæ¸—é€åŸºç¡€â€”â€”ä»ExchangeæœåŠ¡å™¨ä¸Šæœç´¢å’Œå¯¼å‡ºé‚®ä»¶ã€‹</a>ä»‹ç»è¿‡Exchange PowerShell Remotingçš„ç›¸å…³ç”¨æ³•ï¼Œè¿™é‡Œåšä¸€äº›è¡¥å……</p>

<h3 id="1é»˜è®¤è®¾ç½®ä¸‹æ‰€æœ‰åŸŸç”¨æˆ·éƒ½å¯ä»¥è¿æ¥remote-powershell">1.é»˜è®¤è®¾ç½®ä¸‹ï¼Œæ‰€æœ‰åŸŸç”¨æˆ·éƒ½å¯ä»¥è¿æ¥remote PowerShell</h3>

<p>å¸¸ç”¨å‘½ä»¤ï¼š</p>

<p>æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦å…·æœ‰è®¿é—®remote PowerShellçš„æƒé™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-User -Identity &lt;UserIdentity&gt; | Format-List RemotePowerShellEnabled
</code></pre></div></div>

<p>åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·æ˜¯å¦å…·æœ‰è®¿é—®remote PowerShellçš„æƒé™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-User -ResultSize unlimited | Format-Table -Auto Name,DisplayName,RemotePowerShellEnabled
</code></pre></div></div>

<p>åˆ—å‡ºå…·æœ‰è®¿é—®remote PowerShellæƒé™çš„ç”¨æˆ·ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-User -ResultSize unlimited -Filter 'RemotePowerShellEnabled -eq $true'
</code></pre></div></div>

<p>åˆ é™¤æŒ‡å®šç”¨æˆ·çš„remote PowerShellè®¿é—®æƒé™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set-User -Identity &lt;UserIdentity&gt; -RemotePowerShellEnabled $false
</code></pre></div></div>

<p>å¼€å¯æŒ‡å®šç”¨æˆ·çš„remote PowerShellè®¿é—®æƒé™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set-User -Identity &lt;UserIdentity&gt; -RemotePowerShellEnabled $true
</code></pre></div></div>

<p>å¦‚æœæƒ³è¦æ‰§è¡Œç®¡ç†ExchangeæœåŠ¡å™¨çš„å‘½ä»¤ï¼Œç”¨æˆ·éœ€è¦æˆä¸º<code class="language-plaintext highlighter-rouge">Organization Management</code>ç»„çš„æˆå‘˜</p>

<p>æŸ¥çœ‹<code class="language-plaintext highlighter-rouge">Organization Management</code>ç»„æˆå‘˜çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-RoleGroupMember "Organization Management"
</code></pre></div></div>

<h3 id="2è¿æ¥remote-powershellçš„å†…ç½®æ–¹æ³•">2.è¿æ¥remote PowerShellçš„å†…ç½®æ–¹æ³•</h3>

<p>Powershellç¤ºä¾‹å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$User = "test\user1"
$Pass = ConvertTo-SecureString -AsPlainText Password1 -Force
$Credential = New-Object System.Management.Automation.PSCredential -ArgumentList $User,$Pass
$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://exchangeserver.test.com/PowerShell/ -Authentication Kerberos -Credential $Credential
Import-PSSession $Session -AllowClobber
Get-RoleGroupMember "Organization Management"
Remove-PSSession $Session
</code></pre></div></div>

<p>è¯¥æ–¹æ³•é»˜è®¤åªèƒ½ä»åŸŸå†…ä¸»æœºå‘èµ·è¿æ¥ï¼Œä¸æ”¯æŒä»åŸŸå¤–è¿æ¥</p>

<h2 id="0x04-åˆ©ç”¨åˆ†æ">0x04 åˆ©ç”¨åˆ†æ</h2>
<hr />

<h3 id="1commonaccesstokençš„æ ¼å¼">1.CommonAccessTokençš„æ ¼å¼</h3>

<p>ç”¨æˆ·sidéœ€è¦è®¾ç½®æˆAdministratorï¼Œé»˜è®¤ä¸º<code class="language-plaintext highlighter-rouge">S-1-5-domain-500</code></p>

<p>è¿™é‡Œå¯ä»¥é€‰æ‹©å…¶ä»–ç”¨æˆ·çš„sidï¼Œä½†éœ€è¦æ»¡è¶³ç”¨æˆ·ä½äºâ€Organization Managementâ€ç»„ä¸­</p>

<h3 id="2ä½¿ç”¨pypsrpè¿æ¥remote-powershellçš„ä¸€ä¸ªé—®é¢˜">2.ä½¿ç”¨<a href="https://github.com/jborean93/pypsrp">PyPSRP</a>è¿æ¥remote PowerShellçš„ä¸€ä¸ªé—®é¢˜</h3>

<p>ä½¿ç”¨<a href="https://github.com/jborean93/pypsrp">PyPSRP</a>æ‰§è¡ŒPowershellå‘½ä»¤æ—¶ï¼Œæ— æ³•æ‰§è¡Œæ·»åŠ ç”¨æˆ·çš„æ“ä½œ</p>

<p>è¿™æ˜¯å› ä¸ºä¼ é€’Passwordçš„å€¼æ—¶éœ€è¦æ‰§è¡ŒPowershellå‘½ä»¤<code class="language-plaintext highlighter-rouge">convertto-securestring</code>ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">convertto-securestring</code>ä¸æ˜¯Exchange PowerShell Remotingæ”¯æŒçš„å‘½ä»¤</p>

<p>å¦‚æœé€‰æ‹©æ‰§è¡ŒPowershellè„šæœ¬ï¼Œç”±äºé»˜è®¤Powershellç­–ç•¥çš„é™åˆ¶ï¼Œä¼šæç¤ºæ— æ³•æ‰§è¡ŒPowershellè„šæœ¬</p>

<h2 id="0x05-å°ç»“">0x05 å°ç»“</h2>
<hr />

<p>å¯¹äºProxyShellä¸­çš„ç¬¬äºŒä¸ªæ¼æ´CVE-2021-34523ï¼Œç»“åˆåˆ©ç”¨æ€è·¯ï¼Œä¸éš¾çŒœå‡ºæœ€ç®€å•ç²—æš´çš„é˜²å¾¡æ–¹æ³•ï¼šå°†â€Organization Managementâ€ç»„å†…çš„ç”¨æˆ·æ¸…ç©ºï¼Œå°±å¯ä»¥é˜²æ­¢æ”»å‡»è€…æ‰§è¡Œé«˜æƒé™çš„Exchange Powershellå‘½ä»¤</p>

<hr />

<p><a href="https://github.com/3gstudent/feedback/issues/new">LEAVE A REPLY</a></p>

:ET